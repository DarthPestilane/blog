{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/CNAME","path":"CNAME","modified":1,"renderable":0},{"_id":"source/images/favicon.jpg","path":"images/favicon.jpg","modified":1,"renderable":0},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":1,"renderable":1},{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":1,"renderable":1},{"_id":"themes/next/source/js/algolia-search.js","path":"js/algolia-search.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/bookmark.js","path":"js/bookmark.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/local-search.js","path":"js/local-search.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/motion.js","path":"js/motion.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/next-boot.js","path":"js/next-boot.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/utils.js","path":"js/utils.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/anime.min.js","path":"lib/anime.min.js","modified":1,"renderable":1},{"_id":"source/fonts/UbuntuMono-R.ttf","path":"fonts/UbuntuMono-R.ttf","modified":1,"renderable":0},{"_id":"themes/next/source/js/schemes/muse.js","path":"js/schemes/muse.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/schemes/pisces.js","path":"js/schemes/pisces.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-regular-400.woff2","path":"lib/font-awesome/webfonts/fa-regular-400.woff2","modified":1,"renderable":1},{"_id":"source/images/payment.png","path":"images/payment.png","modified":1,"renderable":0},{"_id":"themes/next/source/lib/font-awesome/css/all.min.css","path":"lib/font-awesome/css/all.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-brands-400.woff2","path":"lib/font-awesome/webfonts/fa-brands-400.woff2","modified":1,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-solid-900.woff2","path":"lib/font-awesome/webfonts/fa-solid-900.woff2","modified":1,"renderable":1}],"Cache":[{"_id":"source/.gitignore","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1685252164284},{"_id":"themes/next/.editorconfig","hash":"8570735a8d8d034a3a175afd1dd40b39140b3e6a","modified":1685252164290},{"_id":"themes/next/.eslintrc.json","hash":"cc5f297f0322672fe3f684f823bc4659e4a54c41","modified":1685252164290},{"_id":"themes/next/.gitattributes","hash":"a54f902957d49356376b59287b894b1a3d7a003f","modified":1685252164290},{"_id":"themes/next/.gitignore","hash":"56f3470755c20311ddd30d421b377697a6e5e68b","modified":1685252164291},{"_id":"themes/next/.stylintrc","hash":"2cf4d637b56d8eb423f59656a11f6403aa90f550","modified":1685252164291},{"_id":"themes/next/.travis.yml","hash":"ecca3b919a5b15886e3eca58aa84aafc395590da","modified":1685252164291},{"_id":"themes/next/LICENSE.md","hash":"18144d8ed58c75af66cb419d54f3f63374cd5c5b","modified":1685252164292},{"_id":"themes/next/README.md","hash":"9b4b7d66aca47f9c65d6321b14eef48d95c4dff1","modified":1685252164292},{"_id":"themes/next/_config.yml","hash":"8491ea3d200b4eb3c29625becaf1aa36bbb84341","modified":1705024573666},{"_id":"themes/next/crowdin.yml","hash":"e026078448c77dcdd9ef50256bb6635a8f83dca6","modified":1685252164292},{"_id":"themes/next/gulpfile.js","hash":"1b4fc262b89948937b9e3794de812a7c1f2f3592","modified":1685252164294},{"_id":"themes/next/package.json","hash":"62fad6de02adbbba9fb096cbe2dcc15fe25f2435","modified":1685252164300},{"_id":"source/.DS_Store","hash":"fa645a3b149a95a1ebc2ca7ca36dcfe43b7d1693","modified":1711181857874},{"_id":"source/CNAME","hash":"9bf9d6a94f5130a08c9cde6d849976fc5b4ac22b","modified":1685252164284},{"_id":"themes/next/.github/CODE_OF_CONDUCT.md","hash":"aa4cb7aff595ca628cb58160ee1eee117989ec4e","modified":1685252164290},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"e554931b98f251fd49ff1d2443006d9ea2c20461","modified":1685252164290},{"_id":"themes/next/.github/PULL_REQUEST_TEMPLATE.md","hash":"1a435c20ae8fa183d49bbf96ac956f7c6c25c8af","modified":1685252164291},{"_id":"themes/next/.github/config.yml","hash":"1d3f4e8794986817c0fead095c74f756d45f91ed","modified":1685252164291},{"_id":"themes/next/.github/issue-close-app.yml","hash":"7cba457eec47dbfcfd4086acd1c69eaafca2f0cd","modified":1685252164291},{"_id":"themes/next/.github/issue_label_bot.yaml","hash":"fca600ddef6f80c5e61aeed21722d191e5606e5b","modified":1685252164291},{"_id":"themes/next/.github/lock.yml","hash":"61173b9522ebac13db2c544e138808295624f7fd","modified":1685252164291},{"_id":"themes/next/.github/mergeable.yml","hash":"0ee56e23bbc71e1e76427d2bd255a9879bd36e22","modified":1685252164291},{"_id":"themes/next/.github/release-drafter.yml","hash":"3cc10ce75ecc03a5ce86b00363e2a17eb65d15ea","modified":1685252164291},{"_id":"themes/next/.github/stale.yml","hash":"fdf82de9284f8bc8e0b0712b4cc1cb081a94de59","modified":1685252164291},{"_id":"themes/next/.github/support.yml","hash":"d75db6ffa7b4ca3b865a925f9de9aef3fc51925c","modified":1685252164291},{"_id":"themes/next/docs/AGPL3.md","hash":"0d2b8c5fa8a614723be0767cc3bca39c49578036","modified":1685252164292},{"_id":"themes/next/docs/ALGOLIA-SEARCH.md","hash":"c7a994b9542040317d8f99affa1405c143a94a38","modified":1685252164292},{"_id":"themes/next/docs/DATA-FILES.md","hash":"cddbdc91ee9e65c37a50bec12194f93d36161616","modified":1685252164292},{"_id":"themes/next/docs/AUTHORS.md","hash":"10135a2f78ac40e9f46b3add3e360c025400752f","modified":1685252164292},{"_id":"themes/next/docs/INSTALLATION.md","hash":"af88bcce035780aaa061261ed9d0d6c697678618","modified":1685252164292},{"_id":"themes/next/docs/LEANCLOUD-COUNTER-SECURITY.md","hash":"94dc3404ccb0e5f663af2aa883c1af1d6eae553d","modified":1685252164292},{"_id":"themes/next/docs/LICENSE.txt","hash":"368bf2c29d70f27d8726dd914f1b3211cae4bbab","modified":1685252164292},{"_id":"themes/next/docs/MATH.md","hash":"d645b025ec7fb9fbf799b9bb76af33b9f5b9ed93","modified":1685252164293},{"_id":"themes/next/docs/UPDATE-FROM-5.1.X.md","hash":"8b6e4b2c9cfcb969833092bdeaed78534082e3e6","modified":1685252164293},{"_id":"themes/next/languages/ar.yml","hash":"9815e84e53d750c8bcbd9193c2d44d8d910e3444","modified":1685252164294},{"_id":"themes/next/languages/de.yml","hash":"74c59f2744217003b717b59d96e275b54635abf5","modified":1685252164294},{"_id":"themes/next/languages/default.yml","hash":"45bc5118828bdc72dcaa25282cd367c8622758cb","modified":1685252164294},{"_id":"themes/next/languages/en.yml","hash":"45bc5118828bdc72dcaa25282cd367c8622758cb","modified":1685252164294},{"_id":"themes/next/languages/es.yml","hash":"c64cf05f356096f1464b4b1439da3c6c9b941062","modified":1685252164294},{"_id":"themes/next/languages/fa.yml","hash":"3676b32fda37e122f3c1a655085a1868fb6ad66b","modified":1685252164294},{"_id":"themes/next/languages/fr.yml","hash":"752bf309f46a2cd43890b82300b342d7218d625f","modified":1685252164294},{"_id":"themes/next/languages/hu.yml","hash":"b1ebb77a5fd101195b79f94de293bcf9001d996f","modified":1685252164294},{"_id":"themes/next/languages/id.yml","hash":"572ed855d47aafe26f58c73b1394530754881ec2","modified":1685252164294},{"_id":"themes/next/languages/it.yml","hash":"44759f779ce9c260b895532de1d209ad4bd144bf","modified":1685252164295},{"_id":"themes/next/languages/nl.yml","hash":"5af3473d9f22897204afabc08bb984b247493330","modified":1685252164295},{"_id":"themes/next/languages/ko.yml","hash":"0feea9e43cd399f3610b94d755a39fff1d371e97","modified":1685252164295},{"_id":"themes/next/languages/ja.yml","hash":"0cf0baa663d530f22ff380a051881216d6adcdd8","modified":1685252164295},{"_id":"themes/next/languages/pt-BR.yml","hash":"67555b1ba31a0242b12fc6ce3add28531160e35b","modified":1685252164295},{"_id":"themes/next/languages/ru.yml","hash":"e993d5ca072f7f6887e30fc0c19b4da791ca7a88","modified":1685252164295},{"_id":"themes/next/languages/pt.yml","hash":"718d131f42f214842337776e1eaddd1e9a584054","modified":1685252164295},{"_id":"themes/next/languages/tr.yml","hash":"fe793f4c2608e3f85f0b872fd0ac1fb93e6155e2","modified":1685252164295},{"_id":"themes/next/languages/uk.yml","hash":"3a6d635b1035423b22fc86d9455dba9003724de9","modified":1685252164295},{"_id":"themes/next/languages/vi.yml","hash":"93393b01df148dcbf0863f6eee8e404e2d94ef9e","modified":1685252164295},{"_id":"themes/next/languages/zh-CN.yml","hash":"a1f15571ee7e1e84e3cc0985c3ec4ba1a113f6f8","modified":1685252164295},{"_id":"themes/next/languages/zh-hk.yml","hash":"3789f94010f948e9f23e21235ef422a191753c65","modified":1685252164295},{"_id":"themes/next/languages/zh-tw.yml","hash":"8c09da7c4ec3fca2c6ee897b2eea260596a2baa1","modified":1685252164295},{"_id":"themes/next/layout/_layout.swig","hash":"6a6e92a4664cdb981890a27ac11fd057f44de1d5","modified":1685252164295},{"_id":"themes/next/layout/archive.swig","hash":"e4e31317a8df68f23156cfc49e9b1aa9a12ad2ed","modified":1685252164300},{"_id":"themes/next/layout/category.swig","hash":"1bde61cf4d2d171647311a0ac2c5c7933f6a53b0","modified":1685252164300},{"_id":"themes/next/layout/page.swig","hash":"db581bdeac5c75fabb0f17d7c5e746e47f2a9168","modified":1685252164300},{"_id":"themes/next/layout/index.swig","hash":"7f403a18a68e6d662ae3e154b2c1d3bbe0801a23","modified":1685252164300},{"_id":"themes/next/layout/post.swig","hash":"2f6d992ced7e067521fdce05ffe4fd75481f41c5","modified":1685252164300},{"_id":"themes/next/layout/tag.swig","hash":"0dfb653bd5de980426d55a0606d1ab122bd8c017","modified":1685252164300},{"_id":"themes/next/scripts/renderer.js","hash":"49a65df2028a1bc24814dc72fa50d52231ca4f05","modified":1685252164302},{"_id":"source/404/index.md","hash":"3fc6f9d13a49366637c20428926f6c2b60eabd08","modified":1685252164284},{"_id":"source/categories/index.md","hash":"3c46d851b4829058cacb261b5a4ba084e8eac238","modified":1685252164287},{"_id":"source/_posts/2017-10-09-Mac版搜狗输入法自动英文添加spotlight-app.md","hash":"fd5eec20b226095802f2bd649e9430db142d089c","modified":1685252164284},{"_id":"source/_posts/2017-10-09-梅林单线复用internet+IPTV.md","hash":"2aa4d1c8643a775f7a7b1e85386c65139a24ecc6","modified":1685252164284},{"_id":"source/_posts/2017-10-12-Install-Shadowsocks-server-on-ubuntu.md","hash":"eb90a7f64281904a04222f8f9133ec77c3a0eba1","modified":1685252164284},{"_id":"source/_posts/2017-11-11-Golang中的时间符号规律.md","hash":"d67caa6e6ff31e1bfc20f0dee39f3529bcecd22c","modified":1685252164284},{"_id":"source/_posts/2017-12-16-Merry-Christmas-Soon.md","hash":"29acb8926806e68270980a7fe66104d583ed2eb6","modified":1685252164284},{"_id":"source/_posts/2017-11-11-Mac下使用adb将本地文件拷贝到安卓手机.md","hash":"3881bce92180c79c12f18b55bacb18a35e603e48","modified":1685252164284},{"_id":"source/_posts/2017-12-19-初识gRPC.md","hash":"f15b8af441e2d6efe4b10ee5779dd72b6a30fd62","modified":1685252164284},{"_id":"source/_posts/2017-12-27-Golang-reflect-实践.md","hash":"be3cb7b426fd05b1a7885c3dce29d7d596859b67","modified":1685252164285},{"_id":"source/_posts/2018-01-03-关于装修的感悟.md","hash":"b0364cbf9090471677216056890d69d8be898480","modified":1685252164285},{"_id":"source/_posts/2018-01-17-使用ide-helper提升PHPstorm开发laravel-lumen项目体验.md","hash":"fd9e996bb3fe6f64e922c5cccbada3fb5364292c","modified":1685252164285},{"_id":"source/_posts/2018-01-17-让-`git-status`-命令正确显示中文.md","hash":"6b397b91454c3368c363d594c0330b3ca704045b","modified":1685252164285},{"_id":"source/_posts/2018-01-18-Golang并发编程最简单实践.md","hash":"85c6891aa4bcad3c1402ae4c245755ac5c538488","modified":1685252164285},{"_id":"source/_posts/2018-02-24-快速获取当前内网IP的命令.md","hash":"763ec565c36ba3834884d9dfd6bf6299a44635dd","modified":1685252164285},{"_id":"source/_posts/2018-02-28-Golang中slice的一些helper.md","hash":"2114cbfc0789b2e16c9460994636a3488180572e","modified":1685252164285},{"_id":"source/_posts/2018-04-16-The-Unforgiven-II.md","hash":"51fa55deee13b1b58299269cd8fd844e09753bd8","modified":1685252164285},{"_id":"source/_posts/2018-04-25-搭建简单的nginx文件服务.md","hash":"cb9807dc00ed8efb98565437d38c9207a600d80f","modified":1685252164285},{"_id":"source/_posts/2018-05-03-Happy-Birthday.md","hash":"da4fe749a9d963dccc2df724fc5ff1a3d58e3d13","modified":1685252164285},{"_id":"source/_posts/2018-05-30-Nginx-FPM配置.md","hash":"ab931aa0f057a1fd59bc49ab6c085ebe24b86f88","modified":1685252164285},{"_id":"source/_posts/2018-08-23-certbot更新证书.md","hash":"9a2b02d9df12fb4fbea00b15afa2a8c96db84fac","modified":1685252164285},{"_id":"source/_posts/2018-09-07-Welcome-Home-Sanitarium.md","hash":"8224e6040799940eee5c896652d9ea6dd7c33fa5","modified":1685252164285},{"_id":"source/_posts/2018-11-26-ssh隧道转发.md","hash":"bfb298427d598b0cb591faa05c62369b5ed7a5b9","modified":1685252164285},{"_id":"source/_posts/2019-01-09-Mysql函数运用.md","hash":"2398eb881700a0e44808bb64b4d007c7b43c62bd","modified":1685252164285},{"_id":"source/_posts/2019-04-01-记一次群晖-SHR-降级折腾.md","hash":"8aa684648a31032fb850d88334aac14c4473934c","modified":1685252164286},{"_id":"source/_posts/2019-05-21-iPhoneXS-jailbreak.md","hash":"6216fe9fc4c33c1d4fbe12c07414f18203635094","modified":1685252164286},{"_id":"source/_posts/2019-07-04-MySQL-数据库-InnoDB-学习笔记.md","hash":"de9bfa88f9e325ec8a628575f1248c41d6531d79","modified":1685252164286},{"_id":"source/_posts/2019-07-11-PHP-GC.md","hash":"4616975115557e6d54e3821bdd020eb61ae6ea1b","modified":1685252164286},{"_id":"source/_posts/2019-09-16-解决Macbook-usb断连问题.md","hash":"a32685f8d496bf1c0625469d75eec012f7638a86","modified":1685252164286},{"_id":"source/_posts/2019-06-27-Drone-1.0-简单实践.md","hash":"d1567f0ad2ed5116ea4046091ab1281ba882f990","modified":1685252164286},{"_id":"source/_posts/2020-08-17-理解-Golang-中的-nil-判断.md","hash":"44e764d8df920e706ac220709756557b00fff972","modified":1685252164286},{"_id":"source/_posts/2021-01-11-REGRETS-OF-THE-DYING.md","hash":"425eaaec901fbf233a044dd91db590261a1c4d6c","modified":1685252164286},{"_id":"source/_posts/2021-04-21-Go-Blog-翻译-Context-and-Structs.md","hash":"38a942a849e2179f73830fe8015744dfea853b67","modified":1685252164286},{"_id":"source/_posts/2021-09-15-Go-Blog-翻译-Fuzzing-is-Beta-Ready.md","hash":"1bcc9cc6b76c625cbbd67c7cb5ad3bc9487f36a4","modified":1685252164286},{"_id":"source/_posts/2021-09-22-git-commit-message-standard.md","hash":"1ff8b95fd632ee36f0d0c1cd5e131392e3596607","modified":1685252164286},{"_id":"source/_posts/2021-10-09-Jenkins-多分支-pipeline-配置.md","hash":"141fadd50840729bacc3d298a82555bb674048ab","modified":1712576126860},{"_id":"source/_posts/2021-09-24-Docker-部署-JIRA.md","hash":"a0ba7091bfd9dbf922455cdf075d4d9f7b65573a","modified":1685252164286},{"_id":"source/_posts/2021-10-09-利用-Github-Action-部署博客.md","hash":"72052304655d001552b6e35a1be1e24bbcc58504","modified":1685252164287},{"_id":"source/_posts/2021-12-07-Homebrew-安装-disabled-formula.md","hash":"c728cadb34abf69738b70317ce127463e469b6d6","modified":1686880055189},{"_id":"source/_posts/2021-10-18-温故-base64-编码.md","hash":"b0e6f60004bf6e3b7fa0c2ba83567e4fb49fcbc0","modified":1685252164287},{"_id":"source/_posts/2022-11-10-disable-mds-stores.md","hash":"5b388fcba18f58e3e15b07aaa30beea9a7ef430d","modified":1685252164287},{"_id":"source/_posts/2023-03-15-Nginx-反代-go-module.md","hash":"b3f4adde8e83215f2e1c4d31f8dd8a16dd82df34","modified":1685252164287},{"_id":"source/images/favicon.jpg","hash":"64f11abad22a5bd8156d4fecfef90c62c666af78","modified":1685252164288},{"_id":"source/tags/index.md","hash":"98fb83a89b5ecca9f95686805345a15c643ef536","modified":1685252164290},{"_id":"source/about/index.md","hash":"e8b3c737cc1b2dc288bf77a7f1f089c8ab42b6a4","modified":1685252164287},{"_id":"themes/next/.github/ISSUE_TEMPLATE/bug-report.md","hash":"c3e6b8196c983c40fd140bdeca012d03e6e86967","modified":1685252164291},{"_id":"themes/next/.github/ISSUE_TEMPLATE/feature-request.md","hash":"12d99fb8b62bd9e34d9672f306c9ae4ace7e053e","modified":1685252164291},{"_id":"themes/next/.github/ISSUE_TEMPLATE/other.md","hash":"d3efc0df0275c98440e69476f733097916a2d579","modified":1685252164291},{"_id":"themes/next/.github/ISSUE_TEMPLATE/question.md","hash":"53df7d537e26aaf062d70d86835c5fd8f81412f3","modified":1685252164291},{"_id":"themes/next/docs/ru/DATA-FILES.md","hash":"0bd2d696f62a997a11a7d84fec0130122234174e","modified":1685252164293},{"_id":"themes/next/docs/ru/INSTALLATION.md","hash":"9c4fe2873123bf9ceacab5c50d17d8a0f1baef27","modified":1685252164293},{"_id":"themes/next/docs/ru/README.md","hash":"85dd68ed1250897a8e4a444a53a68c1d49eb7e11","modified":1685252164293},{"_id":"themes/next/docs/ru/UPDATE-FROM-5.1.X.md","hash":"5237a368ab99123749d724b6c379415f2c142a96","modified":1685252164293},{"_id":"themes/next/docs/zh-CN/ALGOLIA-SEARCH.md","hash":"34b88784ec120dfdc20fa82aadeb5f64ef614d14","modified":1685252164293},{"_id":"themes/next/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"fb23b85db6f7d8279d73ae1f41631f92f64fc864","modified":1685252164293},{"_id":"themes/next/docs/zh-CN/CONTRIBUTING.md","hash":"d3f03be036b75dc71cf3c366cd75aee7c127c874","modified":1685252164293},{"_id":"themes/next/docs/zh-CN/INSTALLATION.md","hash":"579c7bd8341873fb8be4732476d412814f1a3df7","modified":1685252164293},{"_id":"themes/next/docs/zh-CN/DATA-FILES.md","hash":"ca1030efdfca5e20f9db2e7a428998e66a24c0d0","modified":1685252164293},{"_id":"themes/next/docs/zh-CN/LEANCLOUD-COUNTER-SECURITY.md","hash":"8b18f84503a361fc712b0fe4d4568e2f086ca97d","modified":1685252164294},{"_id":"themes/next/docs/zh-CN/MATH.md","hash":"b92585d251f1f9ebe401abb5d932cb920f9b8b10","modified":1685252164294},{"_id":"themes/next/docs/zh-CN/README.md","hash":"c038629ff8f3f24e8593c4c8ecf0bef3a35c750d","modified":1685252164294},{"_id":"themes/next/docs/zh-CN/UPDATE-FROM-5.1.X.md","hash":"d9ce7331c1236bbe0a551d56cef2405e47e65325","modified":1685252164294},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"9c8dc0b8170679cdc1ee9ee8dbcbaebf3f42897b","modified":1685252164295},{"_id":"themes/next/layout/_macro/post.swig","hash":"090b5a9b6fca8e968178004cbd6cff205b7eba57","modified":1685252164296},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"71655ca21907e9061b6e8ac52d0d8fbf54d0062b","modified":1685252164296},{"_id":"themes/next/layout/_partials/comments.swig","hash":"db6ab5421b5f4b7cb32ac73ad0e053fdf065f83e","modified":1685252164296},{"_id":"themes/next/layout/_partials/footer.swig","hash":"4369b313cbbeae742cb35f86d23d99d4285f7359","modified":1685252164296},{"_id":"themes/next/layout/_partials/languages.swig","hash":"ba9e272f1065b8f0e8848648caa7dea3f02c6be1","modified":1685252164296},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"9876dbfc15713c7a47d4bcaa301f4757bd978269","modified":1685252164296},{"_id":"themes/next/layout/_partials/widgets.swig","hash":"83a40ce83dfd5cada417444fb2d6f5470aae6bb0","modified":1685252164297},{"_id":"themes/next/layout/_scripts/index.swig","hash":"cea942b450bcb0f352da78d76dc6d6f1d23d5029","modified":1685252164297},{"_id":"themes/next/layout/_scripts/noscript.swig","hash":"d1f2bfde6f1da51a2b35a7ab9e7e8eb6eefd1c6b","modified":1685252164297},{"_id":"themes/next/layout/_scripts/pjax.swig","hash":"4d2c93c66e069852bb0e3ea2e268d213d07bfa3f","modified":1685252164297},{"_id":"themes/next/layout/_scripts/three.swig","hash":"a4f42f2301866bd25a784a2281069d8b66836d0b","modified":1685252164298},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"ef38c213679e7b6d2a4116f56c9e55d678446069","modified":1685252164298},{"_id":"themes/next/layout/_third-party/baidu-push.swig","hash":"b782eb2e34c0c15440837040b5d65b093ab6ec04","modified":1685252164298},{"_id":"themes/next/layout/_third-party/index.swig","hash":"70c3c01dd181de81270c57f3d99b6d8f4c723404","modified":1685252164299},{"_id":"themes/next/layout/_third-party/quicklink.swig","hash":"311e5eceec9e949f1ea8d623b083cec0b8700ff2","modified":1685252164299},{"_id":"themes/next/layout/_third-party/rating.swig","hash":"2731e262a6b88eaee2a3ca61e6a3583a7f594702","modified":1685252164299},{"_id":"themes/next/scripts/events/index.js","hash":"5743cde07f3d2aa11532a168a652e52ec28514fd","modified":1685252164300},{"_id":"themes/next/scripts/filters/default-injects.js","hash":"aec50ed57b9d5d3faf2db3c88374f107203617e0","modified":1685252164301},{"_id":"themes/next/scripts/filters/locals.js","hash":"b193a936ee63451f09f8886343dcfdca577c0141","modified":1685252164301},{"_id":"themes/next/scripts/filters/front-matter.js","hash":"703bdd142a671b4b67d3d9dfb4a19d1dd7e7e8f7","modified":1685252164301},{"_id":"themes/next/scripts/filters/minify.js","hash":"19985723b9f677ff775f3b17dcebf314819a76ac","modified":1685252164301},{"_id":"themes/next/scripts/filters/post.js","hash":"44ba9b1c0bdda57590b53141306bb90adf0678db","modified":1685252164302},{"_id":"themes/next/scripts/helpers/engine.js","hash":"bdb424c3cc0d145bd0c6015bb1d2443c8a9c6cda","modified":1685252164302},{"_id":"themes/next/scripts/helpers/font.js","hash":"40cf00e9f2b7aa6e5f33d412e03ed10304b15fd7","modified":1685252164302},{"_id":"themes/next/scripts/helpers/next-config.js","hash":"5e11f30ddb5093a88a687446617a46b048fa02e5","modified":1685252164302},{"_id":"themes/next/scripts/helpers/next-url.js","hash":"958e86b2bd24e4fdfcbf9ce73e998efe3491a71f","modified":1685252164302},{"_id":"themes/next/scripts/tags/button.js","hash":"8c6b45f36e324820c919a822674703769e6da32c","modified":1685252164302},{"_id":"themes/next/scripts/tags/caniuse.js","hash":"94e0bbc7999b359baa42fa3731bdcf89c79ae2b3","modified":1685252164302},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"f1826ade2d135e2f60e2d95cb035383685b3370c","modified":1685252164302},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"d902fd313e8d35c3cc36f237607c2a0536c9edf1","modified":1685252164302},{"_id":"themes/next/scripts/tags/label.js","hash":"fc5b267d903facb7a35001792db28b801cccb1f8","modified":1685252164302},{"_id":"themes/next/scripts/tags/mermaid.js","hash":"983c6c4adea86160ecc0ba2204bc312aa338121d","modified":1685252164302},{"_id":"themes/next/scripts/tags/note.js","hash":"0a02bb4c15aec41f6d5f1271cdb5c65889e265d9","modified":1685252164302},{"_id":"themes/next/scripts/tags/pdf.js","hash":"8c613b39e7bff735473e35244b5629d02ee20618","modified":1685252164302},{"_id":"themes/next/scripts/tags/tabs.js","hash":"93d8a734a3035c1d3f04933167b500517557ba3e","modified":1685252164303},{"_id":"themes/next/scripts/tags/video.js","hash":"e5ff4c44faee604dd3ea9db6b222828c4750c227","modified":1685252164303},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1685252164309},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1685252164309},{"_id":"themes/next/source/images/avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1685252164309},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1685252164309},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1685252164309},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1685252164309},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1685252164309},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1685252164309},{"_id":"themes/next/source/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1685252164309},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1685252164309},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1685252164309},{"_id":"themes/next/source/css/_colors.styl","hash":"a8442520f719d3d7a19811cb3b85bcfd4a596e1f","modified":1685252164303},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1685252164309},{"_id":"themes/next/source/css/_mixins.styl","hash":"e31a557f8879c2f4d8d5567ee1800b3e03f91f6e","modified":1685252164307},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1685252164309},{"_id":"themes/next/source/css/main.styl","hash":"a3a3bbb5a973052f0186b3523911cb2539ff7b88","modified":1685252164309},{"_id":"themes/next/source/js/algolia-search.js","hash":"498d233eb5c7af6940baf94c1a1c36fdf1dd2636","modified":1685252164310},{"_id":"themes/next/source/js/bookmark.js","hash":"9734ebcb9b83489686f5c2da67dc9e6157e988ad","modified":1685252164310},{"_id":"themes/next/source/js/local-search.js","hash":"35ccf100d8f9c0fd6bfbb7fa88c2a76c42a69110","modified":1685252164310},{"_id":"themes/next/source/js/motion.js","hash":"72df86f6dfa29cce22abeff9d814c9dddfcf13a9","modified":1685252164310},{"_id":"themes/next/source/js/next-boot.js","hash":"a1b0636423009d4a4e4cea97bcbf1842bfab582c","modified":1685252164310},{"_id":"themes/next/source/js/utils.js","hash":"730cca7f164eaf258661a61ff3f769851ff1e5da","modified":1685252164310},{"_id":"themes/next/source/lib/anime.min.js","hash":"47cb482a8a488620a793d50ba8f6752324b46af3","modified":1685252164310},{"_id":"source/fonts/UbuntuMono-R.ttf","hash":"f4bfd74c2d10ea57abe1f7fa23f303e6875774ab","modified":1685252164288},{"_id":"themes/next/layout/_partials/head/head-unique.swig","hash":"000bad572d76ee95d9c0a78f9ccdc8d97cc7d4b4","modified":1685252164296},{"_id":"themes/next/layout/_partials/head/head.swig","hash":"68dde2fab2e53b68b54b2d52e6630733bb38a2b2","modified":1685252164296},{"_id":"themes/next/layout/_partials/header/brand.swig","hash":"c70f8e71e026e878a4e9d5ab3bbbf9b0b23c240c","modified":1685252164296},{"_id":"themes/next/layout/_partials/header/index.swig","hash":"7dbe93b8297b746afb89700b4d29289556e85267","modified":1685252164296},{"_id":"themes/next/layout/_partials/header/menu-item.swig","hash":"9440d8a3a181698b80e1fa47f5104f4565d8cdf3","modified":1685252164296},{"_id":"themes/next/layout/_partials/header/menu.swig","hash":"d31f896680a6c2f2c3f5128b4d4dd46c87ce2130","modified":1685252164296},{"_id":"themes/next/layout/_partials/header/sub-menu.swig","hash":"ae2261bea836581918a1c2b0d1028a78718434e0","modified":1685252164296},{"_id":"themes/next/layout/_partials/page/page-header.swig","hash":"9b7a66791d7822c52117fe167612265356512477","modified":1685252164296},{"_id":"themes/next/layout/_partials/post/post-copyright.swig","hash":"954ad71536b6eb08bd1f30ac6e2f5493b69d1c04","modified":1685252164297},{"_id":"themes/next/layout/_partials/page/breadcrumb.swig","hash":"c851717497ca64789f2176c9ecd1dedab237b752","modified":1685252164296},{"_id":"themes/next/layout/_partials/post/post-followme.swig","hash":"ceba16b9bd3a0c5c8811af7e7e49d0f9dcb2f41e","modified":1685252164297},{"_id":"themes/next/layout/_partials/post/post-footer.swig","hash":"8f14f3f8a1b2998d5114cc56b680fb5c419a6b07","modified":1685252164297},{"_id":"themes/next/layout/_partials/post/post-related.swig","hash":"f79c44692451db26efce704813f7a8872b7e63a0","modified":1685252164297},{"_id":"themes/next/layout/_partials/post/post-reward.swig","hash":"2b1a73556595c37951e39574df5a3f20b2edeaef","modified":1685252164297},{"_id":"themes/next/layout/_partials/search/algolia-search.swig","hash":"48430bd03b8f19c9b8cdb2642005ed67d56c6e0b","modified":1685252164297},{"_id":"themes/next/layout/_partials/search/index.swig","hash":"2be50f9bfb1c56b85b3b6910a7df27f51143632c","modified":1685252164297},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"f48a6a8eba04eb962470ce76dd731e13074d4c45","modified":1685252164297},{"_id":"themes/next/layout/_partials/sidebar/site-overview.swig","hash":"c46849e0af8f8fb78baccd40d2af14df04a074af","modified":1685252164297},{"_id":"themes/next/layout/_scripts/pages/schedule.swig","hash":"077b5d66f6309f2e7dcf08645058ff2e03143e6c","modified":1685252164297},{"_id":"themes/next/layout/_scripts/schemes/gemini.swig","hash":"1c910fc066c06d5fbbe9f2b0c47447539e029af7","modified":1685252164297},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"7f14ef43d9e82bc1efc204c5adf0b1dbfc919a9f","modified":1685252164298},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"7f14ef43d9e82bc1efc204c5adf0b1dbfc919a9f","modified":1685252164298},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"1c910fc066c06d5fbbe9f2b0c47447539e029af7","modified":1685252164298},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"4790058691b7d36cf6d2d6b4e93795a7b8d608ad","modified":1685252164298},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"2fa2b51d56bfac6a1ea76d651c93b9c20b01c09b","modified":1685252164298},{"_id":"themes/next/layout/_third-party/analytics/growingio.swig","hash":"5adea065641e8c55994dd2328ddae53215604928","modified":1685252164298},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"1472cabb0181f60a6a0b7fec8899a4d03dfb2040","modified":1685252164298},{"_id":"themes/next/layout/_third-party/chat/chatra.swig","hash":"f910618292c63871ca2e6c6e66c491f344fa7b1f","modified":1685252164298},{"_id":"themes/next/layout/_third-party/chat/tidio.swig","hash":"cba0e6e0fad08568a9e74ba9a5bee5341cfc04c1","modified":1685252164298},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"f39a5bf3ce9ee9adad282501235e0c588e4356ec","modified":1685252164298},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"b14908644225d78c864cd0a9b60c52407de56183","modified":1685252164298},{"_id":"themes/next/layout/_third-party/comments/disqusjs.swig","hash":"82f5b6822aa5ec958aa987b101ef860494c6cf1f","modified":1685252164298},{"_id":"themes/next/layout/_third-party/comments/gitalk.swig","hash":"d6ceb70648555338a80ae5724b778c8c58d7060d","modified":1685252164298},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"f7a9eca599a682479e8ca863db59be7c9c7508c8","modified":1685252164299},{"_id":"themes/next/layout/_third-party/comments/valine.swig","hash":"be0a8eccf1f6dc21154af297fc79555343031277","modified":1685252164299},{"_id":"themes/next/layout/_third-party/math/index.swig","hash":"6c5976621efd5db5f7c4c6b4f11bc79d6554885f","modified":1685252164299},{"_id":"themes/next/layout/_third-party/math/katex.swig","hash":"4791c977a730f29c846efcf6c9c15131b9400ead","modified":1685252164299},{"_id":"themes/next/layout/_third-party/math/mathjax.swig","hash":"ecf751321e799f0fb3bf94d049e535130e2547aa","modified":1685252164299},{"_id":"themes/next/layout/_third-party/search/algolia-search.swig","hash":"d35a999d67f4c302f76fdf13744ceef3c6506481","modified":1685252164299},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"767b6c714c22588bcd26ba70b0fc19b6810cbacd","modified":1685252164299},{"_id":"themes/next/layout/_third-party/search/swiftype.swig","hash":"ba0dbc06b9d244073a1c681ff7a722dcbf920b51","modified":1685252164299},{"_id":"themes/next/layout/_third-party/statistics/cnzz-analytics.swig","hash":"a17ace37876822327a2f9306a472974442c9005d","modified":1685252164299},{"_id":"themes/next/layout/_third-party/statistics/busuanzi-counter.swig","hash":"4b1986e43d6abce13450d2b41a736dd6a5620a10","modified":1685252164299},{"_id":"themes/next/layout/_third-party/statistics/firestore.swig","hash":"b26ac2bfbe91dd88267f8b96aee6bb222b265b7a","modified":1685252164300},{"_id":"themes/next/layout/_third-party/statistics/index.swig","hash":"5f6a966c509680dbfa70433f9d658cee59c304d7","modified":1685252164300},{"_id":"themes/next/layout/_third-party/statistics/lean-analytics.swig","hash":"d56d5af427cdfecc33a0f62ee62c056b4e33d095","modified":1685252164300},{"_id":"themes/next/layout/_third-party/tags/mermaid.swig","hash":"f3c43664a071ff3c0b28bd7e59b5523446829576","modified":1685252164300},{"_id":"themes/next/layout/_third-party/tags/pdf.swig","hash":"d30b0e255a8092043bac46441243f943ed6fb09b","modified":1685252164300},{"_id":"themes/next/scripts/filters/comment/changyan.js","hash":"a54708fd9309b4357c423a3730eb67f395344a5e","modified":1685252164301},{"_id":"themes/next/scripts/filters/comment/common.js","hash":"2486f3e0150c753e5f3af1a3665d074704b8ee2c","modified":1685252164301},{"_id":"themes/next/scripts/filters/comment/default-config.js","hash":"7f2d93af012c1e14b8596fecbfc7febb43d9b7f5","modified":1685252164301},{"_id":"themes/next/scripts/filters/comment/disqus.js","hash":"4c0c99c7e0f00849003dfce02a131104fb671137","modified":1685252164301},{"_id":"themes/next/scripts/filters/comment/disqusjs.js","hash":"7f8b92913d21070b489457fa5ed996d2a55f2c32","modified":1685252164301},{"_id":"themes/next/scripts/filters/comment/gitalk.js","hash":"e51dc3072c1ba0ea3008f09ecae8b46242ec6021","modified":1685252164301},{"_id":"themes/next/scripts/filters/comment/livere.js","hash":"d5fefc31fba4ab0188305b1af1feb61da49fdeb0","modified":1685252164301},{"_id":"themes/next/scripts/filters/comment/valine.js","hash":"6cbd85f9433c06bae22225ccf75ac55e04f2d106","modified":1685252164301},{"_id":"themes/next/scripts/events/lib/config.js","hash":"d34c6040b13649714939f59be5175e137de65ede","modified":1685252164301},{"_id":"themes/next/scripts/events/lib/injects-point.js","hash":"6661c1c91c7cbdefc6a5e6a034b443b8811235a1","modified":1685252164301},{"_id":"themes/next/scripts/events/lib/injects.js","hash":"f233d8d0103ae7f9b861344aa65c1a3c1de8a845","modified":1685252164301},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"f4e694e5db81e57442c7e34505a416d818b3044a","modified":1685252164308},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"f70be8e229da7e1715c11dd0e975a2e71e453ac8","modified":1685252164308},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"612ec843372dae709acb17112c1145a53450cc59","modified":1685252164308},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"62df49459d552bbf73841753da8011a1f5e875c8","modified":1685252164308},{"_id":"themes/next/source/css/_variables/base.styl","hash":"5c957ed08dcbc6642c04ea49f7aca0e23c9533c7","modified":1685252164308},{"_id":"themes/next/source/js/schemes/muse.js","hash":"1eb9b88103ddcf8827b1a7cbc56471a9c5592d53","modified":1685252164310},{"_id":"themes/next/source/js/schemes/pisces.js","hash":"0ac5ce155bc58c972fe21c4c447f85e6f8755c62","modified":1685252164310},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1685252164311},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1685252164311},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"a1690e035b505d28bdef2b4424c13fc6312ab049","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/mobile.styl","hash":"681d33e3bc85bdca407d93b134c089264837378c","modified":1685252164305},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"ca5e70662dcfb261c25191cc5db5084dcf661c76","modified":1685252164303},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"a47725574e1bee3bc3b63b0ff2039cc982b17eff","modified":1685252164303},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"8e7b57a72e757cf95278239641726bb2d5b869d1","modified":1685252164303},{"_id":"themes/next/source/css/_common/components/reading-progress.styl","hash":"2e3bf7baf383c9073ec5e67f157d3cb3823c0957","modified":1685252164304},{"_id":"themes/next/source/css/_common/scaffolding/comments.styl","hash":"b1f0fab7344a20ed6748b04065b141ad423cf4d9","modified":1685252164306},{"_id":"themes/next/source/css/_common/scaffolding/buttons.styl","hash":"a2e9e00962e43e98ec2614d6d248ef1773bb9b78","modified":1685252164306},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"0b2c4b78eead410020d7c4ded59c75592a648df8","modified":1685252164306},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"b56367ea676ea8e8783ea89cd4ab150c7da7a060","modified":1685252164306},{"_id":"themes/next/source/css/_common/scaffolding/pagination.styl","hash":"8f58570a1bbc34c4989a47a1b7d42a8030f38b06","modified":1685252164306},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"523fb7b653b87ae37fc91fc8813e4ffad87b0d7e","modified":1685252164306},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"18ce72d90459c9aa66910ac64eae115f2dde3767","modified":1685252164306},{"_id":"themes/next/source/css/_common/scaffolding/toggles.styl","hash":"179e33b8ac7f4d8a8e76736a7e4f965fe9ab8b42","modified":1685252164307},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"7785bd756e0c4acede3a47fec1ed7b55988385a5","modified":1685252164307},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"f6516d0f7d89dc7b6c6e143a5af54b926f585d82","modified":1685252164307},{"_id":"themes/next/source/css/_schemes/Mist/_layout.styl","hash":"bb7ace23345364eb14983e860a7172e1683a4c94","modified":1685252164307},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"7104b9cef90ca3b140d7a7afcf15540a250218fc","modified":1685252164307},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expand.styl","hash":"6136da4bbb7e70cec99f5c7ae8c7e74f5e7c261a","modified":1685252164307},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"a717969829fa6ef88225095737df3f8ee86c286b","modified":1685252164307},{"_id":"themes/next/source/css/_schemes/Muse/_header.styl","hash":"f0131db6275ceaecae7e1a6a3798b8f89f6c850d","modified":1685252164308},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"4d1c17345d2d39ef7698f7acf82dfc0f59308c34","modified":1685252164308},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"93db5dafe9294542a6b5f647643cb9deaced8e06","modified":1685252164308},{"_id":"themes/next/source/css/_schemes/Muse/_sidebar.styl","hash":"2b2e7b5cea7783c9c8bb92655e26a67c266886f0","modified":1685252164308},{"_id":"themes/next/source/css/_schemes/Muse/_sub-menu.styl","hash":"c48ccd8d6651fe1a01faff8f01179456d39ba9b1","modified":1685252164308},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1685252164308},{"_id":"themes/next/source/css/_schemes/Pisces/_header.styl","hash":"e282df938bd029f391c466168d0e68389978f120","modified":1685252164308},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"70a4324b70501132855b5e59029acfc5d3da1ebd","modified":1685252164308},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"85da2f3006f4bef9a2199416ecfab4d288f848c4","modified":1685252164308},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"44f47c88c06d89d06f220f102649057118715828","modified":1685252164308},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1685252164308},{"_id":"themes/next/source/css/_schemes/Pisces/_sub-menu.styl","hash":"e740deadcfc4f29c5cb01e40f9df6277262ba4e3","modified":1685252164308},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"260bb01acd44d88dcb7f501a238ab968f86bef9e","modified":1685252164311},{"_id":"themes/next/source/lib/font-awesome/css/all.min.css","hash":"0038dc97c79451578b7bd48af60ba62282b4082b","modified":1685252164310},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"509988477da79c146cb93fb728405f18e923c2de","modified":1685252164311},{"_id":"themes/next/source/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"75a88815c47a249eadb5f0edc1675957f860cca7","modified":1685252164311},{"_id":"source/images/payment.png","hash":"8c3d3bf83dabb6d3301dd836de7d8665614f8def","modified":1685252164290},{"_id":"themes/next/source/css/_common/outline/footer/footer.styl","hash":"454a4aebfabb4469b92a8cbb49f46c49ac9bf165","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/header/bookmark.styl","hash":"e2d606f1ac343e9be4f15dbbaf3464bc4df8bf81","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/header/github-banner.styl","hash":"e7a9fdb6478b8674b1cdf94de4f8052843fb71d9","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/header/headerband.styl","hash":"0caf32492692ba8e854da43697a2ec8a41612194","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/header/header.styl","hash":"a793cfff86ad4af818faef04c18013077873f8f0","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/header/menu.styl","hash":"5f432a6ed9ca80a413c68b00e93d4a411abf280a","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/header/site-nav.styl","hash":"b2fc519828fe89a1f8f03ff7b809ad68cd46f3d7","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/header/site-meta.styl","hash":"45a239edca44acecf971d99b04f30a1aafbf6906","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author-links.styl","hash":"2cb1876e9e0c9ac32160888af27b1178dbcb0616","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author.styl","hash":"fa0222197b5eee47e18ac864cdc6eac75678b8fe","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-button.styl","hash":"1f0e7fbe80956f47087c2458ea880acf7a83078b","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-dimmer.styl","hash":"9b479c2f9a9bfed77885e5093b8245cc5d768ec7","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-blogroll.styl","hash":"44487d9ab290dc97871fa8dd4487016deb56e123","modified":1685252164305},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-nav.styl","hash":"a960a2dd587b15d3b3fe1b59525d6fa971c6a6ec","modified":1685252164306},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toc.styl","hash":"a05a4031e799bc864a4536f9ef61fe643cd421af","modified":1685252164306},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar.styl","hash":"a9cd93c36bae5af9223e7804963096274e8a4f03","modified":1685252164306},{"_id":"themes/next/source/css/_common/outline/sidebar/site-state.styl","hash":"2a47f8a6bb589c2fb635e6c1e4a2563c7f63c407","modified":1685252164306},{"_id":"themes/next/source/css/_common/components/pages/breadcrumb.styl","hash":"fafc96c86926b22afba8bb9418c05e6afbc05a57","modified":1685252164303},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"2bd0eb1512415325653b26d62a4463e6de83c5ac","modified":1685252164303},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toggle.styl","hash":"b3220db827e1adbca7880c2bb23e78fa7cbe95cb","modified":1685252164306},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"7504dbc5c70262b048143b2c37d2b5aa2809afa2","modified":1685252164303},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"e771dcb0b4673e063c0f3e2d73e7336ac05bcd57","modified":1685252164303},{"_id":"themes/next/source/css/_common/components/pages/tag-cloud.styl","hash":"d21d4ac1982c13d02f125a67c065412085a92ff2","modified":1685252164303},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"e75693f33dbc92afc55489438267869ae2f3db54","modified":1685252164303},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"f49ca072b5a800f735e8f01fc3518f885951dd8e","modified":1685252164303},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"902569a9dea90548bec21a823dd3efd94ff7c133","modified":1685252164303},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"ded41fd9d20a5e8db66aaff7cc50f105f5ef2952","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/post/post-followme.styl","hash":"1e4190c10c9e0c9ce92653b0dbcec21754b0b69d","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"72d495a88f7d6515af425c12cbc67308a57d88ea","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/post/post-header.styl","hash":"65cb6edb69e94e70e3291e9132408361148d41d5","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"6a97bcfa635d637dc59005be3b931109e0d1ead5","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/post/post-rtl.styl","hash":"f5c2788a78790aca1a2f37f7149d6058afb539e0","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"d114b2a531129e739a27ba6271cfe6857aa9a865","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"99e12c9ce3d14d4837e3d3f12fc867ba9c565317","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"5b5649b9749e3fd8b63aef22ceeece0a6e1df605","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/third-party/gitalk.styl","hash":"8a7fc03a568b95be8d3337195e38bc7ec5ba2b23","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/third-party/math.styl","hash":"b49e9fbd3c182b8fc066b8c2caf248e3eb748619","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"a760ee83ba6216871a9f14c5e56dc9bd0d9e2103","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/third-party/related-posts.styl","hash":"e2992846b39bf3857b5104675af02ba73e72eed5","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/third-party/search.styl","hash":"9f0b93d109c9aec79450c8a0cf4a4eab717d674d","modified":1685252164304},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"9a878d0119785a2316f42aebcceaa05a120b9a7a","modified":1685252164305},{"_id":"themes/next/source/css/_common/scaffolding/highlight/diff.styl","hash":"d3f73688bb7423e3ab0de1efdf6db46db5e34f80","modified":1685252164306},{"_id":"themes/next/source/css/_common/scaffolding/highlight/copy-code.styl","hash":"f71a3e86c05ea668b008cf05a81f67d92b6d65e4","modified":1685252164306},{"_id":"themes/next/source/css/_common/scaffolding/highlight/highlight.styl","hash":"35c871a809afa8306c8cde13651010e282548bc6","modified":1685252164306},{"_id":"themes/next/source/css/_common/scaffolding/highlight/theme.styl","hash":"3b3acc5caa0b95a2598bef4eeacb21bab21bea56","modified":1685252164306},{"_id":"themes/next/source/css/_common/scaffolding/tags/group-pictures.styl","hash":"709d10f763e357e1472d6471f8be384ec9e2d983","modified":1685252164307},{"_id":"themes/next/source/css/_common/scaffolding/tags/blockquote-center.styl","hash":"1d2778ca5aeeeafaa690dc2766b01b352ab76a02","modified":1685252164307},{"_id":"themes/next/source/css/_common/scaffolding/tags/label.styl","hash":"d7fce4b51b5f4b7c31d93a9edb6c6ce740aa0d6b","modified":1685252164307},{"_id":"themes/next/source/css/_common/scaffolding/tags/note.styl","hash":"e4d9a77ffe98e851c1202676940097ba28253313","modified":1685252164307},{"_id":"themes/next/source/css/_common/scaffolding/tags/pdf.styl","hash":"b49c64f8e9a6ca1c45c0ba98febf1974fdd03616","modified":1685252164307},{"_id":"themes/next/source/css/_common/scaffolding/tags/tabs.styl","hash":"f23670f1d8e749f3e83766d446790d8fd9620278","modified":1685252164307},{"_id":"themes/next/source/css/_common/scaffolding/tags/tags.styl","hash":"9e4c0653cfd3cc6908fa0d97581bcf80861fb1e7","modified":1685252164307},{"_id":"public/images/favicon.jpg","hash":"e00d25a6cb93227c3869c102f4b96d6ed31ffde7","modified":1719451368830},{"_id":"public/images/algolia_logo.svg","hash":"278ffcea4876b37657f2e192bda48c6bc7dd8784","modified":1719451368831},{"_id":"public/images/avatar.gif","hash":"2dbc3e2f2d624b2ca1afe6edc2ca17307f1950c8","modified":1719451368831},{"_id":"public/images/apple-touch-icon-next.png","hash":"b972160c147e9bec3a0f7432e6e80dfa92581b0b","modified":1719451368831},{"_id":"public/images/cc-by-nc-nd.svg","hash":"0b9f570195e442174075793d9f8f20d6fbe2bb53","modified":1719451368831},{"_id":"public/images/cc-by-nc-sa.svg","hash":"e7c88caa870024e1aec9f9d68bb1049ecd1224ce","modified":1719451368831},{"_id":"public/images/cc-by-nc.svg","hash":"cfc37914ccd351934f48e5d62f6536be1e08e0c4","modified":1719451368831},{"_id":"public/images/cc-by-nd.svg","hash":"3337dde904ac515c8344823dfb57945219a3ee16","modified":1719451368832},{"_id":"public/images/cc-by.svg","hash":"da3444198fa9f906c20d10469252ef05802817c6","modified":1719451368832},{"_id":"public/images/logo.svg","hash":"d02fedf124aa26d4def2631bbccafa053653abd6","modified":1719451368832},{"_id":"public/images/favicon-32x32-next.png","hash":"f88e49404e4c2a326e51ae65ea5b2375b5d5fde8","modified":1719451368832},{"_id":"public/images/cc-zero.svg","hash":"dc4d120989ebb48b136ecd0fa931245f7a09c274","modified":1719451368832},{"_id":"public/images/cc-by-sa.svg","hash":"a55cfa202c7cc2100435fe0b04ec2099eb73c867","modified":1719451368832},{"_id":"public/images/favicon-16x16-next.png","hash":"5ee510e58b7b9e062a22da28ce1eb35a2f381021","modified":1719451368832},{"_id":"public/images/payment.png","hash":"03f7ba625a076a8045611dc7ef8396f85de0e093","modified":1719451368832},{"_id":"public/search.xml","hash":"4003a07dc9d6f05e2d2dd2e6977be2d5b683883f","modified":1719451368832},{"_id":"public/404/index.html","hash":"ad7db3c50a933230f97044ed65529bfcf762e09b","modified":1719451368836},{"_id":"public/categories/index.html","hash":"83237bc568a8c8cc7766c376cee6cc2bd7920753","modified":1719451368836},{"_id":"public/tags/index.html","hash":"5f80c544397d424bf5c191670ff08f8dca1f0f59","modified":1719451368836},{"_id":"public/about/index.html","hash":"34bc72289fba6c92d6615765445b90d7c26195a7","modified":1719451368836},{"_id":"public/2023/03/15/Nginx-反代-go-module/index.html","hash":"98abbe61ed812ced8d2942a6aaaca9e134f3dcb1","modified":1719451368836},{"_id":"public/2021/09/22/git-commit-message-standard/index.html","hash":"4804c67b44470c5d47ecd23d140fdc8710aced63","modified":1719451368836},{"_id":"public/2019/09/16/解决Macbook-usb断连问题/index.html","hash":"6840dc797aceb98d2dafc39efed63770e3cd55e0","modified":1719451368836},{"_id":"public/2018/11/26/ssh隧道转发/index.html","hash":"68bbe88d6e391e89b3daf2e2ce491c6e0fba4df2","modified":1719451368836},{"_id":"public/2018/08/23/certbot更新证书/index.html","hash":"af7ea2f4ff83da7db0c4f7eaf37a92a6a8d56a10","modified":1719451368836},{"_id":"public/2018/09/07/Welcome-Home-Sanitarium/index.html","hash":"e696ed1e2497e17eac7ca31671587d00c8edfec1","modified":1719451368836},{"_id":"public/2018/05/30/Nginx-FPM配置/index.html","hash":"20348456dec53acbf202880e7a561bdc34b99b4c","modified":1719451368837},{"_id":"public/2018/05/03/Happy-Birthday/index.html","hash":"e0ccb1e904dfdb9b767ab0a9490884237dec79ff","modified":1719451368837},{"_id":"public/2018/04/16/The-Unforgiven-II/index.html","hash":"0241cecf2f7961a2465fe7e18fc9fe610223de36","modified":1719451368837},{"_id":"public/2018/02/24/快速获取当前内网IP的命令/index.html","hash":"f8b39ab5ddb4530a6b9a0a1aacdf2edc7ff0bd47","modified":1719451368837},{"_id":"public/2018/01/17/让-`git-status`-命令正确显示中文/index.html","hash":"951bdf5ac3ece99acc906706ac475dec06ebddba","modified":1719451368837},{"_id":"public/2017/12/16/Merry-Christmas-Soon/index.html","hash":"df09cbc0a721ad8ab58fbcdfaf66c536c633ffe5","modified":1719451368837},{"_id":"public/2017/11/11/Golang中的时间符号规律/index.html","hash":"437d5daaca2279cfc1198d5ef67e26570b26cae0","modified":1719451368837},{"_id":"public/2017/10/09/Mac版搜狗输入法自动英文添加spotlight-app/index.html","hash":"db18337cb653652dcbfe3481a93664af0e78d252","modified":1719451368837},{"_id":"public/archives/page/2/index.html","hash":"42f4221c44e5f97e7606b5a0a4b0f2078e4793b2","modified":1719451368837},{"_id":"public/archives/index.html","hash":"3d8c65cb9fc00329365dd57bf8de23726a14081f","modified":1719451368837},{"_id":"public/archives/page/3/index.html","hash":"31b864fe15ebc18818f01dce7cfc1f02e108ea5b","modified":1719451368837},{"_id":"public/archives/2017/index.html","hash":"6f1a0ffe69be0178dad31efe7372cff710c170ac","modified":1719451368837},{"_id":"public/archives/page/4/index.html","hash":"600f1f14d5b0c2e35c6c46ccee8c9d57f039e6ca","modified":1719451368837},{"_id":"public/archives/2017/10/index.html","hash":"d5fb73d9d30c5e15b48ee8b22d1fbd3eb7858389","modified":1719451368837},{"_id":"public/archives/2017/11/index.html","hash":"ddc449ed846b543e6c5a912976eb8f47a65b20b7","modified":1719451368838},{"_id":"public/archives/2017/12/index.html","hash":"eb8689020ec6029fd7f31ff8036dd629f7d6efad","modified":1719451368838},{"_id":"public/archives/2018/index.html","hash":"a558247e9ca2b793ffabdb2aa34c40029042f60a","modified":1719451368838},{"_id":"public/archives/2018/page/2/index.html","hash":"c1adc65e61ede52a0de7543f59360ad33798de42","modified":1719451368838},{"_id":"public/archives/2018/01/index.html","hash":"7831c227d7a8af2758f3e9d154d6dc0baf5027f5","modified":1719451368838},{"_id":"public/archives/2018/02/index.html","hash":"9f22c8a9618d4e1f5482246a9fbf628908d2707d","modified":1719451368838},{"_id":"public/archives/2018/04/index.html","hash":"25c6fe7d7555777376f06f3b396fe836ed5d1df4","modified":1719451368838},{"_id":"public/archives/2018/05/index.html","hash":"b4470f837f28371ce531b5a56f7588debe2a8951","modified":1719451368838},{"_id":"public/archives/2018/08/index.html","hash":"60897cc7ea14087a514ca7c3689f41e734d21d72","modified":1719451368838},{"_id":"public/archives/2018/09/index.html","hash":"2b7dcddb6c07d08f1d7214f9ae7a3619a6b47cba","modified":1719451368838},{"_id":"public/archives/2018/11/index.html","hash":"8bbee87595ac45c2c53c2509bad06c94d46c3bad","modified":1719451368838},{"_id":"public/archives/2019/index.html","hash":"aa133567bbea6f5ae7a94aa31fb75791e8ca7193","modified":1719451368838},{"_id":"public/archives/2019/01/index.html","hash":"95ddb6560c9315420cf7bc6f8327b7f6e25b9302","modified":1719451368838},{"_id":"public/archives/2019/04/index.html","hash":"369861e44172ace53bb04180bdc90e41f0c83e8c","modified":1719451368838},{"_id":"public/archives/2019/05/index.html","hash":"8d4ad579953d9c6d73479013b5c9b791938d083a","modified":1719451368838},{"_id":"public/archives/2019/06/index.html","hash":"2516c710a8fa0962981403f4cd470d8c6fe3374f","modified":1719451368838},{"_id":"public/archives/2019/07/index.html","hash":"9d24ceab5e8cea9514faf28e4e20f87225fe4105","modified":1719451368838},{"_id":"public/archives/2020/index.html","hash":"10e8b51ff691e5a5f01ea26c4cba95f490b1eab2","modified":1719451368838},{"_id":"public/archives/2019/09/index.html","hash":"5d081805cc1dc3d6025ff79476b3c7294ffdcf97","modified":1719451368838},{"_id":"public/archives/2020/08/index.html","hash":"2d28fcfeec2c124b31f92d34fdae88cc4bef3345","modified":1719451368838},{"_id":"public/archives/2021/index.html","hash":"eddf2381d4ffddc8986f9a3a5382acdd66ac9a0a","modified":1719451368838},{"_id":"public/archives/2021/01/index.html","hash":"414d0e0db4c74ba5f03afe3554efc6029a3f110a","modified":1719451368838},{"_id":"public/archives/2021/04/index.html","hash":"8042a7b705f6e955e54bc4c9c9e18d1106f90c87","modified":1719451368839},{"_id":"public/archives/2021/09/index.html","hash":"2c3ef21ed511ea075e2b4b9c0ddec73ff0949499","modified":1719451368840},{"_id":"public/archives/2021/12/index.html","hash":"2ae6930d26de07eeb5b9c57744588d8f8029a915","modified":1719451368840},{"_id":"public/archives/2021/10/index.html","hash":"da7d327f958bb2720eedab75ef141858e43eae48","modified":1719451368840},{"_id":"public/archives/2022/index.html","hash":"b9218e30eb2394ac612740e75991b748cf19a1e0","modified":1719451368840},{"_id":"public/archives/2022/11/index.html","hash":"eadffff416325d21ec8ac2b36734edc0e130b0b0","modified":1719451368840},{"_id":"public/archives/2023/index.html","hash":"70f1ba24e7b649a60c3073d43a65538482d0fd4a","modified":1719451368840},{"_id":"public/archives/2023/03/index.html","hash":"32e4d002edcdf4a0ddd7b3b454ebf33c94f829ba","modified":1719451368841},{"_id":"public/categories/笔记/index.html","hash":"5f9f2d29dc7329477685490dd5eb40342cc40c22","modified":1719451368841},{"_id":"public/categories/笔记/page/2/index.html","hash":"e837f48e9fc8189c4f45a35fb426c440320f0add","modified":1719451368841},{"_id":"public/categories/笔记/page/3/index.html","hash":"11b9530220c207021eeda3e146c900b4dbcdc7b5","modified":1719451368841},{"_id":"public/categories/笔记/page/4/index.html","hash":"9b7b299341b3b879f6c341ba8c5a7b3c06917d9c","modified":1719451368841},{"_id":"public/categories/感情/index.html","hash":"7dc4c8039a2952fbcd4575a6c7248b06f18ea3ac","modified":1719451368841},{"_id":"public/categories/随笔/index.html","hash":"0c81972b65a3f9a402b1cf2dc0a287fe7d0d0531","modified":1719451368841},{"_id":"public/categories/翻译/index.html","hash":"d322a901b6cef98729c4b45ec70cec14228376a9","modified":1719451368841},{"_id":"public/tags/mac/index.html","hash":"599de1c2b9096707e35b2125ea30c89a4bdcd601","modified":1719451368841},{"_id":"public/tags/docker/index.html","hash":"98722e6c50e68d1fda0380744b5b493f6dff85ac","modified":1719451368841},{"_id":"public/tags/shadowsocks/index.html","hash":"a5ea79b276a3a0a3b56b7db8af82625dcfc6c450","modified":1719451368841},{"_id":"public/tags/ubuntu/index.html","hash":"8ca7f80ac3457a8345bbd93856dc8ce702cf13f1","modified":1719451368841},{"_id":"public/tags/golang/index.html","hash":"f290a6baad13d6282cd56e90ebdb8edf3343c076","modified":1719451368841},{"_id":"public/tags/android/index.html","hash":"34918d57f6db54e55229d64f07c09f19bc80c071","modified":1719451368841},{"_id":"public/tags/gRPC/index.html","hash":"8703cd2f15232bca4d2f41015f82d56d57db9230","modified":1719451368841},{"_id":"public/tags/router/index.html","hash":"00e93104f32f9e221487592c4ace7bedb0fe083a","modified":1719451368841},{"_id":"public/tags/merlin/index.html","hash":"591dca9fe98c14d5965dadb65ae68800147de5bc","modified":1719451368841},{"_id":"public/tags/php/index.html","hash":"372d23aa4faa70b05012c1854d5ab636e6972afb","modified":1719451368841},{"_id":"public/tags/shell/index.html","hash":"a85b98284ef47724ccfe11a90e142aff416de363","modified":1719451368841},{"_id":"public/tags/linux/index.html","hash":"3bf83bcb341fbef3e5d739f32879720a7f638db7","modified":1719451368841},{"_id":"public/tags/laravel-lumen/index.html","hash":"79d045dfae9cf7cd152bff28e4af39d0282783ff","modified":1719451368841},{"_id":"public/tags/git/index.html","hash":"8d02c006c6d0741de26a019297db93d5f69f2150","modified":1719451368841},{"_id":"public/tags/Metallica/index.html","hash":"09af3bd1c75673180e26c3410c584ccd55eca88d","modified":1719451368841},{"_id":"public/tags/nginx/index.html","hash":"14b1a5a7c3611cd19ea9e941cd4c51c2e0ce83c1","modified":1719451368841},{"_id":"public/tags/fpm/index.html","hash":"a78d6d2685fa31fbd8f85cf6ba0488f887a16d33","modified":1719451368842},{"_id":"public/tags/https/index.html","hash":"385528a481d6937ecfc3403b43e5a649b95768f9","modified":1719451368842},{"_id":"public/tags/mysql/index.html","hash":"fe3cde7e522d0128bfa4bf958c82e3620f0d7930","modified":1719451368842},{"_id":"public/tags/NAS/index.html","hash":"16010effe8ef061c016fcff127326652d4bb06c4","modified":1719451368842},{"_id":"public/tags/群晖/index.html","hash":"f1ebc48642cba7e5170e8f0db095c2643441a30c","modified":1719451368842},{"_id":"public/tags/jailbreak/index.html","hash":"c551734a5bc86fb1a5ca1ece7f27c1f4cea2ed64","modified":1719451368842},{"_id":"public/tags/innodb/index.html","hash":"f56fd13f21e411d0e7e55ffc349672ff0ff36102","modified":1719451368842},{"_id":"public/tags/ssh/index.html","hash":"f5127c8150718a42f7bf8541d479dff17e6fc8e5","modified":1719451368842},{"_id":"public/tags/lock/index.html","hash":"21e4e74d3a57543290fbf679d9c2a245d63a6412","modified":1719451368842},{"_id":"public/tags/index/index.html","hash":"951219d1183a786e4bc8679d69c34ab637dfd458","modified":1719451368842},{"_id":"public/tags/database/index.html","hash":"597dd715b6ef28ad76ea43229156315efec8cc64","modified":1719451368842},{"_id":"public/tags/gc/index.html","hash":"d9d38dcebed7886fa1d1ffad462ce2b78325895d","modified":1719451368842},{"_id":"public/tags/CI/index.html","hash":"57090390abd6d1400436da72ad4f1822643f65fa","modified":1719451368842},{"_id":"public/tags/transaction/index.html","hash":"0628e05f5c07ea58e6a791a4399cb51e4eafdad6","modified":1719451368842},{"_id":"public/tags/Drone/index.html","hash":"01b98e463802ad2df256900abfea9675a8e3252b","modified":1719451368843},{"_id":"public/tags/Jenkins/index.html","hash":"d43cb1b4b1113e1822470cee5880d24d094ae66d","modified":1719451368843},{"_id":"public/tags/Github-Actions/index.html","hash":"125d48199443dabeedb9ab24e6b02440d94abf9d","modified":1719451368843},{"_id":"public/2022/11/10/disable-mds-stores/index.html","hash":"34a0fd70f6ff52a2ab97b7dd1060f3cc9895e1e3","modified":1719451368843},{"_id":"public/2021/12/07/Homebrew-安装-disabled-formula/index.html","hash":"be8f513055a129267de05992df36f3ce6e210db3","modified":1719451368843},{"_id":"public/2021/10/18/温故-base64-编码/index.html","hash":"7e8d111e8b3d82566de74c1bc4a0916fe1de1ab8","modified":1719451368843},{"_id":"public/2021/10/09/Jenkins-多分支-pipeline-配置/index.html","hash":"dab43daa31dca358a0c6ad28b2574cd172a4545f","modified":1719451368843},{"_id":"public/2021/10/09/利用-Github-Action-部署博客/index.html","hash":"dd48d230cec417637d8b80668ab9e1438a20a5f1","modified":1719451368843},{"_id":"public/2021/09/24/Docker-部署-JIRA/index.html","hash":"d1d051a7e68915c50b1b74a2132c295a90a9abbb","modified":1719451368843},{"_id":"public/2021/09/15/Go-Blog-翻译-Fuzzing-is-Beta-Ready/index.html","hash":"38a8a06b7dd1ee7945f5bc350e09d5fff823b80d","modified":1719451368843},{"_id":"public/2021/04/21/Go-Blog-翻译-Context-and-Structs/index.html","hash":"9da19790d3ffa372d25f929a376352b54ce73862","modified":1719451368843},{"_id":"public/2021/01/11/REGRETS-OF-THE-DYING/index.html","hash":"0469a1f400adbfcdd64b646e40767d903bd34880","modified":1719451368843},{"_id":"public/2019/07/11/PHP-GC/index.html","hash":"616da4e337e79c816b495f41b6e76e0ab3df57fa","modified":1719451368843},{"_id":"public/2019/07/04/MySQL-数据库-InnoDB-学习笔记/index.html","hash":"86b9010cefc86d9a15cd4df80a2fcc7ab42f1163","modified":1719451368843},{"_id":"public/2020/08/17/理解-Golang-中的-nil-判断/index.html","hash":"d7b4302dae1acf5d553c1aa529ea3e8933bcec5a","modified":1719451368843},{"_id":"public/2019/06/27/Drone-1.0-简单实践/index.html","hash":"de6ed0ae204033099db267530dd7a0938c242d69","modified":1719451368843},{"_id":"public/2019/05/21/iPhoneXS-jailbreak/index.html","hash":"8e91a306e2463f3f867693e6439dacaaa7a6758f","modified":1719451368843},{"_id":"public/2019/04/01/记一次群晖-SHR-降级折腾/index.html","hash":"651e3904d6aea3df1791fefc80cf053ccb506290","modified":1719451368843},{"_id":"public/2019/01/09/Mysql函数运用/index.html","hash":"da086d485c562b791753da946b905c0ff5811065","modified":1719451368843},{"_id":"public/2018/04/25/搭建简单的nginx文件服务/index.html","hash":"efe7438b3fbc7135b9cbfbd181328eb3adec0af9","modified":1719451368843},{"_id":"public/2018/02/28/Golang中slice的一些helper/index.html","hash":"7852d8b9bb5c135c18efbe3cf7ce2e98cd7724fd","modified":1719451368843},{"_id":"public/2018/01/18/Golang并发编程最简单实践/index.html","hash":"ea5bf626e9c78c32aac467c0b003c38c59486e12","modified":1719451368843},{"_id":"public/2018/01/17/使用ide-helper提升PHPstorm开发laravel-lumen项目体验/index.html","hash":"14505d996a5e745bed82fe519b08b85b0871246e","modified":1719451368843},{"_id":"public/2018/01/03/关于装修的感悟/index.html","hash":"7cf4959830cbe8e847a9e65f8227dcbf8bd3275c","modified":1719451368843},{"_id":"public/2017/12/27/Golang-reflect-实践/index.html","hash":"9a9bede9e94d95fff13ae9bdf56b3fd79beb7064","modified":1719451368843},{"_id":"public/2017/12/19/初识gRPC/index.html","hash":"db4dac277cdb6d52790f5812e281febd0eb31b8b","modified":1719451368843},{"_id":"public/2017/11/11/Mac下使用adb将本地文件拷贝到安卓手机/index.html","hash":"32de49dfd5f55b88c1bf97a8160cfcff2748f127","modified":1719451368843},{"_id":"public/2017/10/12/Install-Shadowsocks-server-on-ubuntu/index.html","hash":"3564f00bc6edb85dd2e365dd59fd6d0c0be7e26c","modified":1719451368843},{"_id":"public/2017/10/09/梅林单线复用internet+IPTV/index.html","hash":"33735ac936606ca710d2384d7b31b5af2e91e166","modified":1719451368843},{"_id":"public/index.html","hash":"2f9d7d01ba8f9c8140470aa5a6597b3313991212","modified":1719451368843},{"_id":"public/page/2/index.html","hash":"9965430c5b7e8e2d28b89f97bd533f1b011bb68a","modified":1719451368843},{"_id":"public/page/3/index.html","hash":"ea2ed6a3ea14b47a16de811e12d79fc64f0fc79a","modified":1719451368843},{"_id":"public/page/4/index.html","hash":"738e53fd74bf6293845407896860d5af47f586ba","modified":1719451368843},{"_id":"public/CNAME","hash":"9bf9d6a94f5130a08c9cde6d849976fc5b4ac22b","modified":1719451368847},{"_id":"public/lib/font-awesome/webfonts/fa-regular-400.woff2","hash":"260bb01acd44d88dcb7f501a238ab968f86bef9e","modified":1719451368847},{"_id":"public/lib/font-awesome/webfonts/fa-brands-400.woff2","hash":"509988477da79c146cb93fb728405f18e923c2de","modified":1719451369586},{"_id":"public/lib/font-awesome/webfonts/fa-solid-900.woff2","hash":"75a88815c47a249eadb5f0edc1675957f860cca7","modified":1719451369586},{"_id":"public/js/next-boot.js","hash":"cd19d9db10d317596b4914b165f9f8f401203fcc","modified":1719451369592},{"_id":"public/js/local-search.js","hash":"d21d56f7d5bd0a02c3cf6b129abb8dcf3f1cee2d","modified":1719451369592},{"_id":"public/js/motion.js","hash":"2a77193621b34f003abec846ff1d6caa3f80df67","modified":1719451369592},{"_id":"public/js/schemes/pisces.js","hash":"8d01e8226a80d4d22ee81577bcdb4cf3938fc8a5","modified":1719451369593},{"_id":"public/js/utils.js","hash":"a3fc8f7c00d5db1199a305911689e8a5972432f6","modified":1719451369593},{"_id":"public/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1719451369593},{"_id":"public/lib/anime.min.js","hash":"47cb482a8a488620a793d50ba8f6752324b46af3","modified":1719451369593},{"_id":"public/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1719451369593},{"_id":"public/css/main.css","hash":"84ac1331414837bcf2635cfa2d88427202a46954","modified":1719451369593},{"_id":"public/lib/font-awesome/css/all.min.css","hash":"0038dc97c79451578b7bd48af60ba62282b4082b","modified":1719451369593},{"_id":"public/fonts/UbuntuMono-R.ttf","hash":"f4bfd74c2d10ea57abe1f7fa23f303e6875774ab","modified":1719451369599}],"Category":[{"name":"笔记","_id":"clxwky1kq0016iubfclvinora"},{"name":"感情","_id":"clxwky1l6001eiubfhu5a052e"},{"name":"随笔","_id":"clxwky1l8001oiubfgiyug2f3"},{"name":"翻译","_id":"clxwky1lb0020iubf7w90i4i6"}],"Data":[],"Page":[{"title":"404","date":"2022-02-09T03:54:03.000Z","comments":0,"_content":"\n404 了...\n","source":"404/index.md","raw":"---\ntitle: 404\ndate: 2022-02-09 11:54:03\ncomments: false\n---\n\n404 了...\n","updated":"2023-05-28T05:36:04.284Z","path":"404/index.html","layout":"page","_id":"clxwky1ip0000iubfv510jm1j","content":"<p>404 了...</p>","site":{"data":{}},"excerpt":"","more":"<p>404 了...</p>"},{"title":"分类","date":"2017-12-16T10:58:25.000Z","type":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ntitle: 分类\ndate: 2017-12-16 18:58:25\ntype: \"categories\"\ncomments: false\n---\n","updated":"2023-05-28T05:36:04.287Z","path":"categories/index.html","layout":"page","_id":"clxwky1iu0002iubful8vka7d","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"标签","date":"2017-12-16T10:56:27.000Z","type":"tags","comments":0,"_content":"","source":"tags/index.md","raw":"---\ntitle: 标签\ndate: 2017-12-16 18:56:27\ntype: \"tags\"\ncomments: false\n---\n","updated":"2023-05-28T05:36:04.290Z","path":"tags/index.html","layout":"page","_id":"clxwky1l00018iubf86o2d7hq","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"╮(￣▽￣)╭","date":"2017-12-16T12:41:12.000Z","type":"about","comment":false,"_content":"<blockquote class=\"blockquote-center\">\n”魔镜魔镜，告诉我谁是世界上最美丽的女人？“\n\n”当然是Mix！(╯‵□′)╯︵┻━┻“\n</blockquote>\n","source":"about/index.md","raw":"---\ntitle: ╮(￣▽￣)╭\ndate: 2017-12-16 20:41:12\ntype: \"about\"\ncomment: false\n---\n<blockquote class=\"blockquote-center\">\n”魔镜魔镜，告诉我谁是世界上最美丽的女人？“\n\n”当然是Mix！(╯‵□′)╯︵┻━┻“\n</blockquote>\n","updated":"2023-05-28T05:36:04.287Z","path":"about/index.html","comments":1,"layout":"page","_id":"clxwky1l20019iubf00d6vzif","content":"<blockquote class=\"blockquote-center\">”魔镜魔镜，告诉我谁是世界上最美丽的女人？“ ”当然是Mix！(╯‵□′)╯︵┻━┻“</blockquote>","site":{"data":{}},"excerpt":"","more":"<blockquote class=\"blockquote-center\">”魔镜魔镜，告诉我谁是世界上最美丽的女人？“ ”当然是Mix！(╯‵□′)╯︵┻━┻“</blockquote>"}],"Post":[{"title":"Mac版搜狗输入法自动英文添加spotlight.app","date":"2017-10-09T07:37:30.000Z","_content":"主要的问题在于不知道 `spotlight.app` 的位置，后来找到了，一些系统级的APP都在 `/System/Library/CoreServices/` 路径下，找到后添加即可。\n","source":"_posts/2017-10-09-Mac版搜狗输入法自动英文添加spotlight-app.md","raw":"---\ntitle: Mac版搜狗输入法自动英文添加spotlight.app\ndate: 2017-10-09 15:37:30\ncategories:\n- 笔记\ntags:\n- mac\n---\n主要的问题在于不知道 `spotlight.app` 的位置，后来找到了，一些系统级的APP都在 `/System/Library/CoreServices/` 路径下，找到后添加即可。\n","slug":"Mac版搜狗输入法自动英文添加spotlight-app","published":1,"updated":"2023-05-28T05:36:04.284Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1iq0001iubf74k18g94","content":"<p>主要的问题在于不知道 <code>spotlight.app</code> 的位置，后来找到了，一些系统级的APP都在 <code>/System/Library/CoreServices/</code> 路径下，找到后添加即可。</p>","site":{"data":{}},"excerpt":"","more":"<p>主要的问题在于不知道 <code>spotlight.app</code> 的位置，后来找到了，一些系统级的APP都在 <code>/System/Library/CoreServices/</code> 路径下，找到后添加即可。</p>"},{"title":"Install Shadowsocks server on ubuntu","date":"2017-10-12T08:07:42.000Z","_content":"这里有两种方式:\n\n# Docker 方式\n\n推荐一个docker镜像 [`mritd/shadowsocks`](https://hub.docker.com/r/mritd/shadowsocks/)\n\n下面是`docker-compose.yml`\n\n```yml\nversion: '3'\n\nservices:\n  ssclient:\n    image: mritd/shadowsocks:latest\n    container_name: ssclient\n    ports:\n      - 1080:1080\n    #\n    # 用作client\n    #\n    # command: -m \"ss-local\" -s \"-s 12.34.56.78 -p 8388 -m rc4-md5 -k password -b 0.0.0.0 -l 1080 --fast-open\"\n    #\n    # 用作server\n    #\n    command: -m \"ss-server\" -s \"-s 0.0.0.0 -p 8388 -m aes-256-cfb -k password --fast-open\"\n```\n\n<!-- more -->\n\n# 传统安装方式\n\n## Installation\n\n```sh\n$ sudo apt-get update\n$ sudo apt-get upgrade -y\n$ sudo apt-get install python-gevent python-pip python-m2crypto python-wheel python-setuptools\n$ sudo pip install shadowsocks\n```\n\n## Config and Start the service\n\nconfig file `ss.json`:\n\n```javascript\n{\n    \"server\": \"0.0.0.0\",\n    \"server_port\": 8388,\n    \"local_address\": \"127.0.0.1\",\n    \"local_port\": 1080,\n    \"password\": \"my_password\",\n    \"timeout\": 300,\n    \"method\": \"rc4-md5\",\n    \"fast_open\": true\n}\n```\n\nstart:\n\n```sh\n$ sudo ssserver -c ss.json -d start # run as daemon\n```\n","source":"_posts/2017-10-12-Install-Shadowsocks-server-on-ubuntu.md","raw":"---\ntitle: Install Shadowsocks server on ubuntu\ndate: 2017-10-12 16:07:42\ntags:\n- docker\n- shadowsocks\n- ubuntu\ncategories:\n- 笔记\n---\n这里有两种方式:\n\n# Docker 方式\n\n推荐一个docker镜像 [`mritd/shadowsocks`](https://hub.docker.com/r/mritd/shadowsocks/)\n\n下面是`docker-compose.yml`\n\n```yml\nversion: '3'\n\nservices:\n  ssclient:\n    image: mritd/shadowsocks:latest\n    container_name: ssclient\n    ports:\n      - 1080:1080\n    #\n    # 用作client\n    #\n    # command: -m \"ss-local\" -s \"-s 12.34.56.78 -p 8388 -m rc4-md5 -k password -b 0.0.0.0 -l 1080 --fast-open\"\n    #\n    # 用作server\n    #\n    command: -m \"ss-server\" -s \"-s 0.0.0.0 -p 8388 -m aes-256-cfb -k password --fast-open\"\n```\n\n<!-- more -->\n\n# 传统安装方式\n\n## Installation\n\n```sh\n$ sudo apt-get update\n$ sudo apt-get upgrade -y\n$ sudo apt-get install python-gevent python-pip python-m2crypto python-wheel python-setuptools\n$ sudo pip install shadowsocks\n```\n\n## Config and Start the service\n\nconfig file `ss.json`:\n\n```javascript\n{\n    \"server\": \"0.0.0.0\",\n    \"server_port\": 8388,\n    \"local_address\": \"127.0.0.1\",\n    \"local_port\": 1080,\n    \"password\": \"my_password\",\n    \"timeout\": 300,\n    \"method\": \"rc4-md5\",\n    \"fast_open\": true\n}\n```\n\nstart:\n\n```sh\n$ sudo ssserver -c ss.json -d start # run as daemon\n```\n","slug":"Install-Shadowsocks-server-on-ubuntu","published":1,"updated":"2023-05-28T05:36:04.284Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1iv0003iubf1pu7ppy3","content":"<p>这里有两种方式:</p><h1 id=\"Docker-方式\"><a href=\"#Docker-方式\" class=\"headerlink\" title=\"Docker 方式\"></a>Docker 方式</h1><p>推荐一个docker镜像 <a href=\"https://hub.docker.com/r/mritd/shadowsocks/\" target=\"_blank\" rel=\"noopener\"><code>mritd/shadowsocks</code></a></p><p>下面是<code>docker-compose.yml</code></p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">'3'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  ssclient:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">mritd/shadowsocks:latest</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">ssclient</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">1080</span><span class=\"string\">:1080</span></span><br><span class=\"line\">    <span class=\"comment\">#</span></span><br><span class=\"line\">    <span class=\"comment\"># 用作client</span></span><br><span class=\"line\">    <span class=\"comment\">#</span></span><br><span class=\"line\">    <span class=\"comment\"># command: -m \"ss-local\" -s \"-s 12.34.56.78 -p 8388 -m rc4-md5 -k password -b 0.0.0.0 -l 1080 --fast-open\"</span></span><br><span class=\"line\">    <span class=\"comment\">#</span></span><br><span class=\"line\">    <span class=\"comment\"># 用作server</span></span><br><span class=\"line\">    <span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"attr\">    command:</span> <span class=\"bullet\">-m</span> <span class=\"string\">\"ss-server\"</span> <span class=\"bullet\">-s</span> <span class=\"string\">\"-s 0.0.0.0 -p 8388 -m aes-256-cfb -k password --fast-open\"</span></span><br></pre></td></tr></table></figure><a id=\"more\"></a><h1 id=\"传统安装方式\"><a href=\"#传统安装方式\" class=\"headerlink\" title=\"传统安装方式\"></a>传统安装方式</h1><h2 id=\"Installation\"><a href=\"#Installation\" class=\"headerlink\" title=\"Installation\"></a>Installation</h2><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo apt-get update</span><br><span class=\"line\">$ sudo apt-get upgrade -y</span><br><span class=\"line\">$ sudo apt-get install python-gevent python-pip python-m2crypto python-wheel python-setuptools</span><br><span class=\"line\">$ sudo pip install shadowsocks</span><br></pre></td></tr></table></figure><h2 id=\"Config-and-Start-the-service\"><a href=\"#Config-and-Start-the-service\" class=\"headerlink\" title=\"Config and Start the service\"></a>Config and Start the service</h2><p>config file <code>ss.json</code>:</p><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">\"server\"</span>: <span class=\"string\">\"0.0.0.0\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"server_port\"</span>: <span class=\"number\">8388</span>,</span><br><span class=\"line\">    <span class=\"string\">\"local_address\"</span>: <span class=\"string\">\"127.0.0.1\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"local_port\"</span>: <span class=\"number\">1080</span>,</span><br><span class=\"line\">    <span class=\"string\">\"password\"</span>: <span class=\"string\">\"my_password\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"timeout\"</span>: <span class=\"number\">300</span>,</span><br><span class=\"line\">    <span class=\"string\">\"method\"</span>: <span class=\"string\">\"rc4-md5\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"fast_open\"</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>start:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo ssserver -c ss.json -d start <span class=\"comment\"># run as daemon</span></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"<p>这里有两种方式:</p><h1 id=\"Docker-方式\"><a href=\"#Docker-方式\" class=\"headerlink\" title=\"Docker 方式\"></a>Docker 方式</h1><p>推荐一个docker镜像 <a href=\"https://hub.docker.com/r/mritd/shadowsocks/\" target=\"_blank\" rel=\"noopener\"><code>mritd/shadowsocks</code></a></p><p>下面是<code>docker-compose.yml</code></p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">'3'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  ssclient:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">mritd/shadowsocks:latest</span></span><br><span class=\"line\"><span class=\"attr\">    container_name:</span> <span class=\"string\">ssclient</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">1080</span><span class=\"string\">:1080</span></span><br><span class=\"line\">    <span class=\"comment\">#</span></span><br><span class=\"line\">    <span class=\"comment\"># 用作client</span></span><br><span class=\"line\">    <span class=\"comment\">#</span></span><br><span class=\"line\">    <span class=\"comment\"># command: -m \"ss-local\" -s \"-s 12.34.56.78 -p 8388 -m rc4-md5 -k password -b 0.0.0.0 -l 1080 --fast-open\"</span></span><br><span class=\"line\">    <span class=\"comment\">#</span></span><br><span class=\"line\">    <span class=\"comment\"># 用作server</span></span><br><span class=\"line\">    <span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"attr\">    command:</span> <span class=\"bullet\">-m</span> <span class=\"string\">\"ss-server\"</span> <span class=\"bullet\">-s</span> <span class=\"string\">\"-s 0.0.0.0 -p 8388 -m aes-256-cfb -k password --fast-open\"</span></span><br></pre></td></tr></table></figure>","more":"<h1 id=\"传统安装方式\"><a href=\"#传统安装方式\" class=\"headerlink\" title=\"传统安装方式\"></a>传统安装方式</h1><h2 id=\"Installation\"><a href=\"#Installation\" class=\"headerlink\" title=\"Installation\"></a>Installation</h2><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo apt-get update</span><br><span class=\"line\">$ sudo apt-get upgrade -y</span><br><span class=\"line\">$ sudo apt-get install python-gevent python-pip python-m2crypto python-wheel python-setuptools</span><br><span class=\"line\">$ sudo pip install shadowsocks</span><br></pre></td></tr></table></figure><h2 id=\"Config-and-Start-the-service\"><a href=\"#Config-and-Start-the-service\" class=\"headerlink\" title=\"Config and Start the service\"></a>Config and Start the service</h2><p>config file <code>ss.json</code>:</p><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">\"server\"</span>: <span class=\"string\">\"0.0.0.0\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"server_port\"</span>: <span class=\"number\">8388</span>,</span><br><span class=\"line\">    <span class=\"string\">\"local_address\"</span>: <span class=\"string\">\"127.0.0.1\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"local_port\"</span>: <span class=\"number\">1080</span>,</span><br><span class=\"line\">    <span class=\"string\">\"password\"</span>: <span class=\"string\">\"my_password\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"timeout\"</span>: <span class=\"number\">300</span>,</span><br><span class=\"line\">    <span class=\"string\">\"method\"</span>: <span class=\"string\">\"rc4-md5\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"fast_open\"</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>start:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo ssserver -c ss.json -d start <span class=\"comment\"># run as daemon</span></span><br></pre></td></tr></table></figure>"},{"title":"Golang中的时间符号规律","date":"2017-11-11T07:43:14.000Z","_content":"# Origin of “Mon Jan 2 15:04:05 MST 2006” in golang\n\nIt is just the numbers 1 2 3 4 5 6 7\n\n1: month (January, Jan, 01, etc)\n\n2: day\n\n3: hour (15 is 3pm on a 24 hour clock)\n\n4: minute\n\n5: second\n\n6: year (2006)\n\n7: timezone (GMT-7 is MST)\n\n😆 😆 😆\n","source":"_posts/2017-11-11-Golang中的时间符号规律.md","raw":"---\ntitle: Golang中的时间符号规律\ndate: 2017-11-11 15:43:14\ncategories:\n- 笔记\ntags:\n- golang\n---\n# Origin of “Mon Jan 2 15:04:05 MST 2006” in golang\n\nIt is just the numbers 1 2 3 4 5 6 7\n\n1: month (January, Jan, 01, etc)\n\n2: day\n\n3: hour (15 is 3pm on a 24 hour clock)\n\n4: minute\n\n5: second\n\n6: year (2006)\n\n7: timezone (GMT-7 is MST)\n\n😆 😆 😆\n","slug":"Golang中的时间符号规律","published":1,"updated":"2023-05-28T05:36:04.284Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1iw0004iubfz0el5f1b","content":"<h1 id=\"Origin-of-“Mon-Jan-2-15-04-05-MST-2006”-in-golang\"><a href=\"#Origin-of-“Mon-Jan-2-15-04-05-MST-2006”-in-golang\" class=\"headerlink\" title=\"Origin of “Mon Jan 2 15:04:05 MST 2006” in golang\"></a>Origin of “Mon Jan 2 15:04:05 MST 2006” in golang</h1><p>It is just the numbers 1 2 3 4 5 6 7</p><p>1: month (January, Jan, 01, etc)</p><p>2: day</p><p>3: hour (15 is 3pm on a 24 hour clock)</p><p>4: minute</p><p>5: second</p><p>6: year (2006)</p><p>7: timezone (GMT-7 is MST)</p><p>😆 😆 😆</p>","site":{"data":{}},"excerpt":"","more":"<h1 id=\"Origin-of-“Mon-Jan-2-15-04-05-MST-2006”-in-golang\"><a href=\"#Origin-of-“Mon-Jan-2-15-04-05-MST-2006”-in-golang\" class=\"headerlink\" title=\"Origin of “Mon Jan 2 15:04:05 MST 2006” in golang\"></a>Origin of “Mon Jan 2 15:04:05 MST 2006” in golang</h1><p>It is just the numbers 1 2 3 4 5 6 7</p><p>1: month (January, Jan, 01, etc)</p><p>2: day</p><p>3: hour (15 is 3pm on a 24 hour clock)</p><p>4: minute</p><p>5: second</p><p>6: year (2006)</p><p>7: timezone (GMT-7 is MST)</p><p>😆 😆 😆</p>"},{"title":"Merry Christmas Soon","date":"2017-12-16T14:00:00.000Z","_content":"圣诞节马上到了，祝亲爱的Mix圣诞节快乐！一直很心疼你周六还要上班。\n\n昨天你兴高采烈地告诉我，今天你的好闺蜜约你去玩，你很开心。\n看到这样开心的你，我感到幸福无比。\n希望今后的日子里，我们都能够开开心心，有困难我们一起面对，天塌下来，有我顶着。\n路遥远，我们一起走。\n爱你。\n❤️\n","source":"_posts/2017-12-16-Merry-Christmas-Soon.md","raw":"---\ntitle: Merry Christmas Soon\ndate: 2017-12-16 22:00:00\ntags:\ncategories:\n- 感情\n---\n圣诞节马上到了，祝亲爱的Mix圣诞节快乐！一直很心疼你周六还要上班。\n\n昨天你兴高采烈地告诉我，今天你的好闺蜜约你去玩，你很开心。\n看到这样开心的你，我感到幸福无比。\n希望今后的日子里，我们都能够开开心心，有困难我们一起面对，天塌下来，有我顶着。\n路遥远，我们一起走。\n爱你。\n❤️\n","slug":"Merry-Christmas-Soon","published":1,"updated":"2023-05-28T05:36:04.284Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1ix0005iubf9giwjzv1","content":"<p>圣诞节马上到了，祝亲爱的Mix圣诞节快乐！一直很心疼你周六还要上班。</p><p>昨天你兴高采烈地告诉我，今天你的好闺蜜约你去玩，你很开心。 看到这样开心的你，我感到幸福无比。 希望今后的日子里，我们都能够开开心心，有困难我们一起面对，天塌下来，有我顶着。 路遥远，我们一起走。 爱你。 ❤️</p>","site":{"data":{}},"excerpt":"","more":"<p>圣诞节马上到了，祝亲爱的Mix圣诞节快乐！一直很心疼你周六还要上班。</p><p>昨天你兴高采烈地告诉我，今天你的好闺蜜约你去玩，你很开心。 看到这样开心的你，我感到幸福无比。 希望今后的日子里，我们都能够开开心心，有困难我们一起面对，天塌下来，有我顶着。 路遥远，我们一起走。 爱你。 ❤️</p>"},{"title":"Mac下使用adb将本地文件拷贝到安卓手机","date":"2017-11-11T07:25:33.000Z","_content":"# Mac下使用 `adb` 将本地文件拷贝到安卓手机\n\n一直想在Mac上找个好用的图形界面的安卓手机助手类的工具，但是寻寻觅觅，还是没有找到，只好用adb来实现了。\n\n<!-- more -->\n\n## 安装adb\n\n### 使用homebrew快速安装\n\n```sh\n$ brew cask install android-platform-tools\n```\n\n### 验证是否已安装\n\n```sh\n$ which adb\n```\n\n## 使用adb push文件到手机上\n\n### 确保adb识别到了你的手机\n\n**首先需要在手机上打开USB调试**\n\n然后可以在终端执行\n\n```sh\n$ adb devices\n```\n来判断adb是否识别到了你的手机\n\n### 拷贝本地文件到手机上\n\nadb 提供了 `push` 命令，即可复制本地文件到手机上\n\n```sh\n$ adb push file.on.mac.zip /sdcard/path/\n```\n\n## Tips\n\n关于手机上的路径，可以使用 `adb shell` 来进入手机的目录结构，然后可以尝试下 `pwd`\n","source":"_posts/2017-11-11-Mac下使用adb将本地文件拷贝到安卓手机.md","raw":"---\ntitle: Mac下使用adb将本地文件拷贝到安卓手机\ndate: 2017-11-11 15:25:33\ntags:\n- mac\n- android\ncategories:\n- 笔记\n---\n# Mac下使用 `adb` 将本地文件拷贝到安卓手机\n\n一直想在Mac上找个好用的图形界面的安卓手机助手类的工具，但是寻寻觅觅，还是没有找到，只好用adb来实现了。\n\n<!-- more -->\n\n## 安装adb\n\n### 使用homebrew快速安装\n\n```sh\n$ brew cask install android-platform-tools\n```\n\n### 验证是否已安装\n\n```sh\n$ which adb\n```\n\n## 使用adb push文件到手机上\n\n### 确保adb识别到了你的手机\n\n**首先需要在手机上打开USB调试**\n\n然后可以在终端执行\n\n```sh\n$ adb devices\n```\n来判断adb是否识别到了你的手机\n\n### 拷贝本地文件到手机上\n\nadb 提供了 `push` 命令，即可复制本地文件到手机上\n\n```sh\n$ adb push file.on.mac.zip /sdcard/path/\n```\n\n## Tips\n\n关于手机上的路径，可以使用 `adb shell` 来进入手机的目录结构，然后可以尝试下 `pwd`\n","slug":"Mac下使用adb将本地文件拷贝到安卓手机","published":1,"updated":"2023-05-28T05:36:04.284Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1iy0006iubfidqhof8w","content":"<h1 id=\"Mac下使用-adb-将本地文件拷贝到安卓手机\"><a href=\"#Mac下使用-adb-将本地文件拷贝到安卓手机\" class=\"headerlink\" title=\"Mac下使用 adb 将本地文件拷贝到安卓手机\"></a>Mac下使用 <code>adb</code> 将本地文件拷贝到安卓手机</h1><p>一直想在Mac上找个好用的图形界面的安卓手机助手类的工具，但是寻寻觅觅，还是没有找到，只好用adb来实现了。</p><a id=\"more\"></a><h2 id=\"安装adb\"><a href=\"#安装adb\" class=\"headerlink\" title=\"安装adb\"></a>安装adb</h2><h3 id=\"使用homebrew快速安装\"><a href=\"#使用homebrew快速安装\" class=\"headerlink\" title=\"使用homebrew快速安装\"></a>使用homebrew快速安装</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ brew cask install android-platform-tools</span><br></pre></td></tr></table></figure><h3 id=\"验证是否已安装\"><a href=\"#验证是否已安装\" class=\"headerlink\" title=\"验证是否已安装\"></a>验证是否已安装</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">which</span> adb</span><br></pre></td></tr></table></figure><h2 id=\"使用adb-push文件到手机上\"><a href=\"#使用adb-push文件到手机上\" class=\"headerlink\" title=\"使用adb push文件到手机上\"></a>使用adb push文件到手机上</h2><h3 id=\"确保adb识别到了你的手机\"><a href=\"#确保adb识别到了你的手机\" class=\"headerlink\" title=\"确保adb识别到了你的手机\"></a>确保adb识别到了你的手机</h3><p><strong>首先需要在手机上打开USB调试</strong></p><p>然后可以在终端执行</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ adb devices</span><br></pre></td></tr></table></figure><p>来判断adb是否识别到了你的手机</p><h3 id=\"拷贝本地文件到手机上\"><a href=\"#拷贝本地文件到手机上\" class=\"headerlink\" title=\"拷贝本地文件到手机上\"></a>拷贝本地文件到手机上</h3><p>adb 提供了 <code>push</code> 命令，即可复制本地文件到手机上</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ adb push file.on.mac.zip /sdcard/path/</span><br></pre></td></tr></table></figure><h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><p>关于手机上的路径，可以使用 <code>adb shell</code> 来进入手机的目录结构，然后可以尝试下 <code>pwd</code></p>","site":{"data":{}},"excerpt":"<h1 id=\"Mac下使用-adb-将本地文件拷贝到安卓手机\"><a href=\"#Mac下使用-adb-将本地文件拷贝到安卓手机\" class=\"headerlink\" title=\"Mac下使用 adb 将本地文件拷贝到安卓手机\"></a>Mac下使用 <code>adb</code> 将本地文件拷贝到安卓手机</h1><p>一直想在Mac上找个好用的图形界面的安卓手机助手类的工具，但是寻寻觅觅，还是没有找到，只好用adb来实现了。</p>","more":"<h2 id=\"安装adb\"><a href=\"#安装adb\" class=\"headerlink\" title=\"安装adb\"></a>安装adb</h2><h3 id=\"使用homebrew快速安装\"><a href=\"#使用homebrew快速安装\" class=\"headerlink\" title=\"使用homebrew快速安装\"></a>使用homebrew快速安装</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ brew cask install android-platform-tools</span><br></pre></td></tr></table></figure><h3 id=\"验证是否已安装\"><a href=\"#验证是否已安装\" class=\"headerlink\" title=\"验证是否已安装\"></a>验证是否已安装</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">which</span> adb</span><br></pre></td></tr></table></figure><h2 id=\"使用adb-push文件到手机上\"><a href=\"#使用adb-push文件到手机上\" class=\"headerlink\" title=\"使用adb push文件到手机上\"></a>使用adb push文件到手机上</h2><h3 id=\"确保adb识别到了你的手机\"><a href=\"#确保adb识别到了你的手机\" class=\"headerlink\" title=\"确保adb识别到了你的手机\"></a>确保adb识别到了你的手机</h3><p><strong>首先需要在手机上打开USB调试</strong></p><p>然后可以在终端执行</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ adb devices</span><br></pre></td></tr></table></figure><p>来判断adb是否识别到了你的手机</p><h3 id=\"拷贝本地文件到手机上\"><a href=\"#拷贝本地文件到手机上\" class=\"headerlink\" title=\"拷贝本地文件到手机上\"></a>拷贝本地文件到手机上</h3><p>adb 提供了 <code>push</code> 命令，即可复制本地文件到手机上</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ adb push file.on.mac.zip /sdcard/path/</span><br></pre></td></tr></table></figure><h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><p>关于手机上的路径，可以使用 <code>adb shell</code> 来进入手机的目录结构，然后可以尝试下 <code>pwd</code></p>"},{"title":"初识gRPC","date":"2017-12-19T03:04:29.000Z","_content":"写这篇文章用于记录首次接触gRPC的感受。\n\n官网：[grpc.io](https://grpc.io/)\n\n先上一张核心概念的流程图：\n\n![Overview](https://grpc.io/img/landing-2.svg)\n\n看了看官方文档，也有了初步的一个认识。个人觉得这个框架中最厉害的是 `protobuf` 的目标语言 `generator` ，整个框架的核心也是围绕着这个生成器展开的。\n\n<!-- more -->\n\n# 核心思路\n\n使用 `.proto` 文件编写方法、参数、返回(类似路由规则)，再通过 `generator` 生成各种语言的文件 比如 `Golang` `PHP` `Javascript` 等。\n在服务端和客户端引入生成的语言文件即可进行业务代码开发，由此达到了跨语言的调用。\n\n# 举个例子\n\n虽然官方等文档已经写的比较清晰了，但是还是想在这里记录一下自己跟着官网打教程体验。\n\n这里暂且只记录 `Golang` 的教程\n\n## 在 `.proto` 文件中定义方法、参数、返回\n\n先来一个最简单的：\n\n```proto3\n// file: $GOPATH/src/proto/user.proto\n\nsyntax = \"proto3\";\n\npackage proto; // 包名\n\nservice User {\n  rpc all (Request) returns (Response);\n}\n\nmessage Request {\n  string json = 1;\n}\n\nmessage Response {\n  string json = 1;\n}\n```\n\n这个简单的 `.proto` 文件定义了 一个路由组 `user` 和 这个路由组里的一个 `all` 方法，\n这个 `all` 方法需要接收一个 `Request` 对象作为参数，`Request` 对象中有一个 `json` 属性，类型是 `string`，\n同时，这个 `all` 方法会返回一个 `Response` 对象，`Response` 对象中有一个 `json` 属性，类型是 `string`。\n\n下一步，我们需要将这个 `.proto` 文件转换为我们的开发语言，也就是 `Golang`。转换等方式也很简单，一个命令就可以搞定。\n但是在使用这个命令前，我们需要安装一些依赖，这些依赖会根据目标语言的不同而不同，具体内容可以参考文档。\n\n安装 Protocol Buffers v3\n\n> Install the protoc compiler that is used to generate gRPC service code. The simplest way to do this is to download pre-compiled binaries for your platform(protoc-<version>-<platform>.zip) from here: https://github.com/google/protobuf/releases\n> Unzip this file.\n> Update the environment variable PATH to include the path to the protoc binary file.\n\n然后安装 the protoc plugin for Go\n\n```sh\ngo get -u -v github.com/golang/protobuf/protoc-gen-go\n```\n\n检查下环境变量\n\n```sh\necho $path # 应该包含 /path/to/protoc 和 $GOPATH\n```\n\n执行命令，生成 `golang` 代码\n\n```sh\ncd $GOPATH/src\nprotoc -I proto proto/*.proto --go_out=plugins=grpc:proto\n```\n\n完成后你会得到一个 `user.pb.go` 文件，其 `package` 是 `proto` 正如在 `user.proto` 文件中定义的一样\n\n当然针对不同的目标语言，命令的参数是不一样的，具体可以参考官方文档。\n\n有了 `user.pb.go` 文件，引用之后，编写 `server` 和 `client` 就很轻松了。thanks to code hint.\n当然，首先需要安装 `gRPC` 框架\n\n```sh\ngo get -u -v google.golang.org/grpc\n```\n\n## 编写server\n\n直接看代码\n\n```golang\n// file: $GOPATH/src/server/main.go\npackage main\n\nimport (\n    \"log\"\n    \"net\"\n    \"proto\"\n    \"google.golang.org/grpc\"\n    \"golang.org/x/net/context\"\n)\n\nvar address string = \":6666\"\n\ntype server struct {}\n\n// 这里等方法名称必须是大写开头，应该是由于golang的语言特性\nfunc (s *server) All(ctx context.Context, req *proto.Request) (*proto.Response, error) {\n    // handle req...\n    return &proto.Response{Json: \"user list\"}, nil\n}\n\nfunc main() {\n    lis, err := net.Listen(\"tcp\", address)\n    if err != nil {\n        log.Fatalf(\"failed to listen: %v\", err)\n    }\n\n    // 注册服务\n    grpcServer := grpc.NewServer()\n    proto.RegisterUserServer(grpcServer, &server{})\n\n    // 监听\n    if err := grpcServer.Serve(lis); err != nil {\n        log.Fatalf(\"failed to serve: %v\", err)\n    }\n}\n```\n\n执行 `server`\n\n```sh\ncd $GOPATH/src\ngo run server/main.go\n```\n\n## 编写client\n\n直接看代码\n\n```golang\n// file: $GOPATH/src/client/main.go\npackage main\n\nimport (\n    \"golang.org/x/net/context\"\n    \"google.golang.org/grpc\"\n    \"log\"\n    \"proto\"\n)\n\nvar address string = \"localhost:6666\" // 和server保持一致\n\nfunc main() {\n    var response *proto.Response\n    var err error\n\n    // 拨号建立连接\n    conn, err := grpc.Dial(address, grpc.WithInsecure())\n    if err != nil {\n        log.Fatalf(\"did not connect: %v\", err)\n    }\n    defer conn.Close()\n\n    // rpc调用\n    users := proto.NewUserClient(conn)\n    response, err = users.All(context.Background(), &proto.Request{Json: \"string param\"})\n    if err != nil {\n        log.Fatalf(\"could not call user.All: %v\", err)\n    }\n    log.Print(response.Json) // 输出响应\n}\n```\n\n执行 `client`\n\n```sh\ncd $GOPATH/src\ngo run client/main.go\n```\n\n输出\n\n```sh\n2017/12/19 11:52:44 user list\n```\n\n## 总结\n\n第一个教程打完了。感觉最主要的功劳还是 `generator` 😆\n\n---\n\n# 更新\n\n生成目标语言的命令：(目前只在Mac上测试过)\n\n```sh\ncd protos # 假设这里放的是 .proto 文件\n\n# golang\nmkdir go\n# 需要安装插件 go get -u -v github.com/golang/protobuf/protoc-gen-go\nprotoc --go_out=./go *.proto # 有木有很简单。。\n\n# node\nmkdir node\n# 需要安装插件 npm install -g grpc-tools\nprotoc --js_out=import_style=commonjs,binary:./node --grpc_out=./node --plugin=protoc-gen-grpc=`which grpc_tools_node_protoc_plugin` *.proto\n# 会生成两种文件 *_pb.js 和 *_grpc_pb.js\n# 前者用于访问 request 和 response\n# 后者用于创建 server 和 client 以及方法调用\n```\n","source":"_posts/2017-12-19-初识gRPC.md","raw":"---\ntitle: 初识gRPC\ndate: 2017-12-19 11:04:29\ncategories:\n- 笔记\ntags:\n- gRPC\n- golang\n---\n写这篇文章用于记录首次接触gRPC的感受。\n\n官网：[grpc.io](https://grpc.io/)\n\n先上一张核心概念的流程图：\n\n![Overview](https://grpc.io/img/landing-2.svg)\n\n看了看官方文档，也有了初步的一个认识。个人觉得这个框架中最厉害的是 `protobuf` 的目标语言 `generator` ，整个框架的核心也是围绕着这个生成器展开的。\n\n<!-- more -->\n\n# 核心思路\n\n使用 `.proto` 文件编写方法、参数、返回(类似路由规则)，再通过 `generator` 生成各种语言的文件 比如 `Golang` `PHP` `Javascript` 等。\n在服务端和客户端引入生成的语言文件即可进行业务代码开发，由此达到了跨语言的调用。\n\n# 举个例子\n\n虽然官方等文档已经写的比较清晰了，但是还是想在这里记录一下自己跟着官网打教程体验。\n\n这里暂且只记录 `Golang` 的教程\n\n## 在 `.proto` 文件中定义方法、参数、返回\n\n先来一个最简单的：\n\n```proto3\n// file: $GOPATH/src/proto/user.proto\n\nsyntax = \"proto3\";\n\npackage proto; // 包名\n\nservice User {\n  rpc all (Request) returns (Response);\n}\n\nmessage Request {\n  string json = 1;\n}\n\nmessage Response {\n  string json = 1;\n}\n```\n\n这个简单的 `.proto` 文件定义了 一个路由组 `user` 和 这个路由组里的一个 `all` 方法，\n这个 `all` 方法需要接收一个 `Request` 对象作为参数，`Request` 对象中有一个 `json` 属性，类型是 `string`，\n同时，这个 `all` 方法会返回一个 `Response` 对象，`Response` 对象中有一个 `json` 属性，类型是 `string`。\n\n下一步，我们需要将这个 `.proto` 文件转换为我们的开发语言，也就是 `Golang`。转换等方式也很简单，一个命令就可以搞定。\n但是在使用这个命令前，我们需要安装一些依赖，这些依赖会根据目标语言的不同而不同，具体内容可以参考文档。\n\n安装 Protocol Buffers v3\n\n> Install the protoc compiler that is used to generate gRPC service code. The simplest way to do this is to download pre-compiled binaries for your platform(protoc-<version>-<platform>.zip) from here: https://github.com/google/protobuf/releases\n> Unzip this file.\n> Update the environment variable PATH to include the path to the protoc binary file.\n\n然后安装 the protoc plugin for Go\n\n```sh\ngo get -u -v github.com/golang/protobuf/protoc-gen-go\n```\n\n检查下环境变量\n\n```sh\necho $path # 应该包含 /path/to/protoc 和 $GOPATH\n```\n\n执行命令，生成 `golang` 代码\n\n```sh\ncd $GOPATH/src\nprotoc -I proto proto/*.proto --go_out=plugins=grpc:proto\n```\n\n完成后你会得到一个 `user.pb.go` 文件，其 `package` 是 `proto` 正如在 `user.proto` 文件中定义的一样\n\n当然针对不同的目标语言，命令的参数是不一样的，具体可以参考官方文档。\n\n有了 `user.pb.go` 文件，引用之后，编写 `server` 和 `client` 就很轻松了。thanks to code hint.\n当然，首先需要安装 `gRPC` 框架\n\n```sh\ngo get -u -v google.golang.org/grpc\n```\n\n## 编写server\n\n直接看代码\n\n```golang\n// file: $GOPATH/src/server/main.go\npackage main\n\nimport (\n    \"log\"\n    \"net\"\n    \"proto\"\n    \"google.golang.org/grpc\"\n    \"golang.org/x/net/context\"\n)\n\nvar address string = \":6666\"\n\ntype server struct {}\n\n// 这里等方法名称必须是大写开头，应该是由于golang的语言特性\nfunc (s *server) All(ctx context.Context, req *proto.Request) (*proto.Response, error) {\n    // handle req...\n    return &proto.Response{Json: \"user list\"}, nil\n}\n\nfunc main() {\n    lis, err := net.Listen(\"tcp\", address)\n    if err != nil {\n        log.Fatalf(\"failed to listen: %v\", err)\n    }\n\n    // 注册服务\n    grpcServer := grpc.NewServer()\n    proto.RegisterUserServer(grpcServer, &server{})\n\n    // 监听\n    if err := grpcServer.Serve(lis); err != nil {\n        log.Fatalf(\"failed to serve: %v\", err)\n    }\n}\n```\n\n执行 `server`\n\n```sh\ncd $GOPATH/src\ngo run server/main.go\n```\n\n## 编写client\n\n直接看代码\n\n```golang\n// file: $GOPATH/src/client/main.go\npackage main\n\nimport (\n    \"golang.org/x/net/context\"\n    \"google.golang.org/grpc\"\n    \"log\"\n    \"proto\"\n)\n\nvar address string = \"localhost:6666\" // 和server保持一致\n\nfunc main() {\n    var response *proto.Response\n    var err error\n\n    // 拨号建立连接\n    conn, err := grpc.Dial(address, grpc.WithInsecure())\n    if err != nil {\n        log.Fatalf(\"did not connect: %v\", err)\n    }\n    defer conn.Close()\n\n    // rpc调用\n    users := proto.NewUserClient(conn)\n    response, err = users.All(context.Background(), &proto.Request{Json: \"string param\"})\n    if err != nil {\n        log.Fatalf(\"could not call user.All: %v\", err)\n    }\n    log.Print(response.Json) // 输出响应\n}\n```\n\n执行 `client`\n\n```sh\ncd $GOPATH/src\ngo run client/main.go\n```\n\n输出\n\n```sh\n2017/12/19 11:52:44 user list\n```\n\n## 总结\n\n第一个教程打完了。感觉最主要的功劳还是 `generator` 😆\n\n---\n\n# 更新\n\n生成目标语言的命令：(目前只在Mac上测试过)\n\n```sh\ncd protos # 假设这里放的是 .proto 文件\n\n# golang\nmkdir go\n# 需要安装插件 go get -u -v github.com/golang/protobuf/protoc-gen-go\nprotoc --go_out=./go *.proto # 有木有很简单。。\n\n# node\nmkdir node\n# 需要安装插件 npm install -g grpc-tools\nprotoc --js_out=import_style=commonjs,binary:./node --grpc_out=./node --plugin=protoc-gen-grpc=`which grpc_tools_node_protoc_plugin` *.proto\n# 会生成两种文件 *_pb.js 和 *_grpc_pb.js\n# 前者用于访问 request 和 response\n# 后者用于创建 server 和 client 以及方法调用\n```\n","slug":"初识gRPC","published":1,"updated":"2023-05-28T05:36:04.284Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j00007iubf0hz6pt16","content":"<p>写这篇文章用于记录首次接触gRPC的感受。</p><p>官网：<a href=\"https://grpc.io/\" target=\"_blank\" rel=\"noopener\">grpc.io</a></p><p>先上一张核心概念的流程图：</p><p><img src=\"https://grpc.io/img/landing-2.svg\" alt=\"Overview\"></p><p>看了看官方文档，也有了初步的一个认识。个人觉得这个框架中最厉害的是 <code>protobuf</code> 的目标语言 <code>generator</code> ，整个框架的核心也是围绕着这个生成器展开的。</p><a id=\"more\"></a><h1 id=\"核心思路\"><a href=\"#核心思路\" class=\"headerlink\" title=\"核心思路\"></a>核心思路</h1><p>使用 <code>.proto</code> 文件编写方法、参数、返回(类似路由规则)，再通过 <code>generator</code> 生成各种语言的文件 比如 <code>Golang</code> <code>PHP</code> <code>Javascript</code> 等。 在服务端和客户端引入生成的语言文件即可进行业务代码开发，由此达到了跨语言的调用。</p><h1 id=\"举个例子\"><a href=\"#举个例子\" class=\"headerlink\" title=\"举个例子\"></a>举个例子</h1><p>虽然官方等文档已经写的比较清晰了，但是还是想在这里记录一下自己跟着官网打教程体验。</p><p>这里暂且只记录 <code>Golang</code> 的教程</p><h2 id=\"在-proto-文件中定义方法、参数、返回\"><a href=\"#在-proto-文件中定义方法、参数、返回\" class=\"headerlink\" title=\"在 .proto 文件中定义方法、参数、返回\"></a>在 <code>.proto</code> 文件中定义方法、参数、返回</h2><p>先来一个最简单的：</p><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// file: $GOPATH/src/proto/user.proto</span><br><span class=\"line\"></span><br><span class=\"line\">syntax = &quot;proto3&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">package proto; // 包名</span><br><span class=\"line\"></span><br><span class=\"line\">service User &#123;</span><br><span class=\"line\">  rpc all (Request) returns (Response);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">message Request &#123;</span><br><span class=\"line\">  string json = 1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">message Response &#123;</span><br><span class=\"line\">  string json = 1;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>这个简单的 <code>.proto</code> 文件定义了 一个路由组 <code>user</code> 和 这个路由组里的一个 <code>all</code> 方法， 这个 <code>all</code> 方法需要接收一个 <code>Request</code> 对象作为参数，<code>Request</code> 对象中有一个 <code>json</code> 属性，类型是 <code>string</code>， 同时，这个 <code>all</code> 方法会返回一个 <code>Response</code> 对象，<code>Response</code> 对象中有一个 <code>json</code> 属性，类型是 <code>string</code>。</p><p>下一步，我们需要将这个 <code>.proto</code> 文件转换为我们的开发语言，也就是 <code>Golang</code>。转换等方式也很简单，一个命令就可以搞定。 但是在使用这个命令前，我们需要安装一些依赖，这些依赖会根据目标语言的不同而不同，具体内容可以参考文档。</p><p>安装 Protocol Buffers v3</p><blockquote><p>Install the protoc compiler that is used to generate gRPC service code. The simplest way to do this is to download pre-compiled binaries for your platform(protoc-<version>-<platform>.zip) from here: <a href=\"https://github.com/google/protobuf/releases\" target=\"_blank\" rel=\"noopener\">https://github.com/google/protobuf/releases</a> Unzip this file. Update the environment variable PATH to include the path to the protoc binary file.</platform></version></p></blockquote><p>然后安装 the protoc plugin for Go</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">go get -u -v github.com/golang/protobuf/protoc-gen-go</span><br></pre></td></tr></table></figure><p>检查下环境变量</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"variable\">$path</span> <span class=\"comment\"># 应该包含 /path/to/protoc 和 $GOPATH</span></span><br></pre></td></tr></table></figure><p>执行命令，生成 <code>golang</code> 代码</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"variable\">$GOPATH</span>/src</span><br><span class=\"line\">protoc -I proto proto/*.proto --go_out=plugins=grpc:proto</span><br></pre></td></tr></table></figure><p>完成后你会得到一个 <code>user.pb.go</code> 文件，其 <code>package</code> 是 <code>proto</code> 正如在 <code>user.proto</code> 文件中定义的一样</p><p>当然针对不同的目标语言，命令的参数是不一样的，具体可以参考官方文档。</p><p>有了 <code>user.pb.go</code> 文件，引用之后，编写 <code>server</code> 和 <code>client</code> 就很轻松了。thanks to code hint. 当然，首先需要安装 <code>gRPC</code> 框架</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">go get -u -v google.golang.org/grpc</span><br></pre></td></tr></table></figure><h2 id=\"编写server\"><a href=\"#编写server\" class=\"headerlink\" title=\"编写server\"></a>编写server</h2><p>直接看代码</p><figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// file: $GOPATH/src/server/main.go</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"log\"</span></span><br><span class=\"line\">    <span class=\"string\">\"net\"</span></span><br><span class=\"line\">    <span class=\"string\">\"proto\"</span></span><br><span class=\"line\">    <span class=\"string\">\"google.golang.org/grpc\"</span></span><br><span class=\"line\">    <span class=\"string\">\"golang.org/x/net/context\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> address <span class=\"keyword\">string</span> = <span class=\"string\">\":6666\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> server <span class=\"keyword\">struct</span> &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 这里等方法名称必须是大写开头，应该是由于golang的语言特性</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(s *server)</span> <span class=\"title\">All</span><span class=\"params\">(ctx context.Context, req *proto.Request)</span> <span class=\"params\">(*proto.Response, error)</span></span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// handle req...</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> &amp;proto.Response&#123;Json: <span class=\"string\">\"user list\"</span>&#125;, <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    lis, err := net.Listen(<span class=\"string\">\"tcp\"</span>, address)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">        log.Fatalf(<span class=\"string\">\"failed to listen: %v\"</span>, err)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 注册服务</span></span><br><span class=\"line\">    grpcServer := grpc.NewServer()</span><br><span class=\"line\">    proto.RegisterUserServer(grpcServer, &amp;server&#123;&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 监听</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> err := grpcServer.Serve(lis); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">        log.Fatalf(<span class=\"string\">\"failed to serve: %v\"</span>, err)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>执行 <code>server</code></p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"variable\">$GOPATH</span>/src</span><br><span class=\"line\">go run server/main.go</span><br></pre></td></tr></table></figure><h2 id=\"编写client\"><a href=\"#编写client\" class=\"headerlink\" title=\"编写client\"></a>编写client</h2><p>直接看代码</p><figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// file: $GOPATH/src/client/main.go</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"golang.org/x/net/context\"</span></span><br><span class=\"line\">    <span class=\"string\">\"google.golang.org/grpc\"</span></span><br><span class=\"line\">    <span class=\"string\">\"log\"</span></span><br><span class=\"line\">    <span class=\"string\">\"proto\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> address <span class=\"keyword\">string</span> = <span class=\"string\">\"localhost:6666\"</span> <span class=\"comment\">// 和server保持一致</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> response *proto.Response</span><br><span class=\"line\">    <span class=\"keyword\">var</span> err error</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 拨号建立连接</span></span><br><span class=\"line\">    conn, err := grpc.Dial(address, grpc.WithInsecure())</span><br><span class=\"line\">    <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">        log.Fatalf(<span class=\"string\">\"did not connect: %v\"</span>, err)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">defer</span> conn.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// rpc调用</span></span><br><span class=\"line\">    users := proto.NewUserClient(conn)</span><br><span class=\"line\">    response, err = users.All(context.Background(), &amp;proto.Request&#123;Json: <span class=\"string\">\"string param\"</span>&#125;)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">        log.Fatalf(<span class=\"string\">\"could not call user.All: %v\"</span>, err)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    log.Print(response.Json) <span class=\"comment\">// 输出响应</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>执行 <code>client</code></p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"variable\">$GOPATH</span>/src</span><br><span class=\"line\">go run client/main.go</span><br></pre></td></tr></table></figure><p>输出</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2017/12/19 11:52:44 user list</span><br></pre></td></tr></table></figure><h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>第一个教程打完了。感觉最主要的功劳还是 <code>generator</code> 😆</p><hr><h1 id=\"更新\"><a href=\"#更新\" class=\"headerlink\" title=\"更新\"></a>更新</h1><p>生成目标语言的命令：(目前只在Mac上测试过)</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> protos <span class=\"comment\"># 假设这里放的是 .proto 文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># golang</span></span><br><span class=\"line\">mkdir go</span><br><span class=\"line\"><span class=\"comment\"># 需要安装插件 go get -u -v github.com/golang/protobuf/protoc-gen-go</span></span><br><span class=\"line\">protoc --go_out=./go *.proto <span class=\"comment\"># 有木有很简单。。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># node</span></span><br><span class=\"line\">mkdir node</span><br><span class=\"line\"><span class=\"comment\"># 需要安装插件 npm install -g grpc-tools</span></span><br><span class=\"line\">protoc --js_out=import_style=commonjs,binary:./node --grpc_out=./node --plugin=protoc-gen-grpc=`<span class=\"built_in\">which</span> grpc_tools_node_protoc_plugin` *.proto</span><br><span class=\"line\"><span class=\"comment\"># 会生成两种文件 *_pb.js 和 *_grpc_pb.js</span></span><br><span class=\"line\"><span class=\"comment\"># 前者用于访问 request 和 response</span></span><br><span class=\"line\"><span class=\"comment\"># 后者用于创建 server 和 client 以及方法调用</span></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"<p>写这篇文章用于记录首次接触gRPC的感受。</p><p>官网：<a href=\"https://grpc.io/\" target=\"_blank\" rel=\"noopener\">grpc.io</a></p><p>先上一张核心概念的流程图：</p><p><img src=\"https://grpc.io/img/landing-2.svg\" alt=\"Overview\"></p><p>看了看官方文档，也有了初步的一个认识。个人觉得这个框架中最厉害的是 <code>protobuf</code> 的目标语言 <code>generator</code> ，整个框架的核心也是围绕着这个生成器展开的。</p>","more":"<h1 id=\"核心思路\"><a href=\"#核心思路\" class=\"headerlink\" title=\"核心思路\"></a>核心思路</h1><p>使用 <code>.proto</code> 文件编写方法、参数、返回(类似路由规则)，再通过 <code>generator</code> 生成各种语言的文件 比如 <code>Golang</code> <code>PHP</code> <code>Javascript</code> 等。 在服务端和客户端引入生成的语言文件即可进行业务代码开发，由此达到了跨语言的调用。</p><h1 id=\"举个例子\"><a href=\"#举个例子\" class=\"headerlink\" title=\"举个例子\"></a>举个例子</h1><p>虽然官方等文档已经写的比较清晰了，但是还是想在这里记录一下自己跟着官网打教程体验。</p><p>这里暂且只记录 <code>Golang</code> 的教程</p><h2 id=\"在-proto-文件中定义方法、参数、返回\"><a href=\"#在-proto-文件中定义方法、参数、返回\" class=\"headerlink\" title=\"在 .proto 文件中定义方法、参数、返回\"></a>在 <code>.proto</code> 文件中定义方法、参数、返回</h2><p>先来一个最简单的：</p><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// file: $GOPATH/src/proto/user.proto</span><br><span class=\"line\"></span><br><span class=\"line\">syntax = &quot;proto3&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">package proto; // 包名</span><br><span class=\"line\"></span><br><span class=\"line\">service User &#123;</span><br><span class=\"line\">  rpc all (Request) returns (Response);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">message Request &#123;</span><br><span class=\"line\">  string json = 1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">message Response &#123;</span><br><span class=\"line\">  string json = 1;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>这个简单的 <code>.proto</code> 文件定义了 一个路由组 <code>user</code> 和 这个路由组里的一个 <code>all</code> 方法， 这个 <code>all</code> 方法需要接收一个 <code>Request</code> 对象作为参数，<code>Request</code> 对象中有一个 <code>json</code> 属性，类型是 <code>string</code>， 同时，这个 <code>all</code> 方法会返回一个 <code>Response</code> 对象，<code>Response</code> 对象中有一个 <code>json</code> 属性，类型是 <code>string</code>。</p><p>下一步，我们需要将这个 <code>.proto</code> 文件转换为我们的开发语言，也就是 <code>Golang</code>。转换等方式也很简单，一个命令就可以搞定。 但是在使用这个命令前，我们需要安装一些依赖，这些依赖会根据目标语言的不同而不同，具体内容可以参考文档。</p><p>安装 Protocol Buffers v3</p><blockquote><p>Install the protoc compiler that is used to generate gRPC service code. The simplest way to do this is to download pre-compiled binaries for your platform(protoc-<version>-<platform>.zip) from here: <a href=\"https://github.com/google/protobuf/releases\" target=\"_blank\" rel=\"noopener\">https://github.com/google/protobuf/releases</a> Unzip this file. Update the environment variable PATH to include the path to the protoc binary file.</platform></version></p></blockquote><p>然后安装 the protoc plugin for Go</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">go get -u -v github.com/golang/protobuf/protoc-gen-go</span><br></pre></td></tr></table></figure><p>检查下环境变量</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"variable\">$path</span> <span class=\"comment\"># 应该包含 /path/to/protoc 和 $GOPATH</span></span><br></pre></td></tr></table></figure><p>执行命令，生成 <code>golang</code> 代码</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"variable\">$GOPATH</span>/src</span><br><span class=\"line\">protoc -I proto proto/*.proto --go_out=plugins=grpc:proto</span><br></pre></td></tr></table></figure><p>完成后你会得到一个 <code>user.pb.go</code> 文件，其 <code>package</code> 是 <code>proto</code> 正如在 <code>user.proto</code> 文件中定义的一样</p><p>当然针对不同的目标语言，命令的参数是不一样的，具体可以参考官方文档。</p><p>有了 <code>user.pb.go</code> 文件，引用之后，编写 <code>server</code> 和 <code>client</code> 就很轻松了。thanks to code hint. 当然，首先需要安装 <code>gRPC</code> 框架</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">go get -u -v google.golang.org/grpc</span><br></pre></td></tr></table></figure><h2 id=\"编写server\"><a href=\"#编写server\" class=\"headerlink\" title=\"编写server\"></a>编写server</h2><p>直接看代码</p><figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// file: $GOPATH/src/server/main.go</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"log\"</span></span><br><span class=\"line\">    <span class=\"string\">\"net\"</span></span><br><span class=\"line\">    <span class=\"string\">\"proto\"</span></span><br><span class=\"line\">    <span class=\"string\">\"google.golang.org/grpc\"</span></span><br><span class=\"line\">    <span class=\"string\">\"golang.org/x/net/context\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> address <span class=\"keyword\">string</span> = <span class=\"string\">\":6666\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> server <span class=\"keyword\">struct</span> &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 这里等方法名称必须是大写开头，应该是由于golang的语言特性</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(s *server)</span> <span class=\"title\">All</span><span class=\"params\">(ctx context.Context, req *proto.Request)</span> <span class=\"params\">(*proto.Response, error)</span></span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// handle req...</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> &amp;proto.Response&#123;Json: <span class=\"string\">\"user list\"</span>&#125;, <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    lis, err := net.Listen(<span class=\"string\">\"tcp\"</span>, address)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">        log.Fatalf(<span class=\"string\">\"failed to listen: %v\"</span>, err)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 注册服务</span></span><br><span class=\"line\">    grpcServer := grpc.NewServer()</span><br><span class=\"line\">    proto.RegisterUserServer(grpcServer, &amp;server&#123;&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 监听</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> err := grpcServer.Serve(lis); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">        log.Fatalf(<span class=\"string\">\"failed to serve: %v\"</span>, err)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>执行 <code>server</code></p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"variable\">$GOPATH</span>/src</span><br><span class=\"line\">go run server/main.go</span><br></pre></td></tr></table></figure><h2 id=\"编写client\"><a href=\"#编写client\" class=\"headerlink\" title=\"编写client\"></a>编写client</h2><p>直接看代码</p><figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// file: $GOPATH/src/client/main.go</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"golang.org/x/net/context\"</span></span><br><span class=\"line\">    <span class=\"string\">\"google.golang.org/grpc\"</span></span><br><span class=\"line\">    <span class=\"string\">\"log\"</span></span><br><span class=\"line\">    <span class=\"string\">\"proto\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> address <span class=\"keyword\">string</span> = <span class=\"string\">\"localhost:6666\"</span> <span class=\"comment\">// 和server保持一致</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> response *proto.Response</span><br><span class=\"line\">    <span class=\"keyword\">var</span> err error</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 拨号建立连接</span></span><br><span class=\"line\">    conn, err := grpc.Dial(address, grpc.WithInsecure())</span><br><span class=\"line\">    <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">        log.Fatalf(<span class=\"string\">\"did not connect: %v\"</span>, err)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">defer</span> conn.Close()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// rpc调用</span></span><br><span class=\"line\">    users := proto.NewUserClient(conn)</span><br><span class=\"line\">    response, err = users.All(context.Background(), &amp;proto.Request&#123;Json: <span class=\"string\">\"string param\"</span>&#125;)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">        log.Fatalf(<span class=\"string\">\"could not call user.All: %v\"</span>, err)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    log.Print(response.Json) <span class=\"comment\">// 输出响应</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>执行 <code>client</code></p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"variable\">$GOPATH</span>/src</span><br><span class=\"line\">go run client/main.go</span><br></pre></td></tr></table></figure><p>输出</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2017/12/19 11:52:44 user list</span><br></pre></td></tr></table></figure><h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>第一个教程打完了。感觉最主要的功劳还是 <code>generator</code> 😆</p><hr><h1 id=\"更新\"><a href=\"#更新\" class=\"headerlink\" title=\"更新\"></a>更新</h1><p>生成目标语言的命令：(目前只在Mac上测试过)</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> protos <span class=\"comment\"># 假设这里放的是 .proto 文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># golang</span></span><br><span class=\"line\">mkdir go</span><br><span class=\"line\"><span class=\"comment\"># 需要安装插件 go get -u -v github.com/golang/protobuf/protoc-gen-go</span></span><br><span class=\"line\">protoc --go_out=./go *.proto <span class=\"comment\"># 有木有很简单。。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># node</span></span><br><span class=\"line\">mkdir node</span><br><span class=\"line\"><span class=\"comment\"># 需要安装插件 npm install -g grpc-tools</span></span><br><span class=\"line\">protoc --js_out=import_style=commonjs,binary:./node --grpc_out=./node --plugin=protoc-gen-grpc=`<span class=\"built_in\">which</span> grpc_tools_node_protoc_plugin` *.proto</span><br><span class=\"line\"><span class=\"comment\"># 会生成两种文件 *_pb.js 和 *_grpc_pb.js</span></span><br><span class=\"line\"><span class=\"comment\"># 前者用于访问 request 和 response</span></span><br><span class=\"line\"><span class=\"comment\"># 后者用于创建 server 和 client 以及方法调用</span></span><br></pre></td></tr></table></figure>"},{"title":"梅林单线复用Internet+IPTV","date":"2017-10-09T07:51:10.000Z","_content":"\n**此方法已无效，无法拿到 backupsettings.conf 了，电信后台修复了这个BUG**\n\n由于装修时网络布线问题，需要把电信光猫的IPTV业务在路由器中和Internet业务分开，达到单线复用\n\n## 设备\n\n- 路由器: `华硕ac68u` 刷了 `梅林7.5`\n- 电信光猫版本: `TEWA-500E`\n\n<!-- more -->\n\n## 开始\n\n电信光猫之所以可以做到将Internet和IPTV的流量分开，是由于设置了VLAN，所以需要把光猫的VLAN设置让路由器来接管，在路由器上配置Internet和IPTV的VLAN。\n\n### 找到原有的VLAN配置\n\n首先需要拿到光猫的超级管理员的账号密码。\n\n`TEWA-500E`的获取方式比较简单\n\n0. 登录\n\n1. 登录之后，在地址栏中输入 `192.168.1.1/backupsettings.conf` 会下载到光猫的配置文件\n\n2. 打开配置文件，搜索关键字 `telecom` (忽略大小写) 可以找到密码的配置，在`<Password>`中间\n\n  ```xml\n  <X_CT-COM_TeleComAccount>\n    <Password>密码</Password>\n  </X_CT-COM_TeleComAccount>\n  ```\n\n3. 重新登录光猫 账号: `telecomadmin`，密码: `找到的密码`\n\n以超级管理员账号登录后，可以看到VLAN的配置\n\n![image](https://qiniu.wrzsj.top/blog/asset/img/gBwg5J@75_discount)\n![image](https://qiniu.wrzsj.top/blog/asset/img/gBwkS0@75_discount)\n\n需要记下上面两个的VLAN ID\n\nInternet的连接模式**可以**设为桥接（非必须），设为桥接后，则需要在路由器完成拨号。\n\n从上图中可以看到，IPTV的VLAN ID是43，Internet的VLAN ID是1372。\n\n然后在VLAN绑定中添加一组\n\n![image](https://qiniu.wrzsj.top/blog/asset/img/gBwZy1@75_discount)\n\n### 在路由器中(梅林固件)，手动配置VLAN\n\n配置如下\n\n![image](https://qiniu.wrzsj.top/blog/asset/img/gBwwcd@75_discount)\n\n### 连线\n\n将光猫的`lan1`口接入路由器的`wan`（如果Internet业务为桥接模式的话，需要在路由器上完成PPPoE拨号），然后将路由器的`lan4`口接入IPTV盒子。大功告成！\n","source":"_posts/2017-10-09-梅林单线复用internet+IPTV.md","raw":"---\ntitle: 梅林单线复用Internet+IPTV\ndate: 2017-10-09 15:51:10\ntags:\n- router\n- merlin\ncategories:\n- 笔记\n---\n\n**此方法已无效，无法拿到 backupsettings.conf 了，电信后台修复了这个BUG**\n\n由于装修时网络布线问题，需要把电信光猫的IPTV业务在路由器中和Internet业务分开，达到单线复用\n\n## 设备\n\n- 路由器: `华硕ac68u` 刷了 `梅林7.5`\n- 电信光猫版本: `TEWA-500E`\n\n<!-- more -->\n\n## 开始\n\n电信光猫之所以可以做到将Internet和IPTV的流量分开，是由于设置了VLAN，所以需要把光猫的VLAN设置让路由器来接管，在路由器上配置Internet和IPTV的VLAN。\n\n### 找到原有的VLAN配置\n\n首先需要拿到光猫的超级管理员的账号密码。\n\n`TEWA-500E`的获取方式比较简单\n\n0. 登录\n\n1. 登录之后，在地址栏中输入 `192.168.1.1/backupsettings.conf` 会下载到光猫的配置文件\n\n2. 打开配置文件，搜索关键字 `telecom` (忽略大小写) 可以找到密码的配置，在`<Password>`中间\n\n  ```xml\n  <X_CT-COM_TeleComAccount>\n    <Password>密码</Password>\n  </X_CT-COM_TeleComAccount>\n  ```\n\n3. 重新登录光猫 账号: `telecomadmin`，密码: `找到的密码`\n\n以超级管理员账号登录后，可以看到VLAN的配置\n\n![image](https://qiniu.wrzsj.top/blog/asset/img/gBwg5J@75_discount)\n![image](https://qiniu.wrzsj.top/blog/asset/img/gBwkS0@75_discount)\n\n需要记下上面两个的VLAN ID\n\nInternet的连接模式**可以**设为桥接（非必须），设为桥接后，则需要在路由器完成拨号。\n\n从上图中可以看到，IPTV的VLAN ID是43，Internet的VLAN ID是1372。\n\n然后在VLAN绑定中添加一组\n\n![image](https://qiniu.wrzsj.top/blog/asset/img/gBwZy1@75_discount)\n\n### 在路由器中(梅林固件)，手动配置VLAN\n\n配置如下\n\n![image](https://qiniu.wrzsj.top/blog/asset/img/gBwwcd@75_discount)\n\n### 连线\n\n将光猫的`lan1`口接入路由器的`wan`（如果Internet业务为桥接模式的话，需要在路由器上完成PPPoE拨号），然后将路由器的`lan4`口接入IPTV盒子。大功告成！\n","slug":"梅林单线复用internet+IPTV","published":1,"updated":"2023-05-28T05:36:04.284Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j00008iubf1pumxhh2","content":"<p><strong>此方法已无效，无法拿到 backupsettings.conf 了，电信后台修复了这个BUG</strong></p><p>由于装修时网络布线问题，需要把电信光猫的IPTV业务在路由器中和Internet业务分开，达到单线复用</p><h2 id=\"设备\"><a href=\"#设备\" class=\"headerlink\" title=\"设备\"></a>设备</h2><ul><li>路由器: <code>华硕ac68u</code> 刷了 <code>梅林7.5</code></li><li>电信光猫版本: <code>TEWA-500E</code></li></ul><a id=\"more\"></a><h2 id=\"开始\"><a href=\"#开始\" class=\"headerlink\" title=\"开始\"></a>开始</h2><p>电信光猫之所以可以做到将Internet和IPTV的流量分开，是由于设置了VLAN，所以需要把光猫的VLAN设置让路由器来接管，在路由器上配置Internet和IPTV的VLAN。</p><h3 id=\"找到原有的VLAN配置\"><a href=\"#找到原有的VLAN配置\" class=\"headerlink\" title=\"找到原有的VLAN配置\"></a>找到原有的VLAN配置</h3><p>首先需要拿到光猫的超级管理员的账号密码。</p><p><code>TEWA-500E</code>的获取方式比较简单</p><ol start=\"0\"><li><p>登录</p></li><li><p>登录之后，在地址栏中输入 <code>192.168.1.1/backupsettings.conf</code> 会下载到光猫的配置文件</p></li><li><p>打开配置文件，搜索关键字 <code>telecom</code> (忽略大小写) 可以找到密码的配置，在<code>&lt;Password&gt;</code>中间</p><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">X_CT-COM_TeleComAccount</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Password</span>&gt;</span>密码<span class=\"tag\">&lt;/<span class=\"name\">Password</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">X_CT-COM_TeleComAccount</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>重新登录光猫 账号: <code>telecomadmin</code>，密码: <code>找到的密码</code></p></li></ol><p>以超级管理员账号登录后，可以看到VLAN的配置</p><p><img src=\"https://qiniu.wrzsj.top/blog/asset/img/gBwg5J@75_discount\" alt=\"image\"> <img src=\"https://qiniu.wrzsj.top/blog/asset/img/gBwkS0@75_discount\" alt=\"image\"></p><p>需要记下上面两个的VLAN ID</p><p>Internet的连接模式<strong>可以</strong>设为桥接（非必须），设为桥接后，则需要在路由器完成拨号。</p><p>从上图中可以看到，IPTV的VLAN ID是43，Internet的VLAN ID是1372。</p><p>然后在VLAN绑定中添加一组</p><p><img src=\"https://qiniu.wrzsj.top/blog/asset/img/gBwZy1@75_discount\" alt=\"image\"></p><h3 id=\"在路由器中-梅林固件-，手动配置VLAN\"><a href=\"#在路由器中-梅林固件-，手动配置VLAN\" class=\"headerlink\" title=\"在路由器中(梅林固件)，手动配置VLAN\"></a>在路由器中(梅林固件)，手动配置VLAN</h3><p>配置如下</p><p><img src=\"https://qiniu.wrzsj.top/blog/asset/img/gBwwcd@75_discount\" alt=\"image\"></p><h3 id=\"连线\"><a href=\"#连线\" class=\"headerlink\" title=\"连线\"></a>连线</h3><p>将光猫的<code>lan1</code>口接入路由器的<code>wan</code>（如果Internet业务为桥接模式的话，需要在路由器上完成PPPoE拨号），然后将路由器的<code>lan4</code>口接入IPTV盒子。大功告成！</p>","site":{"data":{}},"excerpt":"<p><strong>此方法已无效，无法拿到 backupsettings.conf 了，电信后台修复了这个BUG</strong></p><p>由于装修时网络布线问题，需要把电信光猫的IPTV业务在路由器中和Internet业务分开，达到单线复用</p><h2 id=\"设备\"><a href=\"#设备\" class=\"headerlink\" title=\"设备\"></a>设备</h2><ul><li>路由器: <code>华硕ac68u</code> 刷了 <code>梅林7.5</code></li><li>电信光猫版本: <code>TEWA-500E</code></li></ul>","more":"<h2 id=\"开始\"><a href=\"#开始\" class=\"headerlink\" title=\"开始\"></a>开始</h2><p>电信光猫之所以可以做到将Internet和IPTV的流量分开，是由于设置了VLAN，所以需要把光猫的VLAN设置让路由器来接管，在路由器上配置Internet和IPTV的VLAN。</p><h3 id=\"找到原有的VLAN配置\"><a href=\"#找到原有的VLAN配置\" class=\"headerlink\" title=\"找到原有的VLAN配置\"></a>找到原有的VLAN配置</h3><p>首先需要拿到光猫的超级管理员的账号密码。</p><p><code>TEWA-500E</code>的获取方式比较简单</p><ol start=\"0\"><li><p>登录</p></li><li><p>登录之后，在地址栏中输入 <code>192.168.1.1/backupsettings.conf</code> 会下载到光猫的配置文件</p></li><li><p>打开配置文件，搜索关键字 <code>telecom</code> (忽略大小写) 可以找到密码的配置，在<code>&lt;Password&gt;</code>中间</p><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">X_CT-COM_TeleComAccount</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Password</span>&gt;</span>密码<span class=\"tag\">&lt;/<span class=\"name\">Password</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">X_CT-COM_TeleComAccount</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>重新登录光猫 账号: <code>telecomadmin</code>，密码: <code>找到的密码</code></p></li></ol><p>以超级管理员账号登录后，可以看到VLAN的配置</p><p><img src=\"https://qiniu.wrzsj.top/blog/asset/img/gBwg5J@75_discount\" alt=\"image\"> <img src=\"https://qiniu.wrzsj.top/blog/asset/img/gBwkS0@75_discount\" alt=\"image\"></p><p>需要记下上面两个的VLAN ID</p><p>Internet的连接模式<strong>可以</strong>设为桥接（非必须），设为桥接后，则需要在路由器完成拨号。</p><p>从上图中可以看到，IPTV的VLAN ID是43，Internet的VLAN ID是1372。</p><p>然后在VLAN绑定中添加一组</p><p><img src=\"https://qiniu.wrzsj.top/blog/asset/img/gBwZy1@75_discount\" alt=\"image\"></p><h3 id=\"在路由器中-梅林固件-，手动配置VLAN\"><a href=\"#在路由器中-梅林固件-，手动配置VLAN\" class=\"headerlink\" title=\"在路由器中(梅林固件)，手动配置VLAN\"></a>在路由器中(梅林固件)，手动配置VLAN</h3><p>配置如下</p><p><img src=\"https://qiniu.wrzsj.top/blog/asset/img/gBwwcd@75_discount\" alt=\"image\"></p><h3 id=\"连线\"><a href=\"#连线\" class=\"headerlink\" title=\"连线\"></a>连线</h3><p>将光猫的<code>lan1</code>口接入路由器的<code>wan</code>（如果Internet业务为桥接模式的话，需要在路由器上完成PPPoE拨号），然后将路由器的<code>lan4</code>口接入IPTV盒子。大功告成！</p>"},{"title":"Golang reflect 实践","date":"2017-12-27T01:51:00.000Z","_content":"由于最近在用 `golang` 造一个 `query builder + orm` 轮子，过程中很多地方涉及到 `reflect` 包的使用，故写此文章以记录开发中的点滴。\n\n建议先去看下 `golang` 的官方 blog [laws-of-reflection](https://blog.golang.org/laws-of-reflection) 以及 [package文档](https://golang.org/pkg/reflect)\n\n# 场景示例\n\n## 将 `interface{}` 转为 `[]interface{}`\n\n有时候会遇到这样的情况，我们定义了一个函数，函数会接收一个 `interface{}` 类型的参数，并且需要在函数体内将这个参数转为一个 `slice` 即 `[]interface{}`：\n\n```go\npackage main\n\nfunc interfaceSliced(val interface{}) {\n    // TODO: convert `val` into `[]interface{}`\n}\n\nfunc main() {\n    interfaceSliced([]int{1, 2, 3}) // 调用\n}\n```\n\n<!-- more -->\n\n这时我们会需要用到 `reflect` 这个包：\n\n```go\npackage main\n\nimport (\n    \"reflect\"\n    \"fmt\"\n)\n\nfunc interfaceSliced(val interface{}) []interface{} {\n    refObj := reflect.ValueOf(val) // 这里会得到一个reflect.Value对象\n    l := refObj.Len()\n    v := make([]interface{}, l)\n    for i := 0; i < l; i++ {\n        v[i] = refObj.Index(i).Interface()\n    }\n    return v\n}\n\nfunc main() {\n    s := interfaceSliced([]int{1, 2, 3})\n    fmt.Printf(`%T %v`, s, s)\n}\n```\n\n当然，最好再加一些类型判断:\n\n```go\npackage main\n\nimport (\n    \"reflect\"\n    \"errors\"\n    \"fmt\"\n)\n\nfunc interfaceSliced(val interface{}) ([]interface{}, error) {\n    refObj := reflect.ValueOf(val) // 这里会得到一个reflect.Value对象\n    if refObj.Kind() != reflect.Slice {\n        return nil, errors.New(\"val should be a slice\")\n    }\n    l := refObj.Len()\n    v := make([]interface{}, l)\n    for i := 0; i < l; i++ {\n        v[i] = refObj.Index(i).Interface()\n    }\n    return v, nil\n}\n\nfunc main() {\n    s, err := interfaceSliced([]int{1, 2, 3})\n    fmt.Printf(`%T %v | %v`, s, s, err)\n}\n```\n\n## 判断 `struct` 中是否拥有某方法，如果有，则调用并获取其返回值\n\n这个需求的出现是由于想要实现Model的一些特性，比如我们定义了一个名叫 `User` 的 `struct` 来作为 `Model` ，正常来说该 `Model` 对应的表名称为 `users` 。\n但是如果实际情况中，我们的表名称并不一定是完全按照 `CamelCaseSingular to snake_case_plural` 来映射了。\n这时，一般的做法是在 `Model` 中定义一个方法或者属性来显示申明对应的表名称：\n\n```go\npackage main\n\ntype User struct {\n    ID   int\n    Name string\n}\n\nfunc (User) TableName() string {\n    return \"employees\"\n}\n```\n\n上述代码中，我们定义了一个 `Model` 并且约定用 `TableName()` 方法来显示地申明了该 `Model` 对应的表名称。\n我们在解析 Model 的时候就需要去判断是否存在 `TableName()` 方法，如果存在，则调用，从而获取表名称；如果不存在，则按照 `CamelCaseSingular to snake_case_plural` 的原则来得到表名称。\n想要实现这个功能，则需要用到 `reflect` 包和其中的 [`MethodByName()方法`](https://golang.org/pkg/reflect/#Type)\n\n文档：\n```go\ntype Type interface {\n    // MethodByName returns the method with that name in the type's\n    // method set and a boolean indicating if the method was found.\n    //\n    // For a non-interface type T or *T, the returned Method's Type and Func\n    // fields describe a function whose first argument is the receiver.\n    //\n    // For an interface type, the returned Method's Type field gives the\n    // method signature, without a receiver, and the Func field is nil.\n    MethodByName(string) (Method, bool)\n\n    // ...\n```\n\n代码实现：\n\n```go\npackage main\n\nimport (\n    \"reflect\"\n)\n\nfunc findOutTableName(struc interface{}) string {\n    v := reflect.ValueOf(struc)\n    typ := v.Type()\n    var tbName string\n    if _, ok := typ.MethodByName(\"TableName\"); ok {\n        // 如果存在，则调用\n        tbName = v.MethodByName(\"TableName\").Call(nil)[0].String()\n    }\n    if tbName == \"\" {\n        // TODO: CamelCaseSingular to snake_case_plural\n    }\n    return tbName\n}\n```\n\n两块代码合在一起：\n\n```go\npackage main\n\nimport (\n    \"fmt\"\n    \"reflect\"\n)\n\n// User stands for User Model\ntype User struct {\n    ID   int\n    Name string\n}\n\n// TableName specifies the table name of User Model\nfunc (User) TableName() string {\n    return \"employees\"\n}\n\nfunc findOutTableName(struc interface{}) string {\n    v := reflect.ValueOf(struc)\n    typ := v.Type()\n    var tbName string\n    if _, ok := typ.MethodByName(\"TableName\"); ok {\n        tbName = v.MethodByName(\"TableName\").Call(nil)[0].String()\n    }\n    if tbName == \"\" {\n        // TODO: CamelCaseSinglar to snake_case_plural 这里就不做演示了\n    }\n    return tbName\n}\n\nfunc main() {\n    user := User{}\n    fmt.Println(findOutTableName(user)) // employees\n}\n```\n\n---\n\nTo be continued...\n","source":"_posts/2017-12-27-Golang-reflect-实践.md","raw":"---\ntitle: Golang reflect 实践\ndate: 2017-12-27 09:51:00\ntags:\n- golang\ncategories:\n- 笔记\n---\n由于最近在用 `golang` 造一个 `query builder + orm` 轮子，过程中很多地方涉及到 `reflect` 包的使用，故写此文章以记录开发中的点滴。\n\n建议先去看下 `golang` 的官方 blog [laws-of-reflection](https://blog.golang.org/laws-of-reflection) 以及 [package文档](https://golang.org/pkg/reflect)\n\n# 场景示例\n\n## 将 `interface{}` 转为 `[]interface{}`\n\n有时候会遇到这样的情况，我们定义了一个函数，函数会接收一个 `interface{}` 类型的参数，并且需要在函数体内将这个参数转为一个 `slice` 即 `[]interface{}`：\n\n```go\npackage main\n\nfunc interfaceSliced(val interface{}) {\n    // TODO: convert `val` into `[]interface{}`\n}\n\nfunc main() {\n    interfaceSliced([]int{1, 2, 3}) // 调用\n}\n```\n\n<!-- more -->\n\n这时我们会需要用到 `reflect` 这个包：\n\n```go\npackage main\n\nimport (\n    \"reflect\"\n    \"fmt\"\n)\n\nfunc interfaceSliced(val interface{}) []interface{} {\n    refObj := reflect.ValueOf(val) // 这里会得到一个reflect.Value对象\n    l := refObj.Len()\n    v := make([]interface{}, l)\n    for i := 0; i < l; i++ {\n        v[i] = refObj.Index(i).Interface()\n    }\n    return v\n}\n\nfunc main() {\n    s := interfaceSliced([]int{1, 2, 3})\n    fmt.Printf(`%T %v`, s, s)\n}\n```\n\n当然，最好再加一些类型判断:\n\n```go\npackage main\n\nimport (\n    \"reflect\"\n    \"errors\"\n    \"fmt\"\n)\n\nfunc interfaceSliced(val interface{}) ([]interface{}, error) {\n    refObj := reflect.ValueOf(val) // 这里会得到一个reflect.Value对象\n    if refObj.Kind() != reflect.Slice {\n        return nil, errors.New(\"val should be a slice\")\n    }\n    l := refObj.Len()\n    v := make([]interface{}, l)\n    for i := 0; i < l; i++ {\n        v[i] = refObj.Index(i).Interface()\n    }\n    return v, nil\n}\n\nfunc main() {\n    s, err := interfaceSliced([]int{1, 2, 3})\n    fmt.Printf(`%T %v | %v`, s, s, err)\n}\n```\n\n## 判断 `struct` 中是否拥有某方法，如果有，则调用并获取其返回值\n\n这个需求的出现是由于想要实现Model的一些特性，比如我们定义了一个名叫 `User` 的 `struct` 来作为 `Model` ，正常来说该 `Model` 对应的表名称为 `users` 。\n但是如果实际情况中，我们的表名称并不一定是完全按照 `CamelCaseSingular to snake_case_plural` 来映射了。\n这时，一般的做法是在 `Model` 中定义一个方法或者属性来显示申明对应的表名称：\n\n```go\npackage main\n\ntype User struct {\n    ID   int\n    Name string\n}\n\nfunc (User) TableName() string {\n    return \"employees\"\n}\n```\n\n上述代码中，我们定义了一个 `Model` 并且约定用 `TableName()` 方法来显示地申明了该 `Model` 对应的表名称。\n我们在解析 Model 的时候就需要去判断是否存在 `TableName()` 方法，如果存在，则调用，从而获取表名称；如果不存在，则按照 `CamelCaseSingular to snake_case_plural` 的原则来得到表名称。\n想要实现这个功能，则需要用到 `reflect` 包和其中的 [`MethodByName()方法`](https://golang.org/pkg/reflect/#Type)\n\n文档：\n```go\ntype Type interface {\n    // MethodByName returns the method with that name in the type's\n    // method set and a boolean indicating if the method was found.\n    //\n    // For a non-interface type T or *T, the returned Method's Type and Func\n    // fields describe a function whose first argument is the receiver.\n    //\n    // For an interface type, the returned Method's Type field gives the\n    // method signature, without a receiver, and the Func field is nil.\n    MethodByName(string) (Method, bool)\n\n    // ...\n```\n\n代码实现：\n\n```go\npackage main\n\nimport (\n    \"reflect\"\n)\n\nfunc findOutTableName(struc interface{}) string {\n    v := reflect.ValueOf(struc)\n    typ := v.Type()\n    var tbName string\n    if _, ok := typ.MethodByName(\"TableName\"); ok {\n        // 如果存在，则调用\n        tbName = v.MethodByName(\"TableName\").Call(nil)[0].String()\n    }\n    if tbName == \"\" {\n        // TODO: CamelCaseSingular to snake_case_plural\n    }\n    return tbName\n}\n```\n\n两块代码合在一起：\n\n```go\npackage main\n\nimport (\n    \"fmt\"\n    \"reflect\"\n)\n\n// User stands for User Model\ntype User struct {\n    ID   int\n    Name string\n}\n\n// TableName specifies the table name of User Model\nfunc (User) TableName() string {\n    return \"employees\"\n}\n\nfunc findOutTableName(struc interface{}) string {\n    v := reflect.ValueOf(struc)\n    typ := v.Type()\n    var tbName string\n    if _, ok := typ.MethodByName(\"TableName\"); ok {\n        tbName = v.MethodByName(\"TableName\").Call(nil)[0].String()\n    }\n    if tbName == \"\" {\n        // TODO: CamelCaseSinglar to snake_case_plural 这里就不做演示了\n    }\n    return tbName\n}\n\nfunc main() {\n    user := User{}\n    fmt.Println(findOutTableName(user)) // employees\n}\n```\n\n---\n\nTo be continued...\n","slug":"Golang-reflect-实践","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j00009iubf4dpogemv","content":"<p>由于最近在用 <code>golang</code> 造一个 <code>query builder + orm</code> 轮子，过程中很多地方涉及到 <code>reflect</code> 包的使用，故写此文章以记录开发中的点滴。</p><p>建议先去看下 <code>golang</code> 的官方 blog <a href=\"https://blog.golang.org/laws-of-reflection\" target=\"_blank\" rel=\"noopener\">laws-of-reflection</a> 以及 <a href=\"https://golang.org/pkg/reflect\" target=\"_blank\" rel=\"noopener\">package文档</a></p><h1 id=\"场景示例\"><a href=\"#场景示例\" class=\"headerlink\" title=\"场景示例\"></a>场景示例</h1><h2 id=\"将-interface-转为-interface\"><a href=\"#将-interface-转为-interface\" class=\"headerlink\" title=\"将 interface{} 转为 []interface{}\"></a>将 <code>interface{}</code> 转为 <code>[]interface{}</code></h2><p>有时候会遇到这样的情况，我们定义了一个函数，函数会接收一个 <code>interface{}</code> 类型的参数，并且需要在函数体内将这个参数转为一个 <code>slice</code> 即 <code>[]interface{}</code>：</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">interfaceSliced</span><span class=\"params\">(val <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// <span class=\"doctag\">TODO:</span> convert `val` into `[]interface&#123;&#125;`</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    interfaceSliced([]<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;) <span class=\"comment\">// 调用</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><a id=\"more\"></a><p>这时我们会需要用到 <code>reflect</code> 这个包：</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"reflect\"</span></span><br><span class=\"line\">    <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">interfaceSliced</span><span class=\"params\">(val <span class=\"keyword\">interface</span>&#123;&#125;)</span> []<span class=\"title\">interface</span></span>&#123;&#125; &#123;</span><br><span class=\"line\">    refObj := reflect.ValueOf(val) <span class=\"comment\">// 这里会得到一个reflect.Value对象</span></span><br><span class=\"line\">    l := refObj.Len()</span><br><span class=\"line\">    v := <span class=\"built_in\">make</span>([]<span class=\"keyword\">interface</span>&#123;&#125;, l)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; l; i++ &#123;</span><br><span class=\"line\">        v[i] = refObj.Index(i).Interface()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> v</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    s := interfaceSliced([]<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;)</span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">`%T %v`</span>, s, s)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>当然，最好再加一些类型判断:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"reflect\"</span></span><br><span class=\"line\">    <span class=\"string\">\"errors\"</span></span><br><span class=\"line\">    <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">interfaceSliced</span><span class=\"params\">(val <span class=\"keyword\">interface</span>&#123;&#125;)</span> <span class=\"params\">([]<span class=\"keyword\">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class=\"line\">    refObj := reflect.ValueOf(val) <span class=\"comment\">// 这里会得到一个reflect.Value对象</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> refObj.Kind() != reflect.Slice &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, errors.New(<span class=\"string\">\"val should be a slice\"</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    l := refObj.Len()</span><br><span class=\"line\">    v := <span class=\"built_in\">make</span>([]<span class=\"keyword\">interface</span>&#123;&#125;, l)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; l; i++ &#123;</span><br><span class=\"line\">        v[i] = refObj.Index(i).Interface()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> v, <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    s, err := interfaceSliced([]<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;)</span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">`%T %v | %v`</span>, s, s, err)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><h2 id=\"判断-struct-中是否拥有某方法，如果有，则调用并获取其返回值\"><a href=\"#判断-struct-中是否拥有某方法，如果有，则调用并获取其返回值\" class=\"headerlink\" title=\"判断 struct 中是否拥有某方法，如果有，则调用并获取其返回值\"></a>判断 <code>struct</code> 中是否拥有某方法，如果有，则调用并获取其返回值</h2><p>这个需求的出现是由于想要实现Model的一些特性，比如我们定义了一个名叫 <code>User</code> 的 <code>struct</code> 来作为 <code>Model</code> ，正常来说该 <code>Model</code> 对应的表名称为 <code>users</code> 。 但是如果实际情况中，我们的表名称并不一定是完全按照 <code>CamelCaseSingular to snake_case_plural</code> 来映射了。 这时，一般的做法是在 <code>Model</code> 中定义一个方法或者属性来显示申明对应的表名称：</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> User <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    ID   <span class=\"keyword\">int</span></span><br><span class=\"line\">    Name <span class=\"keyword\">string</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(User)</span> <span class=\"title\">TableName</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">\"employees\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>上述代码中，我们定义了一个 <code>Model</code> 并且约定用 <code>TableName()</code> 方法来显示地申明了该 <code>Model</code> 对应的表名称。 我们在解析 Model 的时候就需要去判断是否存在 <code>TableName()</code> 方法，如果存在，则调用，从而获取表名称；如果不存在，则按照 <code>CamelCaseSingular to snake_case_plural</code> 的原则来得到表名称。 想要实现这个功能，则需要用到 <code>reflect</code> 包和其中的 <a href=\"https://golang.org/pkg/reflect/#Type\" target=\"_blank\" rel=\"noopener\"><code>MethodByName()方法</code></a></p><p>文档：</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Type <span class=\"keyword\">interface</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// MethodByName returns the method with that name in the type's</span></span><br><span class=\"line\">    <span class=\"comment\">// method set and a boolean indicating if the method was found.</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// For a non-interface type T or *T, the returned Method's Type and Func</span></span><br><span class=\"line\">    <span class=\"comment\">// fields describe a function whose first argument is the receiver.</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// For an interface type, the returned Method's Type field gives the</span></span><br><span class=\"line\">    <span class=\"comment\">// method signature, without a receiver, and the Func field is nil.</span></span><br><span class=\"line\">    MethodByName(<span class=\"keyword\">string</span>) (Method, <span class=\"keyword\">bool</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure><p></p><p>代码实现：</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"reflect\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">findOutTableName</span><span class=\"params\">(struc <span class=\"keyword\">interface</span>&#123;&#125;)</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">    v := reflect.ValueOf(struc)</span><br><span class=\"line\">    typ := v.Type()</span><br><span class=\"line\">    <span class=\"keyword\">var</span> tbName <span class=\"keyword\">string</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> _, ok := typ.MethodByName(<span class=\"string\">\"TableName\"</span>); ok &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果存在，则调用</span></span><br><span class=\"line\">        tbName = v.MethodByName(<span class=\"string\">\"TableName\"</span>).Call(<span class=\"literal\">nil</span>)[<span class=\"number\">0</span>].String()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> tbName == <span class=\"string\">\"\"</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// <span class=\"doctag\">TODO:</span> CamelCaseSingular to snake_case_plural</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> tbName</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>两块代码合在一起：</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">    <span class=\"string\">\"reflect\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// User stands for User Model</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> User <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    ID   <span class=\"keyword\">int</span></span><br><span class=\"line\">    Name <span class=\"keyword\">string</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// TableName specifies the table name of User Model</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(User)</span> <span class=\"title\">TableName</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">\"employees\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">findOutTableName</span><span class=\"params\">(struc <span class=\"keyword\">interface</span>&#123;&#125;)</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">    v := reflect.ValueOf(struc)</span><br><span class=\"line\">    typ := v.Type()</span><br><span class=\"line\">    <span class=\"keyword\">var</span> tbName <span class=\"keyword\">string</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> _, ok := typ.MethodByName(<span class=\"string\">\"TableName\"</span>); ok &#123;</span><br><span class=\"line\">        tbName = v.MethodByName(<span class=\"string\">\"TableName\"</span>).Call(<span class=\"literal\">nil</span>)[<span class=\"number\">0</span>].String()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> tbName == <span class=\"string\">\"\"</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// <span class=\"doctag\">TODO:</span> CamelCaseSinglar to snake_case_plural 这里就不做演示了</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> tbName</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    user := User&#123;&#125;</span><br><span class=\"line\">    fmt.Println(findOutTableName(user)) <span class=\"comment\">// employees</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><hr><p>To be continued...</p>","site":{"data":{}},"excerpt":"<p>由于最近在用 <code>golang</code> 造一个 <code>query builder + orm</code> 轮子，过程中很多地方涉及到 <code>reflect</code> 包的使用，故写此文章以记录开发中的点滴。</p><p>建议先去看下 <code>golang</code> 的官方 blog <a href=\"https://blog.golang.org/laws-of-reflection\" target=\"_blank\" rel=\"noopener\">laws-of-reflection</a> 以及 <a href=\"https://golang.org/pkg/reflect\" target=\"_blank\" rel=\"noopener\">package文档</a></p><h1 id=\"场景示例\"><a href=\"#场景示例\" class=\"headerlink\" title=\"场景示例\"></a>场景示例</h1><h2 id=\"将-interface-转为-interface\"><a href=\"#将-interface-转为-interface\" class=\"headerlink\" title=\"将 interface{} 转为 []interface{}\"></a>将 <code>interface{}</code> 转为 <code>[]interface{}</code></h2><p>有时候会遇到这样的情况，我们定义了一个函数，函数会接收一个 <code>interface{}</code> 类型的参数，并且需要在函数体内将这个参数转为一个 <code>slice</code> 即 <code>[]interface{}</code>：</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">interfaceSliced</span><span class=\"params\">(val <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// <span class=\"doctag\">TODO:</span> convert `val` into `[]interface&#123;&#125;`</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    interfaceSliced([]<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;) <span class=\"comment\">// 调用</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","more":"<p>这时我们会需要用到 <code>reflect</code> 这个包：</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"reflect\"</span></span><br><span class=\"line\">    <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">interfaceSliced</span><span class=\"params\">(val <span class=\"keyword\">interface</span>&#123;&#125;)</span> []<span class=\"title\">interface</span></span>&#123;&#125; &#123;</span><br><span class=\"line\">    refObj := reflect.ValueOf(val) <span class=\"comment\">// 这里会得到一个reflect.Value对象</span></span><br><span class=\"line\">    l := refObj.Len()</span><br><span class=\"line\">    v := <span class=\"built_in\">make</span>([]<span class=\"keyword\">interface</span>&#123;&#125;, l)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; l; i++ &#123;</span><br><span class=\"line\">        v[i] = refObj.Index(i).Interface()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> v</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    s := interfaceSliced([]<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;)</span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">`%T %v`</span>, s, s)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>当然，最好再加一些类型判断:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"reflect\"</span></span><br><span class=\"line\">    <span class=\"string\">\"errors\"</span></span><br><span class=\"line\">    <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">interfaceSliced</span><span class=\"params\">(val <span class=\"keyword\">interface</span>&#123;&#125;)</span> <span class=\"params\">([]<span class=\"keyword\">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class=\"line\">    refObj := reflect.ValueOf(val) <span class=\"comment\">// 这里会得到一个reflect.Value对象</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> refObj.Kind() != reflect.Slice &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, errors.New(<span class=\"string\">\"val should be a slice\"</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    l := refObj.Len()</span><br><span class=\"line\">    v := <span class=\"built_in\">make</span>([]<span class=\"keyword\">interface</span>&#123;&#125;, l)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; l; i++ &#123;</span><br><span class=\"line\">        v[i] = refObj.Index(i).Interface()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> v, <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    s, err := interfaceSliced([]<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125;)</span><br><span class=\"line\">    fmt.Printf(<span class=\"string\">`%T %v | %v`</span>, s, s, err)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><h2 id=\"判断-struct-中是否拥有某方法，如果有，则调用并获取其返回值\"><a href=\"#判断-struct-中是否拥有某方法，如果有，则调用并获取其返回值\" class=\"headerlink\" title=\"判断 struct 中是否拥有某方法，如果有，则调用并获取其返回值\"></a>判断 <code>struct</code> 中是否拥有某方法，如果有，则调用并获取其返回值</h2><p>这个需求的出现是由于想要实现Model的一些特性，比如我们定义了一个名叫 <code>User</code> 的 <code>struct</code> 来作为 <code>Model</code> ，正常来说该 <code>Model</code> 对应的表名称为 <code>users</code> 。 但是如果实际情况中，我们的表名称并不一定是完全按照 <code>CamelCaseSingular to snake_case_plural</code> 来映射了。 这时，一般的做法是在 <code>Model</code> 中定义一个方法或者属性来显示申明对应的表名称：</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> User <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    ID   <span class=\"keyword\">int</span></span><br><span class=\"line\">    Name <span class=\"keyword\">string</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(User)</span> <span class=\"title\">TableName</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">\"employees\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>上述代码中，我们定义了一个 <code>Model</code> 并且约定用 <code>TableName()</code> 方法来显示地申明了该 <code>Model</code> 对应的表名称。 我们在解析 Model 的时候就需要去判断是否存在 <code>TableName()</code> 方法，如果存在，则调用，从而获取表名称；如果不存在，则按照 <code>CamelCaseSingular to snake_case_plural</code> 的原则来得到表名称。 想要实现这个功能，则需要用到 <code>reflect</code> 包和其中的 <a href=\"https://golang.org/pkg/reflect/#Type\" target=\"_blank\" rel=\"noopener\"><code>MethodByName()方法</code></a></p><p>文档：</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Type <span class=\"keyword\">interface</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// MethodByName returns the method with that name in the type's</span></span><br><span class=\"line\">    <span class=\"comment\">// method set and a boolean indicating if the method was found.</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// For a non-interface type T or *T, the returned Method's Type and Func</span></span><br><span class=\"line\">    <span class=\"comment\">// fields describe a function whose first argument is the receiver.</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"comment\">// For an interface type, the returned Method's Type field gives the</span></span><br><span class=\"line\">    <span class=\"comment\">// method signature, without a receiver, and the Func field is nil.</span></span><br><span class=\"line\">    MethodByName(<span class=\"keyword\">string</span>) (Method, <span class=\"keyword\">bool</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br></pre></td></tr></table></figure><p></p><p>代码实现：</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"reflect\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">findOutTableName</span><span class=\"params\">(struc <span class=\"keyword\">interface</span>&#123;&#125;)</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">    v := reflect.ValueOf(struc)</span><br><span class=\"line\">    typ := v.Type()</span><br><span class=\"line\">    <span class=\"keyword\">var</span> tbName <span class=\"keyword\">string</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> _, ok := typ.MethodByName(<span class=\"string\">\"TableName\"</span>); ok &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果存在，则调用</span></span><br><span class=\"line\">        tbName = v.MethodByName(<span class=\"string\">\"TableName\"</span>).Call(<span class=\"literal\">nil</span>)[<span class=\"number\">0</span>].String()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> tbName == <span class=\"string\">\"\"</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// <span class=\"doctag\">TODO:</span> CamelCaseSingular to snake_case_plural</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> tbName</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>两块代码合在一起：</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">    <span class=\"string\">\"reflect\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// User stands for User Model</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> User <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    ID   <span class=\"keyword\">int</span></span><br><span class=\"line\">    Name <span class=\"keyword\">string</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// TableName specifies the table name of User Model</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(User)</span> <span class=\"title\">TableName</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">\"employees\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">findOutTableName</span><span class=\"params\">(struc <span class=\"keyword\">interface</span>&#123;&#125;)</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">    v := reflect.ValueOf(struc)</span><br><span class=\"line\">    typ := v.Type()</span><br><span class=\"line\">    <span class=\"keyword\">var</span> tbName <span class=\"keyword\">string</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> _, ok := typ.MethodByName(<span class=\"string\">\"TableName\"</span>); ok &#123;</span><br><span class=\"line\">        tbName = v.MethodByName(<span class=\"string\">\"TableName\"</span>).Call(<span class=\"literal\">nil</span>)[<span class=\"number\">0</span>].String()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> tbName == <span class=\"string\">\"\"</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// <span class=\"doctag\">TODO:</span> CamelCaseSinglar to snake_case_plural 这里就不做演示了</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> tbName</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    user := User&#123;&#125;</span><br><span class=\"line\">    fmt.Println(findOutTableName(user)) <span class=\"comment\">// employees</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><hr><p>To be continued...</p>"},{"title":"关于装修的感悟","date":"2018-01-03T02:12:55.000Z","_content":"# 序言\n\n2017年结束了，其实没有什么好review的，设定的计划基本都没完成，甚至忘记了设定了哪些计划。。。\n\n不过最后悔的事情还是想记录一下，以此为鉴，望不再犯。\n\n整个2017年最后悔的事情当属新房装修了。装修其实从2016年就开始了，耗时整整一年多！漫长的工期结束后，房子却任然漏洞百出。\n抛开施工队的种种不专业，出现这种令人不满意的结果其实也和我自身有很大关系。\n\n下面来总结下失败的地方：\n\n# 硬装部分\n\n硬装可谓是整个家风格样式的基础，十分重要，坑也特别多，工人素质也参差不齐，整体很难把控。一旦完工之后，也很难调整和更换。\n所以有必要记录下在硬装部分踩到的坑。\n\n<!-- more -->\n\n## 装修之前\n\n- 做好充分的准备，多了解，多学习，如果没有时间，就不要去计划。\n- 要仔细面试下设计师。\n- 不要选择全包，瓷砖，门什么的还是要自己去选牌子货，然后让厂家的工人来施工。\n- 花钱请第三方监理。\n\n## 打拆\n\n- 如果打掉了飘窗，一定要想办法避免雨飘进来把墙壁打湿的问题。\n- 如果对开发商配的入户门不满意，这时就直接换掉。\n\n## 水电改造\n\n- 如果开发商预置的弱电箱不是很好，这时就直接要求换掉。\n- 弱电箱的位置不要和鞋柜位置重叠，也就是说不要把弱电箱藏到鞋柜里面。\n- 网线要求质量和品牌，自己买也行。\n- 每个房间都要有网线，客厅一定要留至少两个网线口，一进一出。\n- 要统一PVC盒子，不要同时使用开发商预置的和水电改造新装上的。\n- PVC盒子的深浅高矮方向要保持一致。\n- 用来穿线的PVC管子，尽量保持管内干净，不要让水泥石子落入管内。\n- 和装修公司约定好要有电路布线图。如果没有，一定要拍照记录。\n- 如果要安装马桶，提前想好安放方向，量好孔距，并且在旁边留一个插座。\n\n## 找平\n\n- 墙体，地面的找平都很重要，务必做好！\n\n## 贴砖\n\n- 要求砖工贴的时候，控制缝隙间距，保持缝隙间距一致，方便后期做美缝。\n- 如果有生活阳台，需要在阳台的墙壁上贴砖。\n- 地漏提前买好，叮嘱工人不要把水泥弄到地漏的螺纹上。\n- 叮嘱工人不要把水泥弄到其他地方，比如说地漏的螺纹，花洒水阀等。\n- 提前和工人沟通好阴角阳角的处理方式。\n- 吊顶要用铝扣板，干区和湿区都要。\n\n---\n\n总结的这些，希望可以为下一次装修积累一些经验，避免再犯。\n","source":"_posts/2018-01-03-关于装修的感悟.md","raw":"---\ntitle: 关于装修的感悟\ndate: 2018-01-03 10:12:55\ntags:\ncategories:\n- 随笔\n---\n# 序言\n\n2017年结束了，其实没有什么好review的，设定的计划基本都没完成，甚至忘记了设定了哪些计划。。。\n\n不过最后悔的事情还是想记录一下，以此为鉴，望不再犯。\n\n整个2017年最后悔的事情当属新房装修了。装修其实从2016年就开始了，耗时整整一年多！漫长的工期结束后，房子却任然漏洞百出。\n抛开施工队的种种不专业，出现这种令人不满意的结果其实也和我自身有很大关系。\n\n下面来总结下失败的地方：\n\n# 硬装部分\n\n硬装可谓是整个家风格样式的基础，十分重要，坑也特别多，工人素质也参差不齐，整体很难把控。一旦完工之后，也很难调整和更换。\n所以有必要记录下在硬装部分踩到的坑。\n\n<!-- more -->\n\n## 装修之前\n\n- 做好充分的准备，多了解，多学习，如果没有时间，就不要去计划。\n- 要仔细面试下设计师。\n- 不要选择全包，瓷砖，门什么的还是要自己去选牌子货，然后让厂家的工人来施工。\n- 花钱请第三方监理。\n\n## 打拆\n\n- 如果打掉了飘窗，一定要想办法避免雨飘进来把墙壁打湿的问题。\n- 如果对开发商配的入户门不满意，这时就直接换掉。\n\n## 水电改造\n\n- 如果开发商预置的弱电箱不是很好，这时就直接要求换掉。\n- 弱电箱的位置不要和鞋柜位置重叠，也就是说不要把弱电箱藏到鞋柜里面。\n- 网线要求质量和品牌，自己买也行。\n- 每个房间都要有网线，客厅一定要留至少两个网线口，一进一出。\n- 要统一PVC盒子，不要同时使用开发商预置的和水电改造新装上的。\n- PVC盒子的深浅高矮方向要保持一致。\n- 用来穿线的PVC管子，尽量保持管内干净，不要让水泥石子落入管内。\n- 和装修公司约定好要有电路布线图。如果没有，一定要拍照记录。\n- 如果要安装马桶，提前想好安放方向，量好孔距，并且在旁边留一个插座。\n\n## 找平\n\n- 墙体，地面的找平都很重要，务必做好！\n\n## 贴砖\n\n- 要求砖工贴的时候，控制缝隙间距，保持缝隙间距一致，方便后期做美缝。\n- 如果有生活阳台，需要在阳台的墙壁上贴砖。\n- 地漏提前买好，叮嘱工人不要把水泥弄到地漏的螺纹上。\n- 叮嘱工人不要把水泥弄到其他地方，比如说地漏的螺纹，花洒水阀等。\n- 提前和工人沟通好阴角阳角的处理方式。\n- 吊顶要用铝扣板，干区和湿区都要。\n\n---\n\n总结的这些，希望可以为下一次装修积累一些经验，避免再犯。\n","slug":"关于装修的感悟","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j1000aiubfa52nolna","content":"<h1 id=\"序言\"><a href=\"#序言\" class=\"headerlink\" title=\"序言\"></a>序言</h1><p>2017年结束了，其实没有什么好review的，设定的计划基本都没完成，甚至忘记了设定了哪些计划。。。</p><p>不过最后悔的事情还是想记录一下，以此为鉴，望不再犯。</p><p>整个2017年最后悔的事情当属新房装修了。装修其实从2016年就开始了，耗时整整一年多！漫长的工期结束后，房子却任然漏洞百出。 抛开施工队的种种不专业，出现这种令人不满意的结果其实也和我自身有很大关系。</p><p>下面来总结下失败的地方：</p><h1 id=\"硬装部分\"><a href=\"#硬装部分\" class=\"headerlink\" title=\"硬装部分\"></a>硬装部分</h1><p>硬装可谓是整个家风格样式的基础，十分重要，坑也特别多，工人素质也参差不齐，整体很难把控。一旦完工之后，也很难调整和更换。 所以有必要记录下在硬装部分踩到的坑。</p><a id=\"more\"></a><h2 id=\"装修之前\"><a href=\"#装修之前\" class=\"headerlink\" title=\"装修之前\"></a>装修之前</h2><ul><li>做好充分的准备，多了解，多学习，如果没有时间，就不要去计划。</li><li>要仔细面试下设计师。</li><li>不要选择全包，瓷砖，门什么的还是要自己去选牌子货，然后让厂家的工人来施工。</li><li>花钱请第三方监理。</li></ul><h2 id=\"打拆\"><a href=\"#打拆\" class=\"headerlink\" title=\"打拆\"></a>打拆</h2><ul><li>如果打掉了飘窗，一定要想办法避免雨飘进来把墙壁打湿的问题。</li><li>如果对开发商配的入户门不满意，这时就直接换掉。</li></ul><h2 id=\"水电改造\"><a href=\"#水电改造\" class=\"headerlink\" title=\"水电改造\"></a>水电改造</h2><ul><li>如果开发商预置的弱电箱不是很好，这时就直接要求换掉。</li><li>弱电箱的位置不要和鞋柜位置重叠，也就是说不要把弱电箱藏到鞋柜里面。</li><li>网线要求质量和品牌，自己买也行。</li><li>每个房间都要有网线，客厅一定要留至少两个网线口，一进一出。</li><li>要统一PVC盒子，不要同时使用开发商预置的和水电改造新装上的。</li><li>PVC盒子的深浅高矮方向要保持一致。</li><li>用来穿线的PVC管子，尽量保持管内干净，不要让水泥石子落入管内。</li><li>和装修公司约定好要有电路布线图。如果没有，一定要拍照记录。</li><li>如果要安装马桶，提前想好安放方向，量好孔距，并且在旁边留一个插座。</li></ul><h2 id=\"找平\"><a href=\"#找平\" class=\"headerlink\" title=\"找平\"></a>找平</h2><ul><li>墙体，地面的找平都很重要，务必做好！</li></ul><h2 id=\"贴砖\"><a href=\"#贴砖\" class=\"headerlink\" title=\"贴砖\"></a>贴砖</h2><ul><li>要求砖工贴的时候，控制缝隙间距，保持缝隙间距一致，方便后期做美缝。</li><li>如果有生活阳台，需要在阳台的墙壁上贴砖。</li><li>地漏提前买好，叮嘱工人不要把水泥弄到地漏的螺纹上。</li><li>叮嘱工人不要把水泥弄到其他地方，比如说地漏的螺纹，花洒水阀等。</li><li>提前和工人沟通好阴角阳角的处理方式。</li><li>吊顶要用铝扣板，干区和湿区都要。</li></ul><hr><p>总结的这些，希望可以为下一次装修积累一些经验，避免再犯。</p>","site":{"data":{}},"excerpt":"<h1 id=\"序言\"><a href=\"#序言\" class=\"headerlink\" title=\"序言\"></a>序言</h1><p>2017年结束了，其实没有什么好review的，设定的计划基本都没完成，甚至忘记了设定了哪些计划。。。</p><p>不过最后悔的事情还是想记录一下，以此为鉴，望不再犯。</p><p>整个2017年最后悔的事情当属新房装修了。装修其实从2016年就开始了，耗时整整一年多！漫长的工期结束后，房子却任然漏洞百出。 抛开施工队的种种不专业，出现这种令人不满意的结果其实也和我自身有很大关系。</p><p>下面来总结下失败的地方：</p><h1 id=\"硬装部分\"><a href=\"#硬装部分\" class=\"headerlink\" title=\"硬装部分\"></a>硬装部分</h1><p>硬装可谓是整个家风格样式的基础，十分重要，坑也特别多，工人素质也参差不齐，整体很难把控。一旦完工之后，也很难调整和更换。 所以有必要记录下在硬装部分踩到的坑。</p>","more":"<h2 id=\"装修之前\"><a href=\"#装修之前\" class=\"headerlink\" title=\"装修之前\"></a>装修之前</h2><ul><li>做好充分的准备，多了解，多学习，如果没有时间，就不要去计划。</li><li>要仔细面试下设计师。</li><li>不要选择全包，瓷砖，门什么的还是要自己去选牌子货，然后让厂家的工人来施工。</li><li>花钱请第三方监理。</li></ul><h2 id=\"打拆\"><a href=\"#打拆\" class=\"headerlink\" title=\"打拆\"></a>打拆</h2><ul><li>如果打掉了飘窗，一定要想办法避免雨飘进来把墙壁打湿的问题。</li><li>如果对开发商配的入户门不满意，这时就直接换掉。</li></ul><h2 id=\"水电改造\"><a href=\"#水电改造\" class=\"headerlink\" title=\"水电改造\"></a>水电改造</h2><ul><li>如果开发商预置的弱电箱不是很好，这时就直接要求换掉。</li><li>弱电箱的位置不要和鞋柜位置重叠，也就是说不要把弱电箱藏到鞋柜里面。</li><li>网线要求质量和品牌，自己买也行。</li><li>每个房间都要有网线，客厅一定要留至少两个网线口，一进一出。</li><li>要统一PVC盒子，不要同时使用开发商预置的和水电改造新装上的。</li><li>PVC盒子的深浅高矮方向要保持一致。</li><li>用来穿线的PVC管子，尽量保持管内干净，不要让水泥石子落入管内。</li><li>和装修公司约定好要有电路布线图。如果没有，一定要拍照记录。</li><li>如果要安装马桶，提前想好安放方向，量好孔距，并且在旁边留一个插座。</li></ul><h2 id=\"找平\"><a href=\"#找平\" class=\"headerlink\" title=\"找平\"></a>找平</h2><ul><li>墙体，地面的找平都很重要，务必做好！</li></ul><h2 id=\"贴砖\"><a href=\"#贴砖\" class=\"headerlink\" title=\"贴砖\"></a>贴砖</h2><ul><li>要求砖工贴的时候，控制缝隙间距，保持缝隙间距一致，方便后期做美缝。</li><li>如果有生活阳台，需要在阳台的墙壁上贴砖。</li><li>地漏提前买好，叮嘱工人不要把水泥弄到地漏的螺纹上。</li><li>叮嘱工人不要把水泥弄到其他地方，比如说地漏的螺纹，花洒水阀等。</li><li>提前和工人沟通好阴角阳角的处理方式。</li><li>吊顶要用铝扣板，干区和湿区都要。</li></ul><hr><p>总结的这些，希望可以为下一次装修积累一些经验，避免再犯。</p>"},{"title":"使用ide-helper提升PHPstorm开发laravel/lumen项目体验","date":"2018-01-17T07:28:32.000Z","_content":"目前 `phpstorm` 应该是公认的开发 `PHP` 最好的 `IDE` 了，但在开发 `laravel/lumen` 项目时，由于框架实现方式问题，其代码提示功能被迫减弱。\n为了更好的开发体验，在GitHub上有个 [barryvdh/laravel-ide-helper](https://github.com/barryvdh/laravel-ide-helper) 项目，目的就是弥补部分被削弱的代码提示功能。\n\n使用方法是用 `composer` 安装完成后，注册 `service`，用 `artisan` 命令生产 `ide-helper` 文件。具体参考GitHub上的文档。\n\n其实我们最终只是需要生成得到的 `ide-helper` 文件，就可以达到增强代码提示功能的效果，于是用 `shell` 写了个简单的脚本来生成 `lumen` 项目的 `ide-helper` 。\n\n其思路是：\n\n- 首先备份 `composer.json` 和 `composer.lock` 文件\n- 使用 `composer` 安装 `ide-helper`\n- 然后在 `bootstrap/app.php` 文件中追加注册 `service` 的代码（由于 macOS 下 `sed` 命令不太正常，所以用到了 `gsed`，通过 `brew install gnu-sed` 安装）\n- 接着执行 `./artisan ide-helper:generate` 和 `./artisan ide-helper:meta` 来生成 `ide-helper` 文件\n- 最后还原 `bootstrap/app.php`、 `composer.json` 和 `composer.lock` 文件以及对应的 `composer` 依赖\n\n```shell\n# lumen ide helper generator\nlumen-helper-gen() {\n    # backup\n    echo 'backup composer.*'\n    cp composer.json composer.json.bak\n    cp composer.lock composer.lock.bak\n\n    # generate\n    echo 'install ide-helper via composer'\n    composer require --quiet --dev barryvdh/laravel-ide-helper\n    echo 'edit bootstrap/app.php'\n    l=`sed -n '/$app->register/=' bootstrap/app.php | tail -1`\n    gsed -i.bak \"$l a \\$app->register(\\\\\\Barryvdh\\\\\\LaravelIdeHelper\\\\\\IdeHelperServiceProvider::class);\" bootstrap/app.php\n    unset l\n    echo 'generate ide-helper files'\n    ./artisan ide-helper:generate\n    ./artisan ide-helper:meta\n\n    # restore file\n    echo 'restore bootstrap/app.php'\n    mv bootstrap/app.php.bak bootstrap/app.php\n    echo 'restore composer dep'\n    composer remove --dev --no-update --no-progress barryvdh/laravel-ide-helper\n    mv composer.json.bak composer.json\n    mv composer.lock.bak composer.lock\n}\n```\n","source":"_posts/2018-01-17-使用ide-helper提升PHPstorm开发laravel-lumen项目体验.md","raw":"---\ntitle: 使用ide-helper提升PHPstorm开发laravel/lumen项目体验\ndate: 2018-01-17 15:28:32\ntags:\n- php\n- shell\n- laravel/lumen\ncategories:\n- 笔记\n---\n目前 `phpstorm` 应该是公认的开发 `PHP` 最好的 `IDE` 了，但在开发 `laravel/lumen` 项目时，由于框架实现方式问题，其代码提示功能被迫减弱。\n为了更好的开发体验，在GitHub上有个 [barryvdh/laravel-ide-helper](https://github.com/barryvdh/laravel-ide-helper) 项目，目的就是弥补部分被削弱的代码提示功能。\n\n使用方法是用 `composer` 安装完成后，注册 `service`，用 `artisan` 命令生产 `ide-helper` 文件。具体参考GitHub上的文档。\n\n其实我们最终只是需要生成得到的 `ide-helper` 文件，就可以达到增强代码提示功能的效果，于是用 `shell` 写了个简单的脚本来生成 `lumen` 项目的 `ide-helper` 。\n\n其思路是：\n\n- 首先备份 `composer.json` 和 `composer.lock` 文件\n- 使用 `composer` 安装 `ide-helper`\n- 然后在 `bootstrap/app.php` 文件中追加注册 `service` 的代码（由于 macOS 下 `sed` 命令不太正常，所以用到了 `gsed`，通过 `brew install gnu-sed` 安装）\n- 接着执行 `./artisan ide-helper:generate` 和 `./artisan ide-helper:meta` 来生成 `ide-helper` 文件\n- 最后还原 `bootstrap/app.php`、 `composer.json` 和 `composer.lock` 文件以及对应的 `composer` 依赖\n\n```shell\n# lumen ide helper generator\nlumen-helper-gen() {\n    # backup\n    echo 'backup composer.*'\n    cp composer.json composer.json.bak\n    cp composer.lock composer.lock.bak\n\n    # generate\n    echo 'install ide-helper via composer'\n    composer require --quiet --dev barryvdh/laravel-ide-helper\n    echo 'edit bootstrap/app.php'\n    l=`sed -n '/$app->register/=' bootstrap/app.php | tail -1`\n    gsed -i.bak \"$l a \\$app->register(\\\\\\Barryvdh\\\\\\LaravelIdeHelper\\\\\\IdeHelperServiceProvider::class);\" bootstrap/app.php\n    unset l\n    echo 'generate ide-helper files'\n    ./artisan ide-helper:generate\n    ./artisan ide-helper:meta\n\n    # restore file\n    echo 'restore bootstrap/app.php'\n    mv bootstrap/app.php.bak bootstrap/app.php\n    echo 'restore composer dep'\n    composer remove --dev --no-update --no-progress barryvdh/laravel-ide-helper\n    mv composer.json.bak composer.json\n    mv composer.lock.bak composer.lock\n}\n```\n","slug":"使用ide-helper提升PHPstorm开发laravel-lumen项目体验","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j2000biubf66vtnul6","content":"<p>目前 <code>phpstorm</code> 应该是公认的开发 <code>PHP</code> 最好的 <code>IDE</code> 了，但在开发 <code>laravel/lumen</code> 项目时，由于框架实现方式问题，其代码提示功能被迫减弱。 为了更好的开发体验，在GitHub上有个 <a href=\"https://github.com/barryvdh/laravel-ide-helper\" target=\"_blank\" rel=\"noopener\">barryvdh/laravel-ide-helper</a> 项目，目的就是弥补部分被削弱的代码提示功能。</p><p>使用方法是用 <code>composer</code> 安装完成后，注册 <code>service</code>，用 <code>artisan</code> 命令生产 <code>ide-helper</code> 文件。具体参考GitHub上的文档。</p><p>其实我们最终只是需要生成得到的 <code>ide-helper</code> 文件，就可以达到增强代码提示功能的效果，于是用 <code>shell</code> 写了个简单的脚本来生成 <code>lumen</code> 项目的 <code>ide-helper</code> 。</p><p>其思路是：</p><ul><li>首先备份 <code>composer.json</code> 和 <code>composer.lock</code> 文件</li><li>使用 <code>composer</code> 安装 <code>ide-helper</code></li><li>然后在 <code>bootstrap/app.php</code> 文件中追加注册 <code>service</code> 的代码（由于 macOS 下 <code>sed</code> 命令不太正常，所以用到了 <code>gsed</code>，通过 <code>brew install gnu-sed</code> 安装）</li><li>接着执行 <code>./artisan ide-helper:generate</code> 和 <code>./artisan ide-helper:meta</code> 来生成 <code>ide-helper</code> 文件</li><li>最后还原 <code>bootstrap/app.php</code>、 <code>composer.json</code> 和 <code>composer.lock</code> 文件以及对应的 <code>composer</code> 依赖</li></ul><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> lumen ide helper generator</span></span><br><span class=\"line\">lumen-helper-gen() &#123;</span><br><span class=\"line\">    # backup</span><br><span class=\"line\">    echo 'backup composer.*'</span><br><span class=\"line\">    cp composer.json composer.json.bak</span><br><span class=\"line\">    cp composer.lock composer.lock.bak</span><br><span class=\"line\"></span><br><span class=\"line\">    # generate</span><br><span class=\"line\">    echo 'install ide-helper via composer'</span><br><span class=\"line\">    composer require --quiet --dev barryvdh/laravel-ide-helper</span><br><span class=\"line\">    echo 'edit bootstrap/app.php'</span><br><span class=\"line\">    l=`sed -n '/$app-&gt;register/=' bootstrap/app.php | tail -1`</span><br><span class=\"line\">    gsed -i.bak \"$l a \\$app-&gt;register(\\\\\\Barryvdh\\\\\\LaravelIdeHelper\\\\\\IdeHelperServiceProvider::class);\" bootstrap/app.php</span><br><span class=\"line\">    unset l</span><br><span class=\"line\">    echo 'generate ide-helper files'</span><br><span class=\"line\">    ./artisan ide-helper:generate</span><br><span class=\"line\">    ./artisan ide-helper:meta</span><br><span class=\"line\"></span><br><span class=\"line\">    # restore file</span><br><span class=\"line\">    echo 'restore bootstrap/app.php'</span><br><span class=\"line\">    mv bootstrap/app.php.bak bootstrap/app.php</span><br><span class=\"line\">    echo 'restore composer dep'</span><br><span class=\"line\">    composer remove --dev --no-update --no-progress barryvdh/laravel-ide-helper</span><br><span class=\"line\">    mv composer.json.bak composer.json</span><br><span class=\"line\">    mv composer.lock.bak composer.lock</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>目前 <code>phpstorm</code> 应该是公认的开发 <code>PHP</code> 最好的 <code>IDE</code> 了，但在开发 <code>laravel/lumen</code> 项目时，由于框架实现方式问题，其代码提示功能被迫减弱。 为了更好的开发体验，在GitHub上有个 <a href=\"https://github.com/barryvdh/laravel-ide-helper\" target=\"_blank\" rel=\"noopener\">barryvdh/laravel-ide-helper</a> 项目，目的就是弥补部分被削弱的代码提示功能。</p><p>使用方法是用 <code>composer</code> 安装完成后，注册 <code>service</code>，用 <code>artisan</code> 命令生产 <code>ide-helper</code> 文件。具体参考GitHub上的文档。</p><p>其实我们最终只是需要生成得到的 <code>ide-helper</code> 文件，就可以达到增强代码提示功能的效果，于是用 <code>shell</code> 写了个简单的脚本来生成 <code>lumen</code> 项目的 <code>ide-helper</code> 。</p><p>其思路是：</p><ul><li>首先备份 <code>composer.json</code> 和 <code>composer.lock</code> 文件</li><li>使用 <code>composer</code> 安装 <code>ide-helper</code></li><li>然后在 <code>bootstrap/app.php</code> 文件中追加注册 <code>service</code> 的代码（由于 macOS 下 <code>sed</code> 命令不太正常，所以用到了 <code>gsed</code>，通过 <code>brew install gnu-sed</code> 安装）</li><li>接着执行 <code>./artisan ide-helper:generate</code> 和 <code>./artisan ide-helper:meta</code> 来生成 <code>ide-helper</code> 文件</li><li>最后还原 <code>bootstrap/app.php</code>、 <code>composer.json</code> 和 <code>composer.lock</code> 文件以及对应的 <code>composer</code> 依赖</li></ul><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> lumen ide helper generator</span></span><br><span class=\"line\">lumen-helper-gen() &#123;</span><br><span class=\"line\">    # backup</span><br><span class=\"line\">    echo 'backup composer.*'</span><br><span class=\"line\">    cp composer.json composer.json.bak</span><br><span class=\"line\">    cp composer.lock composer.lock.bak</span><br><span class=\"line\"></span><br><span class=\"line\">    # generate</span><br><span class=\"line\">    echo 'install ide-helper via composer'</span><br><span class=\"line\">    composer require --quiet --dev barryvdh/laravel-ide-helper</span><br><span class=\"line\">    echo 'edit bootstrap/app.php'</span><br><span class=\"line\">    l=`sed -n '/$app-&gt;register/=' bootstrap/app.php | tail -1`</span><br><span class=\"line\">    gsed -i.bak \"$l a \\$app-&gt;register(\\\\\\Barryvdh\\\\\\LaravelIdeHelper\\\\\\IdeHelperServiceProvider::class);\" bootstrap/app.php</span><br><span class=\"line\">    unset l</span><br><span class=\"line\">    echo 'generate ide-helper files'</span><br><span class=\"line\">    ./artisan ide-helper:generate</span><br><span class=\"line\">    ./artisan ide-helper:meta</span><br><span class=\"line\"></span><br><span class=\"line\">    # restore file</span><br><span class=\"line\">    echo 'restore bootstrap/app.php'</span><br><span class=\"line\">    mv bootstrap/app.php.bak bootstrap/app.php</span><br><span class=\"line\">    echo 'restore composer dep'</span><br><span class=\"line\">    composer remove --dev --no-update --no-progress barryvdh/laravel-ide-helper</span><br><span class=\"line\">    mv composer.json.bak composer.json</span><br><span class=\"line\">    mv composer.lock.bak composer.lock</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"Golang并发编程最简单实践","date":"2018-01-18T07:28:01.000Z","_content":"不管怎么样，还是要学下并发编程的。这次在 `golang` 上学习。\n\n下面记录一下一个最简单的例子：\n\ngolang 版本: `version: 1.9.2`\n文件名：playground.go\n\n```go\npackage main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc main() {\n    fmt.Println(\"begins at\", time.Now().Format(\"2006-01-02 15:04:05\"))\n    chMap := map[string]chan interface{}{\n        \"big\":    make(chan interface{}),\n        \"medium\": make(chan interface{}),\n        \"small\":  make(chan interface{}),\n    }\n    go bigFetch(chMap[\"big\"])\n    go mediumFetch(chMap[\"medium\"])\n    go smallFetch(chMap[\"small\"])\n    for _, ch := range chMap {\n        fmt.Println(<-ch)\n    }\n    fmt.Println(\"ends at\", time.Now().Format(\"2006-01-02 15:04:05\"))\n}\n\nfunc bigFetch(ch chan interface{}) {\n    time.Sleep(3 * time.Second)\n    ch <- \"complete a big fetch costing 3 seconds\"\n}\n\nfunc mediumFetch(ch chan interface{}) {\n    time.Sleep(2 * time.Second)\n    ch <- \"complete a medium fetch costing 2 seconds\"\n}\n\nfunc smallFetch(ch chan interface{}) {\n    time.Sleep(1 * time.Second)\n    ch <- \"complete a small fetch costing 1 seconds\"\n}\n```\n\n执行一下：\n\n```sh\n$ go run playground.go\n\n# output:\nbegins at: 2018-01-18 15:35:57\ncomplete a small fetch costing 1 seconds\ncomplete a big fetch costing 3 seconds\ncomplete a medium fetch costing 2 seconds\nends at: 2018-01-18 15:36:00\n```\n\n由上面的例子可以看出，并发编程的一个最基本的优势：节约时间！\n如果将上面的例子换成同步执行，则耗时应该是 1 + 2 + 3 = 6s，而并发处理只需要 max(1, 2, 3) = 3s。\n","source":"_posts/2018-01-18-Golang并发编程最简单实践.md","raw":"---\ntitle: Golang并发编程最简单实践\ndate: 2018-01-18 15:28:01\ntags:\n- golang\ncategories:\n- 笔记\n---\n不管怎么样，还是要学下并发编程的。这次在 `golang` 上学习。\n\n下面记录一下一个最简单的例子：\n\ngolang 版本: `version: 1.9.2`\n文件名：playground.go\n\n```go\npackage main\n\nimport (\n    \"fmt\"\n    \"time\"\n)\n\nfunc main() {\n    fmt.Println(\"begins at\", time.Now().Format(\"2006-01-02 15:04:05\"))\n    chMap := map[string]chan interface{}{\n        \"big\":    make(chan interface{}),\n        \"medium\": make(chan interface{}),\n        \"small\":  make(chan interface{}),\n    }\n    go bigFetch(chMap[\"big\"])\n    go mediumFetch(chMap[\"medium\"])\n    go smallFetch(chMap[\"small\"])\n    for _, ch := range chMap {\n        fmt.Println(<-ch)\n    }\n    fmt.Println(\"ends at\", time.Now().Format(\"2006-01-02 15:04:05\"))\n}\n\nfunc bigFetch(ch chan interface{}) {\n    time.Sleep(3 * time.Second)\n    ch <- \"complete a big fetch costing 3 seconds\"\n}\n\nfunc mediumFetch(ch chan interface{}) {\n    time.Sleep(2 * time.Second)\n    ch <- \"complete a medium fetch costing 2 seconds\"\n}\n\nfunc smallFetch(ch chan interface{}) {\n    time.Sleep(1 * time.Second)\n    ch <- \"complete a small fetch costing 1 seconds\"\n}\n```\n\n执行一下：\n\n```sh\n$ go run playground.go\n\n# output:\nbegins at: 2018-01-18 15:35:57\ncomplete a small fetch costing 1 seconds\ncomplete a big fetch costing 3 seconds\ncomplete a medium fetch costing 2 seconds\nends at: 2018-01-18 15:36:00\n```\n\n由上面的例子可以看出，并发编程的一个最基本的优势：节约时间！\n如果将上面的例子换成同步执行，则耗时应该是 1 + 2 + 3 = 6s，而并发处理只需要 max(1, 2, 3) = 3s。\n","slug":"Golang并发编程最简单实践","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j2000ciubf5l8wnqgb","content":"<p>不管怎么样，还是要学下并发编程的。这次在 <code>golang</code> 上学习。</p><p>下面记录一下一个最简单的例子：</p><p>golang 版本: <code>version: 1.9.2</code> 文件名：playground.go</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">    <span class=\"string\">\"time\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"begins at\"</span>, time.Now().Format(<span class=\"string\">\"2006-01-02 15:04:05\"</span>))</span><br><span class=\"line\">    chMap := <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">        <span class=\"string\">\"big\"</span>:    <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;),</span><br><span class=\"line\">        <span class=\"string\">\"medium\"</span>: <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;),</span><br><span class=\"line\">        <span class=\"string\">\"small\"</span>:  <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;),</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">go</span> bigFetch(chMap[<span class=\"string\">\"big\"</span>])</span><br><span class=\"line\">    <span class=\"keyword\">go</span> mediumFetch(chMap[<span class=\"string\">\"medium\"</span>])</span><br><span class=\"line\">    <span class=\"keyword\">go</span> smallFetch(chMap[<span class=\"string\">\"small\"</span>])</span><br><span class=\"line\">    <span class=\"keyword\">for</span> _, ch := <span class=\"keyword\">range</span> chMap &#123;</span><br><span class=\"line\">        fmt.Println(&lt;-ch)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"ends at\"</span>, time.Now().Format(<span class=\"string\">\"2006-01-02 15:04:05\"</span>))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">bigFetch</span><span class=\"params\">(ch <span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">    time.Sleep(<span class=\"number\">3</span> * time.Second)</span><br><span class=\"line\">    ch &lt;- <span class=\"string\">\"complete a big fetch costing 3 seconds\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">mediumFetch</span><span class=\"params\">(ch <span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">    time.Sleep(<span class=\"number\">2</span> * time.Second)</span><br><span class=\"line\">    ch &lt;- <span class=\"string\">\"complete a medium fetch costing 2 seconds\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">smallFetch</span><span class=\"params\">(ch <span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">    time.Sleep(<span class=\"number\">1</span> * time.Second)</span><br><span class=\"line\">    ch &lt;- <span class=\"string\">\"complete a small fetch costing 1 seconds\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>执行一下：</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ go run playground.go</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># output:</span></span><br><span class=\"line\">begins at: 2018-01-18 15:35:57</span><br><span class=\"line\">complete a small fetch costing 1 seconds</span><br><span class=\"line\">complete a big fetch costing 3 seconds</span><br><span class=\"line\">complete a medium fetch costing 2 seconds</span><br><span class=\"line\">ends at: 2018-01-18 15:36:00</span><br></pre></td></tr></table></figure><p>由上面的例子可以看出，并发编程的一个最基本的优势：节约时间！ 如果将上面的例子换成同步执行，则耗时应该是 1 + 2 + 3 = 6s，而并发处理只需要 max(1, 2, 3) = 3s。</p>","site":{"data":{}},"excerpt":"","more":"<p>不管怎么样，还是要学下并发编程的。这次在 <code>golang</code> 上学习。</p><p>下面记录一下一个最简单的例子：</p><p>golang 版本: <code>version: 1.9.2</code> 文件名：playground.go</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">    <span class=\"string\">\"time\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"begins at\"</span>, time.Now().Format(<span class=\"string\">\"2006-01-02 15:04:05\"</span>))</span><br><span class=\"line\">    chMap := <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;&#123;</span><br><span class=\"line\">        <span class=\"string\">\"big\"</span>:    <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;),</span><br><span class=\"line\">        <span class=\"string\">\"medium\"</span>: <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;),</span><br><span class=\"line\">        <span class=\"string\">\"small\"</span>:  <span class=\"built_in\">make</span>(<span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;),</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">go</span> bigFetch(chMap[<span class=\"string\">\"big\"</span>])</span><br><span class=\"line\">    <span class=\"keyword\">go</span> mediumFetch(chMap[<span class=\"string\">\"medium\"</span>])</span><br><span class=\"line\">    <span class=\"keyword\">go</span> smallFetch(chMap[<span class=\"string\">\"small\"</span>])</span><br><span class=\"line\">    <span class=\"keyword\">for</span> _, ch := <span class=\"keyword\">range</span> chMap &#123;</span><br><span class=\"line\">        fmt.Println(&lt;-ch)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    fmt.Println(<span class=\"string\">\"ends at\"</span>, time.Now().Format(<span class=\"string\">\"2006-01-02 15:04:05\"</span>))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">bigFetch</span><span class=\"params\">(ch <span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">    time.Sleep(<span class=\"number\">3</span> * time.Second)</span><br><span class=\"line\">    ch &lt;- <span class=\"string\">\"complete a big fetch costing 3 seconds\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">mediumFetch</span><span class=\"params\">(ch <span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">    time.Sleep(<span class=\"number\">2</span> * time.Second)</span><br><span class=\"line\">    ch &lt;- <span class=\"string\">\"complete a medium fetch costing 2 seconds\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">smallFetch</span><span class=\"params\">(ch <span class=\"keyword\">chan</span> <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">    time.Sleep(<span class=\"number\">1</span> * time.Second)</span><br><span class=\"line\">    ch &lt;- <span class=\"string\">\"complete a small fetch costing 1 seconds\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>执行一下：</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ go run playground.go</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># output:</span></span><br><span class=\"line\">begins at: 2018-01-18 15:35:57</span><br><span class=\"line\">complete a small fetch costing 1 seconds</span><br><span class=\"line\">complete a big fetch costing 3 seconds</span><br><span class=\"line\">complete a medium fetch costing 2 seconds</span><br><span class=\"line\">ends at: 2018-01-18 15:36:00</span><br></pre></td></tr></table></figure><p>由上面的例子可以看出，并发编程的一个最基本的优势：节约时间！ 如果将上面的例子换成同步执行，则耗时应该是 1 + 2 + 3 = 6s，而并发处理只需要 max(1, 2, 3) = 3s。</p>"},{"title":"快速获取当前内网IP的命令","date":"2018-02-24T07:22:39.000Z","_content":"\n```sh\nifconfig | sed -En 's/127.0.0.1//;s/.*inet (addr:)?(([0-9]*\\.){3}[0-9]*).*/\\2/p'\n```\n","source":"_posts/2018-02-24-快速获取当前内网IP的命令.md","raw":"---\ntitle: 快速获取当前内网IP的命令\ndate: 2018-02-24 15:22:39\ntags:\n- linux\ncategories:\n- 笔记\n---\n\n```sh\nifconfig | sed -En 's/127.0.0.1//;s/.*inet (addr:)?(([0-9]*\\.){3}[0-9]*).*/\\2/p'\n```\n","slug":"快速获取当前内网IP的命令","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j3000diubfbfsp42ia","content":"<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ifconfig | sed -En <span class=\"string\">'s/127.0.0.1//;s/.*inet (addr:)?(([0-9]*\\.)&#123;3&#125;[0-9]*).*/\\2/p'</span></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ifconfig | sed -En <span class=\"string\">'s/127.0.0.1//;s/.*inet (addr:)?(([0-9]*\\.)&#123;3&#125;[0-9]*).*/\\2/p'</span></span><br></pre></td></tr></table></figure>"},{"title":"让 `git status` 命令正确显示中文","date":"2018-01-17T08:22:46.000Z","_content":"环境是 `macOS` 。每当使用 `git status` 时，只要修改了带有中文的文件，在控制台输出的中文部分都会被转义成 `Unicode` ，阅读体验不太好。\n\n![image](https://qiniu.wrzsj.top/blog/asset/img/gBwC5W@75_discount)\n\n为了更好的体验，我修改了 `git` 的一个核心设置: `git config --global core.quotepath false` ，从此，再无困扰。\n\n![image](https://qiniu.wrzsj.top/blog/asset/img/gBwcXw@75_discount)\n","source":"_posts/2018-01-17-让-`git-status`-命令正确显示中文.md","raw":"---\ntitle: 让 `git status` 命令正确显示中文\ndate: 2018-01-17 16:22:46\ntags:\n- git\ncategories:\n- 笔记\n---\n环境是 `macOS` 。每当使用 `git status` 时，只要修改了带有中文的文件，在控制台输出的中文部分都会被转义成 `Unicode` ，阅读体验不太好。\n\n![image](https://qiniu.wrzsj.top/blog/asset/img/gBwC5W@75_discount)\n\n为了更好的体验，我修改了 `git` 的一个核心设置: `git config --global core.quotepath false` ，从此，再无困扰。\n\n![image](https://qiniu.wrzsj.top/blog/asset/img/gBwcXw@75_discount)\n","slug":"让-`git-status`-命令正确显示中文","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j3000eiubfrvxcw0pl","content":"<p>环境是 <code>macOS</code> 。每当使用 <code>git status</code> 时，只要修改了带有中文的文件，在控制台输出的中文部分都会被转义成 <code>Unicode</code> ，阅读体验不太好。</p><p><img src=\"https://qiniu.wrzsj.top/blog/asset/img/gBwC5W@75_discount\" alt=\"image\"></p><p>为了更好的体验，我修改了 <code>git</code> 的一个核心设置: <code>git config --global core.quotepath false</code> ，从此，再无困扰。</p><p><img src=\"https://qiniu.wrzsj.top/blog/asset/img/gBwcXw@75_discount\" alt=\"image\"></p>","site":{"data":{}},"excerpt":"","more":"<p>环境是 <code>macOS</code> 。每当使用 <code>git status</code> 时，只要修改了带有中文的文件，在控制台输出的中文部分都会被转义成 <code>Unicode</code> ，阅读体验不太好。</p><p><img src=\"https://qiniu.wrzsj.top/blog/asset/img/gBwC5W@75_discount\" alt=\"image\"></p><p>为了更好的体验，我修改了 <code>git</code> 的一个核心设置: <code>git config --global core.quotepath false</code> ，从此，再无困扰。</p><p><img src=\"https://qiniu.wrzsj.top/blog/asset/img/gBwcXw@75_discount\" alt=\"image\"></p>"},{"title":"Golang中slice的一些helper","date":"2018-02-28T06:20:13.000Z","_content":"最近在用golang写业务代码，没有用框架，所以自己写的一些 `helper` 来辅助开发。这里分享下 `slice` 相关的 `helper` 。\n\n## SliceDiff\n\n### 目的\n\n用于比较两个相同类型的slice，并找到不同的部分\n\n### 设计\n\n最初设计是只接收2个参数，然后返回一个[]interface{}，但是这样的返回意味着面临断言的可能，所有决定用反射优化下。\n函数将接收3个参数，都为slice。第一个是原本的slice，第二个参数是用于和第一个slice做比较，比价之后的结果将会存入第三个参数中，所以第三个参数必须是个指针slice。\n同时也兼容了空slice的情况，如果第一个参数是个空的slice，则直接return，跳过后续计算。\n如果参数存在问题，比如类型不统一、第三个参数不是指针，会直接panic 😱 。\n没有返回值。\n\n<!-- more -->\n\n### 代码实现\n\n```go\nfunc SliceDiff(main, compared, result interface{}) {\n    mainValue := reflect.Indirect(reflect.ValueOf(main))\n    comparedValue := reflect.Indirect(reflect.ValueOf(compared))\n    if mainValue.Type() != comparedValue.Type() {\n        panic(errors.New(\"main's and compared's types should be the same\"))\n    }\n    resultValue := reflect.ValueOf(result)\n    if resultValue.Kind() != reflect.Ptr {\n        panic(errors.New(\"result should be a slice ptr\"))\n    }\n    resultSlice := resultValue.Elem()\n    if resultSlice.Kind() != reflect.Slice {\n        panic(errors.New(\"result should be a slice ptr\"))\n    }\n    mainLen := mainValue.Len()\n    if mainLen == 0 {\n        return\n    }\n    comparedLen := comparedValue.Len()\n    nSlice := reflect.New(resultSlice.Type()).Elem()\n    for i := 0; i < mainLen; i++ {\n        var found bool\n        for j := 0; j < comparedLen; j++ {\n            if reflect.DeepEqual(mainValue.Index(i).Interface(), comparedValue.Index(j).Interface()) {\n                found = true\n                break\n            }\n        }\n        if !found {\n            nSlice = reflect.Append(nSlice, mainValue.Index(i))\n        }\n    }\n    resultSlice.Set(nSlice)\n}\n```\n\n### 示例\n\n```go\nvar diff []int\nSliceDiff([]int{1, 2, 3, 4}, []int{1, 2}, &diff)\nfmt.Println(diff) // []int{3, 4}\n```\n\n---\n\n## SliceUnique\n\n### 目的\n\n对slice中的元素去重\n\n### 设计\n\n函数只需接收一个参数，即要进行去重的slice指针。\n然后由函数实现去重并覆盖原slice。\n如果参数的类型不正确，会直接panic 😱。\n\n### 代码实现\n\n```go\nfunc SliceUnset(slicePtr interface{}, index int) {\n    value := reflect.ValueOf(slicePtr)\n    if value.Kind() != reflect.Ptr {\n        panic(errors.New(\"should be a slice ptr\"))\n    }\n    slice := value.Elem()\n    nSlice := reflect.New(slice.Type()).Elem()\n    if slice.Kind() != reflect.Slice {\n        panic(errors.New(\"should be a slice ptr\"))\n    }\n    l := slice.Len()\n    if l == 0 {\n        return\n    }\n    for i := 0; i < l; i++ {\n        if i != index {\n            nSlice = reflect.Append(nSlice, slice.Index(i))\n        }\n    }\n    slice.Set(nSlice)\n}\n```\n\n### 示例\n\n```go\nvar s := []int{1, 2, 3, 1, 3, 2}\nSliceUnique(&s)\nfmt.Println(s) // []int{1, 2, 3}\n```\n\n---\n\nto be continued...\n","source":"_posts/2018-02-28-Golang中slice的一些helper.md","raw":"---\ntitle: Golang中slice的一些helper\ndate: 2018-02-28 14:20:13\ntags:\n- golang\ncategories:\n- 笔记\n---\n最近在用golang写业务代码，没有用框架，所以自己写的一些 `helper` 来辅助开发。这里分享下 `slice` 相关的 `helper` 。\n\n## SliceDiff\n\n### 目的\n\n用于比较两个相同类型的slice，并找到不同的部分\n\n### 设计\n\n最初设计是只接收2个参数，然后返回一个[]interface{}，但是这样的返回意味着面临断言的可能，所有决定用反射优化下。\n函数将接收3个参数，都为slice。第一个是原本的slice，第二个参数是用于和第一个slice做比较，比价之后的结果将会存入第三个参数中，所以第三个参数必须是个指针slice。\n同时也兼容了空slice的情况，如果第一个参数是个空的slice，则直接return，跳过后续计算。\n如果参数存在问题，比如类型不统一、第三个参数不是指针，会直接panic 😱 。\n没有返回值。\n\n<!-- more -->\n\n### 代码实现\n\n```go\nfunc SliceDiff(main, compared, result interface{}) {\n    mainValue := reflect.Indirect(reflect.ValueOf(main))\n    comparedValue := reflect.Indirect(reflect.ValueOf(compared))\n    if mainValue.Type() != comparedValue.Type() {\n        panic(errors.New(\"main's and compared's types should be the same\"))\n    }\n    resultValue := reflect.ValueOf(result)\n    if resultValue.Kind() != reflect.Ptr {\n        panic(errors.New(\"result should be a slice ptr\"))\n    }\n    resultSlice := resultValue.Elem()\n    if resultSlice.Kind() != reflect.Slice {\n        panic(errors.New(\"result should be a slice ptr\"))\n    }\n    mainLen := mainValue.Len()\n    if mainLen == 0 {\n        return\n    }\n    comparedLen := comparedValue.Len()\n    nSlice := reflect.New(resultSlice.Type()).Elem()\n    for i := 0; i < mainLen; i++ {\n        var found bool\n        for j := 0; j < comparedLen; j++ {\n            if reflect.DeepEqual(mainValue.Index(i).Interface(), comparedValue.Index(j).Interface()) {\n                found = true\n                break\n            }\n        }\n        if !found {\n            nSlice = reflect.Append(nSlice, mainValue.Index(i))\n        }\n    }\n    resultSlice.Set(nSlice)\n}\n```\n\n### 示例\n\n```go\nvar diff []int\nSliceDiff([]int{1, 2, 3, 4}, []int{1, 2}, &diff)\nfmt.Println(diff) // []int{3, 4}\n```\n\n---\n\n## SliceUnique\n\n### 目的\n\n对slice中的元素去重\n\n### 设计\n\n函数只需接收一个参数，即要进行去重的slice指针。\n然后由函数实现去重并覆盖原slice。\n如果参数的类型不正确，会直接panic 😱。\n\n### 代码实现\n\n```go\nfunc SliceUnset(slicePtr interface{}, index int) {\n    value := reflect.ValueOf(slicePtr)\n    if value.Kind() != reflect.Ptr {\n        panic(errors.New(\"should be a slice ptr\"))\n    }\n    slice := value.Elem()\n    nSlice := reflect.New(slice.Type()).Elem()\n    if slice.Kind() != reflect.Slice {\n        panic(errors.New(\"should be a slice ptr\"))\n    }\n    l := slice.Len()\n    if l == 0 {\n        return\n    }\n    for i := 0; i < l; i++ {\n        if i != index {\n            nSlice = reflect.Append(nSlice, slice.Index(i))\n        }\n    }\n    slice.Set(nSlice)\n}\n```\n\n### 示例\n\n```go\nvar s := []int{1, 2, 3, 1, 3, 2}\nSliceUnique(&s)\nfmt.Println(s) // []int{1, 2, 3}\n```\n\n---\n\nto be continued...\n","slug":"Golang中slice的一些helper","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j4000fiubf1bo0zv86","content":"<p>最近在用golang写业务代码，没有用框架，所以自己写的一些 <code>helper</code> 来辅助开发。这里分享下 <code>slice</code> 相关的 <code>helper</code> 。</p><h2 id=\"SliceDiff\"><a href=\"#SliceDiff\" class=\"headerlink\" title=\"SliceDiff\"></a>SliceDiff</h2><h3 id=\"目的\"><a href=\"#目的\" class=\"headerlink\" title=\"目的\"></a>目的</h3><p>用于比较两个相同类型的slice，并找到不同的部分</p><h3 id=\"设计\"><a href=\"#设计\" class=\"headerlink\" title=\"设计\"></a>设计</h3><p>最初设计是只接收2个参数，然后返回一个[]interface{}，但是这样的返回意味着面临断言的可能，所有决定用反射优化下。 函数将接收3个参数，都为slice。第一个是原本的slice，第二个参数是用于和第一个slice做比较，比价之后的结果将会存入第三个参数中，所以第三个参数必须是个指针slice。 同时也兼容了空slice的情况，如果第一个参数是个空的slice，则直接return，跳过后续计算。 如果参数存在问题，比如类型不统一、第三个参数不是指针，会直接panic 😱 。 没有返回值。</p><a id=\"more\"></a><h3 id=\"代码实现\"><a href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">SliceDiff</span><span class=\"params\">(main, compared, result <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">    mainValue := reflect.Indirect(reflect.ValueOf(main))</span><br><span class=\"line\">    comparedValue := reflect.Indirect(reflect.ValueOf(compared))</span><br><span class=\"line\">    <span class=\"keyword\">if</span> mainValue.Type() != comparedValue.Type() &#123;</span><br><span class=\"line\">        <span class=\"built_in\">panic</span>(errors.New(<span class=\"string\">\"main's and compared's types should be the same\"</span>))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    resultValue := reflect.ValueOf(result)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> resultValue.Kind() != reflect.Ptr &#123;</span><br><span class=\"line\">        <span class=\"built_in\">panic</span>(errors.New(<span class=\"string\">\"result should be a slice ptr\"</span>))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    resultSlice := resultValue.Elem()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> resultSlice.Kind() != reflect.Slice &#123;</span><br><span class=\"line\">        <span class=\"built_in\">panic</span>(errors.New(<span class=\"string\">\"result should be a slice ptr\"</span>))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    mainLen := mainValue.Len()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> mainLen == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    comparedLen := comparedValue.Len()</span><br><span class=\"line\">    nSlice := reflect.New(resultSlice.Type()).Elem()</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; mainLen; i++ &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> found <span class=\"keyword\">bool</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> j := <span class=\"number\">0</span>; j &lt; comparedLen; j++ &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> reflect.DeepEqual(mainValue.Index(i).Interface(), comparedValue.Index(j).Interface()) &#123;</span><br><span class=\"line\">                found = <span class=\"literal\">true</span></span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> !found &#123;</span><br><span class=\"line\">            nSlice = reflect.Append(nSlice, mainValue.Index(i))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    resultSlice.Set(nSlice)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><h3 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> diff []<span class=\"keyword\">int</span></span><br><span class=\"line\">SliceDiff([]<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, <span class=\"number\">4</span>&#125;, []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>&#125;, &amp;diff)</span><br><span class=\"line\">fmt.Println(diff) <span class=\"comment\">// []int&#123;3, 4&#125;</span></span><br></pre></td></tr></table></figure><hr><h2 id=\"SliceUnique\"><a href=\"#SliceUnique\" class=\"headerlink\" title=\"SliceUnique\"></a>SliceUnique</h2><h3 id=\"目的-1\"><a href=\"#目的-1\" class=\"headerlink\" title=\"目的\"></a>目的</h3><p>对slice中的元素去重</p><h3 id=\"设计-1\"><a href=\"#设计-1\" class=\"headerlink\" title=\"设计\"></a>设计</h3><p>函数只需接收一个参数，即要进行去重的slice指针。 然后由函数实现去重并覆盖原slice。 如果参数的类型不正确，会直接panic 😱。</p><h3 id=\"代码实现-1\"><a href=\"#代码实现-1\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">SliceUnset</span><span class=\"params\">(slicePtr <span class=\"keyword\">interface</span>&#123;&#125;, index <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">    value := reflect.ValueOf(slicePtr)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> value.Kind() != reflect.Ptr &#123;</span><br><span class=\"line\">        <span class=\"built_in\">panic</span>(errors.New(<span class=\"string\">\"should be a slice ptr\"</span>))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    slice := value.Elem()</span><br><span class=\"line\">    nSlice := reflect.New(slice.Type()).Elem()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> slice.Kind() != reflect.Slice &#123;</span><br><span class=\"line\">        <span class=\"built_in\">panic</span>(errors.New(<span class=\"string\">\"should be a slice ptr\"</span>))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    l := slice.Len()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> l == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; l; i++ &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> i != index &#123;</span><br><span class=\"line\">            nSlice = reflect.Append(nSlice, slice.Index(i))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    slice.Set(nSlice)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><h3 id=\"示例-1\"><a href=\"#示例-1\" class=\"headerlink\" title=\"示例\"></a>示例</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> s := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, <span class=\"number\">1</span>, <span class=\"number\">3</span>, <span class=\"number\">2</span>&#125;</span><br><span class=\"line\">SliceUnique(&amp;s)</span><br><span class=\"line\">fmt.Println(s) <span class=\"comment\">// []int&#123;1, 2, 3&#125;</span></span><br></pre></td></tr></table></figure><hr><p>to be continued...</p>","site":{"data":{}},"excerpt":"<p>最近在用golang写业务代码，没有用框架，所以自己写的一些 <code>helper</code> 来辅助开发。这里分享下 <code>slice</code> 相关的 <code>helper</code> 。</p><h2 id=\"SliceDiff\"><a href=\"#SliceDiff\" class=\"headerlink\" title=\"SliceDiff\"></a>SliceDiff</h2><h3 id=\"目的\"><a href=\"#目的\" class=\"headerlink\" title=\"目的\"></a>目的</h3><p>用于比较两个相同类型的slice，并找到不同的部分</p><h3 id=\"设计\"><a href=\"#设计\" class=\"headerlink\" title=\"设计\"></a>设计</h3><p>最初设计是只接收2个参数，然后返回一个[]interface{}，但是这样的返回意味着面临断言的可能，所有决定用反射优化下。 函数将接收3个参数，都为slice。第一个是原本的slice，第二个参数是用于和第一个slice做比较，比价之后的结果将会存入第三个参数中，所以第三个参数必须是个指针slice。 同时也兼容了空slice的情况，如果第一个参数是个空的slice，则直接return，跳过后续计算。 如果参数存在问题，比如类型不统一、第三个参数不是指针，会直接panic 😱 。 没有返回值。</p>","more":"<h3 id=\"代码实现\"><a href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">SliceDiff</span><span class=\"params\">(main, compared, result <span class=\"keyword\">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class=\"line\">    mainValue := reflect.Indirect(reflect.ValueOf(main))</span><br><span class=\"line\">    comparedValue := reflect.Indirect(reflect.ValueOf(compared))</span><br><span class=\"line\">    <span class=\"keyword\">if</span> mainValue.Type() != comparedValue.Type() &#123;</span><br><span class=\"line\">        <span class=\"built_in\">panic</span>(errors.New(<span class=\"string\">\"main's and compared's types should be the same\"</span>))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    resultValue := reflect.ValueOf(result)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> resultValue.Kind() != reflect.Ptr &#123;</span><br><span class=\"line\">        <span class=\"built_in\">panic</span>(errors.New(<span class=\"string\">\"result should be a slice ptr\"</span>))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    resultSlice := resultValue.Elem()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> resultSlice.Kind() != reflect.Slice &#123;</span><br><span class=\"line\">        <span class=\"built_in\">panic</span>(errors.New(<span class=\"string\">\"result should be a slice ptr\"</span>))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    mainLen := mainValue.Len()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> mainLen == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    comparedLen := comparedValue.Len()</span><br><span class=\"line\">    nSlice := reflect.New(resultSlice.Type()).Elem()</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; mainLen; i++ &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> found <span class=\"keyword\">bool</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> j := <span class=\"number\">0</span>; j &lt; comparedLen; j++ &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> reflect.DeepEqual(mainValue.Index(i).Interface(), comparedValue.Index(j).Interface()) &#123;</span><br><span class=\"line\">                found = <span class=\"literal\">true</span></span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> !found &#123;</span><br><span class=\"line\">            nSlice = reflect.Append(nSlice, mainValue.Index(i))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    resultSlice.Set(nSlice)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><h3 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> diff []<span class=\"keyword\">int</span></span><br><span class=\"line\">SliceDiff([]<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, <span class=\"number\">4</span>&#125;, []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>&#125;, &amp;diff)</span><br><span class=\"line\">fmt.Println(diff) <span class=\"comment\">// []int&#123;3, 4&#125;</span></span><br></pre></td></tr></table></figure><hr><h2 id=\"SliceUnique\"><a href=\"#SliceUnique\" class=\"headerlink\" title=\"SliceUnique\"></a>SliceUnique</h2><h3 id=\"目的-1\"><a href=\"#目的-1\" class=\"headerlink\" title=\"目的\"></a>目的</h3><p>对slice中的元素去重</p><h3 id=\"设计-1\"><a href=\"#设计-1\" class=\"headerlink\" title=\"设计\"></a>设计</h3><p>函数只需接收一个参数，即要进行去重的slice指针。 然后由函数实现去重并覆盖原slice。 如果参数的类型不正确，会直接panic 😱。</p><h3 id=\"代码实现-1\"><a href=\"#代码实现-1\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">SliceUnset</span><span class=\"params\">(slicePtr <span class=\"keyword\">interface</span>&#123;&#125;, index <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">    value := reflect.ValueOf(slicePtr)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> value.Kind() != reflect.Ptr &#123;</span><br><span class=\"line\">        <span class=\"built_in\">panic</span>(errors.New(<span class=\"string\">\"should be a slice ptr\"</span>))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    slice := value.Elem()</span><br><span class=\"line\">    nSlice := reflect.New(slice.Type()).Elem()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> slice.Kind() != reflect.Slice &#123;</span><br><span class=\"line\">        <span class=\"built_in\">panic</span>(errors.New(<span class=\"string\">\"should be a slice ptr\"</span>))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    l := slice.Len()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> l == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; l; i++ &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> i != index &#123;</span><br><span class=\"line\">            nSlice = reflect.Append(nSlice, slice.Index(i))</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    slice.Set(nSlice)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><h3 id=\"示例-1\"><a href=\"#示例-1\" class=\"headerlink\" title=\"示例\"></a>示例</h3><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> s := []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, <span class=\"number\">1</span>, <span class=\"number\">3</span>, <span class=\"number\">2</span>&#125;</span><br><span class=\"line\">SliceUnique(&amp;s)</span><br><span class=\"line\">fmt.Println(s) <span class=\"comment\">// []int&#123;1, 2, 3&#125;</span></span><br></pre></td></tr></table></figure><hr><p>to be continued...</p>"},{"title":"The Unforgiven II","date":"2018-04-16T08:25:37.000Z","_content":"\n## The Unforgiven II\n\nLay beside me\n躺在我身边\n\nTell me what they've done\n向我讲述他们的所作所为\n\nto make my demons run\n来赶走我的心魔\n\nThe door is locked now\n上了锁的门\n\nbut it's open if you're true\n会因为你的真诚而打开\n\nIf you can understand the me\n如果你可以理解面前的这个我\n\nthen i can understand the you\n那我也可以理解面前的这个你\n\n<!-- more -->\n\nLay beside me\n躺在我身边\n\nunder wicked sky\n在邪恶的天空下\n\nThe black of day, dark of night\n白天的黑, 夜晚的暗\n\nWe share this paralyze\n我们都麻木不仁\n\nThe door cracks open\n门突然打开\n\nBlack heart scarring darker still\n内心更加黑暗\n\nbut there's no sun shining through\n没有阳关照射\n\nNo, theres no sun shining\n根本没有阳光\n\nWhat ive felt\n我所感受的\n\nWhat ive known\n我所了解的\n\nTurn the pages\n翻开书卷\n\nTurn the stone\n搬开石头\n\nBehind the door\n我的心门\n\nshould I open it for you?\n是否应该为你打开?\n\n\nWhat ive felt\n我所感受的\n\nWhat ive known\n我所了解的\n\nSick and tired\n伤痛和疲惫\n\nI stand alone\n我独自承担\n\nCould you be there?\n你会在那儿吗?\n\nCause I'm the one who waits for you\n因为我是一直在等待你的人\n\nOr are you unforgiven too?\n或者你也不可饶恕?\n\n---\n\nCome lay beside me\n过来吧, 趟在我身边\n\nThis won't hurt, I swear\n我发誓不会有伤害\n\nShe loves me not\n也许她不爱我\n\nShe loves me still\n也许她还爱我\n\nBut she'll never love again\n但都永远不会再爱了\n\nShe lays beside me\n她趟在我身边\n\nbut she'll be there when I'm gone\n不过当我离去的时候, 她会在那边\n\nBlack heart scarring darker still\n内心更加黑暗\n\nYes, she'll be there when I'm gone\n是的, 当我离去的时候她会在那边\n\nDead sure she'll be there\n一定会在\n\nWhat ive felt\n我所感受的\n\nWhat ive known\n我所了解的\n\nTurn the pages\n翻开书卷\n\nTurn the stone\n搬开石头\n\nBehind the door\n我的心门\n\nshould I open it for you?\n是否应该为你打开?\n\nWhat ive felt\n我所感受的\n\nWhat ive known\n我所了解的\n\nSick and tired\n伤痛和疲惫\n\nI stand alone\n我独自承担\n\nCould you be there?\n你会在那儿吗?\n\nCause I'm the one who waits for you\n因为我是一直在等待你的人\n\nOr are you unforgiven too?\n或者你也不可饶恕?\n\n---\n\nLay beside me\n趟在我身边\n\nTell me what I've done\n向我讲述我的所作所为\n\nThe door is closed, so are your eyes\n你闭着的双眼，如同关上的门\n\nBut now I see the sun\n不过我现在看见了太阳\n\nYes, now I see it\n是的, 我看到了\n\nWhat ive felt\n我所感受的\n\nWhat ive known\n我所了解的\n\nTurn the pages\n翻开书卷\n\nTurn the stone\n搬开石头\n\nBehind the door\n我的心门\n\nshould I open it for you?\n是否应该为你打开?\n\nWhat ive felt\n我所感受的\n\nWhat ive known\n我所了解的\n\nSick and tired\n伤痛和疲惫\n\nI stand alone\n我独自承担\n\nCould you be there?\n你会在那儿吗?\n\nCause I'm the one who waits for you\n因为我是一直在等待你的人\n\nOr are you unforgiven too?\n或者你也不可饶恕?\n","source":"_posts/2018-04-16-The-Unforgiven-II.md","raw":"---\ntitle: The Unforgiven II\ndate: 2018-04-16 16:25:37\ntags:\n- Metallica\ncategories:\n- 翻译\n---\n\n## The Unforgiven II\n\nLay beside me\n躺在我身边\n\nTell me what they've done\n向我讲述他们的所作所为\n\nto make my demons run\n来赶走我的心魔\n\nThe door is locked now\n上了锁的门\n\nbut it's open if you're true\n会因为你的真诚而打开\n\nIf you can understand the me\n如果你可以理解面前的这个我\n\nthen i can understand the you\n那我也可以理解面前的这个你\n\n<!-- more -->\n\nLay beside me\n躺在我身边\n\nunder wicked sky\n在邪恶的天空下\n\nThe black of day, dark of night\n白天的黑, 夜晚的暗\n\nWe share this paralyze\n我们都麻木不仁\n\nThe door cracks open\n门突然打开\n\nBlack heart scarring darker still\n内心更加黑暗\n\nbut there's no sun shining through\n没有阳关照射\n\nNo, theres no sun shining\n根本没有阳光\n\nWhat ive felt\n我所感受的\n\nWhat ive known\n我所了解的\n\nTurn the pages\n翻开书卷\n\nTurn the stone\n搬开石头\n\nBehind the door\n我的心门\n\nshould I open it for you?\n是否应该为你打开?\n\n\nWhat ive felt\n我所感受的\n\nWhat ive known\n我所了解的\n\nSick and tired\n伤痛和疲惫\n\nI stand alone\n我独自承担\n\nCould you be there?\n你会在那儿吗?\n\nCause I'm the one who waits for you\n因为我是一直在等待你的人\n\nOr are you unforgiven too?\n或者你也不可饶恕?\n\n---\n\nCome lay beside me\n过来吧, 趟在我身边\n\nThis won't hurt, I swear\n我发誓不会有伤害\n\nShe loves me not\n也许她不爱我\n\nShe loves me still\n也许她还爱我\n\nBut she'll never love again\n但都永远不会再爱了\n\nShe lays beside me\n她趟在我身边\n\nbut she'll be there when I'm gone\n不过当我离去的时候, 她会在那边\n\nBlack heart scarring darker still\n内心更加黑暗\n\nYes, she'll be there when I'm gone\n是的, 当我离去的时候她会在那边\n\nDead sure she'll be there\n一定会在\n\nWhat ive felt\n我所感受的\n\nWhat ive known\n我所了解的\n\nTurn the pages\n翻开书卷\n\nTurn the stone\n搬开石头\n\nBehind the door\n我的心门\n\nshould I open it for you?\n是否应该为你打开?\n\nWhat ive felt\n我所感受的\n\nWhat ive known\n我所了解的\n\nSick and tired\n伤痛和疲惫\n\nI stand alone\n我独自承担\n\nCould you be there?\n你会在那儿吗?\n\nCause I'm the one who waits for you\n因为我是一直在等待你的人\n\nOr are you unforgiven too?\n或者你也不可饶恕?\n\n---\n\nLay beside me\n趟在我身边\n\nTell me what I've done\n向我讲述我的所作所为\n\nThe door is closed, so are your eyes\n你闭着的双眼，如同关上的门\n\nBut now I see the sun\n不过我现在看见了太阳\n\nYes, now I see it\n是的, 我看到了\n\nWhat ive felt\n我所感受的\n\nWhat ive known\n我所了解的\n\nTurn the pages\n翻开书卷\n\nTurn the stone\n搬开石头\n\nBehind the door\n我的心门\n\nshould I open it for you?\n是否应该为你打开?\n\nWhat ive felt\n我所感受的\n\nWhat ive known\n我所了解的\n\nSick and tired\n伤痛和疲惫\n\nI stand alone\n我独自承担\n\nCould you be there?\n你会在那儿吗?\n\nCause I'm the one who waits for you\n因为我是一直在等待你的人\n\nOr are you unforgiven too?\n或者你也不可饶恕?\n","slug":"The-Unforgiven-II","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j4000giubfdylphnnl","content":"<h2 id=\"The-Unforgiven-II\"><a href=\"#The-Unforgiven-II\" class=\"headerlink\" title=\"The Unforgiven II\"></a>The Unforgiven II</h2><p>Lay beside me 躺在我身边</p><p>Tell me what they&#39;ve done 向我讲述他们的所作所为</p><p>to make my demons run 来赶走我的心魔</p><p>The door is locked now 上了锁的门</p><p>but it&#39;s open if you&#39;re true 会因为你的真诚而打开</p><p>If you can understand the me 如果你可以理解面前的这个我</p><p>then i can understand the you 那我也可以理解面前的这个你</p><a id=\"more\"></a><p>Lay beside me 躺在我身边</p><p>under wicked sky 在邪恶的天空下</p><p>The black of day, dark of night 白天的黑, 夜晚的暗</p><p>We share this paralyze 我们都麻木不仁</p><p>The door cracks open 门突然打开</p><p>Black heart scarring darker still 内心更加黑暗</p><p>but there&#39;s no sun shining through 没有阳关照射</p><p>No, theres no sun shining 根本没有阳光</p><p>What ive felt 我所感受的</p><p>What ive known 我所了解的</p><p>Turn the pages 翻开书卷</p><p>Turn the stone 搬开石头</p><p>Behind the door 我的心门</p><p>should I open it for you? 是否应该为你打开?</p><p>What ive felt 我所感受的</p><p>What ive known 我所了解的</p><p>Sick and tired 伤痛和疲惫</p><p>I stand alone 我独自承担</p><p>Could you be there? 你会在那儿吗?</p><p>Cause I&#39;m the one who waits for you 因为我是一直在等待你的人</p><p>Or are you unforgiven too? 或者你也不可饶恕?</p><hr><p>Come lay beside me 过来吧, 趟在我身边</p><p>This won&#39;t hurt, I swear 我发誓不会有伤害</p><p>She loves me not 也许她不爱我</p><p>She loves me still 也许她还爱我</p><p>But she&#39;ll never love again 但都永远不会再爱了</p><p>She lays beside me 她趟在我身边</p><p>but she&#39;ll be there when I&#39;m gone 不过当我离去的时候, 她会在那边</p><p>Black heart scarring darker still 内心更加黑暗</p><p>Yes, she&#39;ll be there when I&#39;m gone 是的, 当我离去的时候她会在那边</p><p>Dead sure she&#39;ll be there 一定会在</p><p>What ive felt 我所感受的</p><p>What ive known 我所了解的</p><p>Turn the pages 翻开书卷</p><p>Turn the stone 搬开石头</p><p>Behind the door 我的心门</p><p>should I open it for you? 是否应该为你打开?</p><p>What ive felt 我所感受的</p><p>What ive known 我所了解的</p><p>Sick and tired 伤痛和疲惫</p><p>I stand alone 我独自承担</p><p>Could you be there? 你会在那儿吗?</p><p>Cause I&#39;m the one who waits for you 因为我是一直在等待你的人</p><p>Or are you unforgiven too? 或者你也不可饶恕?</p><hr><p>Lay beside me 趟在我身边</p><p>Tell me what I&#39;ve done 向我讲述我的所作所为</p><p>The door is closed, so are your eyes 你闭着的双眼，如同关上的门</p><p>But now I see the sun 不过我现在看见了太阳</p><p>Yes, now I see it 是的, 我看到了</p><p>What ive felt 我所感受的</p><p>What ive known 我所了解的</p><p>Turn the pages 翻开书卷</p><p>Turn the stone 搬开石头</p><p>Behind the door 我的心门</p><p>should I open it for you? 是否应该为你打开?</p><p>What ive felt 我所感受的</p><p>What ive known 我所了解的</p><p>Sick and tired 伤痛和疲惫</p><p>I stand alone 我独自承担</p><p>Could you be there? 你会在那儿吗?</p><p>Cause I&#39;m the one who waits for you 因为我是一直在等待你的人</p><p>Or are you unforgiven too? 或者你也不可饶恕?</p>","site":{"data":{}},"excerpt":"<h2 id=\"The-Unforgiven-II\"><a href=\"#The-Unforgiven-II\" class=\"headerlink\" title=\"The Unforgiven II\"></a>The Unforgiven II</h2><p>Lay beside me 躺在我身边</p><p>Tell me what they&#39;ve done 向我讲述他们的所作所为</p><p>to make my demons run 来赶走我的心魔</p><p>The door is locked now 上了锁的门</p><p>but it&#39;s open if you&#39;re true 会因为你的真诚而打开</p><p>If you can understand the me 如果你可以理解面前的这个我</p><p>then i can understand the you 那我也可以理解面前的这个你</p>","more":"<p>Lay beside me 躺在我身边</p><p>under wicked sky 在邪恶的天空下</p><p>The black of day, dark of night 白天的黑, 夜晚的暗</p><p>We share this paralyze 我们都麻木不仁</p><p>The door cracks open 门突然打开</p><p>Black heart scarring darker still 内心更加黑暗</p><p>but there&#39;s no sun shining through 没有阳关照射</p><p>No, theres no sun shining 根本没有阳光</p><p>What ive felt 我所感受的</p><p>What ive known 我所了解的</p><p>Turn the pages 翻开书卷</p><p>Turn the stone 搬开石头</p><p>Behind the door 我的心门</p><p>should I open it for you? 是否应该为你打开?</p><p>What ive felt 我所感受的</p><p>What ive known 我所了解的</p><p>Sick and tired 伤痛和疲惫</p><p>I stand alone 我独自承担</p><p>Could you be there? 你会在那儿吗?</p><p>Cause I&#39;m the one who waits for you 因为我是一直在等待你的人</p><p>Or are you unforgiven too? 或者你也不可饶恕?</p><hr><p>Come lay beside me 过来吧, 趟在我身边</p><p>This won&#39;t hurt, I swear 我发誓不会有伤害</p><p>She loves me not 也许她不爱我</p><p>She loves me still 也许她还爱我</p><p>But she&#39;ll never love again 但都永远不会再爱了</p><p>She lays beside me 她趟在我身边</p><p>but she&#39;ll be there when I&#39;m gone 不过当我离去的时候, 她会在那边</p><p>Black heart scarring darker still 内心更加黑暗</p><p>Yes, she&#39;ll be there when I&#39;m gone 是的, 当我离去的时候她会在那边</p><p>Dead sure she&#39;ll be there 一定会在</p><p>What ive felt 我所感受的</p><p>What ive known 我所了解的</p><p>Turn the pages 翻开书卷</p><p>Turn the stone 搬开石头</p><p>Behind the door 我的心门</p><p>should I open it for you? 是否应该为你打开?</p><p>What ive felt 我所感受的</p><p>What ive known 我所了解的</p><p>Sick and tired 伤痛和疲惫</p><p>I stand alone 我独自承担</p><p>Could you be there? 你会在那儿吗?</p><p>Cause I&#39;m the one who waits for you 因为我是一直在等待你的人</p><p>Or are you unforgiven too? 或者你也不可饶恕?</p><hr><p>Lay beside me 趟在我身边</p><p>Tell me what I&#39;ve done 向我讲述我的所作所为</p><p>The door is closed, so are your eyes 你闭着的双眼，如同关上的门</p><p>But now I see the sun 不过我现在看见了太阳</p><p>Yes, now I see it 是的, 我看到了</p><p>What ive felt 我所感受的</p><p>What ive known 我所了解的</p><p>Turn the pages 翻开书卷</p><p>Turn the stone 搬开石头</p><p>Behind the door 我的心门</p><p>should I open it for you? 是否应该为你打开?</p><p>What ive felt 我所感受的</p><p>What ive known 我所了解的</p><p>Sick and tired 伤痛和疲惫</p><p>I stand alone 我独自承担</p><p>Could you be there? 你会在那儿吗?</p><p>Cause I&#39;m the one who waits for you 因为我是一直在等待你的人</p><p>Or are you unforgiven too? 或者你也不可饶恕?</p>"},{"title":"搭建简单的nginx文件服务","date":"2018-04-25T02:14:41.000Z","_content":"\n在没有提供第三方存储服务的时候，可以先用NGINX做一个简单的本地存储服务，最终也能很方便地实现通过 `GET /archives/abc/efg/hij/hash.png` 方式访问文件。\n\n**Here we go.**\n\n配置 `nginx.conf`：\n\n```conf\nuser  nginx;\nworker_processes  auto;\n\nerror_log  /var/log/nginx/error.log warn;\npid        /var/run/nginx.pid;\n\nevents {\n    worker_connections  1024;\n}\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile        on;\n    # tcp_nopush     on;\n\n    keepalive_timeout  65;\n\n    gzip on;\n    gzip_proxied any;\n    gzip_types *;\n    gzip_comp_level 6;\n\n    proxy_set_header Host $http_host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n    server {\n        listen 80;\n        location /archives/ {\n            alias /var/www/files/;\n            autoindex off;\n        }\n    }\n}\n```\n\n重点在于：\n\n```conf\nlocation /archives/ {\n    alias /var/www/files/;\n    autoindex off;\n}\n```\n\n这里用的是 `alias` 指令而并非 `root`。两者的区别在于：\n\n> In case of the `root` directive, **full path is appended to the root including the location part**,\n> whereas in case of the `alias` directive, **only the portion of the path *NOT* including the location part is appended to the alias**.\n> https://stackoverflow.com/questions/10631933/nginx-static-file-serving-confusion-with-root-alias\n\n重启nginx后，访问 `localhost/archives/path/to/file.png` 即可访问 `/var/www/files/path/to/file.png` 文件\n注意一点，`alias` 参数的末尾斜杠是必须添加的！\n\n如果要用 `root` 指令，那么就需要配置重写规则了：\n\n```conf\nlocation /archives/ {\n    autoindex off;\n    root /var/www/files;\n    rewrite /archives/(.*) /$1 break;\n}\n```\n","source":"_posts/2018-04-25-搭建简单的nginx文件服务.md","raw":"---\ntitle: 搭建简单的nginx文件服务\ndate: 2018-04-25 10:14:41\ncategories:\n- 笔记\ntags:\n- nginx\n---\n\n在没有提供第三方存储服务的时候，可以先用NGINX做一个简单的本地存储服务，最终也能很方便地实现通过 `GET /archives/abc/efg/hij/hash.png` 方式访问文件。\n\n**Here we go.**\n\n配置 `nginx.conf`：\n\n```conf\nuser  nginx;\nworker_processes  auto;\n\nerror_log  /var/log/nginx/error.log warn;\npid        /var/run/nginx.pid;\n\nevents {\n    worker_connections  1024;\n}\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile        on;\n    # tcp_nopush     on;\n\n    keepalive_timeout  65;\n\n    gzip on;\n    gzip_proxied any;\n    gzip_types *;\n    gzip_comp_level 6;\n\n    proxy_set_header Host $http_host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n    server {\n        listen 80;\n        location /archives/ {\n            alias /var/www/files/;\n            autoindex off;\n        }\n    }\n}\n```\n\n重点在于：\n\n```conf\nlocation /archives/ {\n    alias /var/www/files/;\n    autoindex off;\n}\n```\n\n这里用的是 `alias` 指令而并非 `root`。两者的区别在于：\n\n> In case of the `root` directive, **full path is appended to the root including the location part**,\n> whereas in case of the `alias` directive, **only the portion of the path *NOT* including the location part is appended to the alias**.\n> https://stackoverflow.com/questions/10631933/nginx-static-file-serving-confusion-with-root-alias\n\n重启nginx后，访问 `localhost/archives/path/to/file.png` 即可访问 `/var/www/files/path/to/file.png` 文件\n注意一点，`alias` 参数的末尾斜杠是必须添加的！\n\n如果要用 `root` 指令，那么就需要配置重写规则了：\n\n```conf\nlocation /archives/ {\n    autoindex off;\n    root /var/www/files;\n    rewrite /archives/(.*) /$1 break;\n}\n```\n","slug":"搭建简单的nginx文件服务","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j6000hiubf5tccg8sl","content":"<p>在没有提供第三方存储服务的时候，可以先用NGINX做一个简单的本地存储服务，最终也能很方便地实现通过 <code>GET /archives/abc/efg/hij/hash.png</code> 方式访问文件。</p><p><strong>Here we go.</strong></p><p>配置 <code>nginx.conf</code>：</p><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user  nginx;</span><br><span class=\"line\">worker_processes  auto;</span><br><span class=\"line\"></span><br><span class=\"line\">error_log  /var/log/nginx/error.log warn;</span><br><span class=\"line\">pid        /var/run/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    worker_connections  1024;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">    include       /etc/nginx/mime.types;</span><br><span class=\"line\">    default_type  application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class=\"line\">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class=\"line\">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class=\"line\"></span><br><span class=\"line\">    access_log  /var/log/nginx/access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    sendfile        on;</span><br><span class=\"line\">    # tcp_nopush     on;</span><br><span class=\"line\"></span><br><span class=\"line\">    keepalive_timeout  65;</span><br><span class=\"line\"></span><br><span class=\"line\">    gzip on;</span><br><span class=\"line\">    gzip_proxied any;</span><br><span class=\"line\">    gzip_types *;</span><br><span class=\"line\">    gzip_comp_level 6;</span><br><span class=\"line\"></span><br><span class=\"line\">    proxy_set_header Host $http_host;</span><br><span class=\"line\">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\"></span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">        listen 80;</span><br><span class=\"line\">        location /archives/ &#123;</span><br><span class=\"line\">            alias /var/www/files/;</span><br><span class=\"line\">            autoindex off;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>重点在于：</p><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location /archives/ &#123;</span><br><span class=\"line\">    alias /var/www/files/;</span><br><span class=\"line\">    autoindex off;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>这里用的是 <code>alias</code> 指令而并非 <code>root</code>。两者的区别在于：</p><blockquote><p>In case of the <code>root</code> directive, <strong>full path is appended to the root including the location part</strong>, whereas in case of the <code>alias</code> directive, <strong>only the portion of the path <em>NOT</em> including the location part is appended to the alias</strong>. <a href=\"https://stackoverflow.com/questions/10631933/nginx-static-file-serving-confusion-with-root-alias\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/10631933/nginx-static-file-serving-confusion-with-root-alias</a></p></blockquote><p>重启nginx后，访问 <code>localhost/archives/path/to/file.png</code> 即可访问 <code>/var/www/files/path/to/file.png</code> 文件 注意一点，<code>alias</code> 参数的末尾斜杠是必须添加的！</p><p>如果要用 <code>root</code> 指令，那么就需要配置重写规则了：</p><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location /archives/ &#123;</span><br><span class=\"line\">    autoindex off;</span><br><span class=\"line\">    root /var/www/files;</span><br><span class=\"line\">    rewrite /archives/(.*) /$1 break;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>在没有提供第三方存储服务的时候，可以先用NGINX做一个简单的本地存储服务，最终也能很方便地实现通过 <code>GET /archives/abc/efg/hij/hash.png</code> 方式访问文件。</p><p><strong>Here we go.</strong></p><p>配置 <code>nginx.conf</code>：</p><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user  nginx;</span><br><span class=\"line\">worker_processes  auto;</span><br><span class=\"line\"></span><br><span class=\"line\">error_log  /var/log/nginx/error.log warn;</span><br><span class=\"line\">pid        /var/run/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    worker_connections  1024;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">    include       /etc/nginx/mime.types;</span><br><span class=\"line\">    default_type  application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class=\"line\">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class=\"line\">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class=\"line\"></span><br><span class=\"line\">    access_log  /var/log/nginx/access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    sendfile        on;</span><br><span class=\"line\">    # tcp_nopush     on;</span><br><span class=\"line\"></span><br><span class=\"line\">    keepalive_timeout  65;</span><br><span class=\"line\"></span><br><span class=\"line\">    gzip on;</span><br><span class=\"line\">    gzip_proxied any;</span><br><span class=\"line\">    gzip_types *;</span><br><span class=\"line\">    gzip_comp_level 6;</span><br><span class=\"line\"></span><br><span class=\"line\">    proxy_set_header Host $http_host;</span><br><span class=\"line\">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\"></span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">        listen 80;</span><br><span class=\"line\">        location /archives/ &#123;</span><br><span class=\"line\">            alias /var/www/files/;</span><br><span class=\"line\">            autoindex off;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>重点在于：</p><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location /archives/ &#123;</span><br><span class=\"line\">    alias /var/www/files/;</span><br><span class=\"line\">    autoindex off;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>这里用的是 <code>alias</code> 指令而并非 <code>root</code>。两者的区别在于：</p><blockquote><p>In case of the <code>root</code> directive, <strong>full path is appended to the root including the location part</strong>, whereas in case of the <code>alias</code> directive, <strong>only the portion of the path <em>NOT</em> including the location part is appended to the alias</strong>. <a href=\"https://stackoverflow.com/questions/10631933/nginx-static-file-serving-confusion-with-root-alias\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/10631933/nginx-static-file-serving-confusion-with-root-alias</a></p></blockquote><p>重启nginx后，访问 <code>localhost/archives/path/to/file.png</code> 即可访问 <code>/var/www/files/path/to/file.png</code> 文件 注意一点，<code>alias</code> 参数的末尾斜杠是必须添加的！</p><p>如果要用 <code>root</code> 指令，那么就需要配置重写规则了：</p><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location /archives/ &#123;</span><br><span class=\"line\">    autoindex off;</span><br><span class=\"line\">    root /var/www/files;</span><br><span class=\"line\">    rewrite /archives/(.*) /$1 break;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"Nginx+FPM配置","date":"2018-05-30T02:07:19.000Z","_content":"记录下nginx+fpm的配置，适用于laravel\n\nnginx.conf\n\n```sh\nuser  nginx;\nworker_processes  auto;\n\nerror_log  /var/log/nginx/error.log warn;\npid        /var/run/nginx.pid;\n\nevents {\n    worker_connections  1024;\n}\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n    access_log  /var/log/nginx/access.log  main;\n    sendfile        on;\n    #tcp_nopush     on;\n    keepalive_timeout  65;\n    #gzip  on;\n\n    # servers starts here\n    server {\n        listen 8080;\n        server_name   localhost;\n        root /var/www/project;\n        include ./fpm.conf;\n    }\n}\n```\n\nfpm.conf\n\n```sh\nindex index.php index.html index.htm;\n\nlocation / {\n    try_files $uri $uri/ /index.php?$query_string;\n}\n\nlocation ~ \\.php$ {\n    fastcgi_pass   fpm:9000;\n    fastcgi_index  index.php;\n    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n    include        fastcgi_params;\n}\n```\n","source":"_posts/2018-05-30-Nginx-FPM配置.md","raw":"---\ntitle: Nginx+FPM配置\ndate: 2018-05-30 10:07:19\ncategories:\n- 笔记\ntags:\n- nginx\n- php\n- fpm\n---\n记录下nginx+fpm的配置，适用于laravel\n\nnginx.conf\n\n```sh\nuser  nginx;\nworker_processes  auto;\n\nerror_log  /var/log/nginx/error.log warn;\npid        /var/run/nginx.pid;\n\nevents {\n    worker_connections  1024;\n}\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n    access_log  /var/log/nginx/access.log  main;\n    sendfile        on;\n    #tcp_nopush     on;\n    keepalive_timeout  65;\n    #gzip  on;\n\n    # servers starts here\n    server {\n        listen 8080;\n        server_name   localhost;\n        root /var/www/project;\n        include ./fpm.conf;\n    }\n}\n```\n\nfpm.conf\n\n```sh\nindex index.php index.html index.htm;\n\nlocation / {\n    try_files $uri $uri/ /index.php?$query_string;\n}\n\nlocation ~ \\.php$ {\n    fastcgi_pass   fpm:9000;\n    fastcgi_index  index.php;\n    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n    include        fastcgi_params;\n}\n```\n","slug":"Nginx-FPM配置","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j7000iiubf3qc01na0","content":"<p>记录下nginx+fpm的配置，适用于laravel</p><p>nginx.conf</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user  nginx;</span><br><span class=\"line\">worker_processes  auto;</span><br><span class=\"line\"></span><br><span class=\"line\">error_log  /var/<span class=\"built_in\">log</span>/nginx/error.log warn;</span><br><span class=\"line\">pid        /var/run/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    worker_connections  1024;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">    include       /etc/nginx/mime.types;</span><br><span class=\"line\">    default_type  application/octet-stream;</span><br><span class=\"line\">    log_format  main  <span class=\"string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span></span><br><span class=\"line\">                      <span class=\"string\">'$status $body_bytes_sent \"$http_referer\" '</span></span><br><span class=\"line\">                      <span class=\"string\">'\"$http_user_agent\" \"$http_x_forwarded_for\"'</span>;</span><br><span class=\"line\">    access_log  /var/<span class=\"built_in\">log</span>/nginx/access.log  main;</span><br><span class=\"line\">    sendfile        on;</span><br><span class=\"line\">    <span class=\"comment\">#tcp_nopush     on;</span></span><br><span class=\"line\">    keepalive_timeout  65;</span><br><span class=\"line\">    <span class=\"comment\">#gzip  on;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># servers starts here</span></span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">        listen 8080;</span><br><span class=\"line\">        server_name   localhost;</span><br><span class=\"line\">        root /var/www/project;</span><br><span class=\"line\">        include ./fpm.conf;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>fpm.conf</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">index index.php index.html index.htm;</span><br><span class=\"line\"></span><br><span class=\"line\">location / &#123;</span><br><span class=\"line\">    try_files <span class=\"variable\">$uri</span> <span class=\"variable\">$uri</span>/ /index.php?<span class=\"variable\">$query_string</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">location ~ \\.php$ &#123;</span><br><span class=\"line\">    fastcgi_pass   fpm:9000;</span><br><span class=\"line\">    fastcgi_index  index.php;</span><br><span class=\"line\">    fastcgi_param  SCRIPT_FILENAME  <span class=\"variable\">$document_root</span><span class=\"variable\">$fastcgi_script_name</span>;</span><br><span class=\"line\">    include        fastcgi_params;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>记录下nginx+fpm的配置，适用于laravel</p><p>nginx.conf</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user  nginx;</span><br><span class=\"line\">worker_processes  auto;</span><br><span class=\"line\"></span><br><span class=\"line\">error_log  /var/<span class=\"built_in\">log</span>/nginx/error.log warn;</span><br><span class=\"line\">pid        /var/run/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    worker_connections  1024;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">    include       /etc/nginx/mime.types;</span><br><span class=\"line\">    default_type  application/octet-stream;</span><br><span class=\"line\">    log_format  main  <span class=\"string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span></span><br><span class=\"line\">                      <span class=\"string\">'$status $body_bytes_sent \"$http_referer\" '</span></span><br><span class=\"line\">                      <span class=\"string\">'\"$http_user_agent\" \"$http_x_forwarded_for\"'</span>;</span><br><span class=\"line\">    access_log  /var/<span class=\"built_in\">log</span>/nginx/access.log  main;</span><br><span class=\"line\">    sendfile        on;</span><br><span class=\"line\">    <span class=\"comment\">#tcp_nopush     on;</span></span><br><span class=\"line\">    keepalive_timeout  65;</span><br><span class=\"line\">    <span class=\"comment\">#gzip  on;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># servers starts here</span></span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">        listen 8080;</span><br><span class=\"line\">        server_name   localhost;</span><br><span class=\"line\">        root /var/www/project;</span><br><span class=\"line\">        include ./fpm.conf;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>fpm.conf</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">index index.php index.html index.htm;</span><br><span class=\"line\"></span><br><span class=\"line\">location / &#123;</span><br><span class=\"line\">    try_files <span class=\"variable\">$uri</span> <span class=\"variable\">$uri</span>/ /index.php?<span class=\"variable\">$query_string</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">location ~ \\.php$ &#123;</span><br><span class=\"line\">    fastcgi_pass   fpm:9000;</span><br><span class=\"line\">    fastcgi_index  index.php;</span><br><span class=\"line\">    fastcgi_param  SCRIPT_FILENAME  <span class=\"variable\">$document_root</span><span class=\"variable\">$fastcgi_script_name</span>;</span><br><span class=\"line\">    include        fastcgi_params;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"Happy Birthday!","date":"2018-05-03T03:01:11.000Z","_content":"生日快乐！\n今天（2018-05-03）是你阳历生日，24岁，生命中的第二个本命年，希望可以愉快的度过这一年。\n\n很遗憾，以我们目前所处的环境，能邀请到的朋友实在太少，从而没有办法举办你想要的生日趴。\n遥想大学时光，身边总有好多要好的朋友，甚至每周都可以出来聚一次，不管做什么都是快乐的。\n毕业之后，各奔东西，还在同一座城市的伙伴太少了。\n你也常常在我耳边说，如今能约出来的人越来越少了。\n我也认为我们需要结交一些新的朋友，多接触一些社会各个层面的人。\n然而自从我离开大学校园之后，却很找到志同道合、趣味相投的人；也不太愿意带着目的去结交朋友，而且也不知道对方是否也是带有目的。\n不过仍需努力，不仅是为了生日趴，也为了我们的未来生活。\n\n都说本命年不好过，不过就我觉得这个本命年一定是幸福快乐的，因为不久之前，我们都找到了新的工作，都涨了工资，哥哥也一岁了，健康好动。\n良好的开头已经具备了，成功的一半已经达成了！\n本命年来之不易，希望我们都能记得这一年。\n时光飞逝，不知不觉我们在一起已经超过4年了，我们的脸庞已由当年的青涩，逐渐变得沉稳，爱你的心也越发深沉坚定。\n许多开心和难过的时刻都历历在目，非常感谢和庆幸这一路有你相伴，给与我鼓励和支持，让我成为更好的自己。\n\n我愿意陪你走过剩下的本命年，不知你是否也愿意陪我（愿意） 😂。\n希望你也可以变成更好的自己，生日快乐！\n","source":"_posts/2018-05-03-Happy-Birthday.md","raw":"---\ntitle: Happy Birthday!\ndate: 2018-05-03 11:01:11\ncategories:\n- 感情\ntags:\n---\n生日快乐！\n今天（2018-05-03）是你阳历生日，24岁，生命中的第二个本命年，希望可以愉快的度过这一年。\n\n很遗憾，以我们目前所处的环境，能邀请到的朋友实在太少，从而没有办法举办你想要的生日趴。\n遥想大学时光，身边总有好多要好的朋友，甚至每周都可以出来聚一次，不管做什么都是快乐的。\n毕业之后，各奔东西，还在同一座城市的伙伴太少了。\n你也常常在我耳边说，如今能约出来的人越来越少了。\n我也认为我们需要结交一些新的朋友，多接触一些社会各个层面的人。\n然而自从我离开大学校园之后，却很找到志同道合、趣味相投的人；也不太愿意带着目的去结交朋友，而且也不知道对方是否也是带有目的。\n不过仍需努力，不仅是为了生日趴，也为了我们的未来生活。\n\n都说本命年不好过，不过就我觉得这个本命年一定是幸福快乐的，因为不久之前，我们都找到了新的工作，都涨了工资，哥哥也一岁了，健康好动。\n良好的开头已经具备了，成功的一半已经达成了！\n本命年来之不易，希望我们都能记得这一年。\n时光飞逝，不知不觉我们在一起已经超过4年了，我们的脸庞已由当年的青涩，逐渐变得沉稳，爱你的心也越发深沉坚定。\n许多开心和难过的时刻都历历在目，非常感谢和庆幸这一路有你相伴，给与我鼓励和支持，让我成为更好的自己。\n\n我愿意陪你走过剩下的本命年，不知你是否也愿意陪我（愿意） 😂。\n希望你也可以变成更好的自己，生日快乐！\n","slug":"Happy-Birthday","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j8000jiubf1trks4cq","content":"<p>生日快乐！ 今天（2018-05-03）是你阳历生日，24岁，生命中的第二个本命年，希望可以愉快的度过这一年。</p><p>很遗憾，以我们目前所处的环境，能邀请到的朋友实在太少，从而没有办法举办你想要的生日趴。 遥想大学时光，身边总有好多要好的朋友，甚至每周都可以出来聚一次，不管做什么都是快乐的。 毕业之后，各奔东西，还在同一座城市的伙伴太少了。 你也常常在我耳边说，如今能约出来的人越来越少了。 我也认为我们需要结交一些新的朋友，多接触一些社会各个层面的人。 然而自从我离开大学校园之后，却很找到志同道合、趣味相投的人；也不太愿意带着目的去结交朋友，而且也不知道对方是否也是带有目的。 不过仍需努力，不仅是为了生日趴，也为了我们的未来生活。</p><p>都说本命年不好过，不过就我觉得这个本命年一定是幸福快乐的，因为不久之前，我们都找到了新的工作，都涨了工资，哥哥也一岁了，健康好动。 良好的开头已经具备了，成功的一半已经达成了！ 本命年来之不易，希望我们都能记得这一年。 时光飞逝，不知不觉我们在一起已经超过4年了，我们的脸庞已由当年的青涩，逐渐变得沉稳，爱你的心也越发深沉坚定。 许多开心和难过的时刻都历历在目，非常感谢和庆幸这一路有你相伴，给与我鼓励和支持，让我成为更好的自己。</p><p>我愿意陪你走过剩下的本命年，不知你是否也愿意陪我（愿意） 😂。 希望你也可以变成更好的自己，生日快乐！</p>","site":{"data":{}},"excerpt":"","more":"<p>生日快乐！ 今天（2018-05-03）是你阳历生日，24岁，生命中的第二个本命年，希望可以愉快的度过这一年。</p><p>很遗憾，以我们目前所处的环境，能邀请到的朋友实在太少，从而没有办法举办你想要的生日趴。 遥想大学时光，身边总有好多要好的朋友，甚至每周都可以出来聚一次，不管做什么都是快乐的。 毕业之后，各奔东西，还在同一座城市的伙伴太少了。 你也常常在我耳边说，如今能约出来的人越来越少了。 我也认为我们需要结交一些新的朋友，多接触一些社会各个层面的人。 然而自从我离开大学校园之后，却很找到志同道合、趣味相投的人；也不太愿意带着目的去结交朋友，而且也不知道对方是否也是带有目的。 不过仍需努力，不仅是为了生日趴，也为了我们的未来生活。</p><p>都说本命年不好过，不过就我觉得这个本命年一定是幸福快乐的，因为不久之前，我们都找到了新的工作，都涨了工资，哥哥也一岁了，健康好动。 良好的开头已经具备了，成功的一半已经达成了！ 本命年来之不易，希望我们都能记得这一年。 时光飞逝，不知不觉我们在一起已经超过4年了，我们的脸庞已由当年的青涩，逐渐变得沉稳，爱你的心也越发深沉坚定。 许多开心和难过的时刻都历历在目，非常感谢和庆幸这一路有你相伴，给与我鼓励和支持，让我成为更好的自己。</p><p>我愿意陪你走过剩下的本命年，不知你是否也愿意陪我（愿意） 😂。 希望你也可以变成更好的自己，生日快乐！</p>"},{"title":"certbot更新证书","date":"2018-08-23T12:59:19.000Z","_content":"\n一键更新证书的脚步，适用于docker容器中的nginx\n\n```sh\n#!/bin/sh\n\n# usage:\n# ./cert.sh <certonly|renew>\n\ncd $(dirname \"$0\"); # 到当前目录下\n\ndocker-compose stop nginx\n\ndocker run -it --rm --name certbot \\\n            -v \"/etc/letsencrypt:/etc/letsencrypt\" \\\n            -v \"/var/lib/letsencrypt:/var/lib/letsencrypt\" \\\n            -p 80:80 \\\n            -p 443:443 \\\n            certbot/certbot \"$@\"\n\ndocker-compose up -d\n```\n","source":"_posts/2018-08-23-certbot更新证书.md","raw":"---\ntitle: certbot更新证书\ndate: 2018-08-23 20:59:19\ncategories:\n- 笔记\ntags:\n- nginx\n- https\n---\n\n一键更新证书的脚步，适用于docker容器中的nginx\n\n```sh\n#!/bin/sh\n\n# usage:\n# ./cert.sh <certonly|renew>\n\ncd $(dirname \"$0\"); # 到当前目录下\n\ndocker-compose stop nginx\n\ndocker run -it --rm --name certbot \\\n            -v \"/etc/letsencrypt:/etc/letsencrypt\" \\\n            -v \"/var/lib/letsencrypt:/var/lib/letsencrypt\" \\\n            -p 80:80 \\\n            -p 443:443 \\\n            certbot/certbot \"$@\"\n\ndocker-compose up -d\n```\n","slug":"certbot更新证书","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j8000kiubf8j3rwo42","content":"<p>一键更新证书的脚步，适用于docker容器中的nginx</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># usage:</span></span><br><span class=\"line\"><span class=\"comment\"># ./cert.sh &lt;certonly|renew&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> $(dirname <span class=\"string\">\"<span class=\"variable\">$0</span>\"</span>); <span class=\"comment\"># 到当前目录下</span></span><br><span class=\"line\"></span><br><span class=\"line\">docker-compose stop nginx</span><br><span class=\"line\"></span><br><span class=\"line\">docker run -it --rm --name certbot \\</span><br><span class=\"line\">            -v <span class=\"string\">\"/etc/letsencrypt:/etc/letsencrypt\"</span> \\</span><br><span class=\"line\">            -v <span class=\"string\">\"/var/lib/letsencrypt:/var/lib/letsencrypt\"</span> \\</span><br><span class=\"line\">            -p 80:80 \\</span><br><span class=\"line\">            -p 443:443 \\</span><br><span class=\"line\">            certbot/certbot <span class=\"string\">\"<span class=\"variable\">$@</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">docker-compose up -d</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>一键更新证书的脚步，适用于docker容器中的nginx</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># usage:</span></span><br><span class=\"line\"><span class=\"comment\"># ./cert.sh &lt;certonly|renew&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> $(dirname <span class=\"string\">\"<span class=\"variable\">$0</span>\"</span>); <span class=\"comment\"># 到当前目录下</span></span><br><span class=\"line\"></span><br><span class=\"line\">docker-compose stop nginx</span><br><span class=\"line\"></span><br><span class=\"line\">docker run -it --rm --name certbot \\</span><br><span class=\"line\">            -v <span class=\"string\">\"/etc/letsencrypt:/etc/letsencrypt\"</span> \\</span><br><span class=\"line\">            -v <span class=\"string\">\"/var/lib/letsencrypt:/var/lib/letsencrypt\"</span> \\</span><br><span class=\"line\">            -p 80:80 \\</span><br><span class=\"line\">            -p 443:443 \\</span><br><span class=\"line\">            certbot/certbot <span class=\"string\">\"<span class=\"variable\">$@</span>\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">docker-compose up -d</span><br></pre></td></tr></table></figure>"},{"title":"Welcome Home (Sanitarium)","date":"2018-09-07T07:46:08.000Z","_content":"Welcome to where time stands still\n欢迎来到时间静止的地方\n\nNo one leaves and no one will\n没有人离开，也没有人会离开\n\nMoon is full, never seems to change\n一轮满月，恒古不变\n\n<!-- more -->\n\nJust labeled mentally deranged\n随意地被贴上精神错乱的标签\n\nDream the same thing every night\n每夜做相同的梦\n\nI see our freedom in my sight\n梦见我们的自由\n\nNo locked doors, no windows barred\n没有锁住的门，没有封住的窗\n\nNo things to make my brain seem scarred\n不会让我的大脑伤痕累累\n\nSleep my friend and you will see\n睡吧，我的朋友，你会发现\n\nThat dream is my reality\n梦即是现实\n\nThey keep me locked up in this cage\n他们把我锁在这牢笼里\n\nCan't they see it's why my brain says Rage?\n他们难道看不见这是为什么我脑子喷出怒火?\n\nSanitarium, leave me be\n疯人院，离开我\n\nSanitarium, just leave me alone\n疯人院，别来烦我\n\nBuild my fear of what's out there\n外面的未知让我恐惧\n\nAnd cannot breathe the open air\n无法呼吸\n\nWhisper things into my brain\n喃喃自语\n\nAssuring me that I‘m insane\n确信我已经疯掉\n\nThey think our heads are in their hands\n他们认为我们的人头在他们手掌中\n\nBut violent use brings violent plans\n但是使用暴力只会带来暴力的计划\n\nKeep him tied, it makes him well\n绑住他，就是让他变好的办法\n\nHes getting better, can't you tell?\n他正在变好，你难道看不出来？\n\nNo more can they keep us in\n他们再也不能把我们抓进去\n\nListen, damn it, we will win\n妈的，给我听好，我们一定会胜利\n\nThey see it right, they see it well\n在他们开来这都是好的、对的\n\nBut they think this saves us from our Hell\n可他们觉得这样是将我们从我们的地狱里救出\n\nSanitarium, leave me be\n疯人院，离开我\n\nSanitarium, just leave me alone\n疯人院，别来烦我\n\nFear of living on\n对活下去的恐惧\n\nNatives getting restless now\n当地人现在变得焦躁不安\n\nMutiny in the air\n反叛声在空气里回荡\n\nGot some death to do\n要做些毁灭的事\n\nMirror stares back hard\n镜子中的眼神凌厉\n\nKill, it's such a friendly word\n杀戮是多么友善的词汇\n\nSeems the only way\n像是唯一的方法\n\nFor reaching out again\n再次逃出生天\n","source":"_posts/2018-09-07-Welcome-Home-Sanitarium.md","raw":"---\ntitle: Welcome Home (Sanitarium)\ndate: 2018-09-07 15:46:08\ntags:\n- Metallica\ncategories:\n- 翻译\n---\nWelcome to where time stands still\n欢迎来到时间静止的地方\n\nNo one leaves and no one will\n没有人离开，也没有人会离开\n\nMoon is full, never seems to change\n一轮满月，恒古不变\n\n<!-- more -->\n\nJust labeled mentally deranged\n随意地被贴上精神错乱的标签\n\nDream the same thing every night\n每夜做相同的梦\n\nI see our freedom in my sight\n梦见我们的自由\n\nNo locked doors, no windows barred\n没有锁住的门，没有封住的窗\n\nNo things to make my brain seem scarred\n不会让我的大脑伤痕累累\n\nSleep my friend and you will see\n睡吧，我的朋友，你会发现\n\nThat dream is my reality\n梦即是现实\n\nThey keep me locked up in this cage\n他们把我锁在这牢笼里\n\nCan't they see it's why my brain says Rage?\n他们难道看不见这是为什么我脑子喷出怒火?\n\nSanitarium, leave me be\n疯人院，离开我\n\nSanitarium, just leave me alone\n疯人院，别来烦我\n\nBuild my fear of what's out there\n外面的未知让我恐惧\n\nAnd cannot breathe the open air\n无法呼吸\n\nWhisper things into my brain\n喃喃自语\n\nAssuring me that I‘m insane\n确信我已经疯掉\n\nThey think our heads are in their hands\n他们认为我们的人头在他们手掌中\n\nBut violent use brings violent plans\n但是使用暴力只会带来暴力的计划\n\nKeep him tied, it makes him well\n绑住他，就是让他变好的办法\n\nHes getting better, can't you tell?\n他正在变好，你难道看不出来？\n\nNo more can they keep us in\n他们再也不能把我们抓进去\n\nListen, damn it, we will win\n妈的，给我听好，我们一定会胜利\n\nThey see it right, they see it well\n在他们开来这都是好的、对的\n\nBut they think this saves us from our Hell\n可他们觉得这样是将我们从我们的地狱里救出\n\nSanitarium, leave me be\n疯人院，离开我\n\nSanitarium, just leave me alone\n疯人院，别来烦我\n\nFear of living on\n对活下去的恐惧\n\nNatives getting restless now\n当地人现在变得焦躁不安\n\nMutiny in the air\n反叛声在空气里回荡\n\nGot some death to do\n要做些毁灭的事\n\nMirror stares back hard\n镜子中的眼神凌厉\n\nKill, it's such a friendly word\n杀戮是多么友善的词汇\n\nSeems the only way\n像是唯一的方法\n\nFor reaching out again\n再次逃出生天\n","slug":"Welcome-Home-Sanitarium","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j9000liubf3e0sh7tl","content":"<p>Welcome to where time stands still 欢迎来到时间静止的地方</p><p>No one leaves and no one will 没有人离开，也没有人会离开</p><p>Moon is full, never seems to change 一轮满月，恒古不变</p><a id=\"more\"></a><p>Just labeled mentally deranged 随意地被贴上精神错乱的标签</p><p>Dream the same thing every night 每夜做相同的梦</p><p>I see our freedom in my sight 梦见我们的自由</p><p>No locked doors, no windows barred 没有锁住的门，没有封住的窗</p><p>No things to make my brain seem scarred 不会让我的大脑伤痕累累</p><p>Sleep my friend and you will see 睡吧，我的朋友，你会发现</p><p>That dream is my reality 梦即是现实</p><p>They keep me locked up in this cage 他们把我锁在这牢笼里</p><p>Can&#39;t they see it&#39;s why my brain says Rage? 他们难道看不见这是为什么我脑子喷出怒火?</p><p>Sanitarium, leave me be 疯人院，离开我</p><p>Sanitarium, just leave me alone 疯人院，别来烦我</p><p>Build my fear of what&#39;s out there 外面的未知让我恐惧</p><p>And cannot breathe the open air 无法呼吸</p><p>Whisper things into my brain 喃喃自语</p><p>Assuring me that I‘m insane 确信我已经疯掉</p><p>They think our heads are in their hands 他们认为我们的人头在他们手掌中</p><p>But violent use brings violent plans 但是使用暴力只会带来暴力的计划</p><p>Keep him tied, it makes him well 绑住他，就是让他变好的办法</p><p>Hes getting better, can&#39;t you tell? 他正在变好，你难道看不出来？</p><p>No more can they keep us in 他们再也不能把我们抓进去</p><p>Listen, damn it, we will win 妈的，给我听好，我们一定会胜利</p><p>They see it right, they see it well 在他们开来这都是好的、对的</p><p>But they think this saves us from our Hell 可他们觉得这样是将我们从我们的地狱里救出</p><p>Sanitarium, leave me be 疯人院，离开我</p><p>Sanitarium, just leave me alone 疯人院，别来烦我</p><p>Fear of living on 对活下去的恐惧</p><p>Natives getting restless now 当地人现在变得焦躁不安</p><p>Mutiny in the air 反叛声在空气里回荡</p><p>Got some death to do 要做些毁灭的事</p><p>Mirror stares back hard 镜子中的眼神凌厉</p><p>Kill, it&#39;s such a friendly word 杀戮是多么友善的词汇</p><p>Seems the only way 像是唯一的方法</p><p>For reaching out again 再次逃出生天</p>","site":{"data":{}},"excerpt":"<p>Welcome to where time stands still 欢迎来到时间静止的地方</p><p>No one leaves and no one will 没有人离开，也没有人会离开</p><p>Moon is full, never seems to change 一轮满月，恒古不变</p>","more":"<p>Just labeled mentally deranged 随意地被贴上精神错乱的标签</p><p>Dream the same thing every night 每夜做相同的梦</p><p>I see our freedom in my sight 梦见我们的自由</p><p>No locked doors, no windows barred 没有锁住的门，没有封住的窗</p><p>No things to make my brain seem scarred 不会让我的大脑伤痕累累</p><p>Sleep my friend and you will see 睡吧，我的朋友，你会发现</p><p>That dream is my reality 梦即是现实</p><p>They keep me locked up in this cage 他们把我锁在这牢笼里</p><p>Can&#39;t they see it&#39;s why my brain says Rage? 他们难道看不见这是为什么我脑子喷出怒火?</p><p>Sanitarium, leave me be 疯人院，离开我</p><p>Sanitarium, just leave me alone 疯人院，别来烦我</p><p>Build my fear of what&#39;s out there 外面的未知让我恐惧</p><p>And cannot breathe the open air 无法呼吸</p><p>Whisper things into my brain 喃喃自语</p><p>Assuring me that I‘m insane 确信我已经疯掉</p><p>They think our heads are in their hands 他们认为我们的人头在他们手掌中</p><p>But violent use brings violent plans 但是使用暴力只会带来暴力的计划</p><p>Keep him tied, it makes him well 绑住他，就是让他变好的办法</p><p>Hes getting better, can&#39;t you tell? 他正在变好，你难道看不出来？</p><p>No more can they keep us in 他们再也不能把我们抓进去</p><p>Listen, damn it, we will win 妈的，给我听好，我们一定会胜利</p><p>They see it right, they see it well 在他们开来这都是好的、对的</p><p>But they think this saves us from our Hell 可他们觉得这样是将我们从我们的地狱里救出</p><p>Sanitarium, leave me be 疯人院，离开我</p><p>Sanitarium, just leave me alone 疯人院，别来烦我</p><p>Fear of living on 对活下去的恐惧</p><p>Natives getting restless now 当地人现在变得焦躁不安</p><p>Mutiny in the air 反叛声在空气里回荡</p><p>Got some death to do 要做些毁灭的事</p><p>Mirror stares back hard 镜子中的眼神凌厉</p><p>Kill, it&#39;s such a friendly word 杀戮是多么友善的词汇</p><p>Seems the only way 像是唯一的方法</p><p>For reaching out again 再次逃出生天</p>"},{"title":"Mysql函数运用","date":"2019-01-09T10:05:52.000Z","_content":"自从MySQL更新到v5.7以后，支持了json类型数据，使得在项目中存储弱业务逻辑的结构数据变得尤为简单，同时也提供了许多内置json操作函数，如 `JSON_SET`，`JSON_EXTRAT`等。\n然而如果想要修改json字段中的某个元素内容，可能不会简单到一条 `update` 语句。比如现在有这样一个`json`数据:\n```json\n[\n    {\"name\": \"Jack\", \"age\": \"18\"},\n    {\"name\": \"John\", \"age\": \"20\"},\n    {\"name\": \"Benn\", \"age\": 22},\n    // ...\n]\n```\n很明显，上面的`json`数组中的某些对象的`age`属性值错误的存为了字符串，如果我们想要将`age`转换为整数，不管是写多么复杂的子查询恐怕都无法完成，\n因为MySQL目前还没有可以遍历`json`数组的方法。这时我们可以写一个简单的函数来解决这样的问题，比如这样：\n\n```sql\nset @j = '[{...}, {...}, ...]';\nselect fixJsonArr(@j);\n```\n\n<!-- more -->\n\n在创建函数之前记得修改定界符：\n```sh\nmysql> DELIMITER $$;\n```\n\n创建一个函数：\n```sql\nCREATE FUNCTION `fixJsonArr`(objArr JSON) RETURNS json\nBEGIN\n    -- TODO\nEND\n```\n于是我们定义了一个函数，名为`fixJsonArr`，他将接收一个`json`类型参数，经过处理后返回一个`json`类型的数据。\n\n接下来我们需要遍历整个json数组：\n```sql\n-- context ...\nBEGIN\n    DECLARE i int default 0;\n\n    WHILE i< json_length(objArr) do\n        -- Loop\n        -- TODO\n        select i+1 into i; -- i++\n    END WHILE;\nEND\n```\n上面的代码中我们用到了`json_length`内置函数，它将返回json数组的长度，用于遍历循环操作。\n我们使用`select i+1 into i;`的方式来实现`i`的自增，从而控制循环的结束时机，也为后面的逻辑实现变量赋值的效果。\n\n接下来我们要做的就是拿到`age`属性的值，并且转换为整数类型：\n```sql\n-- context ...\nBEGIN\n    DECLARE i int default 0;\n    DECLARE age int default 0;\n\n    WHILE i < json_length(objArr) do\n        -- Loop\n        select cast(json_extract(objArr, CONCAT('$[', i ,'].age')) as unsigned) into age;\n        -- TODO\n        select i+1 into i; -- i++\n    END WHILE;\nEND\n```\n转换成为整数后，我们将使用json_set方法去修改原本的json数组：\n```sql\n-- context ...\nBEGIN\n    DECLARE i int default 0;\n    DECLARE age int default 0;\n\n    WHILE i < json_length(objArr) do\n        -- Loop\n        select cast(json_extract(objArr, CONCAT('$[', i ,'].age')) as unsigned) into age;\n        select json_set(objArr, CONCAT('$[', i ,'].age'), age) into objArr;\n        select i+1 into i; -- i++\n    END WHILE;\n    -- TODO return\nEND\n```\n最后我们只需要返回修改后的json数组即可完成此函数，整个函数看起来将会是这样：\n```sql\nCREATE FUNCTION `fixJsonArr`(objArr JSON) RETURNS json\nBEGIN\n    DECLARE i int DEFAULT 0;\n    DECLARE age int DEFAULT 0;\n\n    WHILE i < json_length(objArr)\n    DO\n        select cast(json_extract(objArr, CONCAT('$[', i ,'].age')) as unsigned) into age;\n        select json_set(objArr, CONCAT('$[', i ,'].age'), age) into objArr;\n        select i+1 into i;\n    END WHILE;\n    RETURN objArr;\nEND\n```\n\n运用：\n```sql\nupdate tb set JsonCol = fixJsonArr(JsonCol) where ...;\n```\n","source":"_posts/2019-01-09-Mysql函数运用.md","raw":"---\ntitle: Mysql函数运用\ndate: 2019-01-09 18:05:52\ncategories:\n- 笔记\ntags:\n- mysql\n---\n自从MySQL更新到v5.7以后，支持了json类型数据，使得在项目中存储弱业务逻辑的结构数据变得尤为简单，同时也提供了许多内置json操作函数，如 `JSON_SET`，`JSON_EXTRAT`等。\n然而如果想要修改json字段中的某个元素内容，可能不会简单到一条 `update` 语句。比如现在有这样一个`json`数据:\n```json\n[\n    {\"name\": \"Jack\", \"age\": \"18\"},\n    {\"name\": \"John\", \"age\": \"20\"},\n    {\"name\": \"Benn\", \"age\": 22},\n    // ...\n]\n```\n很明显，上面的`json`数组中的某些对象的`age`属性值错误的存为了字符串，如果我们想要将`age`转换为整数，不管是写多么复杂的子查询恐怕都无法完成，\n因为MySQL目前还没有可以遍历`json`数组的方法。这时我们可以写一个简单的函数来解决这样的问题，比如这样：\n\n```sql\nset @j = '[{...}, {...}, ...]';\nselect fixJsonArr(@j);\n```\n\n<!-- more -->\n\n在创建函数之前记得修改定界符：\n```sh\nmysql> DELIMITER $$;\n```\n\n创建一个函数：\n```sql\nCREATE FUNCTION `fixJsonArr`(objArr JSON) RETURNS json\nBEGIN\n    -- TODO\nEND\n```\n于是我们定义了一个函数，名为`fixJsonArr`，他将接收一个`json`类型参数，经过处理后返回一个`json`类型的数据。\n\n接下来我们需要遍历整个json数组：\n```sql\n-- context ...\nBEGIN\n    DECLARE i int default 0;\n\n    WHILE i< json_length(objArr) do\n        -- Loop\n        -- TODO\n        select i+1 into i; -- i++\n    END WHILE;\nEND\n```\n上面的代码中我们用到了`json_length`内置函数，它将返回json数组的长度，用于遍历循环操作。\n我们使用`select i+1 into i;`的方式来实现`i`的自增，从而控制循环的结束时机，也为后面的逻辑实现变量赋值的效果。\n\n接下来我们要做的就是拿到`age`属性的值，并且转换为整数类型：\n```sql\n-- context ...\nBEGIN\n    DECLARE i int default 0;\n    DECLARE age int default 0;\n\n    WHILE i < json_length(objArr) do\n        -- Loop\n        select cast(json_extract(objArr, CONCAT('$[', i ,'].age')) as unsigned) into age;\n        -- TODO\n        select i+1 into i; -- i++\n    END WHILE;\nEND\n```\n转换成为整数后，我们将使用json_set方法去修改原本的json数组：\n```sql\n-- context ...\nBEGIN\n    DECLARE i int default 0;\n    DECLARE age int default 0;\n\n    WHILE i < json_length(objArr) do\n        -- Loop\n        select cast(json_extract(objArr, CONCAT('$[', i ,'].age')) as unsigned) into age;\n        select json_set(objArr, CONCAT('$[', i ,'].age'), age) into objArr;\n        select i+1 into i; -- i++\n    END WHILE;\n    -- TODO return\nEND\n```\n最后我们只需要返回修改后的json数组即可完成此函数，整个函数看起来将会是这样：\n```sql\nCREATE FUNCTION `fixJsonArr`(objArr JSON) RETURNS json\nBEGIN\n    DECLARE i int DEFAULT 0;\n    DECLARE age int DEFAULT 0;\n\n    WHILE i < json_length(objArr)\n    DO\n        select cast(json_extract(objArr, CONCAT('$[', i ,'].age')) as unsigned) into age;\n        select json_set(objArr, CONCAT('$[', i ,'].age'), age) into objArr;\n        select i+1 into i;\n    END WHILE;\n    RETURN objArr;\nEND\n```\n\n运用：\n```sql\nupdate tb set JsonCol = fixJsonArr(JsonCol) where ...;\n```\n","slug":"Mysql函数运用","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j9000miubfqqb4rm7e","content":"<p>自从MySQL更新到v5.7以后，支持了json类型数据，使得在项目中存储弱业务逻辑的结构数据变得尤为简单，同时也提供了许多内置json操作函数，如 <code>JSON_SET</code>，<code>JSON_EXTRAT</code>等。 然而如果想要修改json字段中的某个元素内容，可能不会简单到一条 <code>update</code> 语句。比如现在有这样一个<code>json</code>数据:</p><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[</span><br><span class=\"line\">    &#123;<span class=\"attr\">\"name\"</span>: <span class=\"string\">\"Jack\"</span>, <span class=\"attr\">\"age\"</span>: <span class=\"string\">\"18\"</span>&#125;,</span><br><span class=\"line\">    &#123;<span class=\"attr\">\"name\"</span>: <span class=\"string\">\"John\"</span>, <span class=\"attr\">\"age\"</span>: <span class=\"string\">\"20\"</span>&#125;,</span><br><span class=\"line\">    &#123;<span class=\"attr\">\"name\"</span>: <span class=\"string\">\"Benn\"</span>, <span class=\"attr\">\"age\"</span>: <span class=\"number\">22</span>&#125;,</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure><p></p><p>很明显，上面的<code>json</code>数组中的某些对象的<code>age</code>属性值错误的存为了字符串，如果我们想要将<code>age</code>转换为整数，不管是写多么复杂的子查询恐怕都无法完成， 因为MySQL目前还没有可以遍历<code>json</code>数组的方法。这时我们可以写一个简单的函数来解决这样的问题，比如这样：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">set</span> @j = <span class=\"string\">'[&#123;...&#125;, &#123;...&#125;, ...]'</span>;</span><br><span class=\"line\"><span class=\"keyword\">select</span> fixJsonArr(@j);</span><br></pre></td></tr></table></figure><a id=\"more\"></a><p>在创建函数之前记得修改定界符：</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; DELIMITER $$;</span><br></pre></td></tr></table></figure><p></p><p>创建一个函数：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">FUNCTION</span> <span class=\"string\">`fixJsonArr`</span>(objArr <span class=\"keyword\">JSON</span>) <span class=\"keyword\">RETURNS</span> <span class=\"keyword\">json</span></span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">    <span class=\"comment\">-- TODO</span></span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br></pre></td></tr></table></figure><p></p><p>于是我们定义了一个函数，名为<code>fixJsonArr</code>，他将接收一个<code>json</code>类型参数，经过处理后返回一个<code>json</code>类型的数据。</p><p>接下来我们需要遍历整个json数组：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- context ...</span></span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> i <span class=\"built_in\">int</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    WHILE i&lt; json_length(objArr) do</span><br><span class=\"line\">        <span class=\"comment\">-- Loop</span></span><br><span class=\"line\">        <span class=\"comment\">-- TODO</span></span><br><span class=\"line\">        <span class=\"keyword\">select</span> i+<span class=\"number\">1</span> <span class=\"keyword\">into</span> i; <span class=\"comment\">-- i++</span></span><br><span class=\"line\">    <span class=\"keyword\">END</span> <span class=\"keyword\">WHILE</span>;</span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br></pre></td></tr></table></figure><p></p><p>上面的代码中我们用到了<code>json_length</code>内置函数，它将返回json数组的长度，用于遍历循环操作。 我们使用<code>select i+1 into i;</code>的方式来实现<code>i</code>的自增，从而控制循环的结束时机，也为后面的逻辑实现变量赋值的效果。</p><p>接下来我们要做的就是拿到<code>age</code>属性的值，并且转换为整数类型：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- context ...</span></span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> i <span class=\"built_in\">int</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> age <span class=\"built_in\">int</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    WHILE i &lt; json_length(objArr) do</span><br><span class=\"line\">        <span class=\"comment\">-- Loop</span></span><br><span class=\"line\">        <span class=\"keyword\">select</span> <span class=\"keyword\">cast</span>(json_extract(objArr, <span class=\"keyword\">CONCAT</span>(<span class=\"string\">'$['</span>, i ,<span class=\"string\">'].age'</span>)) <span class=\"keyword\">as</span> <span class=\"keyword\">unsigned</span>) <span class=\"keyword\">into</span> age;</span><br><span class=\"line\">        <span class=\"comment\">-- TODO</span></span><br><span class=\"line\">        <span class=\"keyword\">select</span> i+<span class=\"number\">1</span> <span class=\"keyword\">into</span> i; <span class=\"comment\">-- i++</span></span><br><span class=\"line\">    <span class=\"keyword\">END</span> <span class=\"keyword\">WHILE</span>;</span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br></pre></td></tr></table></figure><p></p><p>转换成为整数后，我们将使用json_set方法去修改原本的json数组：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- context ...</span></span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> i <span class=\"built_in\">int</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> age <span class=\"built_in\">int</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    WHILE i &lt; json_length(objArr) do</span><br><span class=\"line\">        <span class=\"comment\">-- Loop</span></span><br><span class=\"line\">        <span class=\"keyword\">select</span> <span class=\"keyword\">cast</span>(json_extract(objArr, <span class=\"keyword\">CONCAT</span>(<span class=\"string\">'$['</span>, i ,<span class=\"string\">'].age'</span>)) <span class=\"keyword\">as</span> <span class=\"keyword\">unsigned</span>) <span class=\"keyword\">into</span> age;</span><br><span class=\"line\">        <span class=\"keyword\">select</span> json_set(objArr, <span class=\"keyword\">CONCAT</span>(<span class=\"string\">'$['</span>, i ,<span class=\"string\">'].age'</span>), age) <span class=\"keyword\">into</span> objArr;</span><br><span class=\"line\">        <span class=\"keyword\">select</span> i+<span class=\"number\">1</span> <span class=\"keyword\">into</span> i; <span class=\"comment\">-- i++</span></span><br><span class=\"line\">    <span class=\"keyword\">END</span> <span class=\"keyword\">WHILE</span>;</span><br><span class=\"line\">    <span class=\"comment\">-- TODO return</span></span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br></pre></td></tr></table></figure><p></p><p>最后我们只需要返回修改后的json数组即可完成此函数，整个函数看起来将会是这样：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">FUNCTION</span> <span class=\"string\">`fixJsonArr`</span>(objArr <span class=\"keyword\">JSON</span>) <span class=\"keyword\">RETURNS</span> <span class=\"keyword\">json</span></span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> i <span class=\"built_in\">int</span> <span class=\"keyword\">DEFAULT</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> age <span class=\"built_in\">int</span> <span class=\"keyword\">DEFAULT</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    WHILE i &lt; json_length(objArr)</span><br><span class=\"line\">    <span class=\"keyword\">DO</span></span><br><span class=\"line\">        <span class=\"keyword\">select</span> <span class=\"keyword\">cast</span>(json_extract(objArr, <span class=\"keyword\">CONCAT</span>(<span class=\"string\">'$['</span>, i ,<span class=\"string\">'].age'</span>)) <span class=\"keyword\">as</span> <span class=\"keyword\">unsigned</span>) <span class=\"keyword\">into</span> age;</span><br><span class=\"line\">        <span class=\"keyword\">select</span> json_set(objArr, <span class=\"keyword\">CONCAT</span>(<span class=\"string\">'$['</span>, i ,<span class=\"string\">'].age'</span>), age) <span class=\"keyword\">into</span> objArr;</span><br><span class=\"line\">        <span class=\"keyword\">select</span> i+<span class=\"number\">1</span> <span class=\"keyword\">into</span> i;</span><br><span class=\"line\">    <span class=\"keyword\">END</span> <span class=\"keyword\">WHILE</span>;</span><br><span class=\"line\">    RETURN objArr;</span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br></pre></td></tr></table></figure><p></p><p>运用：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">update</span> tb <span class=\"keyword\">set</span> JsonCol = fixJsonArr(JsonCol) <span class=\"keyword\">where</span> ...;</span><br></pre></td></tr></table></figure><p></p>","site":{"data":{}},"excerpt":"<p>自从MySQL更新到v5.7以后，支持了json类型数据，使得在项目中存储弱业务逻辑的结构数据变得尤为简单，同时也提供了许多内置json操作函数，如 <code>JSON_SET</code>，<code>JSON_EXTRAT</code>等。 然而如果想要修改json字段中的某个元素内容，可能不会简单到一条 <code>update</code> 语句。比如现在有这样一个<code>json</code>数据:</p><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[</span><br><span class=\"line\">    &#123;<span class=\"attr\">\"name\"</span>: <span class=\"string\">\"Jack\"</span>, <span class=\"attr\">\"age\"</span>: <span class=\"string\">\"18\"</span>&#125;,</span><br><span class=\"line\">    &#123;<span class=\"attr\">\"name\"</span>: <span class=\"string\">\"John\"</span>, <span class=\"attr\">\"age\"</span>: <span class=\"string\">\"20\"</span>&#125;,</span><br><span class=\"line\">    &#123;<span class=\"attr\">\"name\"</span>: <span class=\"string\">\"Benn\"</span>, <span class=\"attr\">\"age\"</span>: <span class=\"number\">22</span>&#125;,</span><br><span class=\"line\">    // ...</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure><p></p><p>很明显，上面的<code>json</code>数组中的某些对象的<code>age</code>属性值错误的存为了字符串，如果我们想要将<code>age</code>转换为整数，不管是写多么复杂的子查询恐怕都无法完成， 因为MySQL目前还没有可以遍历<code>json</code>数组的方法。这时我们可以写一个简单的函数来解决这样的问题，比如这样：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">set</span> @j = <span class=\"string\">'[&#123;...&#125;, &#123;...&#125;, ...]'</span>;</span><br><span class=\"line\"><span class=\"keyword\">select</span> fixJsonArr(@j);</span><br></pre></td></tr></table></figure>","more":"<p>在创建函数之前记得修改定界符：</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; DELIMITER $$;</span><br></pre></td></tr></table></figure><p></p><p>创建一个函数：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">FUNCTION</span> <span class=\"string\">`fixJsonArr`</span>(objArr <span class=\"keyword\">JSON</span>) <span class=\"keyword\">RETURNS</span> <span class=\"keyword\">json</span></span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">    <span class=\"comment\">-- TODO</span></span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br></pre></td></tr></table></figure><p></p><p>于是我们定义了一个函数，名为<code>fixJsonArr</code>，他将接收一个<code>json</code>类型参数，经过处理后返回一个<code>json</code>类型的数据。</p><p>接下来我们需要遍历整个json数组：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- context ...</span></span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> i <span class=\"built_in\">int</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    WHILE i&lt; json_length(objArr) do</span><br><span class=\"line\">        <span class=\"comment\">-- Loop</span></span><br><span class=\"line\">        <span class=\"comment\">-- TODO</span></span><br><span class=\"line\">        <span class=\"keyword\">select</span> i+<span class=\"number\">1</span> <span class=\"keyword\">into</span> i; <span class=\"comment\">-- i++</span></span><br><span class=\"line\">    <span class=\"keyword\">END</span> <span class=\"keyword\">WHILE</span>;</span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br></pre></td></tr></table></figure><p></p><p>上面的代码中我们用到了<code>json_length</code>内置函数，它将返回json数组的长度，用于遍历循环操作。 我们使用<code>select i+1 into i;</code>的方式来实现<code>i</code>的自增，从而控制循环的结束时机，也为后面的逻辑实现变量赋值的效果。</p><p>接下来我们要做的就是拿到<code>age</code>属性的值，并且转换为整数类型：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- context ...</span></span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> i <span class=\"built_in\">int</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> age <span class=\"built_in\">int</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    WHILE i &lt; json_length(objArr) do</span><br><span class=\"line\">        <span class=\"comment\">-- Loop</span></span><br><span class=\"line\">        <span class=\"keyword\">select</span> <span class=\"keyword\">cast</span>(json_extract(objArr, <span class=\"keyword\">CONCAT</span>(<span class=\"string\">'$['</span>, i ,<span class=\"string\">'].age'</span>)) <span class=\"keyword\">as</span> <span class=\"keyword\">unsigned</span>) <span class=\"keyword\">into</span> age;</span><br><span class=\"line\">        <span class=\"comment\">-- TODO</span></span><br><span class=\"line\">        <span class=\"keyword\">select</span> i+<span class=\"number\">1</span> <span class=\"keyword\">into</span> i; <span class=\"comment\">-- i++</span></span><br><span class=\"line\">    <span class=\"keyword\">END</span> <span class=\"keyword\">WHILE</span>;</span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br></pre></td></tr></table></figure><p></p><p>转换成为整数后，我们将使用json_set方法去修改原本的json数组：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- context ...</span></span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> i <span class=\"built_in\">int</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> age <span class=\"built_in\">int</span> <span class=\"keyword\">default</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    WHILE i &lt; json_length(objArr) do</span><br><span class=\"line\">        <span class=\"comment\">-- Loop</span></span><br><span class=\"line\">        <span class=\"keyword\">select</span> <span class=\"keyword\">cast</span>(json_extract(objArr, <span class=\"keyword\">CONCAT</span>(<span class=\"string\">'$['</span>, i ,<span class=\"string\">'].age'</span>)) <span class=\"keyword\">as</span> <span class=\"keyword\">unsigned</span>) <span class=\"keyword\">into</span> age;</span><br><span class=\"line\">        <span class=\"keyword\">select</span> json_set(objArr, <span class=\"keyword\">CONCAT</span>(<span class=\"string\">'$['</span>, i ,<span class=\"string\">'].age'</span>), age) <span class=\"keyword\">into</span> objArr;</span><br><span class=\"line\">        <span class=\"keyword\">select</span> i+<span class=\"number\">1</span> <span class=\"keyword\">into</span> i; <span class=\"comment\">-- i++</span></span><br><span class=\"line\">    <span class=\"keyword\">END</span> <span class=\"keyword\">WHILE</span>;</span><br><span class=\"line\">    <span class=\"comment\">-- TODO return</span></span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br></pre></td></tr></table></figure><p></p><p>最后我们只需要返回修改后的json数组即可完成此函数，整个函数看起来将会是这样：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">FUNCTION</span> <span class=\"string\">`fixJsonArr`</span>(objArr <span class=\"keyword\">JSON</span>) <span class=\"keyword\">RETURNS</span> <span class=\"keyword\">json</span></span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> i <span class=\"built_in\">int</span> <span class=\"keyword\">DEFAULT</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">DECLARE</span> age <span class=\"built_in\">int</span> <span class=\"keyword\">DEFAULT</span> <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    WHILE i &lt; json_length(objArr)</span><br><span class=\"line\">    <span class=\"keyword\">DO</span></span><br><span class=\"line\">        <span class=\"keyword\">select</span> <span class=\"keyword\">cast</span>(json_extract(objArr, <span class=\"keyword\">CONCAT</span>(<span class=\"string\">'$['</span>, i ,<span class=\"string\">'].age'</span>)) <span class=\"keyword\">as</span> <span class=\"keyword\">unsigned</span>) <span class=\"keyword\">into</span> age;</span><br><span class=\"line\">        <span class=\"keyword\">select</span> json_set(objArr, <span class=\"keyword\">CONCAT</span>(<span class=\"string\">'$['</span>, i ,<span class=\"string\">'].age'</span>), age) <span class=\"keyword\">into</span> objArr;</span><br><span class=\"line\">        <span class=\"keyword\">select</span> i+<span class=\"number\">1</span> <span class=\"keyword\">into</span> i;</span><br><span class=\"line\">    <span class=\"keyword\">END</span> <span class=\"keyword\">WHILE</span>;</span><br><span class=\"line\">    RETURN objArr;</span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br></pre></td></tr></table></figure><p></p><p>运用：</p><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">update</span> tb <span class=\"keyword\">set</span> JsonCol = fixJsonArr(JsonCol) <span class=\"keyword\">where</span> ...;</span><br></pre></td></tr></table></figure><p></p>"},{"title":"ssh隧道转发","date":"2018-11-26T02:39:34.000Z","_content":"使用ssl隧道，将内网中的服务转发到本地端口\n\n语法：\n\n```bash\nssh -N -L 本地端口:内网host:内网端口 user@server-host\n```\n\n示例：\n\n```bash\nssh -N -L 3316:10.0.1.2:3306 user@remote.server.com\n```\n\n将remote.server.com中部署在内网10.0.1.2的服务器连接转发到本地3316端口。\n","source":"_posts/2018-11-26-ssh隧道转发.md","raw":"---\ntitle: ssh隧道转发\ndate: 2018-11-26 10:39:34\ncategories:\n- 笔记\ntags:\n- ssh\n---\n使用ssl隧道，将内网中的服务转发到本地端口\n\n语法：\n\n```bash\nssh -N -L 本地端口:内网host:内网端口 user@server-host\n```\n\n示例：\n\n```bash\nssh -N -L 3316:10.0.1.2:3306 user@remote.server.com\n```\n\n将remote.server.com中部署在内网10.0.1.2的服务器连接转发到本地3316端口。\n","slug":"ssh隧道转发","published":1,"updated":"2023-05-28T05:36:04.285Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1j9000niubf8a6twjli","content":"<p>使用ssl隧道，将内网中的服务转发到本地端口</p><p>语法：</p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -N -L 本地端口:内网host:内网端口 user@server-host</span><br></pre></td></tr></table></figure><p>示例：</p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -N -L 3316:10.0.1.2:3306 user@remote.server.com</span><br></pre></td></tr></table></figure><p>将remote.server.com中部署在内网10.0.1.2的服务器连接转发到本地3316端口。</p>","site":{"data":{}},"excerpt":"","more":"<p>使用ssl隧道，将内网中的服务转发到本地端口</p><p>语法：</p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -N -L 本地端口:内网host:内网端口 user@server-host</span><br></pre></td></tr></table></figure><p>示例：</p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -N -L 3316:10.0.1.2:3306 user@remote.server.com</span><br></pre></td></tr></table></figure><p>将remote.server.com中部署在内网10.0.1.2的服务器连接转发到本地3316端口。</p>"},{"title":"记一次群晖 SHR 降级折腾","date":"2019-04-01T02:14:01.000Z","_content":"## 背景\n\n硬件:\n- NAS: 群晖DS218+(双盘位) 系统版本: DSM 6.2.1-23824 Update 1\n- 硬盘: 2T希捷酷狼 x 2\n- 移动硬盘: 1T希捷\n\n由于在最初安装DSM时，系统自动选择了SHR冗余模式，使得其中一块硬盘变成了数据保护盘，实际可用的容量只有2T。\n随着下载的电影，以及上传照片和其他文件的数量增加，NAS空间使用率已高达95%+。\n\n若要给空间扩容，无非是两种策略:\n- 将原有的两块硬盘整体换为更大容量的2块硬盘\n- 将系统原先设定的SHR冗余模式降级为basic模式(无数据冗余保护)，归还硬盘空间\n\n由于NAS空间中的大部分体积被电影所占用，相比之下真正重要的文件--比如照片，生活视频，工作文件等--数量相对较少。\n经过思考，决定采取第二种解决方案，即SHR降级，并配合外接USB存储设备，对重要文件进行冷备份。\n\n<!-- more -->\n\n## 准备\n\n- 将移动硬盘通过USB和NAS连接，可先将硬盘格式化为NTFS格式。\n- `File Station`应用中会新增`usbshare1-1`和`usbshare1-2`两个共享文件夹。通过查看容量空间，找到可用的那一个(usbshare1-2)。\n- 将重要数据备份到移动硬盘中，比如照片。\n\n## SHR降级步骤\n\n- 在NAS运行状态下取出一块硬盘，取出后，在`存储空间管理员`应用中的存储空间上会显示`堪用`字样，此时NAS机器会发出警报声，但可以关闭。\n- 将取出的硬盘插回去，此时该硬盘处于`未初始化`状态。\n- 新增存储空间，此时可以手动选择RAID类型。按照提示，选择basic模式，逐步完成创建。\n- 打开`控制面板`，将所有的共享文件夹，迁移至新的存储空间中，过程中可能需要停用一些应用程序。\n- 迁移完成后，`堪用`存储空间对应的硬盘拔出，并重新插入，然后按照上述方法新增存储空间。如果无法识别硬盘，则重启NAS。(也许可以不用拔硬盘，直接删除存储空间并新增...)\n- 现在已经有2个存储空间了，可以根据需求，迁移共享文件夹。\n- 修复或重新安装NAS套件。\n\n## 数据冷备份\n\n- 编写冷备份脚步，使用rsync:\n```sh\n#!/bin/sh\necho \"started to sync photo.\";\nrsync -avzh --exclude='@eaDir' --exclude='.DS_Store' --delete /volume2/photo/ /volumeUSB1/usbshare1-2/photo/;\n\necho \"started to sync video.\";\nrsync -avzh --exclude='@eaDir' --exclude='.DS_Store' --delete /volume2/video/ /volumeUSB1/usbshare1-2/video/;\n```\n- 将脚本添加到定时任务中。\n\n## 结束\n\n整个过程可能会耗费数小时，不过群晖NAS套件体验是非常好的，很多功能都能轻松实现。\n","source":"_posts/2019-04-01-记一次群晖-SHR-降级折腾.md","raw":"---\ntitle: 记一次群晖 SHR 降级折腾\ndate: 2019-04-01 10:14:01\ncategories:\n- 笔记\ntags:\n- NAS\n- 群晖\n---\n## 背景\n\n硬件:\n- NAS: 群晖DS218+(双盘位) 系统版本: DSM 6.2.1-23824 Update 1\n- 硬盘: 2T希捷酷狼 x 2\n- 移动硬盘: 1T希捷\n\n由于在最初安装DSM时，系统自动选择了SHR冗余模式，使得其中一块硬盘变成了数据保护盘，实际可用的容量只有2T。\n随着下载的电影，以及上传照片和其他文件的数量增加，NAS空间使用率已高达95%+。\n\n若要给空间扩容，无非是两种策略:\n- 将原有的两块硬盘整体换为更大容量的2块硬盘\n- 将系统原先设定的SHR冗余模式降级为basic模式(无数据冗余保护)，归还硬盘空间\n\n由于NAS空间中的大部分体积被电影所占用，相比之下真正重要的文件--比如照片，生活视频，工作文件等--数量相对较少。\n经过思考，决定采取第二种解决方案，即SHR降级，并配合外接USB存储设备，对重要文件进行冷备份。\n\n<!-- more -->\n\n## 准备\n\n- 将移动硬盘通过USB和NAS连接，可先将硬盘格式化为NTFS格式。\n- `File Station`应用中会新增`usbshare1-1`和`usbshare1-2`两个共享文件夹。通过查看容量空间，找到可用的那一个(usbshare1-2)。\n- 将重要数据备份到移动硬盘中，比如照片。\n\n## SHR降级步骤\n\n- 在NAS运行状态下取出一块硬盘，取出后，在`存储空间管理员`应用中的存储空间上会显示`堪用`字样，此时NAS机器会发出警报声，但可以关闭。\n- 将取出的硬盘插回去，此时该硬盘处于`未初始化`状态。\n- 新增存储空间，此时可以手动选择RAID类型。按照提示，选择basic模式，逐步完成创建。\n- 打开`控制面板`，将所有的共享文件夹，迁移至新的存储空间中，过程中可能需要停用一些应用程序。\n- 迁移完成后，`堪用`存储空间对应的硬盘拔出，并重新插入，然后按照上述方法新增存储空间。如果无法识别硬盘，则重启NAS。(也许可以不用拔硬盘，直接删除存储空间并新增...)\n- 现在已经有2个存储空间了，可以根据需求，迁移共享文件夹。\n- 修复或重新安装NAS套件。\n\n## 数据冷备份\n\n- 编写冷备份脚步，使用rsync:\n```sh\n#!/bin/sh\necho \"started to sync photo.\";\nrsync -avzh --exclude='@eaDir' --exclude='.DS_Store' --delete /volume2/photo/ /volumeUSB1/usbshare1-2/photo/;\n\necho \"started to sync video.\";\nrsync -avzh --exclude='@eaDir' --exclude='.DS_Store' --delete /volume2/video/ /volumeUSB1/usbshare1-2/video/;\n```\n- 将脚本添加到定时任务中。\n\n## 结束\n\n整个过程可能会耗费数小时，不过群晖NAS套件体验是非常好的，很多功能都能轻松实现。\n","slug":"记一次群晖-SHR-降级折腾","published":1,"updated":"2023-05-28T05:36:04.286Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1ja000oiubf4sdbmfeq","content":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>硬件:</p><ul><li>NAS: 群晖DS218+(双盘位) 系统版本: DSM 6.2.1-23824 Update 1</li><li>硬盘: 2T希捷酷狼 x 2</li><li>移动硬盘: 1T希捷</li></ul><p>由于在最初安装DSM时，系统自动选择了SHR冗余模式，使得其中一块硬盘变成了数据保护盘，实际可用的容量只有2T。 随着下载的电影，以及上传照片和其他文件的数量增加，NAS空间使用率已高达95%+。</p><p>若要给空间扩容，无非是两种策略:</p><ul><li>将原有的两块硬盘整体换为更大容量的2块硬盘</li><li>将系统原先设定的SHR冗余模式降级为basic模式(无数据冗余保护)，归还硬盘空间</li></ul><p>由于NAS空间中的大部分体积被电影所占用，相比之下真正重要的文件--比如照片，生活视频，工作文件等--数量相对较少。 经过思考，决定采取第二种解决方案，即SHR降级，并配合外接USB存储设备，对重要文件进行冷备份。</p><a id=\"more\"></a><h2 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h2><ul><li>将移动硬盘通过USB和NAS连接，可先将硬盘格式化为NTFS格式。</li><li><code>File Station</code>应用中会新增<code>usbshare1-1</code>和<code>usbshare1-2</code>两个共享文件夹。通过查看容量空间，找到可用的那一个(usbshare1-2)。</li><li>将重要数据备份到移动硬盘中，比如照片。</li></ul><h2 id=\"SHR降级步骤\"><a href=\"#SHR降级步骤\" class=\"headerlink\" title=\"SHR降级步骤\"></a>SHR降级步骤</h2><ul><li>在NAS运行状态下取出一块硬盘，取出后，在<code>存储空间管理员</code>应用中的存储空间上会显示<code>堪用</code>字样，此时NAS机器会发出警报声，但可以关闭。</li><li>将取出的硬盘插回去，此时该硬盘处于<code>未初始化</code>状态。</li><li>新增存储空间，此时可以手动选择RAID类型。按照提示，选择basic模式，逐步完成创建。</li><li>打开<code>控制面板</code>，将所有的共享文件夹，迁移至新的存储空间中，过程中可能需要停用一些应用程序。</li><li>迁移完成后，<code>堪用</code>存储空间对应的硬盘拔出，并重新插入，然后按照上述方法新增存储空间。如果无法识别硬盘，则重启NAS。(也许可以不用拔硬盘，直接删除存储空间并新增...)</li><li>现在已经有2个存储空间了，可以根据需求，迁移共享文件夹。</li><li>修复或重新安装NAS套件。</li></ul><h2 id=\"数据冷备份\"><a href=\"#数据冷备份\" class=\"headerlink\" title=\"数据冷备份\"></a>数据冷备份</h2><ul><li><p>编写冷备份脚步，使用rsync:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"started to sync photo.\"</span>;</span><br><span class=\"line\">rsync -avzh --exclude=<span class=\"string\">'@eaDir'</span> --exclude=<span class=\"string\">'.DS_Store'</span> --delete /volume2/photo/ /volumeUSB1/usbshare1-2/photo/;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"started to sync video.\"</span>;</span><br><span class=\"line\">rsync -avzh --exclude=<span class=\"string\">'@eaDir'</span> --exclude=<span class=\"string\">'.DS_Store'</span> --delete /volume2/video/ /volumeUSB1/usbshare1-2/video/;</span><br></pre></td></tr></table></figure></li><li><p>将脚本添加到定时任务中。</p></li></ul><h2 id=\"结束\"><a href=\"#结束\" class=\"headerlink\" title=\"结束\"></a>结束</h2><p>整个过程可能会耗费数小时，不过群晖NAS套件体验是非常好的，很多功能都能轻松实现。</p>","site":{"data":{}},"excerpt":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>硬件:</p><ul><li>NAS: 群晖DS218+(双盘位) 系统版本: DSM 6.2.1-23824 Update 1</li><li>硬盘: 2T希捷酷狼 x 2</li><li>移动硬盘: 1T希捷</li></ul><p>由于在最初安装DSM时，系统自动选择了SHR冗余模式，使得其中一块硬盘变成了数据保护盘，实际可用的容量只有2T。 随着下载的电影，以及上传照片和其他文件的数量增加，NAS空间使用率已高达95%+。</p><p>若要给空间扩容，无非是两种策略:</p><ul><li>将原有的两块硬盘整体换为更大容量的2块硬盘</li><li>将系统原先设定的SHR冗余模式降级为basic模式(无数据冗余保护)，归还硬盘空间</li></ul><p>由于NAS空间中的大部分体积被电影所占用，相比之下真正重要的文件--比如照片，生活视频，工作文件等--数量相对较少。 经过思考，决定采取第二种解决方案，即SHR降级，并配合外接USB存储设备，对重要文件进行冷备份。</p>","more":"<h2 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h2><ul><li>将移动硬盘通过USB和NAS连接，可先将硬盘格式化为NTFS格式。</li><li><code>File Station</code>应用中会新增<code>usbshare1-1</code>和<code>usbshare1-2</code>两个共享文件夹。通过查看容量空间，找到可用的那一个(usbshare1-2)。</li><li>将重要数据备份到移动硬盘中，比如照片。</li></ul><h2 id=\"SHR降级步骤\"><a href=\"#SHR降级步骤\" class=\"headerlink\" title=\"SHR降级步骤\"></a>SHR降级步骤</h2><ul><li>在NAS运行状态下取出一块硬盘，取出后，在<code>存储空间管理员</code>应用中的存储空间上会显示<code>堪用</code>字样，此时NAS机器会发出警报声，但可以关闭。</li><li>将取出的硬盘插回去，此时该硬盘处于<code>未初始化</code>状态。</li><li>新增存储空间，此时可以手动选择RAID类型。按照提示，选择basic模式，逐步完成创建。</li><li>打开<code>控制面板</code>，将所有的共享文件夹，迁移至新的存储空间中，过程中可能需要停用一些应用程序。</li><li>迁移完成后，<code>堪用</code>存储空间对应的硬盘拔出，并重新插入，然后按照上述方法新增存储空间。如果无法识别硬盘，则重启NAS。(也许可以不用拔硬盘，直接删除存储空间并新增...)</li><li>现在已经有2个存储空间了，可以根据需求，迁移共享文件夹。</li><li>修复或重新安装NAS套件。</li></ul><h2 id=\"数据冷备份\"><a href=\"#数据冷备份\" class=\"headerlink\" title=\"数据冷备份\"></a>数据冷备份</h2><ul><li><p>编写冷备份脚步，使用rsync:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"started to sync photo.\"</span>;</span><br><span class=\"line\">rsync -avzh --exclude=<span class=\"string\">'@eaDir'</span> --exclude=<span class=\"string\">'.DS_Store'</span> --delete /volume2/photo/ /volumeUSB1/usbshare1-2/photo/;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"started to sync video.\"</span>;</span><br><span class=\"line\">rsync -avzh --exclude=<span class=\"string\">'@eaDir'</span> --exclude=<span class=\"string\">'.DS_Store'</span> --delete /volume2/video/ /volumeUSB1/usbshare1-2/video/;</span><br></pre></td></tr></table></figure></li><li><p>将脚本添加到定时任务中。</p></li></ul><h2 id=\"结束\"><a href=\"#结束\" class=\"headerlink\" title=\"结束\"></a>结束</h2><p>整个过程可能会耗费数小时，不过群晖NAS套件体验是非常好的，很多功能都能轻松实现。</p>"},{"title":"iPhoneXS Jailbreak","date":"2019-05-21T09:45:56.000Z","_content":"\n## 起因\n\n手中的 iPhone XS 为了这次越狱，一直坚持停留在 `iOS12.1` 版本，不过也没什么升级动力。昨天惊喜地发现 YouTube 上有人上传了 [`Top 75 Best FREE iOS 12.1.2 Jailbreak Tweaks! A12 Compatible Tweaks!`](https://www.youtube.com/watch?v=2YceB70p2Ms) 视频，满怀期待地点进去看，果然是有越狱工具 release 了！\n\n## 开始越狱\n\n根据视频里的内容，使用 [`Chimera`](https://chimera.sh/) 作为越狱工具，在手机上安装好后，就可以直接一键越狱了。刚开始没注意到可以在已知漏洞中选择一个作为越狱方式，而直接点了 Jailbreak 按钮，结果中途重启了好几次，但最终也完成了越狱，并且安装上了 `Sileo`（Cydia 的替代品）。后来的折腾中，发现使用 `m***2` 这个漏洞，可以非常顺滑地完成越狱，不会遇到重启。\n\n<!-- more -->\n\n## 插件安装\n\n完成越狱后，非常兴奋地点开 `Sileo`，但是却出现了让我耗费许多时间才得以解决的问题。`Sileo` 无法更新源列表，一刷新就会报404的错，这样一来就几乎无法安装任何插件。 Google 了一番也没看见靠谱的解决方法，看了好多无非都是让你重新越狱，或者让你打开 `Sileo` 的网络权限，可是这个时候的 `Sileo` 根本不会出现在网络权限app列表中。于是继续 Google，终于找到了解决方案：\n\n- 使用爱思助手，下载 `乐网` 到手机上\n- 打开 `乐网` 使用全局模式\n- 此时打开 `Sileo` 就可以刷新源列表了！\n- 后来就可以在网络权限里找到 `Sileo` 了！\n\nOK，既然 `Sileo` 可以正常联网了，已经迫不及待地想去安装插件了，但是又遇到了另一个棘手的问题。当成功安装好插件并完成 respring 后，插件既没有生效，而且也不会在 `设置` 中显示该插件选项，于是又开始 Google，又尝试了很多没有用的方法，比如重新安装 `rockebootstrap`、`preferenceLoader` 等插件，其实这些插件已经是最新版本了。最后通过 ssh 连上手机，找到插件的配置文件的位置，并手动拷贝到另一个目录下才得以解决：\n\n首先使用 ssh 连接到手机：`ssh root@your_ip`，初始密码是 `alpine`，登录后记得马上把密码改了。经过简单的探索，发现安装后的插件的配置文件（`.plist` 和 `.dylib`）都会存放在 `/Library/MobileSubstrate/DynamicLibraries` 目录下，而要想使插件生效，则需要将这些配置文件放到 `/Library/TweakInject` 目录中，于是手动 copy 并 respring 后，所有插件都生效了，并且其选项也出现在 `设置` 中。\n\n这个问题的出现可能来自于越狱工具本身，其现象是没有自动复制插件的配置到正确路径。虽然插件可以正常使用了，但是按照这样手动 copy 的方式来完成插件的安装是很不方便的，依然需要思考更好的方案。\n\n其实很容易就发现 `/Library/TweakInject` 这个目录是个软链接，target 是 `/usr/lib/TweakInject`，也就是说插件的配置文件最终都被 copy 到了这里。于是我将 `/Library/MobileSubstrate/DynamicLibraries` 备份后，也做成了软链接，target 也是 `/usr/lib/TweakInject`，respring 后安装了一个新的插件，结果新插件成功生效，原有的插件依然可用！至此，插件安装的问题算是成功解决了。\n\n## 感想\n\n越狱成功，挺高兴的，因为可以安装许多有用的插件了，这些插件将iOS系统变得更加方便顺手。此时想起一句话：\n\n> 越狱之后，iOS才能发挥出它真正的强大。\n\n使用 `Chimera` 越狱，体验是很好的，不过还是存在bug，比如 `Sileo` 网络权限问题和插件安装问题，解决方法都挺简单但是搜索方法的过程就不太容易了，不能立马Google到，这或许也反映出越狱的需求真的在逐渐减少。然而 `Sileo` 相比 `Cydia` 实在是好太多了，至少是这个时代的产品，而 `Cydia` 明显已经过时了。想想上一次越狱还是2015年左右，当时用的是 iPhone 5c，iOS 版本是 7.x，那时的越狱体验是真的好啊，尤其是盘古，一次性成功，完美越狱，插件可用，不需要折腾。\n\n虽然现在处于半完美越狱状态，重启之后将恢复到非越狱状态，但在我看来这也是一种不错的选择。\n","source":"_posts/2019-05-21-iPhoneXS-jailbreak.md","raw":"---\ntitle: iPhoneXS Jailbreak\ndate: 2019-05-21 17:45:56\ncategories:\n- 笔记\ntags:\n- jailbreak\n---\n\n## 起因\n\n手中的 iPhone XS 为了这次越狱，一直坚持停留在 `iOS12.1` 版本，不过也没什么升级动力。昨天惊喜地发现 YouTube 上有人上传了 [`Top 75 Best FREE iOS 12.1.2 Jailbreak Tweaks! A12 Compatible Tweaks!`](https://www.youtube.com/watch?v=2YceB70p2Ms) 视频，满怀期待地点进去看，果然是有越狱工具 release 了！\n\n## 开始越狱\n\n根据视频里的内容，使用 [`Chimera`](https://chimera.sh/) 作为越狱工具，在手机上安装好后，就可以直接一键越狱了。刚开始没注意到可以在已知漏洞中选择一个作为越狱方式，而直接点了 Jailbreak 按钮，结果中途重启了好几次，但最终也完成了越狱，并且安装上了 `Sileo`（Cydia 的替代品）。后来的折腾中，发现使用 `m***2` 这个漏洞，可以非常顺滑地完成越狱，不会遇到重启。\n\n<!-- more -->\n\n## 插件安装\n\n完成越狱后，非常兴奋地点开 `Sileo`，但是却出现了让我耗费许多时间才得以解决的问题。`Sileo` 无法更新源列表，一刷新就会报404的错，这样一来就几乎无法安装任何插件。 Google 了一番也没看见靠谱的解决方法，看了好多无非都是让你重新越狱，或者让你打开 `Sileo` 的网络权限，可是这个时候的 `Sileo` 根本不会出现在网络权限app列表中。于是继续 Google，终于找到了解决方案：\n\n- 使用爱思助手，下载 `乐网` 到手机上\n- 打开 `乐网` 使用全局模式\n- 此时打开 `Sileo` 就可以刷新源列表了！\n- 后来就可以在网络权限里找到 `Sileo` 了！\n\nOK，既然 `Sileo` 可以正常联网了，已经迫不及待地想去安装插件了，但是又遇到了另一个棘手的问题。当成功安装好插件并完成 respring 后，插件既没有生效，而且也不会在 `设置` 中显示该插件选项，于是又开始 Google，又尝试了很多没有用的方法，比如重新安装 `rockebootstrap`、`preferenceLoader` 等插件，其实这些插件已经是最新版本了。最后通过 ssh 连上手机，找到插件的配置文件的位置，并手动拷贝到另一个目录下才得以解决：\n\n首先使用 ssh 连接到手机：`ssh root@your_ip`，初始密码是 `alpine`，登录后记得马上把密码改了。经过简单的探索，发现安装后的插件的配置文件（`.plist` 和 `.dylib`）都会存放在 `/Library/MobileSubstrate/DynamicLibraries` 目录下，而要想使插件生效，则需要将这些配置文件放到 `/Library/TweakInject` 目录中，于是手动 copy 并 respring 后，所有插件都生效了，并且其选项也出现在 `设置` 中。\n\n这个问题的出现可能来自于越狱工具本身，其现象是没有自动复制插件的配置到正确路径。虽然插件可以正常使用了，但是按照这样手动 copy 的方式来完成插件的安装是很不方便的，依然需要思考更好的方案。\n\n其实很容易就发现 `/Library/TweakInject` 这个目录是个软链接，target 是 `/usr/lib/TweakInject`，也就是说插件的配置文件最终都被 copy 到了这里。于是我将 `/Library/MobileSubstrate/DynamicLibraries` 备份后，也做成了软链接，target 也是 `/usr/lib/TweakInject`，respring 后安装了一个新的插件，结果新插件成功生效，原有的插件依然可用！至此，插件安装的问题算是成功解决了。\n\n## 感想\n\n越狱成功，挺高兴的，因为可以安装许多有用的插件了，这些插件将iOS系统变得更加方便顺手。此时想起一句话：\n\n> 越狱之后，iOS才能发挥出它真正的强大。\n\n使用 `Chimera` 越狱，体验是很好的，不过还是存在bug，比如 `Sileo` 网络权限问题和插件安装问题，解决方法都挺简单但是搜索方法的过程就不太容易了，不能立马Google到，这或许也反映出越狱的需求真的在逐渐减少。然而 `Sileo` 相比 `Cydia` 实在是好太多了，至少是这个时代的产品，而 `Cydia` 明显已经过时了。想想上一次越狱还是2015年左右，当时用的是 iPhone 5c，iOS 版本是 7.x，那时的越狱体验是真的好啊，尤其是盘古，一次性成功，完美越狱，插件可用，不需要折腾。\n\n虽然现在处于半完美越狱状态，重启之后将恢复到非越狱状态，但在我看来这也是一种不错的选择。\n","slug":"iPhoneXS-jailbreak","published":1,"updated":"2023-05-28T05:36:04.286Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1jb000piubf7kz4xt19","content":"<h2 id=\"起因\"><a href=\"#起因\" class=\"headerlink\" title=\"起因\"></a>起因</h2><p>手中的 iPhone XS 为了这次越狱，一直坚持停留在 <code>iOS12.1</code> 版本，不过也没什么升级动力。昨天惊喜地发现 YouTube 上有人上传了 <a href=\"https://www.youtube.com/watch?v=2YceB70p2Ms\" target=\"_blank\" rel=\"noopener\"><code>Top 75 Best FREE iOS 12.1.2 Jailbreak Tweaks! A12 Compatible Tweaks!</code></a> 视频，满怀期待地点进去看，果然是有越狱工具 release 了！</p><h2 id=\"开始越狱\"><a href=\"#开始越狱\" class=\"headerlink\" title=\"开始越狱\"></a>开始越狱</h2><p>根据视频里的内容，使用 <a href=\"https://chimera.sh/\" target=\"_blank\" rel=\"noopener\"><code>Chimera</code></a> 作为越狱工具，在手机上安装好后，就可以直接一键越狱了。刚开始没注意到可以在已知漏洞中选择一个作为越狱方式，而直接点了 Jailbreak 按钮，结果中途重启了好几次，但最终也完成了越狱，并且安装上了 <code>Sileo</code>（Cydia 的替代品）。后来的折腾中，发现使用 <code>m***2</code> 这个漏洞，可以非常顺滑地完成越狱，不会遇到重启。</p><a id=\"more\"></a><h2 id=\"插件安装\"><a href=\"#插件安装\" class=\"headerlink\" title=\"插件安装\"></a>插件安装</h2><p>完成越狱后，非常兴奋地点开 <code>Sileo</code>，但是却出现了让我耗费许多时间才得以解决的问题。<code>Sileo</code> 无法更新源列表，一刷新就会报404的错，这样一来就几乎无法安装任何插件。 Google 了一番也没看见靠谱的解决方法，看了好多无非都是让你重新越狱，或者让你打开 <code>Sileo</code> 的网络权限，可是这个时候的 <code>Sileo</code> 根本不会出现在网络权限app列表中。于是继续 Google，终于找到了解决方案：</p><ul><li>使用爱思助手，下载 <code>乐网</code> 到手机上</li><li>打开 <code>乐网</code> 使用全局模式</li><li>此时打开 <code>Sileo</code> 就可以刷新源列表了！</li><li>后来就可以在网络权限里找到 <code>Sileo</code> 了！</li></ul><p>OK，既然 <code>Sileo</code> 可以正常联网了，已经迫不及待地想去安装插件了，但是又遇到了另一个棘手的问题。当成功安装好插件并完成 respring 后，插件既没有生效，而且也不会在 <code>设置</code> 中显示该插件选项，于是又开始 Google，又尝试了很多没有用的方法，比如重新安装 <code>rockebootstrap</code>、<code>preferenceLoader</code> 等插件，其实这些插件已经是最新版本了。最后通过 ssh 连上手机，找到插件的配置文件的位置，并手动拷贝到另一个目录下才得以解决：</p><p>首先使用 ssh 连接到手机：<code>ssh root@your_ip</code>，初始密码是 <code>alpine</code>，登录后记得马上把密码改了。经过简单的探索，发现安装后的插件的配置文件（<code>.plist</code> 和 <code>.dylib</code>）都会存放在 <code>/Library/MobileSubstrate/DynamicLibraries</code> 目录下，而要想使插件生效，则需要将这些配置文件放到 <code>/Library/TweakInject</code> 目录中，于是手动 copy 并 respring 后，所有插件都生效了，并且其选项也出现在 <code>设置</code> 中。</p><p>这个问题的出现可能来自于越狱工具本身，其现象是没有自动复制插件的配置到正确路径。虽然插件可以正常使用了，但是按照这样手动 copy 的方式来完成插件的安装是很不方便的，依然需要思考更好的方案。</p><p>其实很容易就发现 <code>/Library/TweakInject</code> 这个目录是个软链接，target 是 <code>/usr/lib/TweakInject</code>，也就是说插件的配置文件最终都被 copy 到了这里。于是我将 <code>/Library/MobileSubstrate/DynamicLibraries</code> 备份后，也做成了软链接，target 也是 <code>/usr/lib/TweakInject</code>，respring 后安装了一个新的插件，结果新插件成功生效，原有的插件依然可用！至此，插件安装的问题算是成功解决了。</p><h2 id=\"感想\"><a href=\"#感想\" class=\"headerlink\" title=\"感想\"></a>感想</h2><p>越狱成功，挺高兴的，因为可以安装许多有用的插件了，这些插件将iOS系统变得更加方便顺手。此时想起一句话：</p><blockquote><p>越狱之后，iOS才能发挥出它真正的强大。</p></blockquote><p>使用 <code>Chimera</code> 越狱，体验是很好的，不过还是存在bug，比如 <code>Sileo</code> 网络权限问题和插件安装问题，解决方法都挺简单但是搜索方法的过程就不太容易了，不能立马Google到，这或许也反映出越狱的需求真的在逐渐减少。然而 <code>Sileo</code> 相比 <code>Cydia</code> 实在是好太多了，至少是这个时代的产品，而 <code>Cydia</code> 明显已经过时了。想想上一次越狱还是2015年左右，当时用的是 iPhone 5c，iOS 版本是 7.x，那时的越狱体验是真的好啊，尤其是盘古，一次性成功，完美越狱，插件可用，不需要折腾。</p><p>虽然现在处于半完美越狱状态，重启之后将恢复到非越狱状态，但在我看来这也是一种不错的选择。</p>","site":{"data":{}},"excerpt":"<h2 id=\"起因\"><a href=\"#起因\" class=\"headerlink\" title=\"起因\"></a>起因</h2><p>手中的 iPhone XS 为了这次越狱，一直坚持停留在 <code>iOS12.1</code> 版本，不过也没什么升级动力。昨天惊喜地发现 YouTube 上有人上传了 <a href=\"https://www.youtube.com/watch?v=2YceB70p2Ms\" target=\"_blank\" rel=\"noopener\"><code>Top 75 Best FREE iOS 12.1.2 Jailbreak Tweaks! A12 Compatible Tweaks!</code></a> 视频，满怀期待地点进去看，果然是有越狱工具 release 了！</p><h2 id=\"开始越狱\"><a href=\"#开始越狱\" class=\"headerlink\" title=\"开始越狱\"></a>开始越狱</h2><p>根据视频里的内容，使用 <a href=\"https://chimera.sh/\" target=\"_blank\" rel=\"noopener\"><code>Chimera</code></a> 作为越狱工具，在手机上安装好后，就可以直接一键越狱了。刚开始没注意到可以在已知漏洞中选择一个作为越狱方式，而直接点了 Jailbreak 按钮，结果中途重启了好几次，但最终也完成了越狱，并且安装上了 <code>Sileo</code>（Cydia 的替代品）。后来的折腾中，发现使用 <code>m***2</code> 这个漏洞，可以非常顺滑地完成越狱，不会遇到重启。</p>","more":"<h2 id=\"插件安装\"><a href=\"#插件安装\" class=\"headerlink\" title=\"插件安装\"></a>插件安装</h2><p>完成越狱后，非常兴奋地点开 <code>Sileo</code>，但是却出现了让我耗费许多时间才得以解决的问题。<code>Sileo</code> 无法更新源列表，一刷新就会报404的错，这样一来就几乎无法安装任何插件。 Google 了一番也没看见靠谱的解决方法，看了好多无非都是让你重新越狱，或者让你打开 <code>Sileo</code> 的网络权限，可是这个时候的 <code>Sileo</code> 根本不会出现在网络权限app列表中。于是继续 Google，终于找到了解决方案：</p><ul><li>使用爱思助手，下载 <code>乐网</code> 到手机上</li><li>打开 <code>乐网</code> 使用全局模式</li><li>此时打开 <code>Sileo</code> 就可以刷新源列表了！</li><li>后来就可以在网络权限里找到 <code>Sileo</code> 了！</li></ul><p>OK，既然 <code>Sileo</code> 可以正常联网了，已经迫不及待地想去安装插件了，但是又遇到了另一个棘手的问题。当成功安装好插件并完成 respring 后，插件既没有生效，而且也不会在 <code>设置</code> 中显示该插件选项，于是又开始 Google，又尝试了很多没有用的方法，比如重新安装 <code>rockebootstrap</code>、<code>preferenceLoader</code> 等插件，其实这些插件已经是最新版本了。最后通过 ssh 连上手机，找到插件的配置文件的位置，并手动拷贝到另一个目录下才得以解决：</p><p>首先使用 ssh 连接到手机：<code>ssh root@your_ip</code>，初始密码是 <code>alpine</code>，登录后记得马上把密码改了。经过简单的探索，发现安装后的插件的配置文件（<code>.plist</code> 和 <code>.dylib</code>）都会存放在 <code>/Library/MobileSubstrate/DynamicLibraries</code> 目录下，而要想使插件生效，则需要将这些配置文件放到 <code>/Library/TweakInject</code> 目录中，于是手动 copy 并 respring 后，所有插件都生效了，并且其选项也出现在 <code>设置</code> 中。</p><p>这个问题的出现可能来自于越狱工具本身，其现象是没有自动复制插件的配置到正确路径。虽然插件可以正常使用了，但是按照这样手动 copy 的方式来完成插件的安装是很不方便的，依然需要思考更好的方案。</p><p>其实很容易就发现 <code>/Library/TweakInject</code> 这个目录是个软链接，target 是 <code>/usr/lib/TweakInject</code>，也就是说插件的配置文件最终都被 copy 到了这里。于是我将 <code>/Library/MobileSubstrate/DynamicLibraries</code> 备份后，也做成了软链接，target 也是 <code>/usr/lib/TweakInject</code>，respring 后安装了一个新的插件，结果新插件成功生效，原有的插件依然可用！至此，插件安装的问题算是成功解决了。</p><h2 id=\"感想\"><a href=\"#感想\" class=\"headerlink\" title=\"感想\"></a>感想</h2><p>越狱成功，挺高兴的，因为可以安装许多有用的插件了，这些插件将iOS系统变得更加方便顺手。此时想起一句话：</p><blockquote><p>越狱之后，iOS才能发挥出它真正的强大。</p></blockquote><p>使用 <code>Chimera</code> 越狱，体验是很好的，不过还是存在bug，比如 <code>Sileo</code> 网络权限问题和插件安装问题，解决方法都挺简单但是搜索方法的过程就不太容易了，不能立马Google到，这或许也反映出越狱的需求真的在逐渐减少。然而 <code>Sileo</code> 相比 <code>Cydia</code> 实在是好太多了，至少是这个时代的产品，而 <code>Cydia</code> 明显已经过时了。想想上一次越狱还是2015年左右，当时用的是 iPhone 5c，iOS 版本是 7.x，那时的越狱体验是真的好啊，尤其是盘古，一次性成功，完美越狱，插件可用，不需要折腾。</p><p>虽然现在处于半完美越狱状态，重启之后将恢复到非越狱状态，但在我看来这也是一种不错的选择。</p>"},{"title":"MySQL 数据库 InnoDB 学习笔记","date":"2019-07-04T07:55:28.000Z","_content":"记录最近对MySQL学习的一些总结。\n\n<!-- more -->\n\n# 索引\n\n## 聚合索引\n\n主键字段的索引就是聚合索引，索引中保存了整行记录的所有字段值\n\n## 辅助索引\n\n其他字段的索引就是辅助索引，辅助索引仅仅保存了记录行的主键值(id) 和当前索引的字段。\n\n## 索引覆盖(覆盖索引)\n\n一般来说，当执行 `select * from user where age = 10;` 时，如果 `age` 字段添加了 `B+TREE` 索引，\n则 MySQL 会先通过辅助索引查找到记录的 id，再通过聚合索引最终查找到数据行各字段的值。\n但如果查询语句中只去查询索引中包含的字段，查询时就只需通过辅助索引定位，拿到索引字段值后将结果返回即可，\n不用再去查找聚合索引，这样就实现了索引覆盖。当然，如果查询语句中还同时包含主键字段 (id) ，那也同样可以实现索引覆盖。\n\n## 索引建立的几大原则\n\n1. 最左匹配\n\n    索引会从where 语句开始，从左到右进行匹配，直到遇到范围查询 (>，<，!=，like，between) 时，匹配将会停止。\n    在 `a = 1 and b = 2 and c > 3 and d = 4` 语句中，建立联合索引 (a, b, c, d)，此时 字段 d 是无法用到索引的，因为 c > 3 是范围查询，\n    索引匹配到这里就停止了。如果将联合索引的顺序调整为 (a, b, d, c) 则可以用到索引，\n    因为上述的 where 语句等效于 `a = 1 and b = 2 and d = 4 and c > 3` 这个顺序和索引一致，虽然有范围查询但那已经是最后一个条件了。\n    我们不用手动去调整 where 中条件的顺序，MySQL 查询优化器会自动调整条件位置，以尽可能地使用索引。\n\n2. = 之间可以乱序\n\n    由于 MySQL 查询优化器会自动调整条件位置，以尽可能地使用索引，所以在有索引 (a, b, c) 的情况下，`a = 1 and c = 3 and b = 2` 这样的语句也是可以使用索引的。\n\n3. 尽量选择区分度高的字段来添加索引\n\n    区分度是指一个字段的值在记录中去重后的数量比上所有记录数量，表示这个字段值不重复的比例，即: `count(distinct('column')) / count(*)`，\n    在sql中一般可以这样来查看: `select type, count(*) from t group by type`。区分度越高则需要索引匹配的次数就越少，查询就越快速。\n    可以看出，表中主键的区分度固定为 1，而一些类型、状态等枚举字段将会在数据量逐渐增大情况下趋近与 0，这样的字段更适合添加 `Hash` 索引而不是 `B+TREE`。\n\n4. 索引列不能参与计算，否则无法使用索引\n\n    比如 `from_unixtime(created_at) = '2019-07-04 14:41:30'` 是不能使用 create_time 索引的，应换成这样: `created_at = unix_timestamp('2019-07-04 14:43:11')`\n\n# 事务\n\n## 术语概念\n\n- 脏读 (Dirty Read):\n\n    事务中的修改，即使没有提交，对其他事务也都是可见的。事务可以读取未提交的数据，这也被称作脏读。\n    例: A事务begin => B事务begin => B事务update某行 => A事务select该行，得到了更新后的结果\n\n- 不可重复读 (Unrepeatable Read):\n\n    事务中的修改提交后，其结果被其他事务所读取到。\n    例: A事务begin => B事务begin => B事务update某行 =>B 事务commit => A事务读取该行，得到了更新后的结果\n\n- 幻读 (Phantom Read):\n\n    所谓幻读，指的是当某个事务在读取某个范围内的记录时，另外一个事务又在该范围内插入了新的记录，当之前的事务再次读取该范围的记录时，会产生幻行。\n    例: A事务begin => B事务begin => B事务insert => B事务commit => A事务select，得到了之前没有的数据\n    解决方式: 加锁 (乐观锁 / 悲观锁)。InnoDB 存储引擎通过多版本并发控制（MVCC）解决了幻读的问题。\n\n| 事务隔离级别                | 脏读 | 不可重复读 | 幻读 | 备注                                                            |\n| --------------------------- | ---- | ---------- | ---- | --------------------------------------------------------------- |\n| (未提交读) Read Uncommitted | y    | y          | y    | 性能好，但是会早成许多业务上的异常，一般不用                    |\n| (已提交读) Read Committed   | n    | y          | y    | 可以避免脏读，但是会出现不可重复读                              |\n| (可重复读) Repeatable Read  | n    | n          | y    | InnoDB 默认的隔离级别，实际上已经通过 Next-Key 锁机制避免了幻读 |\n| (串行化) Serializable       | n    | n          | n    | 性能消耗太大，一般不用 (select 时也会加锁)                      |\n\n## 不可重复读和幻读的区别\n\n区别在于 `不可重复读` 是由 `update` 操作造成，而 `幻读` 是由 `insert`、`delete` 操作造成。\n在 `Read Committed` 级别下，当执行sql读取到数据后，给这些记录加锁，让其他事务无法修改这些数据，\n则实现了 `可重复读`。但是这种方法是无法阻止 `insert` 操作的，当事务A读取了数据，并修改了某些数据(加锁)，\n事务B还是可以insert数据提交，这时A事务再次读取就会发现多出了之前没有的数据，这就是幻读，而且无法通过行锁来避免。\n\n## 乐观锁和悲观锁\n\n- 悲观锁\n\n悲观锁是有数据库本身提供的，具有良好的排他性。\n在悲观锁的情况下，为了保证事务的隔离性，就需要一致性锁定读。读取数据时加锁，其它事务无法修改这些数据。\n\n- 乐观锁\n\n相比悲观锁，乐观锁要宽松一些，通常是通过版本(version)记录机制来实现的。何谓数据版本？即为数据增加一个版本标识，\n在基于数据库表的版本解决方案中，一般是通过为数据库表增加一个 `version` 字段来实现 (MVCC)。\n读数据时将 `version` 一起读取，更新时对 `version` +1，提交的时候，将提交的数据版本和数据库表对应记录的版本进行对比，如果提交数据的版本大于当前数据版本，则执行更新，否则认为是过期的数据，不更新。\n\n## MVCC 在 InnoDB 中的实现\n\n在 MySQL 的 InnoDB 中，会在每行数据后添加两个额外的隐藏值来实现 MVCC，其中一个记录这条数据何时被创建，另一个记录这条数据何时过期(或者被删除)。\n在实际操作中，存储的并不是时间，而是事务版本号。每开始一个新事务，版本号就会 +1。\n\n- `select` 时，只读取<=当前事务版本的数据\n- `insert` / `update` / `delete` 时，更新数据的事务版本\n\nMVCC 解决了幻读的问题，然而却并不能阻止其他事务对数据的 `insert`，任然会引发数据冲突。要解决这个问题，需要对数据上锁。\n\n## 快照读与当前度\n\n在 `Repeatalbe Read` 级别下，MySQL 通过 MVCC 实现了快照读 (snapshot read)，即事务中普通的 select 语句只能读取到当下版本的数据。\n然而update 等操作却读取的是最新版本的数据，也就是当前读 (current read)。在 MVCC 中:\n\n- 快照读: 普通的 select 语句，不会加锁\n  - `select * from t1 ...`\n- 当前读: 特殊的 `select` 语句和 `insert` / `update` / `delete` 语句，都会上锁\n  - `select * from t1 where ... lock in share mode`\n  - `select * from t2 where ... for update`\n  - `insert into ...`\n  - `update t1 set ...`\n  - `delete from t1 ...`\n\n## Next-Key锁\n\nNext-Key 锁是行锁和 GAP 锁(间隙锁)的结合。在 `Repeatalbe Read` 级别中，如果执行了索引查询并上锁，则会一同锁住索引两侧的数据(按索引字段排序)。\n事务A执行 `select * from user`，其中 age 字段存在索引，其结果为:\n\n```sh\n+----+--------+---------+---------+-----+\n| id | name   | address | other   | age |\n+----+--------+---------+---------+-----+\n| 7  | name7  | chengdu | nothing | 7   |\n| 13 | name13 | chengdu | nothing | 13  |\n| 14 | name14 | chengdu | nothing | 14  |\n+----+--------+---------+-------+-------+\n```\n\n这里假设 `age` 字段值在整个表中的排序为 `..., 7, 13, 14, ...`。\n事务A接着执行 `select * from user where age = 13 lock in share mode` 对数据上锁，输出:\n\n```sh\n+----+--------+---------+---------+-----+\n| id | name   | address | other   | age |\n+----+--------+---------+---------+-----+\n| 13 | name13 | chengdu | nothing | 13  |\n+----+--------+---------+---------+-----+\n```\n\n这时事务B想要插入数据，执行 `insert into user values(0, 'name16', 'hxxi', 'woman', 'nothing', 12)`，此时操作会被阻塞。\n如果将刚才插入语句中的 age 字段值修改为一个 >= 14 或者 < 7 的值，结果会怎么样呢？执行 `insert into user values(0, 'name16', 'hxxi', 'woman', 'nothing', 6)`，输出:\n\n```sh\nQuery OK, 1 row affected\nTime: 0.012s\n```\n\n这说明了事务A中的 `select * from user where age = 13 lock in share mode` 不仅锁住了满足条件的记录行，\n也锁住了 `age >= 7` 和 `age < 14` 的记录，也就是区间 `[7, 14)`，这就是 Next-Key 锁的效果。\n在上面例子里的 age 字段是有索引的，这点非常重要，因为如果没有索引的话，Next-Key 锁的范围将会锁住整个表，\n即便是 `insert into user values(0, 'name16', 'hxxi', 'woman', 'nothing', 6)` 也会被阻塞。\n\n","source":"_posts/2019-07-04-MySQL-数据库-InnoDB-学习笔记.md","raw":"---\ntitle: MySQL 数据库 InnoDB 学习笔记\ndate: 2019-07-04 15:55:28\ncategories:\n- 笔记\ntags:\n- mysql\n- innodb\n- lock\n- transaction\n- index\n- database\n---\n记录最近对MySQL学习的一些总结。\n\n<!-- more -->\n\n# 索引\n\n## 聚合索引\n\n主键字段的索引就是聚合索引，索引中保存了整行记录的所有字段值\n\n## 辅助索引\n\n其他字段的索引就是辅助索引，辅助索引仅仅保存了记录行的主键值(id) 和当前索引的字段。\n\n## 索引覆盖(覆盖索引)\n\n一般来说，当执行 `select * from user where age = 10;` 时，如果 `age` 字段添加了 `B+TREE` 索引，\n则 MySQL 会先通过辅助索引查找到记录的 id，再通过聚合索引最终查找到数据行各字段的值。\n但如果查询语句中只去查询索引中包含的字段，查询时就只需通过辅助索引定位，拿到索引字段值后将结果返回即可，\n不用再去查找聚合索引，这样就实现了索引覆盖。当然，如果查询语句中还同时包含主键字段 (id) ，那也同样可以实现索引覆盖。\n\n## 索引建立的几大原则\n\n1. 最左匹配\n\n    索引会从where 语句开始，从左到右进行匹配，直到遇到范围查询 (>，<，!=，like，between) 时，匹配将会停止。\n    在 `a = 1 and b = 2 and c > 3 and d = 4` 语句中，建立联合索引 (a, b, c, d)，此时 字段 d 是无法用到索引的，因为 c > 3 是范围查询，\n    索引匹配到这里就停止了。如果将联合索引的顺序调整为 (a, b, d, c) 则可以用到索引，\n    因为上述的 where 语句等效于 `a = 1 and b = 2 and d = 4 and c > 3` 这个顺序和索引一致，虽然有范围查询但那已经是最后一个条件了。\n    我们不用手动去调整 where 中条件的顺序，MySQL 查询优化器会自动调整条件位置，以尽可能地使用索引。\n\n2. = 之间可以乱序\n\n    由于 MySQL 查询优化器会自动调整条件位置，以尽可能地使用索引，所以在有索引 (a, b, c) 的情况下，`a = 1 and c = 3 and b = 2` 这样的语句也是可以使用索引的。\n\n3. 尽量选择区分度高的字段来添加索引\n\n    区分度是指一个字段的值在记录中去重后的数量比上所有记录数量，表示这个字段值不重复的比例，即: `count(distinct('column')) / count(*)`，\n    在sql中一般可以这样来查看: `select type, count(*) from t group by type`。区分度越高则需要索引匹配的次数就越少，查询就越快速。\n    可以看出，表中主键的区分度固定为 1，而一些类型、状态等枚举字段将会在数据量逐渐增大情况下趋近与 0，这样的字段更适合添加 `Hash` 索引而不是 `B+TREE`。\n\n4. 索引列不能参与计算，否则无法使用索引\n\n    比如 `from_unixtime(created_at) = '2019-07-04 14:41:30'` 是不能使用 create_time 索引的，应换成这样: `created_at = unix_timestamp('2019-07-04 14:43:11')`\n\n# 事务\n\n## 术语概念\n\n- 脏读 (Dirty Read):\n\n    事务中的修改，即使没有提交，对其他事务也都是可见的。事务可以读取未提交的数据，这也被称作脏读。\n    例: A事务begin => B事务begin => B事务update某行 => A事务select该行，得到了更新后的结果\n\n- 不可重复读 (Unrepeatable Read):\n\n    事务中的修改提交后，其结果被其他事务所读取到。\n    例: A事务begin => B事务begin => B事务update某行 =>B 事务commit => A事务读取该行，得到了更新后的结果\n\n- 幻读 (Phantom Read):\n\n    所谓幻读，指的是当某个事务在读取某个范围内的记录时，另外一个事务又在该范围内插入了新的记录，当之前的事务再次读取该范围的记录时，会产生幻行。\n    例: A事务begin => B事务begin => B事务insert => B事务commit => A事务select，得到了之前没有的数据\n    解决方式: 加锁 (乐观锁 / 悲观锁)。InnoDB 存储引擎通过多版本并发控制（MVCC）解决了幻读的问题。\n\n| 事务隔离级别                | 脏读 | 不可重复读 | 幻读 | 备注                                                            |\n| --------------------------- | ---- | ---------- | ---- | --------------------------------------------------------------- |\n| (未提交读) Read Uncommitted | y    | y          | y    | 性能好，但是会早成许多业务上的异常，一般不用                    |\n| (已提交读) Read Committed   | n    | y          | y    | 可以避免脏读，但是会出现不可重复读                              |\n| (可重复读) Repeatable Read  | n    | n          | y    | InnoDB 默认的隔离级别，实际上已经通过 Next-Key 锁机制避免了幻读 |\n| (串行化) Serializable       | n    | n          | n    | 性能消耗太大，一般不用 (select 时也会加锁)                      |\n\n## 不可重复读和幻读的区别\n\n区别在于 `不可重复读` 是由 `update` 操作造成，而 `幻读` 是由 `insert`、`delete` 操作造成。\n在 `Read Committed` 级别下，当执行sql读取到数据后，给这些记录加锁，让其他事务无法修改这些数据，\n则实现了 `可重复读`。但是这种方法是无法阻止 `insert` 操作的，当事务A读取了数据，并修改了某些数据(加锁)，\n事务B还是可以insert数据提交，这时A事务再次读取就会发现多出了之前没有的数据，这就是幻读，而且无法通过行锁来避免。\n\n## 乐观锁和悲观锁\n\n- 悲观锁\n\n悲观锁是有数据库本身提供的，具有良好的排他性。\n在悲观锁的情况下，为了保证事务的隔离性，就需要一致性锁定读。读取数据时加锁，其它事务无法修改这些数据。\n\n- 乐观锁\n\n相比悲观锁，乐观锁要宽松一些，通常是通过版本(version)记录机制来实现的。何谓数据版本？即为数据增加一个版本标识，\n在基于数据库表的版本解决方案中，一般是通过为数据库表增加一个 `version` 字段来实现 (MVCC)。\n读数据时将 `version` 一起读取，更新时对 `version` +1，提交的时候，将提交的数据版本和数据库表对应记录的版本进行对比，如果提交数据的版本大于当前数据版本，则执行更新，否则认为是过期的数据，不更新。\n\n## MVCC 在 InnoDB 中的实现\n\n在 MySQL 的 InnoDB 中，会在每行数据后添加两个额外的隐藏值来实现 MVCC，其中一个记录这条数据何时被创建，另一个记录这条数据何时过期(或者被删除)。\n在实际操作中，存储的并不是时间，而是事务版本号。每开始一个新事务，版本号就会 +1。\n\n- `select` 时，只读取<=当前事务版本的数据\n- `insert` / `update` / `delete` 时，更新数据的事务版本\n\nMVCC 解决了幻读的问题，然而却并不能阻止其他事务对数据的 `insert`，任然会引发数据冲突。要解决这个问题，需要对数据上锁。\n\n## 快照读与当前度\n\n在 `Repeatalbe Read` 级别下，MySQL 通过 MVCC 实现了快照读 (snapshot read)，即事务中普通的 select 语句只能读取到当下版本的数据。\n然而update 等操作却读取的是最新版本的数据，也就是当前读 (current read)。在 MVCC 中:\n\n- 快照读: 普通的 select 语句，不会加锁\n  - `select * from t1 ...`\n- 当前读: 特殊的 `select` 语句和 `insert` / `update` / `delete` 语句，都会上锁\n  - `select * from t1 where ... lock in share mode`\n  - `select * from t2 where ... for update`\n  - `insert into ...`\n  - `update t1 set ...`\n  - `delete from t1 ...`\n\n## Next-Key锁\n\nNext-Key 锁是行锁和 GAP 锁(间隙锁)的结合。在 `Repeatalbe Read` 级别中，如果执行了索引查询并上锁，则会一同锁住索引两侧的数据(按索引字段排序)。\n事务A执行 `select * from user`，其中 age 字段存在索引，其结果为:\n\n```sh\n+----+--------+---------+---------+-----+\n| id | name   | address | other   | age |\n+----+--------+---------+---------+-----+\n| 7  | name7  | chengdu | nothing | 7   |\n| 13 | name13 | chengdu | nothing | 13  |\n| 14 | name14 | chengdu | nothing | 14  |\n+----+--------+---------+-------+-------+\n```\n\n这里假设 `age` 字段值在整个表中的排序为 `..., 7, 13, 14, ...`。\n事务A接着执行 `select * from user where age = 13 lock in share mode` 对数据上锁，输出:\n\n```sh\n+----+--------+---------+---------+-----+\n| id | name   | address | other   | age |\n+----+--------+---------+---------+-----+\n| 13 | name13 | chengdu | nothing | 13  |\n+----+--------+---------+---------+-----+\n```\n\n这时事务B想要插入数据，执行 `insert into user values(0, 'name16', 'hxxi', 'woman', 'nothing', 12)`，此时操作会被阻塞。\n如果将刚才插入语句中的 age 字段值修改为一个 >= 14 或者 < 7 的值，结果会怎么样呢？执行 `insert into user values(0, 'name16', 'hxxi', 'woman', 'nothing', 6)`，输出:\n\n```sh\nQuery OK, 1 row affected\nTime: 0.012s\n```\n\n这说明了事务A中的 `select * from user where age = 13 lock in share mode` 不仅锁住了满足条件的记录行，\n也锁住了 `age >= 7` 和 `age < 14` 的记录，也就是区间 `[7, 14)`，这就是 Next-Key 锁的效果。\n在上面例子里的 age 字段是有索引的，这点非常重要，因为如果没有索引的话，Next-Key 锁的范围将会锁住整个表，\n即便是 `insert into user values(0, 'name16', 'hxxi', 'woman', 'nothing', 6)` 也会被阻塞。\n\n","slug":"MySQL-数据库-InnoDB-学习笔记","published":1,"updated":"2023-05-28T05:36:04.286Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1jc000qiubf9tyxwuof","content":"<p>记录最近对MySQL学习的一些总结。</p><a id=\"more\"></a><h1 id=\"索引\"><a href=\"#索引\" class=\"headerlink\" title=\"索引\"></a>索引</h1><h2 id=\"聚合索引\"><a href=\"#聚合索引\" class=\"headerlink\" title=\"聚合索引\"></a>聚合索引</h2><p>主键字段的索引就是聚合索引，索引中保存了整行记录的所有字段值</p><h2 id=\"辅助索引\"><a href=\"#辅助索引\" class=\"headerlink\" title=\"辅助索引\"></a>辅助索引</h2><p>其他字段的索引就是辅助索引，辅助索引仅仅保存了记录行的主键值(id) 和当前索引的字段。</p><h2 id=\"索引覆盖-覆盖索引\"><a href=\"#索引覆盖-覆盖索引\" class=\"headerlink\" title=\"索引覆盖(覆盖索引)\"></a>索引覆盖(覆盖索引)</h2><p>一般来说，当执行 <code>select * from user where age = 10;</code> 时，如果 <code>age</code> 字段添加了 <code>B+TREE</code> 索引， 则 MySQL 会先通过辅助索引查找到记录的 id，再通过聚合索引最终查找到数据行各字段的值。 但如果查询语句中只去查询索引中包含的字段，查询时就只需通过辅助索引定位，拿到索引字段值后将结果返回即可， 不用再去查找聚合索引，这样就实现了索引覆盖。当然，如果查询语句中还同时包含主键字段 (id) ，那也同样可以实现索引覆盖。</p><h2 id=\"索引建立的几大原则\"><a href=\"#索引建立的几大原则\" class=\"headerlink\" title=\"索引建立的几大原则\"></a>索引建立的几大原则</h2><ol><li><p>最左匹配</p><p>索引会从where 语句开始，从左到右进行匹配，直到遇到范围查询 (&gt;，&lt;，!=，like，between) 时，匹配将会停止。 在 <code>a = 1 and b = 2 and c &gt; 3 and d = 4</code> 语句中，建立联合索引 (a, b, c, d)，此时 字段 d 是无法用到索引的，因为 c &gt; 3 是范围查询， 索引匹配到这里就停止了。如果将联合索引的顺序调整为 (a, b, d, c) 则可以用到索引， 因为上述的 where 语句等效于 <code>a = 1 and b = 2 and d = 4 and c &gt; 3</code> 这个顺序和索引一致，虽然有范围查询但那已经是最后一个条件了。 我们不用手动去调整 where 中条件的顺序，MySQL 查询优化器会自动调整条件位置，以尽可能地使用索引。</p></li><li><p>= 之间可以乱序</p><p>由于 MySQL 查询优化器会自动调整条件位置，以尽可能地使用索引，所以在有索引 (a, b, c) 的情况下，<code>a = 1 and c = 3 and b = 2</code> 这样的语句也是可以使用索引的。</p></li><li><p>尽量选择区分度高的字段来添加索引</p><p>区分度是指一个字段的值在记录中去重后的数量比上所有记录数量，表示这个字段值不重复的比例，即: <code>count(distinct(&#39;column&#39;)) / count(*)</code>， 在sql中一般可以这样来查看: <code>select type, count(*) from t group by type</code>。区分度越高则需要索引匹配的次数就越少，查询就越快速。 可以看出，表中主键的区分度固定为 1，而一些类型、状态等枚举字段将会在数据量逐渐增大情况下趋近与 0，这样的字段更适合添加 <code>Hash</code> 索引而不是 <code>B+TREE</code>。</p></li><li><p>索引列不能参与计算，否则无法使用索引</p><p>比如 <code>from_unixtime(created_at) = &#39;2019-07-04 14:41:30&#39;</code> 是不能使用 create_time 索引的，应换成这样: <code>created_at = unix_timestamp(&#39;2019-07-04 14:43:11&#39;)</code></p></li></ol><h1 id=\"事务\"><a href=\"#事务\" class=\"headerlink\" title=\"事务\"></a>事务</h1><h2 id=\"术语概念\"><a href=\"#术语概念\" class=\"headerlink\" title=\"术语概念\"></a>术语概念</h2><ul><li><p>脏读 (Dirty Read):</p><p>事务中的修改，即使没有提交，对其他事务也都是可见的。事务可以读取未提交的数据，这也被称作脏读。 例: A事务begin =&gt; B事务begin =&gt; B事务update某行 =&gt; A事务select该行，得到了更新后的结果</p></li><li><p>不可重复读 (Unrepeatable Read):</p><p>事务中的修改提交后，其结果被其他事务所读取到。 例: A事务begin =&gt; B事务begin =&gt; B事务update某行 =&gt;B 事务commit =&gt; A事务读取该行，得到了更新后的结果</p></li><li><p>幻读 (Phantom Read):</p><p>所谓幻读，指的是当某个事务在读取某个范围内的记录时，另外一个事务又在该范围内插入了新的记录，当之前的事务再次读取该范围的记录时，会产生幻行。 例: A事务begin =&gt; B事务begin =&gt; B事务insert =&gt; B事务commit =&gt; A事务select，得到了之前没有的数据 解决方式: 加锁 (乐观锁 / 悲观锁)。InnoDB 存储引擎通过多版本并发控制（MVCC）解决了幻读的问题。</p></li></ul><table><thead><tr><th>事务隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th><th>备注</th></tr></thead><tbody><tr><td>(未提交读) Read Uncommitted</td><td>y</td><td>y</td><td>y</td><td>性能好，但是会早成许多业务上的异常，一般不用</td></tr><tr><td>(已提交读) Read Committed</td><td>n</td><td>y</td><td>y</td><td>可以避免脏读，但是会出现不可重复读</td></tr><tr><td>(可重复读) Repeatable Read</td><td>n</td><td>n</td><td>y</td><td>InnoDB 默认的隔离级别，实际上已经通过 Next-Key 锁机制避免了幻读</td></tr><tr><td>(串行化) Serializable</td><td>n</td><td>n</td><td>n</td><td>性能消耗太大，一般不用 (select 时也会加锁)</td></tr></tbody></table><h2 id=\"不可重复读和幻读的区别\"><a href=\"#不可重复读和幻读的区别\" class=\"headerlink\" title=\"不可重复读和幻读的区别\"></a>不可重复读和幻读的区别</h2><p>区别在于 <code>不可重复读</code> 是由 <code>update</code> 操作造成，而 <code>幻读</code> 是由 <code>insert</code>、<code>delete</code> 操作造成。 在 <code>Read Committed</code> 级别下，当执行sql读取到数据后，给这些记录加锁，让其他事务无法修改这些数据， 则实现了 <code>可重复读</code>。但是这种方法是无法阻止 <code>insert</code> 操作的，当事务A读取了数据，并修改了某些数据(加锁)， 事务B还是可以insert数据提交，这时A事务再次读取就会发现多出了之前没有的数据，这就是幻读，而且无法通过行锁来避免。</p><h2 id=\"乐观锁和悲观锁\"><a href=\"#乐观锁和悲观锁\" class=\"headerlink\" title=\"乐观锁和悲观锁\"></a>乐观锁和悲观锁</h2><ul><li>悲观锁</li></ul><p>悲观锁是有数据库本身提供的，具有良好的排他性。 在悲观锁的情况下，为了保证事务的隔离性，就需要一致性锁定读。读取数据时加锁，其它事务无法修改这些数据。</p><ul><li>乐观锁</li></ul><p>相比悲观锁，乐观锁要宽松一些，通常是通过版本(version)记录机制来实现的。何谓数据版本？即为数据增加一个版本标识， 在基于数据库表的版本解决方案中，一般是通过为数据库表增加一个 <code>version</code> 字段来实现 (MVCC)。 读数据时将 <code>version</code> 一起读取，更新时对 <code>version</code> +1，提交的时候，将提交的数据版本和数据库表对应记录的版本进行对比，如果提交数据的版本大于当前数据版本，则执行更新，否则认为是过期的数据，不更新。</p><h2 id=\"MVCC-在-InnoDB-中的实现\"><a href=\"#MVCC-在-InnoDB-中的实现\" class=\"headerlink\" title=\"MVCC 在 InnoDB 中的实现\"></a>MVCC 在 InnoDB 中的实现</h2><p>在 MySQL 的 InnoDB 中，会在每行数据后添加两个额外的隐藏值来实现 MVCC，其中一个记录这条数据何时被创建，另一个记录这条数据何时过期(或者被删除)。 在实际操作中，存储的并不是时间，而是事务版本号。每开始一个新事务，版本号就会 +1。</p><ul><li><code>select</code> 时，只读取&lt;=当前事务版本的数据</li><li><code>insert</code> / <code>update</code> / <code>delete</code> 时，更新数据的事务版本</li></ul><p>MVCC 解决了幻读的问题，然而却并不能阻止其他事务对数据的 <code>insert</code>，任然会引发数据冲突。要解决这个问题，需要对数据上锁。</p><h2 id=\"快照读与当前度\"><a href=\"#快照读与当前度\" class=\"headerlink\" title=\"快照读与当前度\"></a>快照读与当前度</h2><p>在 <code>Repeatalbe Read</code> 级别下，MySQL 通过 MVCC 实现了快照读 (snapshot read)，即事务中普通的 select 语句只能读取到当下版本的数据。 然而update 等操作却读取的是最新版本的数据，也就是当前读 (current read)。在 MVCC 中:</p><ul><li>快照读: 普通的 select 语句，不会加锁<ul><li><code>select * from t1 ...</code></li></ul></li><li>当前读: 特殊的 <code>select</code> 语句和 <code>insert</code> / <code>update</code> / <code>delete</code> 语句，都会上锁<ul><li><code>select * from t1 where ... lock in share mode</code></li><li><code>select * from t2 where ... for update</code></li><li><code>insert into ...</code></li><li><code>update t1 set ...</code></li><li><code>delete from t1 ...</code></li></ul></li></ul><h2 id=\"Next-Key锁\"><a href=\"#Next-Key锁\" class=\"headerlink\" title=\"Next-Key锁\"></a>Next-Key锁</h2><p>Next-Key 锁是行锁和 GAP 锁(间隙锁)的结合。在 <code>Repeatalbe Read</code> 级别中，如果执行了索引查询并上锁，则会一同锁住索引两侧的数据(按索引字段排序)。 事务A执行 <code>select * from user</code>，其中 age 字段存在索引，其结果为:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+----+--------+---------+---------+-----+</span><br><span class=\"line\">| id | name   | address | other   | age |</span><br><span class=\"line\">+----+--------+---------+---------+-----+</span><br><span class=\"line\">| 7  | name7  | chengdu | nothing | 7   |</span><br><span class=\"line\">| 13 | name13 | chengdu | nothing | 13  |</span><br><span class=\"line\">| 14 | name14 | chengdu | nothing | 14  |</span><br><span class=\"line\">+----+--------+---------+-------+-------+</span><br></pre></td></tr></table></figure><p>这里假设 <code>age</code> 字段值在整个表中的排序为 <code>..., 7, 13, 14, ...</code>。 事务A接着执行 <code>select * from user where age = 13 lock in share mode</code> 对数据上锁，输出:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+----+--------+---------+---------+-----+</span><br><span class=\"line\">| id | name   | address | other   | age |</span><br><span class=\"line\">+----+--------+---------+---------+-----+</span><br><span class=\"line\">| 13 | name13 | chengdu | nothing | 13  |</span><br><span class=\"line\">+----+--------+---------+---------+-----+</span><br></pre></td></tr></table></figure><p>这时事务B想要插入数据，执行 <code>insert into user values(0, &#39;name16&#39;, &#39;hxxi&#39;, &#39;woman&#39;, &#39;nothing&#39;, 12)</code>，此时操作会被阻塞。 如果将刚才插入语句中的 age 字段值修改为一个 &gt;= 14 或者 &lt; 7 的值，结果会怎么样呢？执行 <code>insert into user values(0, &#39;name16&#39;, &#39;hxxi&#39;, &#39;woman&#39;, &#39;nothing&#39;, 6)</code>，输出:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Query OK, 1 row affected</span><br><span class=\"line\">Time: 0.012s</span><br></pre></td></tr></table></figure><p>这说明了事务A中的 <code>select * from user where age = 13 lock in share mode</code> 不仅锁住了满足条件的记录行， 也锁住了 <code>age &gt;= 7</code> 和 <code>age &lt; 14</code> 的记录，也就是区间 <code>[7, 14)</code>，这就是 Next-Key 锁的效果。 在上面例子里的 age 字段是有索引的，这点非常重要，因为如果没有索引的话，Next-Key 锁的范围将会锁住整个表， 即便是 <code>insert into user values(0, &#39;name16&#39;, &#39;hxxi&#39;, &#39;woman&#39;, &#39;nothing&#39;, 6)</code> 也会被阻塞。</p>","site":{"data":{}},"excerpt":"<p>记录最近对MySQL学习的一些总结。</p>","more":"<h1 id=\"索引\"><a href=\"#索引\" class=\"headerlink\" title=\"索引\"></a>索引</h1><h2 id=\"聚合索引\"><a href=\"#聚合索引\" class=\"headerlink\" title=\"聚合索引\"></a>聚合索引</h2><p>主键字段的索引就是聚合索引，索引中保存了整行记录的所有字段值</p><h2 id=\"辅助索引\"><a href=\"#辅助索引\" class=\"headerlink\" title=\"辅助索引\"></a>辅助索引</h2><p>其他字段的索引就是辅助索引，辅助索引仅仅保存了记录行的主键值(id) 和当前索引的字段。</p><h2 id=\"索引覆盖-覆盖索引\"><a href=\"#索引覆盖-覆盖索引\" class=\"headerlink\" title=\"索引覆盖(覆盖索引)\"></a>索引覆盖(覆盖索引)</h2><p>一般来说，当执行 <code>select * from user where age = 10;</code> 时，如果 <code>age</code> 字段添加了 <code>B+TREE</code> 索引， 则 MySQL 会先通过辅助索引查找到记录的 id，再通过聚合索引最终查找到数据行各字段的值。 但如果查询语句中只去查询索引中包含的字段，查询时就只需通过辅助索引定位，拿到索引字段值后将结果返回即可， 不用再去查找聚合索引，这样就实现了索引覆盖。当然，如果查询语句中还同时包含主键字段 (id) ，那也同样可以实现索引覆盖。</p><h2 id=\"索引建立的几大原则\"><a href=\"#索引建立的几大原则\" class=\"headerlink\" title=\"索引建立的几大原则\"></a>索引建立的几大原则</h2><ol><li><p>最左匹配</p><p>索引会从where 语句开始，从左到右进行匹配，直到遇到范围查询 (&gt;，&lt;，!=，like，between) 时，匹配将会停止。 在 <code>a = 1 and b = 2 and c &gt; 3 and d = 4</code> 语句中，建立联合索引 (a, b, c, d)，此时 字段 d 是无法用到索引的，因为 c &gt; 3 是范围查询， 索引匹配到这里就停止了。如果将联合索引的顺序调整为 (a, b, d, c) 则可以用到索引， 因为上述的 where 语句等效于 <code>a = 1 and b = 2 and d = 4 and c &gt; 3</code> 这个顺序和索引一致，虽然有范围查询但那已经是最后一个条件了。 我们不用手动去调整 where 中条件的顺序，MySQL 查询优化器会自动调整条件位置，以尽可能地使用索引。</p></li><li><p>= 之间可以乱序</p><p>由于 MySQL 查询优化器会自动调整条件位置，以尽可能地使用索引，所以在有索引 (a, b, c) 的情况下，<code>a = 1 and c = 3 and b = 2</code> 这样的语句也是可以使用索引的。</p></li><li><p>尽量选择区分度高的字段来添加索引</p><p>区分度是指一个字段的值在记录中去重后的数量比上所有记录数量，表示这个字段值不重复的比例，即: <code>count(distinct(&#39;column&#39;)) / count(*)</code>， 在sql中一般可以这样来查看: <code>select type, count(*) from t group by type</code>。区分度越高则需要索引匹配的次数就越少，查询就越快速。 可以看出，表中主键的区分度固定为 1，而一些类型、状态等枚举字段将会在数据量逐渐增大情况下趋近与 0，这样的字段更适合添加 <code>Hash</code> 索引而不是 <code>B+TREE</code>。</p></li><li><p>索引列不能参与计算，否则无法使用索引</p><p>比如 <code>from_unixtime(created_at) = &#39;2019-07-04 14:41:30&#39;</code> 是不能使用 create_time 索引的，应换成这样: <code>created_at = unix_timestamp(&#39;2019-07-04 14:43:11&#39;)</code></p></li></ol><h1 id=\"事务\"><a href=\"#事务\" class=\"headerlink\" title=\"事务\"></a>事务</h1><h2 id=\"术语概念\"><a href=\"#术语概念\" class=\"headerlink\" title=\"术语概念\"></a>术语概念</h2><ul><li><p>脏读 (Dirty Read):</p><p>事务中的修改，即使没有提交，对其他事务也都是可见的。事务可以读取未提交的数据，这也被称作脏读。 例: A事务begin =&gt; B事务begin =&gt; B事务update某行 =&gt; A事务select该行，得到了更新后的结果</p></li><li><p>不可重复读 (Unrepeatable Read):</p><p>事务中的修改提交后，其结果被其他事务所读取到。 例: A事务begin =&gt; B事务begin =&gt; B事务update某行 =&gt;B 事务commit =&gt; A事务读取该行，得到了更新后的结果</p></li><li><p>幻读 (Phantom Read):</p><p>所谓幻读，指的是当某个事务在读取某个范围内的记录时，另外一个事务又在该范围内插入了新的记录，当之前的事务再次读取该范围的记录时，会产生幻行。 例: A事务begin =&gt; B事务begin =&gt; B事务insert =&gt; B事务commit =&gt; A事务select，得到了之前没有的数据 解决方式: 加锁 (乐观锁 / 悲观锁)。InnoDB 存储引擎通过多版本并发控制（MVCC）解决了幻读的问题。</p></li></ul><table><thead><tr><th>事务隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th><th>备注</th></tr></thead><tbody><tr><td>(未提交读) Read Uncommitted</td><td>y</td><td>y</td><td>y</td><td>性能好，但是会早成许多业务上的异常，一般不用</td></tr><tr><td>(已提交读) Read Committed</td><td>n</td><td>y</td><td>y</td><td>可以避免脏读，但是会出现不可重复读</td></tr><tr><td>(可重复读) Repeatable Read</td><td>n</td><td>n</td><td>y</td><td>InnoDB 默认的隔离级别，实际上已经通过 Next-Key 锁机制避免了幻读</td></tr><tr><td>(串行化) Serializable</td><td>n</td><td>n</td><td>n</td><td>性能消耗太大，一般不用 (select 时也会加锁)</td></tr></tbody></table><h2 id=\"不可重复读和幻读的区别\"><a href=\"#不可重复读和幻读的区别\" class=\"headerlink\" title=\"不可重复读和幻读的区别\"></a>不可重复读和幻读的区别</h2><p>区别在于 <code>不可重复读</code> 是由 <code>update</code> 操作造成，而 <code>幻读</code> 是由 <code>insert</code>、<code>delete</code> 操作造成。 在 <code>Read Committed</code> 级别下，当执行sql读取到数据后，给这些记录加锁，让其他事务无法修改这些数据， 则实现了 <code>可重复读</code>。但是这种方法是无法阻止 <code>insert</code> 操作的，当事务A读取了数据，并修改了某些数据(加锁)， 事务B还是可以insert数据提交，这时A事务再次读取就会发现多出了之前没有的数据，这就是幻读，而且无法通过行锁来避免。</p><h2 id=\"乐观锁和悲观锁\"><a href=\"#乐观锁和悲观锁\" class=\"headerlink\" title=\"乐观锁和悲观锁\"></a>乐观锁和悲观锁</h2><ul><li>悲观锁</li></ul><p>悲观锁是有数据库本身提供的，具有良好的排他性。 在悲观锁的情况下，为了保证事务的隔离性，就需要一致性锁定读。读取数据时加锁，其它事务无法修改这些数据。</p><ul><li>乐观锁</li></ul><p>相比悲观锁，乐观锁要宽松一些，通常是通过版本(version)记录机制来实现的。何谓数据版本？即为数据增加一个版本标识， 在基于数据库表的版本解决方案中，一般是通过为数据库表增加一个 <code>version</code> 字段来实现 (MVCC)。 读数据时将 <code>version</code> 一起读取，更新时对 <code>version</code> +1，提交的时候，将提交的数据版本和数据库表对应记录的版本进行对比，如果提交数据的版本大于当前数据版本，则执行更新，否则认为是过期的数据，不更新。</p><h2 id=\"MVCC-在-InnoDB-中的实现\"><a href=\"#MVCC-在-InnoDB-中的实现\" class=\"headerlink\" title=\"MVCC 在 InnoDB 中的实现\"></a>MVCC 在 InnoDB 中的实现</h2><p>在 MySQL 的 InnoDB 中，会在每行数据后添加两个额外的隐藏值来实现 MVCC，其中一个记录这条数据何时被创建，另一个记录这条数据何时过期(或者被删除)。 在实际操作中，存储的并不是时间，而是事务版本号。每开始一个新事务，版本号就会 +1。</p><ul><li><code>select</code> 时，只读取&lt;=当前事务版本的数据</li><li><code>insert</code> / <code>update</code> / <code>delete</code> 时，更新数据的事务版本</li></ul><p>MVCC 解决了幻读的问题，然而却并不能阻止其他事务对数据的 <code>insert</code>，任然会引发数据冲突。要解决这个问题，需要对数据上锁。</p><h2 id=\"快照读与当前度\"><a href=\"#快照读与当前度\" class=\"headerlink\" title=\"快照读与当前度\"></a>快照读与当前度</h2><p>在 <code>Repeatalbe Read</code> 级别下，MySQL 通过 MVCC 实现了快照读 (snapshot read)，即事务中普通的 select 语句只能读取到当下版本的数据。 然而update 等操作却读取的是最新版本的数据，也就是当前读 (current read)。在 MVCC 中:</p><ul><li>快照读: 普通的 select 语句，不会加锁<ul><li><code>select * from t1 ...</code></li></ul></li><li>当前读: 特殊的 <code>select</code> 语句和 <code>insert</code> / <code>update</code> / <code>delete</code> 语句，都会上锁<ul><li><code>select * from t1 where ... lock in share mode</code></li><li><code>select * from t2 where ... for update</code></li><li><code>insert into ...</code></li><li><code>update t1 set ...</code></li><li><code>delete from t1 ...</code></li></ul></li></ul><h2 id=\"Next-Key锁\"><a href=\"#Next-Key锁\" class=\"headerlink\" title=\"Next-Key锁\"></a>Next-Key锁</h2><p>Next-Key 锁是行锁和 GAP 锁(间隙锁)的结合。在 <code>Repeatalbe Read</code> 级别中，如果执行了索引查询并上锁，则会一同锁住索引两侧的数据(按索引字段排序)。 事务A执行 <code>select * from user</code>，其中 age 字段存在索引，其结果为:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+----+--------+---------+---------+-----+</span><br><span class=\"line\">| id | name   | address | other   | age |</span><br><span class=\"line\">+----+--------+---------+---------+-----+</span><br><span class=\"line\">| 7  | name7  | chengdu | nothing | 7   |</span><br><span class=\"line\">| 13 | name13 | chengdu | nothing | 13  |</span><br><span class=\"line\">| 14 | name14 | chengdu | nothing | 14  |</span><br><span class=\"line\">+----+--------+---------+-------+-------+</span><br></pre></td></tr></table></figure><p>这里假设 <code>age</code> 字段值在整个表中的排序为 <code>..., 7, 13, 14, ...</code>。 事务A接着执行 <code>select * from user where age = 13 lock in share mode</code> 对数据上锁，输出:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+----+--------+---------+---------+-----+</span><br><span class=\"line\">| id | name   | address | other   | age |</span><br><span class=\"line\">+----+--------+---------+---------+-----+</span><br><span class=\"line\">| 13 | name13 | chengdu | nothing | 13  |</span><br><span class=\"line\">+----+--------+---------+---------+-----+</span><br></pre></td></tr></table></figure><p>这时事务B想要插入数据，执行 <code>insert into user values(0, &#39;name16&#39;, &#39;hxxi&#39;, &#39;woman&#39;, &#39;nothing&#39;, 12)</code>，此时操作会被阻塞。 如果将刚才插入语句中的 age 字段值修改为一个 &gt;= 14 或者 &lt; 7 的值，结果会怎么样呢？执行 <code>insert into user values(0, &#39;name16&#39;, &#39;hxxi&#39;, &#39;woman&#39;, &#39;nothing&#39;, 6)</code>，输出:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Query OK, 1 row affected</span><br><span class=\"line\">Time: 0.012s</span><br></pre></td></tr></table></figure><p>这说明了事务A中的 <code>select * from user where age = 13 lock in share mode</code> 不仅锁住了满足条件的记录行， 也锁住了 <code>age &gt;= 7</code> 和 <code>age &lt; 14</code> 的记录，也就是区间 <code>[7, 14)</code>，这就是 Next-Key 锁的效果。 在上面例子里的 age 字段是有索引的，这点非常重要，因为如果没有索引的话，Next-Key 锁的范围将会锁住整个表， 即便是 <code>insert into user values(0, &#39;name16&#39;, &#39;hxxi&#39;, &#39;woman&#39;, &#39;nothing&#39;, 6)</code> 也会被阻塞。</p>"},{"title":"解决Macbook usb断连问题","date":"2019-09-16T01:48:32.000Z","_content":"\n有一天想用macbook的usb接口给苹果手机充电，连上之后出现连接不稳定，充电断断续续的情况。\n换了另一台手机和另一根数据线，也出现这样的情况，当时以为是电脑出问题了。\n后来在网上找到了解决方法。\n\n执行下面两个命令，可以让usbd服务重启，从而解决连接不稳定的问题。\n\n```sh\nsudo killall -STOP -c usbd # will pause the issue related process\n```\n\n```sh\nsudo killall -CONT usbd # will resume the process\n```\n","source":"_posts/2019-09-16-解决Macbook-usb断连问题.md","raw":"---\ntitle: 解决Macbook usb断连问题\ndate: 2019-09-16 09:48:32\ncategories:\n- 笔记\ntags:\n- mac\n---\n\n有一天想用macbook的usb接口给苹果手机充电，连上之后出现连接不稳定，充电断断续续的情况。\n换了另一台手机和另一根数据线，也出现这样的情况，当时以为是电脑出问题了。\n后来在网上找到了解决方法。\n\n执行下面两个命令，可以让usbd服务重启，从而解决连接不稳定的问题。\n\n```sh\nsudo killall -STOP -c usbd # will pause the issue related process\n```\n\n```sh\nsudo killall -CONT usbd # will resume the process\n```\n","slug":"解决Macbook-usb断连问题","published":1,"updated":"2023-05-28T05:36:04.286Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1jc000riubfo9go6qsb","content":"<p>有一天想用macbook的usb接口给苹果手机充电，连上之后出现连接不稳定，充电断断续续的情况。 换了另一台手机和另一根数据线，也出现这样的情况，当时以为是电脑出问题了。 后来在网上找到了解决方法。</p><p>执行下面两个命令，可以让usbd服务重启，从而解决连接不稳定的问题。</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo killall -STOP -c usbd <span class=\"comment\"># will pause the issue related process</span></span><br></pre></td></tr></table></figure><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo killall -CONT usbd <span class=\"comment\"># will resume the process</span></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>有一天想用macbook的usb接口给苹果手机充电，连上之后出现连接不稳定，充电断断续续的情况。 换了另一台手机和另一根数据线，也出现这样的情况，当时以为是电脑出问题了。 后来在网上找到了解决方法。</p><p>执行下面两个命令，可以让usbd服务重启，从而解决连接不稳定的问题。</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo killall -STOP -c usbd <span class=\"comment\"># will pause the issue related process</span></span><br></pre></td></tr></table></figure><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo killall -CONT usbd <span class=\"comment\"># will resume the process</span></span><br></pre></td></tr></table></figure>"},{"title":"PHP 垃圾回收机制","date":"2019-07-11T08:43:37.000Z","_content":"\n## 引用计数器的基本概念\n\nPHP 变量是存放于一个叫做 \"zval\" 的容器中。zval 容器包含了变量的类型和值以及附加的两位 (bit) 信息。第一个叫做 \"is_ref\" 是个 bool 值，表示变量是否为 \"reference set\" 的一部分。通过这个位信息，PHP 引擎即可区分该变量是普通变量还是引用。由于 PHP 允许用户 (user-land) 通过 & 操作符来创建引用，zval 容器也包含了一个内部的引用计数机制用来优化内存使用。第二个位信息叫做 \"refcount\"，它包含指向这个 zval 容器的变量名称 (也叫符号 (symbols) ) 个数。所有的符号都存放在符号表 (symbol table) 中，其中，每个符号都有自己的作用域 (scope)。对于主脚本 (例: 被浏览器请求的脚本) 和每个函数或方法也都有作用域。\n\n<!-- more -->\n\n当一个变量被赋常量值时，就会生成一个 zval 变量容器，像这样:\n\n```php\n$a = \"new string\";\n```\n\n这个例子中，一个新的符号名 a 在当前作用域被创建了，也有一个新的变量容器被创建了，其类型是 string，值是 \"new string\"。\"is_ref\" 位默认是 FALSE，因为还没有引用被用户创建。\"refcount\" 为 1 因为只有一个符号在使用这个变量容器。注意，如果 \"refcount\" 为 1，\"is_ref\" 只会为 FALSE。如果你安装了 Xdebug，亦可以调用 xdebug_debug_zval() 方法来展示信息。\n\n```php\n$a = \"new string\";\nxdebug_debug_zval('a');\n```\n\n上面的例子将输出:\n\n```sh\na: (refcount=1, is_ref=0)='new string'\n```\n\n将这个变量赋值给另一个变量会增加 \"refcount\"。\n\n```php\n$a = \"new string\";\n$b = $a;\nxdebug_debug_zval( 'a' );\n```\n\n上面的例子将输出:\n\n```php\na: (refcount=2, is_ref=0)='new string'\n```\n\n现在 \"refcount\" 是 2，因为同一个变量容器被关联 (linked) 到了 a 和 b。PHP 足够聪明，在非必要时不会去拷贝实际的变量容器。容器变量在 \"refcount\" 减至 0 时被销毁。当有关联的变量容器的符号离开了作用域 (如: 函数结束时) 或者被取消赋值 (如: 被 unset() 时) 时，\"refcount\" 会减 1。下面的例子就能说明:\n\n```php\n$a = \"new string\";\n$c = $b = $a;\nxdebug_debug_zval( 'a' );\n$b = 42;\nxdebug_debug_zval( 'a' );\nunset( $c );\nxdebug_debug_zval( 'a' );\n```\n\n上面的例子将输出:\n\n```sh\na: (refcount=3, is_ref=0)='new string'\na: (refcount=2, is_ref=0)='new string' // when $b assigned by a new value\na: (refcount=1, is_ref=0)='new string' // when $c is unset()\n```\n\n如果我们现在调用 `unset($a);`，容器变量(包括类型和值)将从内存中被移除。\n\n### 复合类型\n\n对于复合类型而言，比如数组和对象，事情会变得稍微复杂些。和标量 (scalar) 值相反，数组和对象将自己的成员存放在自己的符号表中。这意味着下面的示例创建了 3 个 zval 容器:\n\n```php\n$a = ['meaning' => 'life','number' => 42];\nxdebug_debug_zval( 'a' );\n```\n\n上面的例子将输出类似这样的东西:\n\n```sh\na: (refcount=1, is_ref=0)=array (\n   'meaning' => (refcount=1, is_ref=0)='life',\n   'number' => (refcount=1, is_ref=0)=42\n)\n```\n\n或者是这样的图示:\n\n![image](https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-simple-array.png)\n\n3 个 zval 容器分别是: a，meaning 和 number。相似的规则同样可用来减少 \"refcounts\"。下面，我们添加另一个元素到数组中，并将值设置为一个已存在元素的内容:\n\n```php\n$a = ['meaning' => 'life','number' => 42];\n$a['life'] = $a['meaning'];\nxdebug_debug_zval( 'a' );\n```\n\n上面的例子将输出类似这样的东西:\n\n```sh\na: (refcount=1, is_ref=0)=array (\n   'meaning' => (refcount=2, is_ref=0)='life',\n   'number' => (refcount=1, is_ref=0)=42,\n   'life' => (refcount=2, is_ref=0)='life'\n)\n```\n\n或者是这样的图示:\n\n![image](https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-simple-array2.png)\n\n从上述 Xdebug 输出中，我们可以看出新老数组元素现在指向了一个 \"refcount\" 为 2 的zval 容器。虽然 Xdebug 的输出中有两个值为 \"life\" 的 zval 容器，但是他们其实同一个。虽然 xdebug_debug_zval() 函数不会说明这个，但你可以通过查看内存指针来分辨。\n\n从数组中移除元素就像是将符号从作用域中移除一样。移除后，数组元素所指向的容器的 \"refcount\" 会被减少。同样，当 \"refcount\" 减至 0 时，变量容器将会从内存中移除。下面的例子可以说明:\n\n```php\n$a = ['meaning' => 'life', 'number' => 42];\n$a['life'] = $a['meaning'];\nunset( $a['meaning'], $a['number'] );\nxdebug_debug_zval( 'a' );\n```\n\n上面的例子将输出类似这样的东西:\n\n```sh\na: (refcount=1, is_ref=0)=array (\n   'life' => (refcount=1, is_ref=0)='life'\n)\n```\n\n现在，如果我们将数组本身作为一个元素添加到数组中，事情就变得有趣了，我们将在下面的例子中这么做，而且会悄悄地添加一个引用操作符，不然 PHP 会创建一个拷贝:\n\n```php\n$a = ['one'];\n$a[] = &$a;\nxdebug_debug_zval( 'a' );\n```\n\n上面的例子将输出类似这样的东西:\n\n```sh\na: (refcount=2, is_ref=1)=array (\n   0 => (refcount=1, is_ref=0)='one',\n   1 => (refcount=2, is_ref=1)=...\n)\n```\n\n或者是这样的图示:\n\n![image](https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-loop-array.png)\n\n可以看出数组变量 `(a)` 和 第二个元素 `(1)` 现在都指向了一个 \"refcount\" 为 2 的变量容器。上面的 \"...\" 表示发送了递归，当然，在这里意味着指回了起源数组。\n\n和之前一样，对一个变量进行 unset() 会移除其符号，其指向的变量容器的引用数 (reference count) 将被减 1。所以如果我们在上述代码后面 unset 变量 `$a`，那么 `$a` 和 元素 `(1)` 所指向的变量容器的引用数就会减 1，由 \"2\" 变为 \"1\"。可以这样呈现:\n\n```sh\n(refcount=1, is_ref=1)=array (\n   0 => (refcount=1, is_ref=0)='one',\n   1 => (refcount=1, is_ref=1)=...\n)\n```\n\n或者是这样的图示:\n\n![image](https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-leak-array.png)\n\n### 清理问题\n\n虽然在任何作用域中都没有符号指向这个结构了，但是它无法被清理掉，因为数组元素 \"1\" 仍然指向自己本身。由于没有额外的符号指向它，所以对于用户来讲，是无法清理掉这个结构的，于是你就遇上了内存泄露。幸运的是，PHP 会在请求结束时清理掉这个数据结构，但在这之前，将会占去宝贵的内存空间。如果你在实现解析算法或者其他东西时将子元素指回了父元素，这种情况就会经常发生。当然，同样的情况也会发生在对象身上，而且可能性更高，因为对象总是隐式地被引用。\n\n这样的情况发生一两次倒也不是问题，但如果发生上千次或者几十万次的内存流失，这明显就成问题了。这样的问题往往发生在长时间运行的脚本中，比如守护进程 (请求基本上永远不会结束) 或者大量的单元测试。后者，在对 eZ Components 库的 Template 组建做单元测试时，有时会需要使用超过 2GB 的内存，而测试服务也许无法满足，这便是问题。\n\n## 回收周期\n\n从传统上讲，PHP 以往使用的引用计数内存机制，无法定位循环引用内存泄露，然而自 5.3.0 起，PHP 通过实现 [引用计数系统中的并发周期回收(Concurrent Cycle Collection in Reference Counted Systems)](http://researcher.watson.ibm.com/researcher/files/us-bacon/Bacon01Concurrent.pdf) 的同步算法来解决了这个问题。\n\n虽然对算法的完全说明有点超出这部分内容的范围，但基本的解释是有的。首先我们要建立一些基本原则。如果 \"refcount\" 增加了，zval 容器仍在被使用，所以这不是垃圾。如果 \"refcount\" 被减少了，并且被减至 0，则 zval 可以被释放。这意味着，只有当 \"refcount\" 被减少至非零时，垃圾周期 (garbage cycles) 才可以被产生。其次，在一次垃圾周期中，是有可能通过判断 \"refcount\" 是否可以被减 1，以及哪些 zval 的 \"refcount\" 是 0 的方式，来发现垃圾的。\n\n![image](https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-gc-algorithm.png)\n\n为避免发生检查所有 refcount 可能减少的垃圾周期，该算法把所有可能的root (possible roots)，即 zval 放进 \"root buffer\" (以紫色示意) 中。同时也确保每个可能是垃圾的 root 在 root buffer 中只出现一次。只有当 root buffer 达到饱和，回收机制才会对里面所有不同的 zval 启动。详见上图步骤 A。\n\n在步骤 B 中，算法针对所有可能的 root 执行一次深度优先搜索，找到 zval 后对其 refcount 减 1，并确保不会在同一个 zval 上重复执行 (以灰色示意)。在步骤 C 中，算法再次对每个 root 节点进行深度优先搜索，再次检索每个 zval 的 refcount 值。如果发现 refcount 为 0，zval 则被标记成 \"白色\" (蓝色部分)。如果 refcount 大于 0，则算法将从此处执行深度优先搜索并回滚 refcount 减 1 操作，并将这些 zval 重新标记为 \"黑色\"。在最后的步骤 D 中，算法遍历整个root buffer，从中移除 zval root，同时检索出之前步骤中被标记为 \"白色\" 的 zval。每个被标记为 \"白色\" 的 zval 都将被释放。\n\n现在你对算法是如何工作已经有了基本的认识，我们回过头来看它是如何与PHP集成的。默认情况下，PHP 的垃圾回收机制 (garbage collector) 是开启的。然而 php.ini 配置文件允许你做出修改: [zend.enable_gc](https://www.php.net/manual/en/info.configuration.php#ini.zend.enable-gc)。\n\n当 GC 开启时，一旦 root buffer 达到饱和，上述的循环查找算法就会被执行。root buffer 固定可存放 10,000 个 root (虽然你可以通过修改位于 PHP 源码 Zend/zend_gc.c 中的 GC_ROOT_BUFFER_MAX_ENTRIES 常量，然后重编译 PHP 来改变这个数值)。当 GC 关闭时，循环查找算法将不会启动。然而，可能的 root 将永远记录在 root buffer 里，不管是否在配置中开启了 GC。\n\n如果在 GC 关闭的情况下， root buffer 达到饱和，后续的可能的 root 就不会被记录下来。那些无法被记录的可能的 root 将永远无法被算法分析。如果它们存在循环引用，他们讲永远无法被清理掉，并造成内存泄露。\n\n为什么在GC关闭的情况下，还是会有 root 被记录呢？是因为记录这些 root 要比在每次找到root时判断GC是否开启更快。然而，垃圾回收与分析机制本身可能会消耗相当长的时间。\n\n除了修改 zend.enable_gc 配置，同样也可以通过调用 gc_enable() 或 gc_disable() 来控制垃圾回收机制的开与关。调用这些函数和修改配置是等效的。这同样也可以用来强制控制垃圾回收即便 root buffer 尚未饱和。你可以使用 gc_collect_cycles() 函数实现。该函数将返回被算法收集的周期数量。\n\n允许打开和关闭垃圾回收机制并且允许自主初始化的原因，是由于你的应用程序的某部分可能是高时效性的。在这种情况下，你可能不想使用垃圾回收机制。当然，对你的应用程序的某部分关闭垃圾回收机制，是在冒着可能发生内存泄漏的风险，因为一些可能 root 也许存不进有限的 root buffer。因此，就在你调用 gc_disable() 函数释放内存之前，先调用 gc_collect_cycles() 函数可能比较明智。因为这将清除已存放在 root buffer 中的所有可能 root，然后在垃圾回收机制被关闭时，可留下空 buffer 以有更多空间存储可能 root。\n","source":"_posts/2019-07-11-PHP-GC.md","raw":"---\ntitle: PHP 垃圾回收机制\ndate: 2019-07-11 16:43:37\ncategories:\n- [笔记]\n- [翻译]\ntags:\n- php\n- gc\n---\n\n## 引用计数器的基本概念\n\nPHP 变量是存放于一个叫做 \"zval\" 的容器中。zval 容器包含了变量的类型和值以及附加的两位 (bit) 信息。第一个叫做 \"is_ref\" 是个 bool 值，表示变量是否为 \"reference set\" 的一部分。通过这个位信息，PHP 引擎即可区分该变量是普通变量还是引用。由于 PHP 允许用户 (user-land) 通过 & 操作符来创建引用，zval 容器也包含了一个内部的引用计数机制用来优化内存使用。第二个位信息叫做 \"refcount\"，它包含指向这个 zval 容器的变量名称 (也叫符号 (symbols) ) 个数。所有的符号都存放在符号表 (symbol table) 中，其中，每个符号都有自己的作用域 (scope)。对于主脚本 (例: 被浏览器请求的脚本) 和每个函数或方法也都有作用域。\n\n<!-- more -->\n\n当一个变量被赋常量值时，就会生成一个 zval 变量容器，像这样:\n\n```php\n$a = \"new string\";\n```\n\n这个例子中，一个新的符号名 a 在当前作用域被创建了，也有一个新的变量容器被创建了，其类型是 string，值是 \"new string\"。\"is_ref\" 位默认是 FALSE，因为还没有引用被用户创建。\"refcount\" 为 1 因为只有一个符号在使用这个变量容器。注意，如果 \"refcount\" 为 1，\"is_ref\" 只会为 FALSE。如果你安装了 Xdebug，亦可以调用 xdebug_debug_zval() 方法来展示信息。\n\n```php\n$a = \"new string\";\nxdebug_debug_zval('a');\n```\n\n上面的例子将输出:\n\n```sh\na: (refcount=1, is_ref=0)='new string'\n```\n\n将这个变量赋值给另一个变量会增加 \"refcount\"。\n\n```php\n$a = \"new string\";\n$b = $a;\nxdebug_debug_zval( 'a' );\n```\n\n上面的例子将输出:\n\n```php\na: (refcount=2, is_ref=0)='new string'\n```\n\n现在 \"refcount\" 是 2，因为同一个变量容器被关联 (linked) 到了 a 和 b。PHP 足够聪明，在非必要时不会去拷贝实际的变量容器。容器变量在 \"refcount\" 减至 0 时被销毁。当有关联的变量容器的符号离开了作用域 (如: 函数结束时) 或者被取消赋值 (如: 被 unset() 时) 时，\"refcount\" 会减 1。下面的例子就能说明:\n\n```php\n$a = \"new string\";\n$c = $b = $a;\nxdebug_debug_zval( 'a' );\n$b = 42;\nxdebug_debug_zval( 'a' );\nunset( $c );\nxdebug_debug_zval( 'a' );\n```\n\n上面的例子将输出:\n\n```sh\na: (refcount=3, is_ref=0)='new string'\na: (refcount=2, is_ref=0)='new string' // when $b assigned by a new value\na: (refcount=1, is_ref=0)='new string' // when $c is unset()\n```\n\n如果我们现在调用 `unset($a);`，容器变量(包括类型和值)将从内存中被移除。\n\n### 复合类型\n\n对于复合类型而言，比如数组和对象，事情会变得稍微复杂些。和标量 (scalar) 值相反，数组和对象将自己的成员存放在自己的符号表中。这意味着下面的示例创建了 3 个 zval 容器:\n\n```php\n$a = ['meaning' => 'life','number' => 42];\nxdebug_debug_zval( 'a' );\n```\n\n上面的例子将输出类似这样的东西:\n\n```sh\na: (refcount=1, is_ref=0)=array (\n   'meaning' => (refcount=1, is_ref=0)='life',\n   'number' => (refcount=1, is_ref=0)=42\n)\n```\n\n或者是这样的图示:\n\n![image](https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-simple-array.png)\n\n3 个 zval 容器分别是: a，meaning 和 number。相似的规则同样可用来减少 \"refcounts\"。下面，我们添加另一个元素到数组中，并将值设置为一个已存在元素的内容:\n\n```php\n$a = ['meaning' => 'life','number' => 42];\n$a['life'] = $a['meaning'];\nxdebug_debug_zval( 'a' );\n```\n\n上面的例子将输出类似这样的东西:\n\n```sh\na: (refcount=1, is_ref=0)=array (\n   'meaning' => (refcount=2, is_ref=0)='life',\n   'number' => (refcount=1, is_ref=0)=42,\n   'life' => (refcount=2, is_ref=0)='life'\n)\n```\n\n或者是这样的图示:\n\n![image](https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-simple-array2.png)\n\n从上述 Xdebug 输出中，我们可以看出新老数组元素现在指向了一个 \"refcount\" 为 2 的zval 容器。虽然 Xdebug 的输出中有两个值为 \"life\" 的 zval 容器，但是他们其实同一个。虽然 xdebug_debug_zval() 函数不会说明这个，但你可以通过查看内存指针来分辨。\n\n从数组中移除元素就像是将符号从作用域中移除一样。移除后，数组元素所指向的容器的 \"refcount\" 会被减少。同样，当 \"refcount\" 减至 0 时，变量容器将会从内存中移除。下面的例子可以说明:\n\n```php\n$a = ['meaning' => 'life', 'number' => 42];\n$a['life'] = $a['meaning'];\nunset( $a['meaning'], $a['number'] );\nxdebug_debug_zval( 'a' );\n```\n\n上面的例子将输出类似这样的东西:\n\n```sh\na: (refcount=1, is_ref=0)=array (\n   'life' => (refcount=1, is_ref=0)='life'\n)\n```\n\n现在，如果我们将数组本身作为一个元素添加到数组中，事情就变得有趣了，我们将在下面的例子中这么做，而且会悄悄地添加一个引用操作符，不然 PHP 会创建一个拷贝:\n\n```php\n$a = ['one'];\n$a[] = &$a;\nxdebug_debug_zval( 'a' );\n```\n\n上面的例子将输出类似这样的东西:\n\n```sh\na: (refcount=2, is_ref=1)=array (\n   0 => (refcount=1, is_ref=0)='one',\n   1 => (refcount=2, is_ref=1)=...\n)\n```\n\n或者是这样的图示:\n\n![image](https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-loop-array.png)\n\n可以看出数组变量 `(a)` 和 第二个元素 `(1)` 现在都指向了一个 \"refcount\" 为 2 的变量容器。上面的 \"...\" 表示发送了递归，当然，在这里意味着指回了起源数组。\n\n和之前一样，对一个变量进行 unset() 会移除其符号，其指向的变量容器的引用数 (reference count) 将被减 1。所以如果我们在上述代码后面 unset 变量 `$a`，那么 `$a` 和 元素 `(1)` 所指向的变量容器的引用数就会减 1，由 \"2\" 变为 \"1\"。可以这样呈现:\n\n```sh\n(refcount=1, is_ref=1)=array (\n   0 => (refcount=1, is_ref=0)='one',\n   1 => (refcount=1, is_ref=1)=...\n)\n```\n\n或者是这样的图示:\n\n![image](https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-leak-array.png)\n\n### 清理问题\n\n虽然在任何作用域中都没有符号指向这个结构了，但是它无法被清理掉，因为数组元素 \"1\" 仍然指向自己本身。由于没有额外的符号指向它，所以对于用户来讲，是无法清理掉这个结构的，于是你就遇上了内存泄露。幸运的是，PHP 会在请求结束时清理掉这个数据结构，但在这之前，将会占去宝贵的内存空间。如果你在实现解析算法或者其他东西时将子元素指回了父元素，这种情况就会经常发生。当然，同样的情况也会发生在对象身上，而且可能性更高，因为对象总是隐式地被引用。\n\n这样的情况发生一两次倒也不是问题，但如果发生上千次或者几十万次的内存流失，这明显就成问题了。这样的问题往往发生在长时间运行的脚本中，比如守护进程 (请求基本上永远不会结束) 或者大量的单元测试。后者，在对 eZ Components 库的 Template 组建做单元测试时，有时会需要使用超过 2GB 的内存，而测试服务也许无法满足，这便是问题。\n\n## 回收周期\n\n从传统上讲，PHP 以往使用的引用计数内存机制，无法定位循环引用内存泄露，然而自 5.3.0 起，PHP 通过实现 [引用计数系统中的并发周期回收(Concurrent Cycle Collection in Reference Counted Systems)](http://researcher.watson.ibm.com/researcher/files/us-bacon/Bacon01Concurrent.pdf) 的同步算法来解决了这个问题。\n\n虽然对算法的完全说明有点超出这部分内容的范围，但基本的解释是有的。首先我们要建立一些基本原则。如果 \"refcount\" 增加了，zval 容器仍在被使用，所以这不是垃圾。如果 \"refcount\" 被减少了，并且被减至 0，则 zval 可以被释放。这意味着，只有当 \"refcount\" 被减少至非零时，垃圾周期 (garbage cycles) 才可以被产生。其次，在一次垃圾周期中，是有可能通过判断 \"refcount\" 是否可以被减 1，以及哪些 zval 的 \"refcount\" 是 0 的方式，来发现垃圾的。\n\n![image](https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-gc-algorithm.png)\n\n为避免发生检查所有 refcount 可能减少的垃圾周期，该算法把所有可能的root (possible roots)，即 zval 放进 \"root buffer\" (以紫色示意) 中。同时也确保每个可能是垃圾的 root 在 root buffer 中只出现一次。只有当 root buffer 达到饱和，回收机制才会对里面所有不同的 zval 启动。详见上图步骤 A。\n\n在步骤 B 中，算法针对所有可能的 root 执行一次深度优先搜索，找到 zval 后对其 refcount 减 1，并确保不会在同一个 zval 上重复执行 (以灰色示意)。在步骤 C 中，算法再次对每个 root 节点进行深度优先搜索，再次检索每个 zval 的 refcount 值。如果发现 refcount 为 0，zval 则被标记成 \"白色\" (蓝色部分)。如果 refcount 大于 0，则算法将从此处执行深度优先搜索并回滚 refcount 减 1 操作，并将这些 zval 重新标记为 \"黑色\"。在最后的步骤 D 中，算法遍历整个root buffer，从中移除 zval root，同时检索出之前步骤中被标记为 \"白色\" 的 zval。每个被标记为 \"白色\" 的 zval 都将被释放。\n\n现在你对算法是如何工作已经有了基本的认识，我们回过头来看它是如何与PHP集成的。默认情况下，PHP 的垃圾回收机制 (garbage collector) 是开启的。然而 php.ini 配置文件允许你做出修改: [zend.enable_gc](https://www.php.net/manual/en/info.configuration.php#ini.zend.enable-gc)。\n\n当 GC 开启时，一旦 root buffer 达到饱和，上述的循环查找算法就会被执行。root buffer 固定可存放 10,000 个 root (虽然你可以通过修改位于 PHP 源码 Zend/zend_gc.c 中的 GC_ROOT_BUFFER_MAX_ENTRIES 常量，然后重编译 PHP 来改变这个数值)。当 GC 关闭时，循环查找算法将不会启动。然而，可能的 root 将永远记录在 root buffer 里，不管是否在配置中开启了 GC。\n\n如果在 GC 关闭的情况下， root buffer 达到饱和，后续的可能的 root 就不会被记录下来。那些无法被记录的可能的 root 将永远无法被算法分析。如果它们存在循环引用，他们讲永远无法被清理掉，并造成内存泄露。\n\n为什么在GC关闭的情况下，还是会有 root 被记录呢？是因为记录这些 root 要比在每次找到root时判断GC是否开启更快。然而，垃圾回收与分析机制本身可能会消耗相当长的时间。\n\n除了修改 zend.enable_gc 配置，同样也可以通过调用 gc_enable() 或 gc_disable() 来控制垃圾回收机制的开与关。调用这些函数和修改配置是等效的。这同样也可以用来强制控制垃圾回收即便 root buffer 尚未饱和。你可以使用 gc_collect_cycles() 函数实现。该函数将返回被算法收集的周期数量。\n\n允许打开和关闭垃圾回收机制并且允许自主初始化的原因，是由于你的应用程序的某部分可能是高时效性的。在这种情况下，你可能不想使用垃圾回收机制。当然，对你的应用程序的某部分关闭垃圾回收机制，是在冒着可能发生内存泄漏的风险，因为一些可能 root 也许存不进有限的 root buffer。因此，就在你调用 gc_disable() 函数释放内存之前，先调用 gc_collect_cycles() 函数可能比较明智。因为这将清除已存放在 root buffer 中的所有可能 root，然后在垃圾回收机制被关闭时，可留下空 buffer 以有更多空间存储可能 root。\n","slug":"PHP-GC","published":1,"updated":"2023-05-28T05:36:04.286Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1jd000siubfufllpjyo","content":"<h2 id=\"引用计数器的基本概念\"><a href=\"#引用计数器的基本概念\" class=\"headerlink\" title=\"引用计数器的基本概念\"></a>引用计数器的基本概念</h2><p>PHP 变量是存放于一个叫做 &quot;zval&quot; 的容器中。zval 容器包含了变量的类型和值以及附加的两位 (bit) 信息。第一个叫做 &quot;is_ref&quot; 是个 bool 值，表示变量是否为 &quot;reference set&quot; 的一部分。通过这个位信息，PHP 引擎即可区分该变量是普通变量还是引用。由于 PHP 允许用户 (user-land) 通过 &amp; 操作符来创建引用，zval 容器也包含了一个内部的引用计数机制用来优化内存使用。第二个位信息叫做 &quot;refcount&quot;，它包含指向这个 zval 容器的变量名称 (也叫符号 (symbols) ) 个数。所有的符号都存放在符号表 (symbol table) 中，其中，每个符号都有自己的作用域 (scope)。对于主脚本 (例: 被浏览器请求的脚本) 和每个函数或方法也都有作用域。</p><a id=\"more\"></a><p>当一个变量被赋常量值时，就会生成一个 zval 变量容器，像这样:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = <span class=\"string\">\"new string\"</span>;</span><br></pre></td></tr></table></figure><p>这个例子中，一个新的符号名 a 在当前作用域被创建了，也有一个新的变量容器被创建了，其类型是 string，值是 &quot;new string&quot;。&quot;is_ref&quot; 位默认是 FALSE，因为还没有引用被用户创建。&quot;refcount&quot; 为 1 因为只有一个符号在使用这个变量容器。注意，如果 &quot;refcount&quot; 为 1，&quot;is_ref&quot; 只会为 FALSE。如果你安装了 Xdebug，亦可以调用 xdebug_debug_zval() 方法来展示信息。</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = <span class=\"string\">\"new string\"</span>;</span><br><span class=\"line\">xdebug_debug_zval(<span class=\"string\">'a'</span>);</span><br></pre></td></tr></table></figure><p>上面的例子将输出:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=1, is_ref=0)=<span class=\"string\">'new string'</span></span><br></pre></td></tr></table></figure><p>将这个变量赋值给另一个变量会增加 &quot;refcount&quot;。</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = <span class=\"string\">\"new string\"</span>;</span><br><span class=\"line\">$b = $a;</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br></pre></td></tr></table></figure><p>上面的例子将输出:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=<span class=\"number\">2</span>, is_ref=<span class=\"number\">0</span>)=<span class=\"string\">'new string'</span></span><br></pre></td></tr></table></figure><p>现在 &quot;refcount&quot; 是 2，因为同一个变量容器被关联 (linked) 到了 a 和 b。PHP 足够聪明，在非必要时不会去拷贝实际的变量容器。容器变量在 &quot;refcount&quot; 减至 0 时被销毁。当有关联的变量容器的符号离开了作用域 (如: 函数结束时) 或者被取消赋值 (如: 被 unset() 时) 时，&quot;refcount&quot; 会减 1。下面的例子就能说明:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = <span class=\"string\">\"new string\"</span>;</span><br><span class=\"line\">$c = $b = $a;</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br><span class=\"line\">$b = <span class=\"number\">42</span>;</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br><span class=\"line\"><span class=\"keyword\">unset</span>( $c );</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br></pre></td></tr></table></figure><p>上面的例子将输出:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=3, is_ref=0)=<span class=\"string\">'new string'</span></span><br><span class=\"line\">a: (refcount=2, is_ref=0)=<span class=\"string\">'new string'</span> // when <span class=\"variable\">$b</span> assigned by a new value</span><br><span class=\"line\">a: (refcount=1, is_ref=0)=<span class=\"string\">'new string'</span> // when <span class=\"variable\">$c</span> is <span class=\"built_in\">unset</span>()</span><br></pre></td></tr></table></figure><p>如果我们现在调用 <code>unset($a);</code>，容器变量(包括类型和值)将从内存中被移除。</p><h3 id=\"复合类型\"><a href=\"#复合类型\" class=\"headerlink\" title=\"复合类型\"></a>复合类型</h3><p>对于复合类型而言，比如数组和对象，事情会变得稍微复杂些。和标量 (scalar) 值相反，数组和对象将自己的成员存放在自己的符号表中。这意味着下面的示例创建了 3 个 zval 容器:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = [<span class=\"string\">'meaning'</span> =&gt; <span class=\"string\">'life'</span>,<span class=\"string\">'number'</span> =&gt; <span class=\"number\">42</span>];</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br></pre></td></tr></table></figure><p>上面的例子将输出类似这样的东西:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=1, is_ref=0)=array (</span><br><span class=\"line\">   <span class=\"string\">'meaning'</span> =&gt; (refcount=1, is_ref=0)=<span class=\"string\">'life'</span>,</span><br><span class=\"line\">   <span class=\"string\">'number'</span> =&gt; (refcount=1, is_ref=0)=42</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure><p>或者是这样的图示:</p><p><img src=\"https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-simple-array.png\" alt=\"image\"></p><p>3 个 zval 容器分别是: a，meaning 和 number。相似的规则同样可用来减少 &quot;refcounts&quot;。下面，我们添加另一个元素到数组中，并将值设置为一个已存在元素的内容:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = [<span class=\"string\">'meaning'</span> =&gt; <span class=\"string\">'life'</span>,<span class=\"string\">'number'</span> =&gt; <span class=\"number\">42</span>];</span><br><span class=\"line\">$a[<span class=\"string\">'life'</span>] = $a[<span class=\"string\">'meaning'</span>];</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br></pre></td></tr></table></figure><p>上面的例子将输出类似这样的东西:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=1, is_ref=0)=array (</span><br><span class=\"line\">   <span class=\"string\">'meaning'</span> =&gt; (refcount=2, is_ref=0)=<span class=\"string\">'life'</span>,</span><br><span class=\"line\">   <span class=\"string\">'number'</span> =&gt; (refcount=1, is_ref=0)=42,</span><br><span class=\"line\">   <span class=\"string\">'life'</span> =&gt; (refcount=2, is_ref=0)=<span class=\"string\">'life'</span></span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure><p>或者是这样的图示:</p><p><img src=\"https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-simple-array2.png\" alt=\"image\"></p><p>从上述 Xdebug 输出中，我们可以看出新老数组元素现在指向了一个 &quot;refcount&quot; 为 2 的zval 容器。虽然 Xdebug 的输出中有两个值为 &quot;life&quot; 的 zval 容器，但是他们其实同一个。虽然 xdebug_debug_zval() 函数不会说明这个，但你可以通过查看内存指针来分辨。</p><p>从数组中移除元素就像是将符号从作用域中移除一样。移除后，数组元素所指向的容器的 &quot;refcount&quot; 会被减少。同样，当 &quot;refcount&quot; 减至 0 时，变量容器将会从内存中移除。下面的例子可以说明:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = [<span class=\"string\">'meaning'</span> =&gt; <span class=\"string\">'life'</span>, <span class=\"string\">'number'</span> =&gt; <span class=\"number\">42</span>];</span><br><span class=\"line\">$a[<span class=\"string\">'life'</span>] = $a[<span class=\"string\">'meaning'</span>];</span><br><span class=\"line\"><span class=\"keyword\">unset</span>( $a[<span class=\"string\">'meaning'</span>], $a[<span class=\"string\">'number'</span>] );</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br></pre></td></tr></table></figure><p>上面的例子将输出类似这样的东西:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=1, is_ref=0)=array (</span><br><span class=\"line\">   <span class=\"string\">'life'</span> =&gt; (refcount=1, is_ref=0)=<span class=\"string\">'life'</span></span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure><p>现在，如果我们将数组本身作为一个元素添加到数组中，事情就变得有趣了，我们将在下面的例子中这么做，而且会悄悄地添加一个引用操作符，不然 PHP 会创建一个拷贝:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = [<span class=\"string\">'one'</span>];</span><br><span class=\"line\">$a[] = &amp;$a;</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br></pre></td></tr></table></figure><p>上面的例子将输出类似这样的东西:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=2, is_ref=1)=array (</span><br><span class=\"line\">   0 =&gt; (refcount=1, is_ref=0)=<span class=\"string\">'one'</span>,</span><br><span class=\"line\">   1 =&gt; (refcount=2, is_ref=1)=...</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure><p>或者是这样的图示:</p><p><img src=\"https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-loop-array.png\" alt=\"image\"></p><p>可以看出数组变量 <code>(a)</code> 和 第二个元素 <code>(1)</code> 现在都指向了一个 &quot;refcount&quot; 为 2 的变量容器。上面的 &quot;...&quot; 表示发送了递归，当然，在这里意味着指回了起源数组。</p><p>和之前一样，对一个变量进行 unset() 会移除其符号，其指向的变量容器的引用数 (reference count) 将被减 1。所以如果我们在上述代码后面 unset 变量 <code>$a</code>，那么 <code>$a</code> 和 元素 <code>(1)</code> 所指向的变量容器的引用数就会减 1，由 &quot;2&quot; 变为 &quot;1&quot;。可以这样呈现:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(refcount=1, is_ref=1)=array (</span><br><span class=\"line\">   0 =&gt; (refcount=1, is_ref=0)=<span class=\"string\">'one'</span>,</span><br><span class=\"line\">   1 =&gt; (refcount=1, is_ref=1)=...</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure><p>或者是这样的图示:</p><p><img src=\"https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-leak-array.png\" alt=\"image\"></p><h3 id=\"清理问题\"><a href=\"#清理问题\" class=\"headerlink\" title=\"清理问题\"></a>清理问题</h3><p>虽然在任何作用域中都没有符号指向这个结构了，但是它无法被清理掉，因为数组元素 &quot;1&quot; 仍然指向自己本身。由于没有额外的符号指向它，所以对于用户来讲，是无法清理掉这个结构的，于是你就遇上了内存泄露。幸运的是，PHP 会在请求结束时清理掉这个数据结构，但在这之前，将会占去宝贵的内存空间。如果你在实现解析算法或者其他东西时将子元素指回了父元素，这种情况就会经常发生。当然，同样的情况也会发生在对象身上，而且可能性更高，因为对象总是隐式地被引用。</p><p>这样的情况发生一两次倒也不是问题，但如果发生上千次或者几十万次的内存流失，这明显就成问题了。这样的问题往往发生在长时间运行的脚本中，比如守护进程 (请求基本上永远不会结束) 或者大量的单元测试。后者，在对 eZ Components 库的 Template 组建做单元测试时，有时会需要使用超过 2GB 的内存，而测试服务也许无法满足，这便是问题。</p><h2 id=\"回收周期\"><a href=\"#回收周期\" class=\"headerlink\" title=\"回收周期\"></a>回收周期</h2><p>从传统上讲，PHP 以往使用的引用计数内存机制，无法定位循环引用内存泄露，然而自 5.3.0 起，PHP 通过实现 <a href=\"http://researcher.watson.ibm.com/researcher/files/us-bacon/Bacon01Concurrent.pdf\" target=\"_blank\" rel=\"noopener\">引用计数系统中的并发周期回收(Concurrent Cycle Collection in Reference Counted Systems)</a> 的同步算法来解决了这个问题。</p><p>虽然对算法的完全说明有点超出这部分内容的范围，但基本的解释是有的。首先我们要建立一些基本原则。如果 &quot;refcount&quot; 增加了，zval 容器仍在被使用，所以这不是垃圾。如果 &quot;refcount&quot; 被减少了，并且被减至 0，则 zval 可以被释放。这意味着，只有当 &quot;refcount&quot; 被减少至非零时，垃圾周期 (garbage cycles) 才可以被产生。其次，在一次垃圾周期中，是有可能通过判断 &quot;refcount&quot; 是否可以被减 1，以及哪些 zval 的 &quot;refcount&quot; 是 0 的方式，来发现垃圾的。</p><p><img src=\"https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-gc-algorithm.png\" alt=\"image\"></p><p>为避免发生检查所有 refcount 可能减少的垃圾周期，该算法把所有可能的root (possible roots)，即 zval 放进 &quot;root buffer&quot; (以紫色示意) 中。同时也确保每个可能是垃圾的 root 在 root buffer 中只出现一次。只有当 root buffer 达到饱和，回收机制才会对里面所有不同的 zval 启动。详见上图步骤 A。</p><p>在步骤 B 中，算法针对所有可能的 root 执行一次深度优先搜索，找到 zval 后对其 refcount 减 1，并确保不会在同一个 zval 上重复执行 (以灰色示意)。在步骤 C 中，算法再次对每个 root 节点进行深度优先搜索，再次检索每个 zval 的 refcount 值。如果发现 refcount 为 0，zval 则被标记成 &quot;白色&quot; (蓝色部分)。如果 refcount 大于 0，则算法将从此处执行深度优先搜索并回滚 refcount 减 1 操作，并将这些 zval 重新标记为 &quot;黑色&quot;。在最后的步骤 D 中，算法遍历整个root buffer，从中移除 zval root，同时检索出之前步骤中被标记为 &quot;白色&quot; 的 zval。每个被标记为 &quot;白色&quot; 的 zval 都将被释放。</p><p>现在你对算法是如何工作已经有了基本的认识，我们回过头来看它是如何与PHP集成的。默认情况下，PHP 的垃圾回收机制 (garbage collector) 是开启的。然而 php.ini 配置文件允许你做出修改: <a href=\"https://www.php.net/manual/en/info.configuration.php#ini.zend.enable-gc\" target=\"_blank\" rel=\"noopener\">zend.enable_gc</a>。</p><p>当 GC 开启时，一旦 root buffer 达到饱和，上述的循环查找算法就会被执行。root buffer 固定可存放 10,000 个 root (虽然你可以通过修改位于 PHP 源码 Zend/zend_gc.c 中的 GC_ROOT_BUFFER_MAX_ENTRIES 常量，然后重编译 PHP 来改变这个数值)。当 GC 关闭时，循环查找算法将不会启动。然而，可能的 root 将永远记录在 root buffer 里，不管是否在配置中开启了 GC。</p><p>如果在 GC 关闭的情况下， root buffer 达到饱和，后续的可能的 root 就不会被记录下来。那些无法被记录的可能的 root 将永远无法被算法分析。如果它们存在循环引用，他们讲永远无法被清理掉，并造成内存泄露。</p><p>为什么在GC关闭的情况下，还是会有 root 被记录呢？是因为记录这些 root 要比在每次找到root时判断GC是否开启更快。然而，垃圾回收与分析机制本身可能会消耗相当长的时间。</p><p>除了修改 zend.enable_gc 配置，同样也可以通过调用 gc_enable() 或 gc_disable() 来控制垃圾回收机制的开与关。调用这些函数和修改配置是等效的。这同样也可以用来强制控制垃圾回收即便 root buffer 尚未饱和。你可以使用 gc_collect_cycles() 函数实现。该函数将返回被算法收集的周期数量。</p><p>允许打开和关闭垃圾回收机制并且允许自主初始化的原因，是由于你的应用程序的某部分可能是高时效性的。在这种情况下，你可能不想使用垃圾回收机制。当然，对你的应用程序的某部分关闭垃圾回收机制，是在冒着可能发生内存泄漏的风险，因为一些可能 root 也许存不进有限的 root buffer。因此，就在你调用 gc_disable() 函数释放内存之前，先调用 gc_collect_cycles() 函数可能比较明智。因为这将清除已存放在 root buffer 中的所有可能 root，然后在垃圾回收机制被关闭时，可留下空 buffer 以有更多空间存储可能 root。</p>","site":{"data":{}},"excerpt":"<h2 id=\"引用计数器的基本概念\"><a href=\"#引用计数器的基本概念\" class=\"headerlink\" title=\"引用计数器的基本概念\"></a>引用计数器的基本概念</h2><p>PHP 变量是存放于一个叫做 &quot;zval&quot; 的容器中。zval 容器包含了变量的类型和值以及附加的两位 (bit) 信息。第一个叫做 &quot;is_ref&quot; 是个 bool 值，表示变量是否为 &quot;reference set&quot; 的一部分。通过这个位信息，PHP 引擎即可区分该变量是普通变量还是引用。由于 PHP 允许用户 (user-land) 通过 &amp; 操作符来创建引用，zval 容器也包含了一个内部的引用计数机制用来优化内存使用。第二个位信息叫做 &quot;refcount&quot;，它包含指向这个 zval 容器的变量名称 (也叫符号 (symbols) ) 个数。所有的符号都存放在符号表 (symbol table) 中，其中，每个符号都有自己的作用域 (scope)。对于主脚本 (例: 被浏览器请求的脚本) 和每个函数或方法也都有作用域。</p>","more":"<p>当一个变量被赋常量值时，就会生成一个 zval 变量容器，像这样:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = <span class=\"string\">\"new string\"</span>;</span><br></pre></td></tr></table></figure><p>这个例子中，一个新的符号名 a 在当前作用域被创建了，也有一个新的变量容器被创建了，其类型是 string，值是 &quot;new string&quot;。&quot;is_ref&quot; 位默认是 FALSE，因为还没有引用被用户创建。&quot;refcount&quot; 为 1 因为只有一个符号在使用这个变量容器。注意，如果 &quot;refcount&quot; 为 1，&quot;is_ref&quot; 只会为 FALSE。如果你安装了 Xdebug，亦可以调用 xdebug_debug_zval() 方法来展示信息。</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = <span class=\"string\">\"new string\"</span>;</span><br><span class=\"line\">xdebug_debug_zval(<span class=\"string\">'a'</span>);</span><br></pre></td></tr></table></figure><p>上面的例子将输出:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=1, is_ref=0)=<span class=\"string\">'new string'</span></span><br></pre></td></tr></table></figure><p>将这个变量赋值给另一个变量会增加 &quot;refcount&quot;。</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = <span class=\"string\">\"new string\"</span>;</span><br><span class=\"line\">$b = $a;</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br></pre></td></tr></table></figure><p>上面的例子将输出:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=<span class=\"number\">2</span>, is_ref=<span class=\"number\">0</span>)=<span class=\"string\">'new string'</span></span><br></pre></td></tr></table></figure><p>现在 &quot;refcount&quot; 是 2，因为同一个变量容器被关联 (linked) 到了 a 和 b。PHP 足够聪明，在非必要时不会去拷贝实际的变量容器。容器变量在 &quot;refcount&quot; 减至 0 时被销毁。当有关联的变量容器的符号离开了作用域 (如: 函数结束时) 或者被取消赋值 (如: 被 unset() 时) 时，&quot;refcount&quot; 会减 1。下面的例子就能说明:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = <span class=\"string\">\"new string\"</span>;</span><br><span class=\"line\">$c = $b = $a;</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br><span class=\"line\">$b = <span class=\"number\">42</span>;</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br><span class=\"line\"><span class=\"keyword\">unset</span>( $c );</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br></pre></td></tr></table></figure><p>上面的例子将输出:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=3, is_ref=0)=<span class=\"string\">'new string'</span></span><br><span class=\"line\">a: (refcount=2, is_ref=0)=<span class=\"string\">'new string'</span> // when <span class=\"variable\">$b</span> assigned by a new value</span><br><span class=\"line\">a: (refcount=1, is_ref=0)=<span class=\"string\">'new string'</span> // when <span class=\"variable\">$c</span> is <span class=\"built_in\">unset</span>()</span><br></pre></td></tr></table></figure><p>如果我们现在调用 <code>unset($a);</code>，容器变量(包括类型和值)将从内存中被移除。</p><h3 id=\"复合类型\"><a href=\"#复合类型\" class=\"headerlink\" title=\"复合类型\"></a>复合类型</h3><p>对于复合类型而言，比如数组和对象，事情会变得稍微复杂些。和标量 (scalar) 值相反，数组和对象将自己的成员存放在自己的符号表中。这意味着下面的示例创建了 3 个 zval 容器:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = [<span class=\"string\">'meaning'</span> =&gt; <span class=\"string\">'life'</span>,<span class=\"string\">'number'</span> =&gt; <span class=\"number\">42</span>];</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br></pre></td></tr></table></figure><p>上面的例子将输出类似这样的东西:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=1, is_ref=0)=array (</span><br><span class=\"line\">   <span class=\"string\">'meaning'</span> =&gt; (refcount=1, is_ref=0)=<span class=\"string\">'life'</span>,</span><br><span class=\"line\">   <span class=\"string\">'number'</span> =&gt; (refcount=1, is_ref=0)=42</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure><p>或者是这样的图示:</p><p><img src=\"https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-simple-array.png\" alt=\"image\"></p><p>3 个 zval 容器分别是: a，meaning 和 number。相似的规则同样可用来减少 &quot;refcounts&quot;。下面，我们添加另一个元素到数组中，并将值设置为一个已存在元素的内容:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = [<span class=\"string\">'meaning'</span> =&gt; <span class=\"string\">'life'</span>,<span class=\"string\">'number'</span> =&gt; <span class=\"number\">42</span>];</span><br><span class=\"line\">$a[<span class=\"string\">'life'</span>] = $a[<span class=\"string\">'meaning'</span>];</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br></pre></td></tr></table></figure><p>上面的例子将输出类似这样的东西:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=1, is_ref=0)=array (</span><br><span class=\"line\">   <span class=\"string\">'meaning'</span> =&gt; (refcount=2, is_ref=0)=<span class=\"string\">'life'</span>,</span><br><span class=\"line\">   <span class=\"string\">'number'</span> =&gt; (refcount=1, is_ref=0)=42,</span><br><span class=\"line\">   <span class=\"string\">'life'</span> =&gt; (refcount=2, is_ref=0)=<span class=\"string\">'life'</span></span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure><p>或者是这样的图示:</p><p><img src=\"https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-simple-array2.png\" alt=\"image\"></p><p>从上述 Xdebug 输出中，我们可以看出新老数组元素现在指向了一个 &quot;refcount&quot; 为 2 的zval 容器。虽然 Xdebug 的输出中有两个值为 &quot;life&quot; 的 zval 容器，但是他们其实同一个。虽然 xdebug_debug_zval() 函数不会说明这个，但你可以通过查看内存指针来分辨。</p><p>从数组中移除元素就像是将符号从作用域中移除一样。移除后，数组元素所指向的容器的 &quot;refcount&quot; 会被减少。同样，当 &quot;refcount&quot; 减至 0 时，变量容器将会从内存中移除。下面的例子可以说明:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = [<span class=\"string\">'meaning'</span> =&gt; <span class=\"string\">'life'</span>, <span class=\"string\">'number'</span> =&gt; <span class=\"number\">42</span>];</span><br><span class=\"line\">$a[<span class=\"string\">'life'</span>] = $a[<span class=\"string\">'meaning'</span>];</span><br><span class=\"line\"><span class=\"keyword\">unset</span>( $a[<span class=\"string\">'meaning'</span>], $a[<span class=\"string\">'number'</span>] );</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br></pre></td></tr></table></figure><p>上面的例子将输出类似这样的东西:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=1, is_ref=0)=array (</span><br><span class=\"line\">   <span class=\"string\">'life'</span> =&gt; (refcount=1, is_ref=0)=<span class=\"string\">'life'</span></span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure><p>现在，如果我们将数组本身作为一个元素添加到数组中，事情就变得有趣了，我们将在下面的例子中这么做，而且会悄悄地添加一个引用操作符，不然 PHP 会创建一个拷贝:</p><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = [<span class=\"string\">'one'</span>];</span><br><span class=\"line\">$a[] = &amp;$a;</span><br><span class=\"line\">xdebug_debug_zval( <span class=\"string\">'a'</span> );</span><br></pre></td></tr></table></figure><p>上面的例子将输出类似这样的东西:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a: (refcount=2, is_ref=1)=array (</span><br><span class=\"line\">   0 =&gt; (refcount=1, is_ref=0)=<span class=\"string\">'one'</span>,</span><br><span class=\"line\">   1 =&gt; (refcount=2, is_ref=1)=...</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure><p>或者是这样的图示:</p><p><img src=\"https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-loop-array.png\" alt=\"image\"></p><p>可以看出数组变量 <code>(a)</code> 和 第二个元素 <code>(1)</code> 现在都指向了一个 &quot;refcount&quot; 为 2 的变量容器。上面的 &quot;...&quot; 表示发送了递归，当然，在这里意味着指回了起源数组。</p><p>和之前一样，对一个变量进行 unset() 会移除其符号，其指向的变量容器的引用数 (reference count) 将被减 1。所以如果我们在上述代码后面 unset 变量 <code>$a</code>，那么 <code>$a</code> 和 元素 <code>(1)</code> 所指向的变量容器的引用数就会减 1，由 &quot;2&quot; 变为 &quot;1&quot;。可以这样呈现:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(refcount=1, is_ref=1)=array (</span><br><span class=\"line\">   0 =&gt; (refcount=1, is_ref=0)=<span class=\"string\">'one'</span>,</span><br><span class=\"line\">   1 =&gt; (refcount=1, is_ref=1)=...</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure><p>或者是这样的图示:</p><p><img src=\"https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-leak-array.png\" alt=\"image\"></p><h3 id=\"清理问题\"><a href=\"#清理问题\" class=\"headerlink\" title=\"清理问题\"></a>清理问题</h3><p>虽然在任何作用域中都没有符号指向这个结构了，但是它无法被清理掉，因为数组元素 &quot;1&quot; 仍然指向自己本身。由于没有额外的符号指向它，所以对于用户来讲，是无法清理掉这个结构的，于是你就遇上了内存泄露。幸运的是，PHP 会在请求结束时清理掉这个数据结构，但在这之前，将会占去宝贵的内存空间。如果你在实现解析算法或者其他东西时将子元素指回了父元素，这种情况就会经常发生。当然，同样的情况也会发生在对象身上，而且可能性更高，因为对象总是隐式地被引用。</p><p>这样的情况发生一两次倒也不是问题，但如果发生上千次或者几十万次的内存流失，这明显就成问题了。这样的问题往往发生在长时间运行的脚本中，比如守护进程 (请求基本上永远不会结束) 或者大量的单元测试。后者，在对 eZ Components 库的 Template 组建做单元测试时，有时会需要使用超过 2GB 的内存，而测试服务也许无法满足，这便是问题。</p><h2 id=\"回收周期\"><a href=\"#回收周期\" class=\"headerlink\" title=\"回收周期\"></a>回收周期</h2><p>从传统上讲，PHP 以往使用的引用计数内存机制，无法定位循环引用内存泄露，然而自 5.3.0 起，PHP 通过实现 <a href=\"http://researcher.watson.ibm.com/researcher/files/us-bacon/Bacon01Concurrent.pdf\" target=\"_blank\" rel=\"noopener\">引用计数系统中的并发周期回收(Concurrent Cycle Collection in Reference Counted Systems)</a> 的同步算法来解决了这个问题。</p><p>虽然对算法的完全说明有点超出这部分内容的范围，但基本的解释是有的。首先我们要建立一些基本原则。如果 &quot;refcount&quot; 增加了，zval 容器仍在被使用，所以这不是垃圾。如果 &quot;refcount&quot; 被减少了，并且被减至 0，则 zval 可以被释放。这意味着，只有当 &quot;refcount&quot; 被减少至非零时，垃圾周期 (garbage cycles) 才可以被产生。其次，在一次垃圾周期中，是有可能通过判断 &quot;refcount&quot; 是否可以被减 1，以及哪些 zval 的 &quot;refcount&quot; 是 0 的方式，来发现垃圾的。</p><p><img src=\"https://www.php.net/manual/en/images/12f37b1c6963c1c5c18f30495416a197-gc-algorithm.png\" alt=\"image\"></p><p>为避免发生检查所有 refcount 可能减少的垃圾周期，该算法把所有可能的root (possible roots)，即 zval 放进 &quot;root buffer&quot; (以紫色示意) 中。同时也确保每个可能是垃圾的 root 在 root buffer 中只出现一次。只有当 root buffer 达到饱和，回收机制才会对里面所有不同的 zval 启动。详见上图步骤 A。</p><p>在步骤 B 中，算法针对所有可能的 root 执行一次深度优先搜索，找到 zval 后对其 refcount 减 1，并确保不会在同一个 zval 上重复执行 (以灰色示意)。在步骤 C 中，算法再次对每个 root 节点进行深度优先搜索，再次检索每个 zval 的 refcount 值。如果发现 refcount 为 0，zval 则被标记成 &quot;白色&quot; (蓝色部分)。如果 refcount 大于 0，则算法将从此处执行深度优先搜索并回滚 refcount 减 1 操作，并将这些 zval 重新标记为 &quot;黑色&quot;。在最后的步骤 D 中，算法遍历整个root buffer，从中移除 zval root，同时检索出之前步骤中被标记为 &quot;白色&quot; 的 zval。每个被标记为 &quot;白色&quot; 的 zval 都将被释放。</p><p>现在你对算法是如何工作已经有了基本的认识，我们回过头来看它是如何与PHP集成的。默认情况下，PHP 的垃圾回收机制 (garbage collector) 是开启的。然而 php.ini 配置文件允许你做出修改: <a href=\"https://www.php.net/manual/en/info.configuration.php#ini.zend.enable-gc\" target=\"_blank\" rel=\"noopener\">zend.enable_gc</a>。</p><p>当 GC 开启时，一旦 root buffer 达到饱和，上述的循环查找算法就会被执行。root buffer 固定可存放 10,000 个 root (虽然你可以通过修改位于 PHP 源码 Zend/zend_gc.c 中的 GC_ROOT_BUFFER_MAX_ENTRIES 常量，然后重编译 PHP 来改变这个数值)。当 GC 关闭时，循环查找算法将不会启动。然而，可能的 root 将永远记录在 root buffer 里，不管是否在配置中开启了 GC。</p><p>如果在 GC 关闭的情况下， root buffer 达到饱和，后续的可能的 root 就不会被记录下来。那些无法被记录的可能的 root 将永远无法被算法分析。如果它们存在循环引用，他们讲永远无法被清理掉，并造成内存泄露。</p><p>为什么在GC关闭的情况下，还是会有 root 被记录呢？是因为记录这些 root 要比在每次找到root时判断GC是否开启更快。然而，垃圾回收与分析机制本身可能会消耗相当长的时间。</p><p>除了修改 zend.enable_gc 配置，同样也可以通过调用 gc_enable() 或 gc_disable() 来控制垃圾回收机制的开与关。调用这些函数和修改配置是等效的。这同样也可以用来强制控制垃圾回收即便 root buffer 尚未饱和。你可以使用 gc_collect_cycles() 函数实现。该函数将返回被算法收集的周期数量。</p><p>允许打开和关闭垃圾回收机制并且允许自主初始化的原因，是由于你的应用程序的某部分可能是高时效性的。在这种情况下，你可能不想使用垃圾回收机制。当然，对你的应用程序的某部分关闭垃圾回收机制，是在冒着可能发生内存泄漏的风险，因为一些可能 root 也许存不进有限的 root buffer。因此，就在你调用 gc_disable() 函数释放内存之前，先调用 gc_collect_cycles() 函数可能比较明智。因为这将清除已存放在 root buffer 中的所有可能 root，然后在垃圾回收机制被关闭时，可留下空 buffer 以有更多空间存储可能 root。</p>"},{"title":"理解 Golang 中的 nil 判断","date":"2020-08-17T04:12:13.000Z","_content":"\n## nil 的含义\n\n从单词的角度来看， `nil` 有多个意思，但通常都表示 `零`，在 Golang 中，有些类型的零值是 nil 而有的不是。\n\n```go\n// 不同类型的零值\nvar n int               // 0\nvar s string            // \"\"\nvar b bool              // false\nvar p *Pointer          // nil\nvar slice []byte        // nil\nvar m map[string]string // nil\nvar fn func() error     // nil\nvar ch chan int         // nil\nvar i interface{}       // nil\n```\n\n<!-- more -->\n\n## Pointer 的零值\n\n一个 `pointer` (指针) 变量，表示该变量指向了某一个内存地址，当我们只是声明了一个指针变量，而不指明其指向的内存地址，\n这个变量就会是 `nil`:\n\n```go\ntype Person struct {}\nvar ptr *Person // 声明了一个指针变量，但是没有说明指针地址\nassertTrue(ptr == nil)\n```\n\n## Slice 的零值\n\n`slice` 是数组的切片，其内部有三个元素构成:\n\n```go\n// 伪代码\ntype slice struct {\n    Ptr *pointer // 指向底层数组的指针\n    Len int      // 长度\n    Cap int      // 容量\n}\n```\n\n当我们只是声明了一个 slice 后，并没有告诉 slice 要指向那个底层数组，所以此时 Ptr 为 `nil`:\n\n```go\nvar s []byte         // s 中的 Ptr 为 nil\nassertTrue(s == nil) // 此时，变量 s == nil 为 true\n\nvar ss = []int{1, 2, 3} // ss 是知道自己的底层数组的\nassertTrue(ss != nil)   // 所以不为 nil\n```\n\n## Map, Channel, Function 的零值\n\n这三种类型的零值为 `nil` ，是因为当我们声明了变量后，并没有说明该变量对应的 implemention (实现) 是什么。\n\n## Interface 的零值\n\n首先思考一个例子，**实际开发中不要这样做**:\n\n```go\ntype MyError struct{} // MyError 实现 error 接口\nfunc (*MyError) Error() string {\n    return \"here is my error\"\n}\n\nfunc NewError() error {\n    var myErr *MyError\n    return myErr // 返回时把 myErr 转为 error 接口\n}\n\nfunc main() {\n    err := NewError()\n    if err == nil {\n        // cool!\n    } else {\n        // whoops..\n    }\n}\n```\n\n我们调用 `NewError()` 后得到的 err 是 `nil` 吗？运行后发现 `err` 不为 nil。要解释这个现象需要从 interface 的结构说起。\n\n`interface` 内部有两个元素 ———— `type` (类型) 和 `value` (值):\n\n```go\n// 伪代码\ntype interface struct {\n    Type xx  // 类型\n    Value xx // 值\n}\n```\n\n在上述 `NewError()` 方法的定义里，我们声明了一个空指针变量 `myErr` ，这个变量为 `nil` ，\n然后返回的时候将 `myErr` 转成了 `error` 接口。\n\n调用后得到的 `err` 变量已经是一个 `interface` 了，\n而此时这个 interface 的值为 nil ，但类型是 `*MyError` ，所以 `err == nil` 会是 false。\n\n再回过头来看看:\n\n```go\nvar i interface{}    // value 和 type 都为空\nassertTrue(i == nil) // 所以整个 interface == nil\n\nvar p *Pointer        // p == nil\nvar t interface{} = p // t 的值为nil，但类型为 *Pointer\nassertTrue(t != nil)  // 所以 t != nil\n```\n","source":"_posts/2020-08-17-理解-Golang-中的-nil-判断.md","raw":"---\ntitle: 理解 Golang 中的 nil 判断\ndate: 2020-08-17 12:12:13\ncategories:\n- 笔记\ntags:\n- golang\n---\n\n## nil 的含义\n\n从单词的角度来看， `nil` 有多个意思，但通常都表示 `零`，在 Golang 中，有些类型的零值是 nil 而有的不是。\n\n```go\n// 不同类型的零值\nvar n int               // 0\nvar s string            // \"\"\nvar b bool              // false\nvar p *Pointer          // nil\nvar slice []byte        // nil\nvar m map[string]string // nil\nvar fn func() error     // nil\nvar ch chan int         // nil\nvar i interface{}       // nil\n```\n\n<!-- more -->\n\n## Pointer 的零值\n\n一个 `pointer` (指针) 变量，表示该变量指向了某一个内存地址，当我们只是声明了一个指针变量，而不指明其指向的内存地址，\n这个变量就会是 `nil`:\n\n```go\ntype Person struct {}\nvar ptr *Person // 声明了一个指针变量，但是没有说明指针地址\nassertTrue(ptr == nil)\n```\n\n## Slice 的零值\n\n`slice` 是数组的切片，其内部有三个元素构成:\n\n```go\n// 伪代码\ntype slice struct {\n    Ptr *pointer // 指向底层数组的指针\n    Len int      // 长度\n    Cap int      // 容量\n}\n```\n\n当我们只是声明了一个 slice 后，并没有告诉 slice 要指向那个底层数组，所以此时 Ptr 为 `nil`:\n\n```go\nvar s []byte         // s 中的 Ptr 为 nil\nassertTrue(s == nil) // 此时，变量 s == nil 为 true\n\nvar ss = []int{1, 2, 3} // ss 是知道自己的底层数组的\nassertTrue(ss != nil)   // 所以不为 nil\n```\n\n## Map, Channel, Function 的零值\n\n这三种类型的零值为 `nil` ，是因为当我们声明了变量后，并没有说明该变量对应的 implemention (实现) 是什么。\n\n## Interface 的零值\n\n首先思考一个例子，**实际开发中不要这样做**:\n\n```go\ntype MyError struct{} // MyError 实现 error 接口\nfunc (*MyError) Error() string {\n    return \"here is my error\"\n}\n\nfunc NewError() error {\n    var myErr *MyError\n    return myErr // 返回时把 myErr 转为 error 接口\n}\n\nfunc main() {\n    err := NewError()\n    if err == nil {\n        // cool!\n    } else {\n        // whoops..\n    }\n}\n```\n\n我们调用 `NewError()` 后得到的 err 是 `nil` 吗？运行后发现 `err` 不为 nil。要解释这个现象需要从 interface 的结构说起。\n\n`interface` 内部有两个元素 ———— `type` (类型) 和 `value` (值):\n\n```go\n// 伪代码\ntype interface struct {\n    Type xx  // 类型\n    Value xx // 值\n}\n```\n\n在上述 `NewError()` 方法的定义里，我们声明了一个空指针变量 `myErr` ，这个变量为 `nil` ，\n然后返回的时候将 `myErr` 转成了 `error` 接口。\n\n调用后得到的 `err` 变量已经是一个 `interface` 了，\n而此时这个 interface 的值为 nil ，但类型是 `*MyError` ，所以 `err == nil` 会是 false。\n\n再回过头来看看:\n\n```go\nvar i interface{}    // value 和 type 都为空\nassertTrue(i == nil) // 所以整个 interface == nil\n\nvar p *Pointer        // p == nil\nvar t interface{} = p // t 的值为nil，但类型为 *Pointer\nassertTrue(t != nil)  // 所以 t != nil\n```\n","slug":"理解-Golang-中的-nil-判断","published":1,"updated":"2023-05-28T05:36:04.286Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1jd000tiubfg1plb8yi","content":"<h2 id=\"nil-的含义\"><a href=\"#nil-的含义\" class=\"headerlink\" title=\"nil 的含义\"></a>nil 的含义</h2><p>从单词的角度来看， <code>nil</code> 有多个意思，但通常都表示 <code>零</code>，在 Golang 中，有些类型的零值是 nil 而有的不是。</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 不同类型的零值</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> n <span class=\"keyword\">int</span>               <span class=\"comment\">// 0</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> s <span class=\"keyword\">string</span>            <span class=\"comment\">// \"\"</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> b <span class=\"keyword\">bool</span>              <span class=\"comment\">// false</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> p *Pointer          <span class=\"comment\">// nil</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> slice []<span class=\"keyword\">byte</span>        <span class=\"comment\">// nil</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> m <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">string</span> <span class=\"comment\">// nil</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> fn <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span> <span class=\"title\">error</span>     // <span class=\"title\">nil</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">var</span> <span class=\"title\">ch</span> <span class=\"title\">chan</span> <span class=\"title\">int</span>         // <span class=\"title\">nil</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">var</span> <span class=\"title\">i</span> <span class=\"title\">interface</span></span>&#123;&#125;       <span class=\"comment\">// nil</span></span><br></pre></td></tr></table></figure><a id=\"more\"></a><h2 id=\"Pointer-的零值\"><a href=\"#Pointer-的零值\" class=\"headerlink\" title=\"Pointer 的零值\"></a>Pointer 的零值</h2><p>一个 <code>pointer</code> (指针) 变量，表示该变量指向了某一个内存地址，当我们只是声明了一个指针变量，而不指明其指向的内存地址， 这个变量就会是 <code>nil</code>:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Person <span class=\"keyword\">struct</span> &#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">var</span> ptr *Person <span class=\"comment\">// 声明了一个指针变量，但是没有说明指针地址</span></span><br><span class=\"line\">assertTrue(ptr == <span class=\"literal\">nil</span>)</span><br></pre></td></tr></table></figure><h2 id=\"Slice-的零值\"><a href=\"#Slice-的零值\" class=\"headerlink\" title=\"Slice 的零值\"></a>Slice 的零值</h2><p><code>slice</code> 是数组的切片，其内部有三个元素构成:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 伪代码</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> slice <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    Ptr *pointer <span class=\"comment\">// 指向底层数组的指针</span></span><br><span class=\"line\">    Len <span class=\"keyword\">int</span>      <span class=\"comment\">// 长度</span></span><br><span class=\"line\">    Cap <span class=\"keyword\">int</span>      <span class=\"comment\">// 容量</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>当我们只是声明了一个 slice 后，并没有告诉 slice 要指向那个底层数组，所以此时 Ptr 为 <code>nil</code>:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> s []<span class=\"keyword\">byte</span>         <span class=\"comment\">// s 中的 Ptr 为 nil</span></span><br><span class=\"line\">assertTrue(s == <span class=\"literal\">nil</span>) <span class=\"comment\">// 此时，变量 s == nil 为 true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> ss = []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125; <span class=\"comment\">// ss 是知道自己的底层数组的</span></span><br><span class=\"line\">assertTrue(ss != <span class=\"literal\">nil</span>)   <span class=\"comment\">// 所以不为 nil</span></span><br></pre></td></tr></table></figure><h2 id=\"Map-Channel-Function-的零值\"><a href=\"#Map-Channel-Function-的零值\" class=\"headerlink\" title=\"Map, Channel, Function 的零值\"></a>Map, Channel, Function 的零值</h2><p>这三种类型的零值为 <code>nil</code> ，是因为当我们声明了变量后，并没有说明该变量对应的 implemention (实现) 是什么。</p><h2 id=\"Interface-的零值\"><a href=\"#Interface-的零值\" class=\"headerlink\" title=\"Interface 的零值\"></a>Interface 的零值</h2><p>首先思考一个例子，<strong>实际开发中不要这样做</strong>:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> MyError <span class=\"keyword\">struct</span>&#123;&#125; <span class=\"comment\">// MyError 实现 error 接口</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(*MyError)</span> <span class=\"title\">Error</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">\"here is my error\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewError</span><span class=\"params\">()</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> myErr *MyError</span><br><span class=\"line\">    <span class=\"keyword\">return</span> myErr <span class=\"comment\">// 返回时把 myErr 转为 error 接口</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    err := NewError()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> err == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// cool!</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// whoops..</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>我们调用 <code>NewError()</code> 后得到的 err 是 <code>nil</code> 吗？运行后发现 <code>err</code> 不为 nil。要解释这个现象需要从 interface 的结构说起。</p><p><code>interface</code> 内部有两个元素 ———— <code>type</code> (类型) 和 <code>value</code> (值):</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 伪代码</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"keyword\">interface</span> <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    Type xx  <span class=\"comment\">// 类型</span></span><br><span class=\"line\">    Value xx <span class=\"comment\">// 值</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>在上述 <code>NewError()</code> 方法的定义里，我们声明了一个空指针变量 <code>myErr</code> ，这个变量为 <code>nil</code> ， 然后返回的时候将 <code>myErr</code> 转成了 <code>error</code> 接口。</p><p>调用后得到的 <code>err</code> 变量已经是一个 <code>interface</code> 了， 而此时这个 interface 的值为 nil ，但类型是 <code>*MyError</code> ，所以 <code>err == nil</code> 会是 false。</p><p>再回过头来看看:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> i <span class=\"keyword\">interface</span>&#123;&#125;    <span class=\"comment\">// value 和 type 都为空</span></span><br><span class=\"line\">assertTrue(i == <span class=\"literal\">nil</span>) <span class=\"comment\">// 所以整个 interface == nil</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> p *Pointer        <span class=\"comment\">// p == nil</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> t <span class=\"keyword\">interface</span>&#123;&#125; = p <span class=\"comment\">// t 的值为nil，但类型为 *Pointer</span></span><br><span class=\"line\">assertTrue(t != <span class=\"literal\">nil</span>)  <span class=\"comment\">// 所以 t != nil</span></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"<h2 id=\"nil-的含义\"><a href=\"#nil-的含义\" class=\"headerlink\" title=\"nil 的含义\"></a>nil 的含义</h2><p>从单词的角度来看， <code>nil</code> 有多个意思，但通常都表示 <code>零</code>，在 Golang 中，有些类型的零值是 nil 而有的不是。</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 不同类型的零值</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> n <span class=\"keyword\">int</span>               <span class=\"comment\">// 0</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> s <span class=\"keyword\">string</span>            <span class=\"comment\">// \"\"</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> b <span class=\"keyword\">bool</span>              <span class=\"comment\">// false</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> p *Pointer          <span class=\"comment\">// nil</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> slice []<span class=\"keyword\">byte</span>        <span class=\"comment\">// nil</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> m <span class=\"keyword\">map</span>[<span class=\"keyword\">string</span>]<span class=\"keyword\">string</span> <span class=\"comment\">// nil</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> fn <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span> <span class=\"title\">error</span>     // <span class=\"title\">nil</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">var</span> <span class=\"title\">ch</span> <span class=\"title\">chan</span> <span class=\"title\">int</span>         // <span class=\"title\">nil</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">var</span> <span class=\"title\">i</span> <span class=\"title\">interface</span></span>&#123;&#125;       <span class=\"comment\">// nil</span></span><br></pre></td></tr></table></figure>","more":"<h2 id=\"Pointer-的零值\"><a href=\"#Pointer-的零值\" class=\"headerlink\" title=\"Pointer 的零值\"></a>Pointer 的零值</h2><p>一个 <code>pointer</code> (指针) 变量，表示该变量指向了某一个内存地址，当我们只是声明了一个指针变量，而不指明其指向的内存地址， 这个变量就会是 <code>nil</code>:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Person <span class=\"keyword\">struct</span> &#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">var</span> ptr *Person <span class=\"comment\">// 声明了一个指针变量，但是没有说明指针地址</span></span><br><span class=\"line\">assertTrue(ptr == <span class=\"literal\">nil</span>)</span><br></pre></td></tr></table></figure><h2 id=\"Slice-的零值\"><a href=\"#Slice-的零值\" class=\"headerlink\" title=\"Slice 的零值\"></a>Slice 的零值</h2><p><code>slice</code> 是数组的切片，其内部有三个元素构成:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 伪代码</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> slice <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    Ptr *pointer <span class=\"comment\">// 指向底层数组的指针</span></span><br><span class=\"line\">    Len <span class=\"keyword\">int</span>      <span class=\"comment\">// 长度</span></span><br><span class=\"line\">    Cap <span class=\"keyword\">int</span>      <span class=\"comment\">// 容量</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>当我们只是声明了一个 slice 后，并没有告诉 slice 要指向那个底层数组，所以此时 Ptr 为 <code>nil</code>:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> s []<span class=\"keyword\">byte</span>         <span class=\"comment\">// s 中的 Ptr 为 nil</span></span><br><span class=\"line\">assertTrue(s == <span class=\"literal\">nil</span>) <span class=\"comment\">// 此时，变量 s == nil 为 true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> ss = []<span class=\"keyword\">int</span>&#123;<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>&#125; <span class=\"comment\">// ss 是知道自己的底层数组的</span></span><br><span class=\"line\">assertTrue(ss != <span class=\"literal\">nil</span>)   <span class=\"comment\">// 所以不为 nil</span></span><br></pre></td></tr></table></figure><h2 id=\"Map-Channel-Function-的零值\"><a href=\"#Map-Channel-Function-的零值\" class=\"headerlink\" title=\"Map, Channel, Function 的零值\"></a>Map, Channel, Function 的零值</h2><p>这三种类型的零值为 <code>nil</code> ，是因为当我们声明了变量后，并没有说明该变量对应的 implemention (实现) 是什么。</p><h2 id=\"Interface-的零值\"><a href=\"#Interface-的零值\" class=\"headerlink\" title=\"Interface 的零值\"></a>Interface 的零值</h2><p>首先思考一个例子，<strong>实际开发中不要这样做</strong>:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> MyError <span class=\"keyword\">struct</span>&#123;&#125; <span class=\"comment\">// MyError 实现 error 接口</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(*MyError)</span> <span class=\"title\">Error</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">\"here is my error\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewError</span><span class=\"params\">()</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> myErr *MyError</span><br><span class=\"line\">    <span class=\"keyword\">return</span> myErr <span class=\"comment\">// 返回时把 myErr 转为 error 接口</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">    err := NewError()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> err == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// cool!</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// whoops..</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>我们调用 <code>NewError()</code> 后得到的 err 是 <code>nil</code> 吗？运行后发现 <code>err</code> 不为 nil。要解释这个现象需要从 interface 的结构说起。</p><p><code>interface</code> 内部有两个元素 ———— <code>type</code> (类型) 和 <code>value</code> (值):</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 伪代码</span></span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"keyword\">interface</span> <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    Type xx  <span class=\"comment\">// 类型</span></span><br><span class=\"line\">    Value xx <span class=\"comment\">// 值</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>在上述 <code>NewError()</code> 方法的定义里，我们声明了一个空指针变量 <code>myErr</code> ，这个变量为 <code>nil</code> ， 然后返回的时候将 <code>myErr</code> 转成了 <code>error</code> 接口。</p><p>调用后得到的 <code>err</code> 变量已经是一个 <code>interface</code> 了， 而此时这个 interface 的值为 nil ，但类型是 <code>*MyError</code> ，所以 <code>err == nil</code> 会是 false。</p><p>再回过头来看看:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> i <span class=\"keyword\">interface</span>&#123;&#125;    <span class=\"comment\">// value 和 type 都为空</span></span><br><span class=\"line\">assertTrue(i == <span class=\"literal\">nil</span>) <span class=\"comment\">// 所以整个 interface == nil</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> p *Pointer        <span class=\"comment\">// p == nil</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> t <span class=\"keyword\">interface</span>&#123;&#125; = p <span class=\"comment\">// t 的值为nil，但类型为 *Pointer</span></span><br><span class=\"line\">assertTrue(t != <span class=\"literal\">nil</span>)  <span class=\"comment\">// 所以 t != nil</span></span><br></pre></td></tr></table></figure>"},{"title":"Go Blog 翻译: Context and Structs","date":"2021-04-21T09:10:54.000Z","_content":"\n## Context and Structs\n\n原文地址: https://blog.golang.org/context-and-structs\n\n作者: Jean de Klerk, Matt T. Proud\n\n时间: 24 February 2021\n\n### Introduction\n\n在许多尤其是现代的 Go API 中, function 或 method 的第一个参数常常是 [context.Context](https://golang.org/pkg/context/). Context 为传输提供了 deadline, 为调用方提供了 cancellation, 也为其他进程间跨 API 请求提供了传值手段. 它常常被间接或直接使用了远程服务的库所使用, 例如数据库, API 等.\n\n[Context 文档](https://golang.org/pkg/context/) 所述:\n\n> Context 不应存储在 struct 内部, 而应传给需要它的 function.\n\n这篇文章就是针对上述建议的详述, 通过举例说明的方式来阐述为什么要传递 Context 而不是存储在另一个 type 里. 本文也强调了一种边缘情况: 将 Context 存储在 struct 中也是合理的. 以及如何安全实现.\n\n<!-- more -->\n\n### Prefer contexts passed as arguments\n\n要理解这个建议: **不要把 Context 存储在 struct 中**. 我们先看看建议的方式下写的代码:\n\n```go\ntype Worker struct { /* … */ }\n\ntype Work struct { /* … */ }\n\nfunc New() *Worker {\n  return &Worker{}\n}\n\nfunc (w *Worker) Fetch(ctx context.Context) (*Work, error) {\n  _ = ctx // A per-call ctx is used for cancellation, deadlines, and metadata.\n}\n\nfunc (w *Worker) Process(ctx context.Context, work *Work) error {\n  _ = ctx // A per-call ctx is used for cancellation, deadlines, and metadata.\n}\n```\n\n`(*Worker).Fetch` 和 `(*Worker).Process` 两个方法都直接接受 context 参数. 在 `pass-as-argument` 的设计下, 用户可以对每次调用设置 `deadlines`, `cancellation`, 和 `metadata`. 而且, `context.Context` 传到每个方法的方式是很清晰的, 不用去担心 `context.Context` 会不会在其他方法中用到. 这是因为 `context` 被划定为了操作所需的最小粒度, 这极大地增强了包中 context 的实用性和清晰度.\n\n### Storing context in structs leads to confusion\n\n我们再来用 *不推荐* 的 `context-in-struct` 方式来审视下代码. 这问题在于, 当你把 context 存储在 struct 里, 调用方就无法看清楚 context 的生命周期, 情况得不可预测:\n\n```go\ntype Worker struct {\n  ctx context.Context\n}\n\nfunc New(ctx context.Context) *Worker {\n  return &Worker{ctx: ctx}\n}\n\nfunc (w *Worker) Fetch() (*Work, error) {\n  _ = w.ctx // A shared w.ctx is used for cancellation, deadlines, and metadata.\n}\n\nfunc (w *Worker) Process(work *Work) error {\n  _ = w.ctx // A shared w.ctx is used for cancellation, deadlines, and metadata.\n}\n```\n\n`(*Worker).Fetch` 和 `(*Worker).Process` 方法都使用了存储在 Worker 里的 context. 这阻碍了 Fetch 和 Process 调用方 (可能他们拥有各自不同的 context) 在每次调用时的基本操作: 指定 deadline, 请求 cancellation 以及附加 metadata. 例如: 用户无法仅为 `(*Worker).Fetch` 提供 deadline, 也无法仅为 `(*Worker).Process` 提供 cancel. 因为context是共享的, 所以调用方的生命周期是虚实夹杂的, 并且当 Worker 被创建时, context 就会被作用于整个生命周期.\n\n相比 `pass-as-argument` 方式, 用户会对这个 API 感到很疑惑, 心想:\n\n- New 方法会被传入 context.Context, 那这个构造方法在执行时会需要 cancelation 或 deadlines 吗?\n- 在 New 方法中传入的 context.Context 会被 `(*Worker).Fetch` 和 `(*Worker).Process` 方法使用吗? 两个方法都不会用到? 还是说有方法会用到?\n\n这个 API 也需要有大量的文档来明确地告诉用户, context.Context 具体是用来干什么的. 用户也不得不读源码而不能依赖 API 所传达的结构.\n\n而且, 这可能是很危险的, 将这样的设计方式运用在生产级别的服务器上. 因为如果不是每个请求都有一个 context, 就不能充分地\"尊重\" cancellation. 不能对每次调用设置 deadline, 你的进程可能会堆积和耗尽其资源 (比如 内存)!\n\n### Exception to the rule: preserving backwards compatibility\n\n当 Go 1.7 [带着 context.Context](https://golang.org/doc/go1.7) 发布后, 大量的 API 需要以向后兼容的方式添加 context 支持. 例如: [net/http 中 Client 方法](https://golang.org/pkg/net/http/), 像 Get 和 Do, 就是 context 极佳的候选者. 通过这些方法所发出的外部请求都会受益于由 `context.Context` 带来的 deadline, cancellation, 和 metadata 的支持.\n\n有两种方式来添加向后兼容的 `context.Context` 支持: 一种是将 context 定义在 struct 里 (context-in-struct), 另一种, 正如我们所见, 是复制函数来接收 context.Context 参数, 并将 Context 作为新函数的名后缀. 复制函数的方式相比 context-in-struct 更好, 更深入的讨论详见 [Keeping your modules compatible](https://blog.golang.org/module-compatibility). 然而, 在某些情况下这是不现实的: 比如你的 API 暴露了大量的方法, 将他们全都复制一遍也许是不可行的.\n\n`net/http` 包选择 `context-in-struct` 的方式, 它为我们提供了一个有用的案例来学习. 我们来看看 `net/http` 的 Do 方法. 在引入 context.Context 之前, Do 方法是这样定义的:\n\n```go\nfunc (c *Client) Do(req *Request) (*Response, error)\n```\n\n在 Go 1.7 之后, 如果不是为了保证向后兼容, Do 方法可能会是这样:\n\n```go\nfunc (c *Client) Do(ctx context.Context, req *Request) (*Response, error)\n```\n\n但是! 确保向后兼容及秉持 [Go 1 promise of compatibility](https://golang.org/doc/go1compat), 对于标准库来说, 是至关重要的. 因此, 维护人员选择了将 context.Context 添加到 `http.Request` struct 中, 来实现 context.Context 的支持, 而不破坏兼容性:\n\n```go\ntype Request struct {\n  ctx context.Context\n\n  // ...\n}\n\nfunc NewRequestWithContext(ctx context.Context, method, url string, body io.Reader) (*Request, error) {\n  // Simplified for brevity of this article.\n  return &Request{\n    ctx: ctx,\n    // ...\n  }\n}\n\nfunc (c *Client) Do(req *Request) (*Response, error)\n```\n\n由此看来, 在改造 API 支持 context 时, 将 context.Context 添加到 struct 里也可以是合理的. 然而, 要记住首选仍然是复制方法, 它既可以保证 context.Context 的兼容性, 也不会牺牲通用性和可读性. 例如:\n\n```go\nfunc (c *Client) Call() error {\n  return c.CallContext(context.Background())\n}\n\nfunc (c *Client) CallContext(ctx context.Context) error {\n  // ...\n}\n```\n\n### Conclusion\n\nContext 让跨库 / 垮 API 传播重要信息到调用栈变得容易.但也须要做到贯彻到底和条理清晰, 来保证可读性, 方便debug, 和有效性.\n\n当 Context 用作第一个参数, 而不是存储在 struct 时, 用户可以利用其扩展性构建强大的 cancelation, deadline, 和 metadata 调用栈. 同时, 最棒的是, 当 Context 用作第一个参数传递时, 其作用域是能被充分理解的, 这让整个调用栈都具有可读性和易调试性的.\n\n当在设计一个包含 context 的 API 时, 记住这个建议:\n\n> pass context.Context in as an argument; don't store it in structs.\n","source":"_posts/2021-04-21-Go-Blog-翻译-Context-and-Structs.md","raw":"---\ntitle: 'Go Blog 翻译: Context and Structs'\ndate: 2021-04-21 17:10:54\ncategories:\n- [翻译]\n- [笔记]\ntags:\n- golang\n---\n\n## Context and Structs\n\n原文地址: https://blog.golang.org/context-and-structs\n\n作者: Jean de Klerk, Matt T. Proud\n\n时间: 24 February 2021\n\n### Introduction\n\n在许多尤其是现代的 Go API 中, function 或 method 的第一个参数常常是 [context.Context](https://golang.org/pkg/context/). Context 为传输提供了 deadline, 为调用方提供了 cancellation, 也为其他进程间跨 API 请求提供了传值手段. 它常常被间接或直接使用了远程服务的库所使用, 例如数据库, API 等.\n\n[Context 文档](https://golang.org/pkg/context/) 所述:\n\n> Context 不应存储在 struct 内部, 而应传给需要它的 function.\n\n这篇文章就是针对上述建议的详述, 通过举例说明的方式来阐述为什么要传递 Context 而不是存储在另一个 type 里. 本文也强调了一种边缘情况: 将 Context 存储在 struct 中也是合理的. 以及如何安全实现.\n\n<!-- more -->\n\n### Prefer contexts passed as arguments\n\n要理解这个建议: **不要把 Context 存储在 struct 中**. 我们先看看建议的方式下写的代码:\n\n```go\ntype Worker struct { /* … */ }\n\ntype Work struct { /* … */ }\n\nfunc New() *Worker {\n  return &Worker{}\n}\n\nfunc (w *Worker) Fetch(ctx context.Context) (*Work, error) {\n  _ = ctx // A per-call ctx is used for cancellation, deadlines, and metadata.\n}\n\nfunc (w *Worker) Process(ctx context.Context, work *Work) error {\n  _ = ctx // A per-call ctx is used for cancellation, deadlines, and metadata.\n}\n```\n\n`(*Worker).Fetch` 和 `(*Worker).Process` 两个方法都直接接受 context 参数. 在 `pass-as-argument` 的设计下, 用户可以对每次调用设置 `deadlines`, `cancellation`, 和 `metadata`. 而且, `context.Context` 传到每个方法的方式是很清晰的, 不用去担心 `context.Context` 会不会在其他方法中用到. 这是因为 `context` 被划定为了操作所需的最小粒度, 这极大地增强了包中 context 的实用性和清晰度.\n\n### Storing context in structs leads to confusion\n\n我们再来用 *不推荐* 的 `context-in-struct` 方式来审视下代码. 这问题在于, 当你把 context 存储在 struct 里, 调用方就无法看清楚 context 的生命周期, 情况得不可预测:\n\n```go\ntype Worker struct {\n  ctx context.Context\n}\n\nfunc New(ctx context.Context) *Worker {\n  return &Worker{ctx: ctx}\n}\n\nfunc (w *Worker) Fetch() (*Work, error) {\n  _ = w.ctx // A shared w.ctx is used for cancellation, deadlines, and metadata.\n}\n\nfunc (w *Worker) Process(work *Work) error {\n  _ = w.ctx // A shared w.ctx is used for cancellation, deadlines, and metadata.\n}\n```\n\n`(*Worker).Fetch` 和 `(*Worker).Process` 方法都使用了存储在 Worker 里的 context. 这阻碍了 Fetch 和 Process 调用方 (可能他们拥有各自不同的 context) 在每次调用时的基本操作: 指定 deadline, 请求 cancellation 以及附加 metadata. 例如: 用户无法仅为 `(*Worker).Fetch` 提供 deadline, 也无法仅为 `(*Worker).Process` 提供 cancel. 因为context是共享的, 所以调用方的生命周期是虚实夹杂的, 并且当 Worker 被创建时, context 就会被作用于整个生命周期.\n\n相比 `pass-as-argument` 方式, 用户会对这个 API 感到很疑惑, 心想:\n\n- New 方法会被传入 context.Context, 那这个构造方法在执行时会需要 cancelation 或 deadlines 吗?\n- 在 New 方法中传入的 context.Context 会被 `(*Worker).Fetch` 和 `(*Worker).Process` 方法使用吗? 两个方法都不会用到? 还是说有方法会用到?\n\n这个 API 也需要有大量的文档来明确地告诉用户, context.Context 具体是用来干什么的. 用户也不得不读源码而不能依赖 API 所传达的结构.\n\n而且, 这可能是很危险的, 将这样的设计方式运用在生产级别的服务器上. 因为如果不是每个请求都有一个 context, 就不能充分地\"尊重\" cancellation. 不能对每次调用设置 deadline, 你的进程可能会堆积和耗尽其资源 (比如 内存)!\n\n### Exception to the rule: preserving backwards compatibility\n\n当 Go 1.7 [带着 context.Context](https://golang.org/doc/go1.7) 发布后, 大量的 API 需要以向后兼容的方式添加 context 支持. 例如: [net/http 中 Client 方法](https://golang.org/pkg/net/http/), 像 Get 和 Do, 就是 context 极佳的候选者. 通过这些方法所发出的外部请求都会受益于由 `context.Context` 带来的 deadline, cancellation, 和 metadata 的支持.\n\n有两种方式来添加向后兼容的 `context.Context` 支持: 一种是将 context 定义在 struct 里 (context-in-struct), 另一种, 正如我们所见, 是复制函数来接收 context.Context 参数, 并将 Context 作为新函数的名后缀. 复制函数的方式相比 context-in-struct 更好, 更深入的讨论详见 [Keeping your modules compatible](https://blog.golang.org/module-compatibility). 然而, 在某些情况下这是不现实的: 比如你的 API 暴露了大量的方法, 将他们全都复制一遍也许是不可行的.\n\n`net/http` 包选择 `context-in-struct` 的方式, 它为我们提供了一个有用的案例来学习. 我们来看看 `net/http` 的 Do 方法. 在引入 context.Context 之前, Do 方法是这样定义的:\n\n```go\nfunc (c *Client) Do(req *Request) (*Response, error)\n```\n\n在 Go 1.7 之后, 如果不是为了保证向后兼容, Do 方法可能会是这样:\n\n```go\nfunc (c *Client) Do(ctx context.Context, req *Request) (*Response, error)\n```\n\n但是! 确保向后兼容及秉持 [Go 1 promise of compatibility](https://golang.org/doc/go1compat), 对于标准库来说, 是至关重要的. 因此, 维护人员选择了将 context.Context 添加到 `http.Request` struct 中, 来实现 context.Context 的支持, 而不破坏兼容性:\n\n```go\ntype Request struct {\n  ctx context.Context\n\n  // ...\n}\n\nfunc NewRequestWithContext(ctx context.Context, method, url string, body io.Reader) (*Request, error) {\n  // Simplified for brevity of this article.\n  return &Request{\n    ctx: ctx,\n    // ...\n  }\n}\n\nfunc (c *Client) Do(req *Request) (*Response, error)\n```\n\n由此看来, 在改造 API 支持 context 时, 将 context.Context 添加到 struct 里也可以是合理的. 然而, 要记住首选仍然是复制方法, 它既可以保证 context.Context 的兼容性, 也不会牺牲通用性和可读性. 例如:\n\n```go\nfunc (c *Client) Call() error {\n  return c.CallContext(context.Background())\n}\n\nfunc (c *Client) CallContext(ctx context.Context) error {\n  // ...\n}\n```\n\n### Conclusion\n\nContext 让跨库 / 垮 API 传播重要信息到调用栈变得容易.但也须要做到贯彻到底和条理清晰, 来保证可读性, 方便debug, 和有效性.\n\n当 Context 用作第一个参数, 而不是存储在 struct 时, 用户可以利用其扩展性构建强大的 cancelation, deadline, 和 metadata 调用栈. 同时, 最棒的是, 当 Context 用作第一个参数传递时, 其作用域是能被充分理解的, 这让整个调用栈都具有可读性和易调试性的.\n\n当在设计一个包含 context 的 API 时, 记住这个建议:\n\n> pass context.Context in as an argument; don't store it in structs.\n","slug":"Go-Blog-翻译-Context-and-Structs","published":1,"updated":"2023-05-28T05:36:04.286Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1jd000uiubfyqe13gdx","content":"<h2 id=\"Context-and-Structs\"><a href=\"#Context-and-Structs\" class=\"headerlink\" title=\"Context and Structs\"></a>Context and Structs</h2><p>原文地址: <a href=\"https://blog.golang.org/context-and-structs\" target=\"_blank\" rel=\"noopener\">https://blog.golang.org/context-and-structs</a></p><p>作者: Jean de Klerk, Matt T. Proud</p><p>时间: 24 February 2021</p><h3 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a>Introduction</h3><p>在许多尤其是现代的 Go API 中, function 或 method 的第一个参数常常是 <a href=\"https://golang.org/pkg/context/\" target=\"_blank\" rel=\"noopener\">context.Context</a>. Context 为传输提供了 deadline, 为调用方提供了 cancellation, 也为其他进程间跨 API 请求提供了传值手段. 它常常被间接或直接使用了远程服务的库所使用, 例如数据库, API 等.</p><p><a href=\"https://golang.org/pkg/context/\" target=\"_blank\" rel=\"noopener\">Context 文档</a> 所述:</p><blockquote><p>Context 不应存储在 struct 内部, 而应传给需要它的 function.</p></blockquote><p>这篇文章就是针对上述建议的详述, 通过举例说明的方式来阐述为什么要传递 Context 而不是存储在另一个 type 里. 本文也强调了一种边缘情况: 将 Context 存储在 struct 中也是合理的. 以及如何安全实现.</p><a id=\"more\"></a><h3 id=\"Prefer-contexts-passed-as-arguments\"><a href=\"#Prefer-contexts-passed-as-arguments\" class=\"headerlink\" title=\"Prefer contexts passed as arguments\"></a>Prefer contexts passed as arguments</h3><p>要理解这个建议: <strong>不要把 Context 存储在 struct 中</strong>. 我们先看看建议的方式下写的代码:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Worker <span class=\"keyword\">struct</span> &#123; <span class=\"comment\">/* … */</span> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> Work <span class=\"keyword\">struct</span> &#123; <span class=\"comment\">/* … */</span> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">New</span><span class=\"params\">()</span> *<span class=\"title\">Worker</span></span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &amp;Worker&#123;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(w *Worker)</span> <span class=\"title\">Fetch</span><span class=\"params\">(ctx context.Context)</span> <span class=\"params\">(*Work, error)</span></span> &#123;</span><br><span class=\"line\">  _ = ctx <span class=\"comment\">// A per-call ctx is used for cancellation, deadlines, and metadata.</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(w *Worker)</span> <span class=\"title\">Process</span><span class=\"params\">(ctx context.Context, work *Work)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">  _ = ctx <span class=\"comment\">// A per-call ctx is used for cancellation, deadlines, and metadata.</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p><code>(*Worker).Fetch</code> 和 <code>(*Worker).Process</code> 两个方法都直接接受 context 参数. 在 <code>pass-as-argument</code> 的设计下, 用户可以对每次调用设置 <code>deadlines</code>, <code>cancellation</code>, 和 <code>metadata</code>. 而且, <code>context.Context</code> 传到每个方法的方式是很清晰的, 不用去担心 <code>context.Context</code> 会不会在其他方法中用到. 这是因为 <code>context</code> 被划定为了操作所需的最小粒度, 这极大地增强了包中 context 的实用性和清晰度.</p><h3 id=\"Storing-context-in-structs-leads-to-confusion\"><a href=\"#Storing-context-in-structs-leads-to-confusion\" class=\"headerlink\" title=\"Storing context in structs leads to confusion\"></a>Storing context in structs leads to confusion</h3><p>我们再来用 <em>不推荐</em> 的 <code>context-in-struct</code> 方式来审视下代码. 这问题在于, 当你把 context 存储在 struct 里, 调用方就无法看清楚 context 的生命周期, 情况得不可预测:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Worker <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">  ctx context.Context</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">New</span><span class=\"params\">(ctx context.Context)</span> *<span class=\"title\">Worker</span></span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &amp;Worker&#123;ctx: ctx&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(w *Worker)</span> <span class=\"title\">Fetch</span><span class=\"params\">()</span> <span class=\"params\">(*Work, error)</span></span> &#123;</span><br><span class=\"line\">  _ = w.ctx <span class=\"comment\">// A shared w.ctx is used for cancellation, deadlines, and metadata.</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(w *Worker)</span> <span class=\"title\">Process</span><span class=\"params\">(work *Work)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">  _ = w.ctx <span class=\"comment\">// A shared w.ctx is used for cancellation, deadlines, and metadata.</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p><code>(*Worker).Fetch</code> 和 <code>(*Worker).Process</code> 方法都使用了存储在 Worker 里的 context. 这阻碍了 Fetch 和 Process 调用方 (可能他们拥有各自不同的 context) 在每次调用时的基本操作: 指定 deadline, 请求 cancellation 以及附加 metadata. 例如: 用户无法仅为 <code>(*Worker).Fetch</code> 提供 deadline, 也无法仅为 <code>(*Worker).Process</code> 提供 cancel. 因为context是共享的, 所以调用方的生命周期是虚实夹杂的, 并且当 Worker 被创建时, context 就会被作用于整个生命周期.</p><p>相比 <code>pass-as-argument</code> 方式, 用户会对这个 API 感到很疑惑, 心想:</p><ul><li>New 方法会被传入 context.Context, 那这个构造方法在执行时会需要 cancelation 或 deadlines 吗?</li><li>在 New 方法中传入的 context.Context 会被 <code>(*Worker).Fetch</code> 和 <code>(*Worker).Process</code> 方法使用吗? 两个方法都不会用到? 还是说有方法会用到?</li></ul><p>这个 API 也需要有大量的文档来明确地告诉用户, context.Context 具体是用来干什么的. 用户也不得不读源码而不能依赖 API 所传达的结构.</p><p>而且, 这可能是很危险的, 将这样的设计方式运用在生产级别的服务器上. 因为如果不是每个请求都有一个 context, 就不能充分地&quot;尊重&quot; cancellation. 不能对每次调用设置 deadline, 你的进程可能会堆积和耗尽其资源 (比如 内存)!</p><h3 id=\"Exception-to-the-rule-preserving-backwards-compatibility\"><a href=\"#Exception-to-the-rule-preserving-backwards-compatibility\" class=\"headerlink\" title=\"Exception to the rule: preserving backwards compatibility\"></a>Exception to the rule: preserving backwards compatibility</h3><p>当 Go 1.7 <a href=\"https://golang.org/doc/go1.7\" target=\"_blank\" rel=\"noopener\">带着 context.Context</a> 发布后, 大量的 API 需要以向后兼容的方式添加 context 支持. 例如: <a href=\"https://golang.org/pkg/net/http/\" target=\"_blank\" rel=\"noopener\">net/http 中 Client 方法</a>, 像 Get 和 Do, 就是 context 极佳的候选者. 通过这些方法所发出的外部请求都会受益于由 <code>context.Context</code> 带来的 deadline, cancellation, 和 metadata 的支持.</p><p>有两种方式来添加向后兼容的 <code>context.Context</code> 支持: 一种是将 context 定义在 struct 里 (context-in-struct), 另一种, 正如我们所见, 是复制函数来接收 context.Context 参数, 并将 Context 作为新函数的名后缀. 复制函数的方式相比 context-in-struct 更好, 更深入的讨论详见 <a href=\"https://blog.golang.org/module-compatibility\" target=\"_blank\" rel=\"noopener\">Keeping your modules compatible</a>. 然而, 在某些情况下这是不现实的: 比如你的 API 暴露了大量的方法, 将他们全都复制一遍也许是不可行的.</p><p><code>net/http</code> 包选择 <code>context-in-struct</code> 的方式, 它为我们提供了一个有用的案例来学习. 我们来看看 <code>net/http</code> 的 Do 方法. 在引入 context.Context 之前, Do 方法是这样定义的:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">Do</span><span class=\"params\">(req *Request)</span> <span class=\"params\">(*Response, error)</span></span></span><br></pre></td></tr></table></figure><p>在 Go 1.7 之后, 如果不是为了保证向后兼容, Do 方法可能会是这样:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">Do</span><span class=\"params\">(ctx context.Context, req *Request)</span> <span class=\"params\">(*Response, error)</span></span></span><br></pre></td></tr></table></figure><p>但是! 确保向后兼容及秉持 <a href=\"https://golang.org/doc/go1compat\" target=\"_blank\" rel=\"noopener\">Go 1 promise of compatibility</a>, 对于标准库来说, 是至关重要的. 因此, 维护人员选择了将 context.Context 添加到 <code>http.Request</code> struct 中, 来实现 context.Context 的支持, 而不破坏兼容性:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Request <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">  ctx context.Context</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewRequestWithContext</span><span class=\"params\">(ctx context.Context, method, url <span class=\"keyword\">string</span>, body io.Reader)</span> <span class=\"params\">(*Request, error)</span></span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// Simplified for brevity of this article.</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &amp;Request&#123;</span><br><span class=\"line\">    ctx: ctx,</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">Do</span><span class=\"params\">(req *Request)</span> <span class=\"params\">(*Response, error)</span></span></span><br></pre></td></tr></table></figure><p>由此看来, 在改造 API 支持 context 时, 将 context.Context 添加到 struct 里也可以是合理的. 然而, 要记住首选仍然是复制方法, 它既可以保证 context.Context 的兼容性, 也不会牺牲通用性和可读性. 例如:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">Call</span><span class=\"params\">()</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> c.CallContext(context.Background())</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">CallContext</span><span class=\"params\">(ctx context.Context)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><h3 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h3><p>Context 让跨库 / 垮 API 传播重要信息到调用栈变得容易.但也须要做到贯彻到底和条理清晰, 来保证可读性, 方便debug, 和有效性.</p><p>当 Context 用作第一个参数, 而不是存储在 struct 时, 用户可以利用其扩展性构建强大的 cancelation, deadline, 和 metadata 调用栈. 同时, 最棒的是, 当 Context 用作第一个参数传递时, 其作用域是能被充分理解的, 这让整个调用栈都具有可读性和易调试性的.</p><p>当在设计一个包含 context 的 API 时, 记住这个建议:</p><blockquote><p>pass context.Context in as an argument; don&#39;t store it in structs.</p></blockquote>","site":{"data":{}},"excerpt":"<h2 id=\"Context-and-Structs\"><a href=\"#Context-and-Structs\" class=\"headerlink\" title=\"Context and Structs\"></a>Context and Structs</h2><p>原文地址: <a href=\"https://blog.golang.org/context-and-structs\" target=\"_blank\" rel=\"noopener\">https://blog.golang.org/context-and-structs</a></p><p>作者: Jean de Klerk, Matt T. Proud</p><p>时间: 24 February 2021</p><h3 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a>Introduction</h3><p>在许多尤其是现代的 Go API 中, function 或 method 的第一个参数常常是 <a href=\"https://golang.org/pkg/context/\" target=\"_blank\" rel=\"noopener\">context.Context</a>. Context 为传输提供了 deadline, 为调用方提供了 cancellation, 也为其他进程间跨 API 请求提供了传值手段. 它常常被间接或直接使用了远程服务的库所使用, 例如数据库, API 等.</p><p><a href=\"https://golang.org/pkg/context/\" target=\"_blank\" rel=\"noopener\">Context 文档</a> 所述:</p><blockquote><p>Context 不应存储在 struct 内部, 而应传给需要它的 function.</p></blockquote><p>这篇文章就是针对上述建议的详述, 通过举例说明的方式来阐述为什么要传递 Context 而不是存储在另一个 type 里. 本文也强调了一种边缘情况: 将 Context 存储在 struct 中也是合理的. 以及如何安全实现.</p>","more":"<h3 id=\"Prefer-contexts-passed-as-arguments\"><a href=\"#Prefer-contexts-passed-as-arguments\" class=\"headerlink\" title=\"Prefer contexts passed as arguments\"></a>Prefer contexts passed as arguments</h3><p>要理解这个建议: <strong>不要把 Context 存储在 struct 中</strong>. 我们先看看建议的方式下写的代码:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Worker <span class=\"keyword\">struct</span> &#123; <span class=\"comment\">/* … */</span> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> Work <span class=\"keyword\">struct</span> &#123; <span class=\"comment\">/* … */</span> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">New</span><span class=\"params\">()</span> *<span class=\"title\">Worker</span></span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &amp;Worker&#123;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(w *Worker)</span> <span class=\"title\">Fetch</span><span class=\"params\">(ctx context.Context)</span> <span class=\"params\">(*Work, error)</span></span> &#123;</span><br><span class=\"line\">  _ = ctx <span class=\"comment\">// A per-call ctx is used for cancellation, deadlines, and metadata.</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(w *Worker)</span> <span class=\"title\">Process</span><span class=\"params\">(ctx context.Context, work *Work)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">  _ = ctx <span class=\"comment\">// A per-call ctx is used for cancellation, deadlines, and metadata.</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p><code>(*Worker).Fetch</code> 和 <code>(*Worker).Process</code> 两个方法都直接接受 context 参数. 在 <code>pass-as-argument</code> 的设计下, 用户可以对每次调用设置 <code>deadlines</code>, <code>cancellation</code>, 和 <code>metadata</code>. 而且, <code>context.Context</code> 传到每个方法的方式是很清晰的, 不用去担心 <code>context.Context</code> 会不会在其他方法中用到. 这是因为 <code>context</code> 被划定为了操作所需的最小粒度, 这极大地增强了包中 context 的实用性和清晰度.</p><h3 id=\"Storing-context-in-structs-leads-to-confusion\"><a href=\"#Storing-context-in-structs-leads-to-confusion\" class=\"headerlink\" title=\"Storing context in structs leads to confusion\"></a>Storing context in structs leads to confusion</h3><p>我们再来用 <em>不推荐</em> 的 <code>context-in-struct</code> 方式来审视下代码. 这问题在于, 当你把 context 存储在 struct 里, 调用方就无法看清楚 context 的生命周期, 情况得不可预测:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Worker <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">  ctx context.Context</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">New</span><span class=\"params\">(ctx context.Context)</span> *<span class=\"title\">Worker</span></span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> &amp;Worker&#123;ctx: ctx&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(w *Worker)</span> <span class=\"title\">Fetch</span><span class=\"params\">()</span> <span class=\"params\">(*Work, error)</span></span> &#123;</span><br><span class=\"line\">  _ = w.ctx <span class=\"comment\">// A shared w.ctx is used for cancellation, deadlines, and metadata.</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(w *Worker)</span> <span class=\"title\">Process</span><span class=\"params\">(work *Work)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">  _ = w.ctx <span class=\"comment\">// A shared w.ctx is used for cancellation, deadlines, and metadata.</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p><code>(*Worker).Fetch</code> 和 <code>(*Worker).Process</code> 方法都使用了存储在 Worker 里的 context. 这阻碍了 Fetch 和 Process 调用方 (可能他们拥有各自不同的 context) 在每次调用时的基本操作: 指定 deadline, 请求 cancellation 以及附加 metadata. 例如: 用户无法仅为 <code>(*Worker).Fetch</code> 提供 deadline, 也无法仅为 <code>(*Worker).Process</code> 提供 cancel. 因为context是共享的, 所以调用方的生命周期是虚实夹杂的, 并且当 Worker 被创建时, context 就会被作用于整个生命周期.</p><p>相比 <code>pass-as-argument</code> 方式, 用户会对这个 API 感到很疑惑, 心想:</p><ul><li>New 方法会被传入 context.Context, 那这个构造方法在执行时会需要 cancelation 或 deadlines 吗?</li><li>在 New 方法中传入的 context.Context 会被 <code>(*Worker).Fetch</code> 和 <code>(*Worker).Process</code> 方法使用吗? 两个方法都不会用到? 还是说有方法会用到?</li></ul><p>这个 API 也需要有大量的文档来明确地告诉用户, context.Context 具体是用来干什么的. 用户也不得不读源码而不能依赖 API 所传达的结构.</p><p>而且, 这可能是很危险的, 将这样的设计方式运用在生产级别的服务器上. 因为如果不是每个请求都有一个 context, 就不能充分地&quot;尊重&quot; cancellation. 不能对每次调用设置 deadline, 你的进程可能会堆积和耗尽其资源 (比如 内存)!</p><h3 id=\"Exception-to-the-rule-preserving-backwards-compatibility\"><a href=\"#Exception-to-the-rule-preserving-backwards-compatibility\" class=\"headerlink\" title=\"Exception to the rule: preserving backwards compatibility\"></a>Exception to the rule: preserving backwards compatibility</h3><p>当 Go 1.7 <a href=\"https://golang.org/doc/go1.7\" target=\"_blank\" rel=\"noopener\">带着 context.Context</a> 发布后, 大量的 API 需要以向后兼容的方式添加 context 支持. 例如: <a href=\"https://golang.org/pkg/net/http/\" target=\"_blank\" rel=\"noopener\">net/http 中 Client 方法</a>, 像 Get 和 Do, 就是 context 极佳的候选者. 通过这些方法所发出的外部请求都会受益于由 <code>context.Context</code> 带来的 deadline, cancellation, 和 metadata 的支持.</p><p>有两种方式来添加向后兼容的 <code>context.Context</code> 支持: 一种是将 context 定义在 struct 里 (context-in-struct), 另一种, 正如我们所见, 是复制函数来接收 context.Context 参数, 并将 Context 作为新函数的名后缀. 复制函数的方式相比 context-in-struct 更好, 更深入的讨论详见 <a href=\"https://blog.golang.org/module-compatibility\" target=\"_blank\" rel=\"noopener\">Keeping your modules compatible</a>. 然而, 在某些情况下这是不现实的: 比如你的 API 暴露了大量的方法, 将他们全都复制一遍也许是不可行的.</p><p><code>net/http</code> 包选择 <code>context-in-struct</code> 的方式, 它为我们提供了一个有用的案例来学习. 我们来看看 <code>net/http</code> 的 Do 方法. 在引入 context.Context 之前, Do 方法是这样定义的:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">Do</span><span class=\"params\">(req *Request)</span> <span class=\"params\">(*Response, error)</span></span></span><br></pre></td></tr></table></figure><p>在 Go 1.7 之后, 如果不是为了保证向后兼容, Do 方法可能会是这样:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">Do</span><span class=\"params\">(ctx context.Context, req *Request)</span> <span class=\"params\">(*Response, error)</span></span></span><br></pre></td></tr></table></figure><p>但是! 确保向后兼容及秉持 <a href=\"https://golang.org/doc/go1compat\" target=\"_blank\" rel=\"noopener\">Go 1 promise of compatibility</a>, 对于标准库来说, 是至关重要的. 因此, 维护人员选择了将 context.Context 添加到 <code>http.Request</code> struct 中, 来实现 context.Context 的支持, 而不破坏兼容性:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Request <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">  ctx context.Context</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewRequestWithContext</span><span class=\"params\">(ctx context.Context, method, url <span class=\"keyword\">string</span>, body io.Reader)</span> <span class=\"params\">(*Request, error)</span></span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// Simplified for brevity of this article.</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> &amp;Request&#123;</span><br><span class=\"line\">    ctx: ctx,</span><br><span class=\"line\">    <span class=\"comment\">// ...</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">Do</span><span class=\"params\">(req *Request)</span> <span class=\"params\">(*Response, error)</span></span></span><br></pre></td></tr></table></figure><p>由此看来, 在改造 API 支持 context 时, 将 context.Context 添加到 struct 里也可以是合理的. 然而, 要记住首选仍然是复制方法, 它既可以保证 context.Context 的兼容性, 也不会牺牲通用性和可读性. 例如:</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">Call</span><span class=\"params\">()</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> c.CallContext(context.Background())</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(c *Client)</span> <span class=\"title\">CallContext</span><span class=\"params\">(ctx context.Context)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// ...</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><h3 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h3><p>Context 让跨库 / 垮 API 传播重要信息到调用栈变得容易.但也须要做到贯彻到底和条理清晰, 来保证可读性, 方便debug, 和有效性.</p><p>当 Context 用作第一个参数, 而不是存储在 struct 时, 用户可以利用其扩展性构建强大的 cancelation, deadline, 和 metadata 调用栈. 同时, 最棒的是, 当 Context 用作第一个参数传递时, 其作用域是能被充分理解的, 这让整个调用栈都具有可读性和易调试性的.</p><p>当在设计一个包含 context 的 API 时, 记住这个建议:</p><blockquote><p>pass context.Context in as an argument; don&#39;t store it in structs.</p></blockquote>"},{"title":"git commit message standard","date":"2021-09-22T07:41:33.000Z","_content":"\n回首这些年工作和业余时间的 git 使用，发现在提交内容时，写的 commit message 其实并没有做到统一和规范化。\n于是抽空去 Google 了一番，发现有不少的开源项目在使用一种语义化的提交。\n这种语义化的提交能够做到足够简短且开门见山。\n看过之后确实也是受益匪浅，故在此记录。\n\nhttps://gist.github.com/joshbuchea/6f47e86d2510bce28f8e7f42ae84c716 。\n这是一个拥有 2k+ star 的 gist，里面陈述着语义化提交的基本范式。\n下面是我个人对这套规范的理解。\n\n## 语义化的提交\n\n来看看这个提交信息的小小改动，能对你的程序带来多少益处吧。\n\n格式: `<type>(<scope>): <subject>`，其中 `<scope>` 是非必要的。\n\n```sh\ngit commit -m \"feat: add hat wobble\"\n               ^--^  ^------------^\n               |     |\n               |     +-> 总结内容(subject)，注意是用现在时态\n               |\n               +-------> 类型(type): chore, docs, feat, fix, refactor, style, test\n```\n\n### 不同类型(type)的语义\n\n| Type       | 语义                                                    |\n| ---------- | ------------------------------------------------------- |\n| `feat`     | 针对用户侧的新特性。是对外的而非对内的                  |\n| `fix`      | 针对用户侧的 bug 修复。是对外的而非对内的               |\n| `docs`     | 仅文档内容的变更                                        |\n| `style`    | 仅格式化相关，比如行尾的分号(;)，空格等。不影响线上使用 |\n| `refactor` | 重构功能代码，如重命名变量，抽象方法等                  |\n| `test`     | 添加或重构单元测试。不影响线上使用                      |\n| `chore`    | 更新 CI/CD 流程、任务或脚本。不影响线上使用             |\n","source":"_posts/2021-09-22-git-commit-message-standard.md","raw":"---\ntitle: git commit message standard\ndate: 2021-09-22 15:41:33\ncategories:\n- 笔记\ntags:\n- git\n---\n\n回首这些年工作和业余时间的 git 使用，发现在提交内容时，写的 commit message 其实并没有做到统一和规范化。\n于是抽空去 Google 了一番，发现有不少的开源项目在使用一种语义化的提交。\n这种语义化的提交能够做到足够简短且开门见山。\n看过之后确实也是受益匪浅，故在此记录。\n\nhttps://gist.github.com/joshbuchea/6f47e86d2510bce28f8e7f42ae84c716 。\n这是一个拥有 2k+ star 的 gist，里面陈述着语义化提交的基本范式。\n下面是我个人对这套规范的理解。\n\n## 语义化的提交\n\n来看看这个提交信息的小小改动，能对你的程序带来多少益处吧。\n\n格式: `<type>(<scope>): <subject>`，其中 `<scope>` 是非必要的。\n\n```sh\ngit commit -m \"feat: add hat wobble\"\n               ^--^  ^------------^\n               |     |\n               |     +-> 总结内容(subject)，注意是用现在时态\n               |\n               +-------> 类型(type): chore, docs, feat, fix, refactor, style, test\n```\n\n### 不同类型(type)的语义\n\n| Type       | 语义                                                    |\n| ---------- | ------------------------------------------------------- |\n| `feat`     | 针对用户侧的新特性。是对外的而非对内的                  |\n| `fix`      | 针对用户侧的 bug 修复。是对外的而非对内的               |\n| `docs`     | 仅文档内容的变更                                        |\n| `style`    | 仅格式化相关，比如行尾的分号(;)，空格等。不影响线上使用 |\n| `refactor` | 重构功能代码，如重命名变量，抽象方法等                  |\n| `test`     | 添加或重构单元测试。不影响线上使用                      |\n| `chore`    | 更新 CI/CD 流程、任务或脚本。不影响线上使用             |\n","slug":"git-commit-message-standard","published":1,"updated":"2023-05-28T05:36:04.286Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1je000viubfjqrn7h9g","content":"<p>回首这些年工作和业余时间的 git 使用，发现在提交内容时，写的 commit message 其实并没有做到统一和规范化。 于是抽空去 Google 了一番，发现有不少的开源项目在使用一种语义化的提交。 这种语义化的提交能够做到足够简短且开门见山。 看过之后确实也是受益匪浅，故在此记录。</p><p><a href=\"https://gist.github.com/joshbuchea/6f47e86d2510bce28f8e7f42ae84c716\" target=\"_blank\" rel=\"noopener\">https://gist.github.com/joshbuchea/6f47e86d2510bce28f8e7f42ae84c716</a> 。 这是一个拥有 2k+ star 的 gist，里面陈述着语义化提交的基本范式。 下面是我个人对这套规范的理解。</p><h2 id=\"语义化的提交\"><a href=\"#语义化的提交\" class=\"headerlink\" title=\"语义化的提交\"></a>语义化的提交</h2><p>来看看这个提交信息的小小改动，能对你的程序带来多少益处吧。</p><p>格式: <code>&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;</code>，其中 <code>&lt;scope&gt;</code> 是非必要的。</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git commit -m <span class=\"string\">\"feat: add hat wobble\"</span></span><br><span class=\"line\">               ^--^  ^------------^</span><br><span class=\"line\">               |     |</span><br><span class=\"line\">               |     +-&gt; 总结内容(subject)，注意是用现在时态</span><br><span class=\"line\">               |</span><br><span class=\"line\">               +-------&gt; 类型(<span class=\"built_in\">type</span>): chore, docs, feat, fix, refactor, style, <span class=\"built_in\">test</span></span><br></pre></td></tr></table></figure><h3 id=\"不同类型-type-的语义\"><a href=\"#不同类型-type-的语义\" class=\"headerlink\" title=\"不同类型(type)的语义\"></a>不同类型(type)的语义</h3><table><thead><tr><th>Type</th><th>语义</th></tr></thead><tbody><tr><td><code>feat</code></td><td>针对用户侧的新特性。是对外的而非对内的</td></tr><tr><td><code>fix</code></td><td>针对用户侧的 bug 修复。是对外的而非对内的</td></tr><tr><td><code>docs</code></td><td>仅文档内容的变更</td></tr><tr><td><code>style</code></td><td>仅格式化相关，比如行尾的分号(;)，空格等。不影响线上使用</td></tr><tr><td><code>refactor</code></td><td>重构功能代码，如重命名变量，抽象方法等</td></tr><tr><td><code>test</code></td><td>添加或重构单元测试。不影响线上使用</td></tr><tr><td><code>chore</code></td><td>更新 CI/CD 流程、任务或脚本。不影响线上使用</td></tr></tbody></table>","site":{"data":{}},"excerpt":"","more":"<p>回首这些年工作和业余时间的 git 使用，发现在提交内容时，写的 commit message 其实并没有做到统一和规范化。 于是抽空去 Google 了一番，发现有不少的开源项目在使用一种语义化的提交。 这种语义化的提交能够做到足够简短且开门见山。 看过之后确实也是受益匪浅，故在此记录。</p><p><a href=\"https://gist.github.com/joshbuchea/6f47e86d2510bce28f8e7f42ae84c716\" target=\"_blank\" rel=\"noopener\">https://gist.github.com/joshbuchea/6f47e86d2510bce28f8e7f42ae84c716</a> 。 这是一个拥有 2k+ star 的 gist，里面陈述着语义化提交的基本范式。 下面是我个人对这套规范的理解。</p><h2 id=\"语义化的提交\"><a href=\"#语义化的提交\" class=\"headerlink\" title=\"语义化的提交\"></a>语义化的提交</h2><p>来看看这个提交信息的小小改动，能对你的程序带来多少益处吧。</p><p>格式: <code>&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;</code>，其中 <code>&lt;scope&gt;</code> 是非必要的。</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git commit -m <span class=\"string\">\"feat: add hat wobble\"</span></span><br><span class=\"line\">               ^--^  ^------------^</span><br><span class=\"line\">               |     |</span><br><span class=\"line\">               |     +-&gt; 总结内容(subject)，注意是用现在时态</span><br><span class=\"line\">               |</span><br><span class=\"line\">               +-------&gt; 类型(<span class=\"built_in\">type</span>): chore, docs, feat, fix, refactor, style, <span class=\"built_in\">test</span></span><br></pre></td></tr></table></figure><h3 id=\"不同类型-type-的语义\"><a href=\"#不同类型-type-的语义\" class=\"headerlink\" title=\"不同类型(type)的语义\"></a>不同类型(type)的语义</h3><table><thead><tr><th>Type</th><th>语义</th></tr></thead><tbody><tr><td><code>feat</code></td><td>针对用户侧的新特性。是对外的而非对内的</td></tr><tr><td><code>fix</code></td><td>针对用户侧的 bug 修复。是对外的而非对内的</td></tr><tr><td><code>docs</code></td><td>仅文档内容的变更</td></tr><tr><td><code>style</code></td><td>仅格式化相关，比如行尾的分号(;)，空格等。不影响线上使用</td></tr><tr><td><code>refactor</code></td><td>重构功能代码，如重命名变量，抽象方法等</td></tr><tr><td><code>test</code></td><td>添加或重构单元测试。不影响线上使用</td></tr><tr><td><code>chore</code></td><td>更新 CI/CD 流程、任务或脚本。不影响线上使用</td></tr></tbody></table>"},{"title":"Drone 1.0 简单实践","date":"2019-06-27T07:05:04.000Z","_content":"本文仅针对 Drone 1.0 版本\n\n由于版本更新无法向下兼容，所有有必要自己从头实践一下。实现目标为：\n\n- 搭建 drone ci 服务器，配置nginx反代，实现https访问\n- 编写 `.drone.yml` 配置文件，实现 golang 项目的自动化部署，包括 build，依赖缓存，二进制发布(rsync)\n\n<!-- more -->\n\n## Drone CI 服务器搭建与访问\n\n我选用的是针对 GitHub 仓库的单机部署。\n根据[官方文档](https://docs.drone.io/installation/github/single-machine/)的说明，先进行 `docker pull drone/drone:1` 将镜像拉下来，然后配置 `docker-compose.yml` (官方只给出了 `docker run` 的启动方式，可能是因为 1.0 版本只需要启动一个容器吧)：\n\n```yml\nversion: '3'\n\nservices:\n  ci:\n    image: drone/drone:1\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock # 宿主机的路径不能变\n      - /var/lib/drone:/data # 宿主机路径可以是别的地方\n    environment:\n      - DRONE_GITHUB_SERVER=https://github.com\n      - DRONE_GITHUB_CLIENT_ID=github的clientID\n      - DRONE_GITHUB_CLIENT_SECRET=github的clientSecret\n      - DRONE_RUNNER_CAPACITY=2\n      - DRONE_USER_CREATE=username:DarthPestilane,admin:true # 指定管理员用户\n      - DRONE_SERVER_HOST=ci.yourhost.com # ci 服务器域名\n      - DRONE_SERVER_PROTO=https\n      - DRONE_TLS_AUTOCERT=true\n      - DRONE_LOGS_DEBUG=true # debug 日志级别\n    ports:\n      - 8004:80 # 将端口暴露出来\n```\n\nDrone CI 容器启动后，我们继续配置 nginx 反代：\n\n```conf\nserver {\n    listen 443 ssl http2;\n    server_name ci.yourhost.com;\n\n    ssl_certificate /path/to/ci.yourhost.com/fullchain.pem;\n    ssl_certificate_key /path/to/ci.yourhost.com/privkey.pem;\n\n    location / {\n        proxy_pass http://172.17.0.1:8004; # 反代到 drone 服务，ip为 docker network bridge\n    }\n}\nserver {\n    # 强制 https\n    listen 80;\n    server_name ci.yourhost.com;\n    return 301 https://ci.yourhost.com$request_uri;\n}\n```\n\n配置完成后，记得先要将域名和证书准备好，然后 restart nginx 容器。此时我们可以通过域名访问Drone CI了。\n\n## 配置 CI (.drone.yml)\n\nDrone 1.0版本的配置文件依然是 `.drone.yml`。我将 CI 步骤分为两步：build 和 deploy。\n\n### Build\n\n最简单的配置：\n\n```yml\nkind: pipeline\nname: drone-test\n\nsteps:\n- name: build\n  image: golang\n  environment:\n    GOOS: linux\n    GOARCH: amd64\n    CGO_ENABLED: 0\n  commands:\n  - go build\n  - go test\n```\n\nCI 服务器会拉取 GitHub 仓库代码，并读取上述配置，然后根据配置执行对应的操作。这里 CI 会执行**类似**下面的命令：\n\n```sh\ndocker run --rm \\\n    --env=GOOS=linux \\\n    # --env=... 其他环境变量 \\\n    --volumes=`pwd`:/drone/src \\\n    --workdir=/drone/src \\ # workdir 也为 /drone/src\n    --entrypoint=build.sh \\\n    golang \\\n    # your commands\n```\n\n在容器内部会执行：\n\n```sh\n#!/bin/sh\nset -e\n\ngo build\ngo test\n```\n\n执行完成后，如果命令不出错，就可以在宿主机上得到编译好的二进制文件。然而如果我的 golang 项目中包含了第三方依赖，按照这样的配置，每次 push 后执行 `go build` 是会重新通过网络下载依赖包的，因为宿主机本地没有保存依赖，以至于 build 时间太长(想想 `npm install` 😱)。\n但了解了 CI 对容器的操作后，这个问题就迎刃而解了。\n\n更新配置：\n\n```yml\n# ...\nsteps:\n- name: build\n  image: golang\n  volumes:\n  - name: cache-go-deps\n    path: /go # 容器内的路径\n  # ...\n#...\n\nvolumes:\n- name: cache-go-deps\n  host:\n    path: /var/local/drone-cache/repo/go-cache # 宿主机的路径\n```\n\n上面的配置中，我将宿主机的路径挂载到了容器内，实现了依赖缓存持久化，后面的 build 过程可以就可以使用依赖缓存了。\n\n### Deploy\n\n实现了自动化 build 后，还需要实现自动化部署，即分发二进制。\n在实际生产中，CI 服务器需要将 build 完成后的项目，发布到生产服务器上，这里我使用 rsync 来发布：\n\n```yml\n# ...\nsteps:\n- name: build\n  # ...\n\n- name: deploy\n  image: drillster/drone-rsync\n  environment:\n    RSYNC_KEY:\n      from_secret: rsync_key\n  settings:\n    user: admin\n    hosts:\n      - \"prod01.host.com\"\n      - \"prod02.host.com\"\n    ports:\n      - 22\n      - 22\n    source: ./\n    target: /var/local/prod/\n    recursive: true\n    delete: true\n    include:\n      - drone-test\n    exclude:\n      - \"**.*\"\n    script:\n      - /var/local/prod/drone-test\n#...\n```\n\n通过上面的配置文件，drone 会将容器中的 `./` 目录（其中的内容和宿主机相同）下的指定文件分别同步到两个生产服务器中的 `/var/local/prod/` 目录中，并登录生产服务器，执行指定的 `scripts`。这些操作的前提是要允许 CI 服务器够通过 `ssh` 的文件秘钥方式登录到生产服务器，那么首先我需要确保 CI 宿主机本身可以登录到生产服务器。\n在CI 宿主机上执行 `ssh-keygen` 命令，生成公钥和私钥(id_rsa, id_rsa.pub)，然后将公钥内容拷贝到生产服务器的 `~/.ssh/authorized_keys` 文件中，这样一来在 CI 宿主机上就可以登录到生产服务器了。然而我最终的目标是要在 Drone CI 的容器中实现 ssh 登录，有个很直接的方法就是直接将宿主机私钥填写在 .drone.yml 配置里，但是这样做太危险了，好在 Drone 1.0 版本可以通过 Web UI 来添加私密信息键值对(key-secret)，于是我在 Web 界面中配置了 `rsync_key`，并将这个名称引用在 `.drone.yml` 中，这样就安全了！\n关于 `drillster/drone-rsync` 镜像的更多配置参数，可以参考它的 [Docs](https://github.com/Drillster/drone-rsync/blob/master/1-DOCS.md)\n\n===\n\n至此，整个 CI 配置已经大部分完成了，再加上一些 git pull 和触发条件的配置(triggers)，整个 `.drone.yml` 看起来是这样的：\n\n```yml\nkind: pipeline\nname: drone-test\n\nclone:\n  depth: 10\n\ntrigger:\n  branch:\n  - master # 只有在master分支的变动，才会触发 CI\n\nsteps:\n- name: build\n  image: golang\n  environment:\n    GOOS: linux\n    GOARCH: amd64\n    CGO_ENABLED: 0\n  volumes:\n  - name: cache-go-deps\n    path: /go # 容器内的路径\n  commands:\n  - go build\n  - go test\n\n- name: deploy\n  image: drillster/drone-rsync\n  environment:\n    RSYNC_KEY:\n      from_secret: rsync_key\n  settings:\n    user: admin\n    hosts:\n      - \"prod01.host.com\"\n      - \"prod02.host.com\"\n    ports:\n      - 22\n      - 22\n    source: ./\n    target: /var/local/prod/\n    recursive: true\n    delete: true\n    include:\n      - drone-test\n    exclude:\n      - \"**.*\"\n    script:\n      - /var/local/prod/drone-test\n\nvolumes:\n- name: cache-go-deps\n  host:\n    path: /var/local/drone-cache/repo/go-cache # 宿主机的路径\n```\n","source":"_posts/2019-06-27-Drone-1.0-简单实践.md","raw":"---\ntitle: Drone 1.0 简单实践\ndate: 2019-06-27 15:05:04\ncategories:\n- 笔记\ntags:\n- CI\n- Drone\n---\n本文仅针对 Drone 1.0 版本\n\n由于版本更新无法向下兼容，所有有必要自己从头实践一下。实现目标为：\n\n- 搭建 drone ci 服务器，配置nginx反代，实现https访问\n- 编写 `.drone.yml` 配置文件，实现 golang 项目的自动化部署，包括 build，依赖缓存，二进制发布(rsync)\n\n<!-- more -->\n\n## Drone CI 服务器搭建与访问\n\n我选用的是针对 GitHub 仓库的单机部署。\n根据[官方文档](https://docs.drone.io/installation/github/single-machine/)的说明，先进行 `docker pull drone/drone:1` 将镜像拉下来，然后配置 `docker-compose.yml` (官方只给出了 `docker run` 的启动方式，可能是因为 1.0 版本只需要启动一个容器吧)：\n\n```yml\nversion: '3'\n\nservices:\n  ci:\n    image: drone/drone:1\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock # 宿主机的路径不能变\n      - /var/lib/drone:/data # 宿主机路径可以是别的地方\n    environment:\n      - DRONE_GITHUB_SERVER=https://github.com\n      - DRONE_GITHUB_CLIENT_ID=github的clientID\n      - DRONE_GITHUB_CLIENT_SECRET=github的clientSecret\n      - DRONE_RUNNER_CAPACITY=2\n      - DRONE_USER_CREATE=username:DarthPestilane,admin:true # 指定管理员用户\n      - DRONE_SERVER_HOST=ci.yourhost.com # ci 服务器域名\n      - DRONE_SERVER_PROTO=https\n      - DRONE_TLS_AUTOCERT=true\n      - DRONE_LOGS_DEBUG=true # debug 日志级别\n    ports:\n      - 8004:80 # 将端口暴露出来\n```\n\nDrone CI 容器启动后，我们继续配置 nginx 反代：\n\n```conf\nserver {\n    listen 443 ssl http2;\n    server_name ci.yourhost.com;\n\n    ssl_certificate /path/to/ci.yourhost.com/fullchain.pem;\n    ssl_certificate_key /path/to/ci.yourhost.com/privkey.pem;\n\n    location / {\n        proxy_pass http://172.17.0.1:8004; # 反代到 drone 服务，ip为 docker network bridge\n    }\n}\nserver {\n    # 强制 https\n    listen 80;\n    server_name ci.yourhost.com;\n    return 301 https://ci.yourhost.com$request_uri;\n}\n```\n\n配置完成后，记得先要将域名和证书准备好，然后 restart nginx 容器。此时我们可以通过域名访问Drone CI了。\n\n## 配置 CI (.drone.yml)\n\nDrone 1.0版本的配置文件依然是 `.drone.yml`。我将 CI 步骤分为两步：build 和 deploy。\n\n### Build\n\n最简单的配置：\n\n```yml\nkind: pipeline\nname: drone-test\n\nsteps:\n- name: build\n  image: golang\n  environment:\n    GOOS: linux\n    GOARCH: amd64\n    CGO_ENABLED: 0\n  commands:\n  - go build\n  - go test\n```\n\nCI 服务器会拉取 GitHub 仓库代码，并读取上述配置，然后根据配置执行对应的操作。这里 CI 会执行**类似**下面的命令：\n\n```sh\ndocker run --rm \\\n    --env=GOOS=linux \\\n    # --env=... 其他环境变量 \\\n    --volumes=`pwd`:/drone/src \\\n    --workdir=/drone/src \\ # workdir 也为 /drone/src\n    --entrypoint=build.sh \\\n    golang \\\n    # your commands\n```\n\n在容器内部会执行：\n\n```sh\n#!/bin/sh\nset -e\n\ngo build\ngo test\n```\n\n执行完成后，如果命令不出错，就可以在宿主机上得到编译好的二进制文件。然而如果我的 golang 项目中包含了第三方依赖，按照这样的配置，每次 push 后执行 `go build` 是会重新通过网络下载依赖包的，因为宿主机本地没有保存依赖，以至于 build 时间太长(想想 `npm install` 😱)。\n但了解了 CI 对容器的操作后，这个问题就迎刃而解了。\n\n更新配置：\n\n```yml\n# ...\nsteps:\n- name: build\n  image: golang\n  volumes:\n  - name: cache-go-deps\n    path: /go # 容器内的路径\n  # ...\n#...\n\nvolumes:\n- name: cache-go-deps\n  host:\n    path: /var/local/drone-cache/repo/go-cache # 宿主机的路径\n```\n\n上面的配置中，我将宿主机的路径挂载到了容器内，实现了依赖缓存持久化，后面的 build 过程可以就可以使用依赖缓存了。\n\n### Deploy\n\n实现了自动化 build 后，还需要实现自动化部署，即分发二进制。\n在实际生产中，CI 服务器需要将 build 完成后的项目，发布到生产服务器上，这里我使用 rsync 来发布：\n\n```yml\n# ...\nsteps:\n- name: build\n  # ...\n\n- name: deploy\n  image: drillster/drone-rsync\n  environment:\n    RSYNC_KEY:\n      from_secret: rsync_key\n  settings:\n    user: admin\n    hosts:\n      - \"prod01.host.com\"\n      - \"prod02.host.com\"\n    ports:\n      - 22\n      - 22\n    source: ./\n    target: /var/local/prod/\n    recursive: true\n    delete: true\n    include:\n      - drone-test\n    exclude:\n      - \"**.*\"\n    script:\n      - /var/local/prod/drone-test\n#...\n```\n\n通过上面的配置文件，drone 会将容器中的 `./` 目录（其中的内容和宿主机相同）下的指定文件分别同步到两个生产服务器中的 `/var/local/prod/` 目录中，并登录生产服务器，执行指定的 `scripts`。这些操作的前提是要允许 CI 服务器够通过 `ssh` 的文件秘钥方式登录到生产服务器，那么首先我需要确保 CI 宿主机本身可以登录到生产服务器。\n在CI 宿主机上执行 `ssh-keygen` 命令，生成公钥和私钥(id_rsa, id_rsa.pub)，然后将公钥内容拷贝到生产服务器的 `~/.ssh/authorized_keys` 文件中，这样一来在 CI 宿主机上就可以登录到生产服务器了。然而我最终的目标是要在 Drone CI 的容器中实现 ssh 登录，有个很直接的方法就是直接将宿主机私钥填写在 .drone.yml 配置里，但是这样做太危险了，好在 Drone 1.0 版本可以通过 Web UI 来添加私密信息键值对(key-secret)，于是我在 Web 界面中配置了 `rsync_key`，并将这个名称引用在 `.drone.yml` 中，这样就安全了！\n关于 `drillster/drone-rsync` 镜像的更多配置参数，可以参考它的 [Docs](https://github.com/Drillster/drone-rsync/blob/master/1-DOCS.md)\n\n===\n\n至此，整个 CI 配置已经大部分完成了，再加上一些 git pull 和触发条件的配置(triggers)，整个 `.drone.yml` 看起来是这样的：\n\n```yml\nkind: pipeline\nname: drone-test\n\nclone:\n  depth: 10\n\ntrigger:\n  branch:\n  - master # 只有在master分支的变动，才会触发 CI\n\nsteps:\n- name: build\n  image: golang\n  environment:\n    GOOS: linux\n    GOARCH: amd64\n    CGO_ENABLED: 0\n  volumes:\n  - name: cache-go-deps\n    path: /go # 容器内的路径\n  commands:\n  - go build\n  - go test\n\n- name: deploy\n  image: drillster/drone-rsync\n  environment:\n    RSYNC_KEY:\n      from_secret: rsync_key\n  settings:\n    user: admin\n    hosts:\n      - \"prod01.host.com\"\n      - \"prod02.host.com\"\n    ports:\n      - 22\n      - 22\n    source: ./\n    target: /var/local/prod/\n    recursive: true\n    delete: true\n    include:\n      - drone-test\n    exclude:\n      - \"**.*\"\n    script:\n      - /var/local/prod/drone-test\n\nvolumes:\n- name: cache-go-deps\n  host:\n    path: /var/local/drone-cache/repo/go-cache # 宿主机的路径\n```\n","slug":"Drone-1.0-简单实践","published":1,"updated":"2023-05-28T05:36:04.286Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1je000wiubfmaqjte92","content":"<p>本文仅针对 Drone 1.0 版本</p><p>由于版本更新无法向下兼容，所有有必要自己从头实践一下。实现目标为：</p><ul><li>搭建 drone ci 服务器，配置nginx反代，实现https访问</li><li>编写 <code>.drone.yml</code> 配置文件，实现 golang 项目的自动化部署，包括 build，依赖缓存，二进制发布(rsync)</li></ul><a id=\"more\"></a><h2 id=\"Drone-CI-服务器搭建与访问\"><a href=\"#Drone-CI-服务器搭建与访问\" class=\"headerlink\" title=\"Drone CI 服务器搭建与访问\"></a>Drone CI 服务器搭建与访问</h2><p>我选用的是针对 GitHub 仓库的单机部署。 根据<a href=\"https://docs.drone.io/installation/github/single-machine/\" target=\"_blank\" rel=\"noopener\">官方文档</a>的说明，先进行 <code>docker pull drone/drone:1</code> 将镜像拉下来，然后配置 <code>docker-compose.yml</code> (官方只给出了 <code>docker run</code> 的启动方式，可能是因为 1.0 版本只需要启动一个容器吧)：</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">'3'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  ci:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">drone/drone:1</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/var/run/docker.sock:/var/run/docker.sock</span> <span class=\"comment\"># 宿主机的路径不能变</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/var/lib/drone:/data</span> <span class=\"comment\"># 宿主机路径可以是别的地方</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_GITHUB_SERVER=https://github.com</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_GITHUB_CLIENT_ID=github的clientID</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_GITHUB_CLIENT_SECRET=github的clientSecret</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_RUNNER_CAPACITY=2</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_USER_CREATE=username:DarthPestilane,admin:true</span> <span class=\"comment\"># 指定管理员用户</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_SERVER_HOST=ci.yourhost.com</span> <span class=\"comment\"># ci 服务器域名</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_SERVER_PROTO=https</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_TLS_AUTOCERT=true</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_LOGS_DEBUG=true</span> <span class=\"comment\"># debug 日志级别</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">8004</span><span class=\"string\">:80</span> <span class=\"comment\"># 将端口暴露出来</span></span><br></pre></td></tr></table></figure><p>Drone CI 容器启动后，我们继续配置 nginx 反代：</p><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 443 ssl http2;</span><br><span class=\"line\">    server_name ci.yourhost.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    ssl_certificate /path/to/ci.yourhost.com/fullchain.pem;</span><br><span class=\"line\">    ssl_certificate_key /path/to/ci.yourhost.com/privkey.pem;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://172.17.0.1:8004; # 反代到 drone 服务，ip为 docker network bridge</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    # 强制 https</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">    server_name ci.yourhost.com;</span><br><span class=\"line\">    return 301 https://ci.yourhost.com$request_uri;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>配置完成后，记得先要将域名和证书准备好，然后 restart nginx 容器。此时我们可以通过域名访问Drone CI了。</p><h2 id=\"配置-CI-drone-yml\"><a href=\"#配置-CI-drone-yml\" class=\"headerlink\" title=\"配置 CI (.drone.yml)\"></a>配置 CI (.drone.yml)</h2><p>Drone 1.0版本的配置文件依然是 <code>.drone.yml</code>。我将 CI 步骤分为两步：build 和 deploy。</p><h3 id=\"Build\"><a href=\"#Build\" class=\"headerlink\" title=\"Build\"></a>Build</h3><p>最简单的配置：</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">pipeline</span></span><br><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">drone-test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">steps:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"attr\">  image:</span> <span class=\"string\">golang</span></span><br><span class=\"line\"><span class=\"attr\">  environment:</span></span><br><span class=\"line\"><span class=\"attr\">    GOOS:</span> <span class=\"string\">linux</span></span><br><span class=\"line\"><span class=\"attr\">    GOARCH:</span> <span class=\"string\">amd64</span></span><br><span class=\"line\"><span class=\"attr\">    CGO_ENABLED:</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">  commands:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">go</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">go</span> <span class=\"string\">test</span></span><br></pre></td></tr></table></figure><p>CI 服务器会拉取 GitHub 仓库代码，并读取上述配置，然后根据配置执行对应的操作。这里 CI 会执行<strong>类似</strong>下面的命令：</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --rm \\</span><br><span class=\"line\">    --env=GOOS=linux \\</span><br><span class=\"line\">    <span class=\"comment\"># --env=... 其他环境变量 \\</span></span><br><span class=\"line\">    --volumes=`<span class=\"built_in\">pwd</span>`:/drone/src \\</span><br><span class=\"line\">    --workdir=/drone/src \\ <span class=\"comment\"># workdir 也为 /drone/src</span></span><br><span class=\"line\">    --entrypoint=build.sh \\</span><br><span class=\"line\">    golang \\</span><br><span class=\"line\">    <span class=\"comment\"># your commands</span></span><br></pre></td></tr></table></figure><p>在容器内部会执行：</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> -e</span><br><span class=\"line\"></span><br><span class=\"line\">go build</span><br><span class=\"line\">go <span class=\"built_in\">test</span></span><br></pre></td></tr></table></figure><p>执行完成后，如果命令不出错，就可以在宿主机上得到编译好的二进制文件。然而如果我的 golang 项目中包含了第三方依赖，按照这样的配置，每次 push 后执行 <code>go build</code> 是会重新通过网络下载依赖包的，因为宿主机本地没有保存依赖，以至于 build 时间太长(想想 <code>npm install</code> 😱)。 但了解了 CI 对容器的操作后，这个问题就迎刃而解了。</p><p>更新配置：</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ...</span></span><br><span class=\"line\"><span class=\"attr\">steps:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"attr\">  image:</span> <span class=\"string\">golang</span></span><br><span class=\"line\"><span class=\"attr\">  volumes:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">cache-go-deps</span></span><br><span class=\"line\"><span class=\"attr\">    path:</span> <span class=\"string\">/go</span> <span class=\"comment\"># 容器内的路径</span></span><br><span class=\"line\">  <span class=\"comment\"># ...</span></span><br><span class=\"line\"><span class=\"comment\">#...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">cache-go-deps</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span></span><br><span class=\"line\"><span class=\"attr\">    path:</span> <span class=\"string\">/var/local/drone-cache/repo/go-cache</span> <span class=\"comment\"># 宿主机的路径</span></span><br></pre></td></tr></table></figure><p>上面的配置中，我将宿主机的路径挂载到了容器内，实现了依赖缓存持久化，后面的 build 过程可以就可以使用依赖缓存了。</p><h3 id=\"Deploy\"><a href=\"#Deploy\" class=\"headerlink\" title=\"Deploy\"></a>Deploy</h3><p>实现了自动化 build 后，还需要实现自动化部署，即分发二进制。 在实际生产中，CI 服务器需要将 build 完成后的项目，发布到生产服务器上，这里我使用 rsync 来发布：</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ...</span></span><br><span class=\"line\"><span class=\"attr\">steps:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">build</span></span><br><span class=\"line\">  <span class=\"comment\"># ...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">deploy</span></span><br><span class=\"line\"><span class=\"attr\">  image:</span> <span class=\"string\">drillster/drone-rsync</span></span><br><span class=\"line\"><span class=\"attr\">  environment:</span></span><br><span class=\"line\"><span class=\"attr\">    RSYNC_KEY:</span></span><br><span class=\"line\"><span class=\"attr\">      from_secret:</span> <span class=\"string\">rsync_key</span></span><br><span class=\"line\"><span class=\"attr\">  settings:</span></span><br><span class=\"line\"><span class=\"attr\">    user:</span> <span class=\"string\">admin</span></span><br><span class=\"line\"><span class=\"attr\">    hosts:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"prod01.host.com\"</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"prod02.host.com\"</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"attr\">    source:</span> <span class=\"string\">./</span></span><br><span class=\"line\"><span class=\"attr\">    target:</span> <span class=\"string\">/var/local/prod/</span></span><br><span class=\"line\"><span class=\"attr\">    recursive:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">    delete:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">    include:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">drone-test</span></span><br><span class=\"line\"><span class=\"attr\">    exclude:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"**.*\"</span></span><br><span class=\"line\"><span class=\"attr\">    script:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/var/local/prod/drone-test</span></span><br><span class=\"line\"><span class=\"comment\">#...</span></span><br></pre></td></tr></table></figure><p>通过上面的配置文件，drone 会将容器中的 <code>./</code> 目录（其中的内容和宿主机相同）下的指定文件分别同步到两个生产服务器中的 <code>/var/local/prod/</code> 目录中，并登录生产服务器，执行指定的 <code>scripts</code>。这些操作的前提是要允许 CI 服务器够通过 <code>ssh</code> 的文件秘钥方式登录到生产服务器，那么首先我需要确保 CI 宿主机本身可以登录到生产服务器。 在CI 宿主机上执行 <code>ssh-keygen</code> 命令，生成公钥和私钥(id_rsa, id_rsa.pub)，然后将公钥内容拷贝到生产服务器的 <code>~/.ssh/authorized_keys</code> 文件中，这样一来在 CI 宿主机上就可以登录到生产服务器了。然而我最终的目标是要在 Drone CI 的容器中实现 ssh 登录，有个很直接的方法就是直接将宿主机私钥填写在 .drone.yml 配置里，但是这样做太危险了，好在 Drone 1.0 版本可以通过 Web UI 来添加私密信息键值对(key-secret)，于是我在 Web 界面中配置了 <code>rsync_key</code>，并将这个名称引用在 <code>.drone.yml</code> 中，这样就安全了！ 关于 <code>drillster/drone-rsync</code> 镜像的更多配置参数，可以参考它的 <a href=\"https://github.com/Drillster/drone-rsync/blob/master/1-DOCS.md\" target=\"_blank\" rel=\"noopener\">Docs</a></p><p>===</p><p>至此，整个 CI 配置已经大部分完成了，再加上一些 git pull 和触发条件的配置(triggers)，整个 <code>.drone.yml</code> 看起来是这样的：</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">pipeline</span></span><br><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">drone-test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">clone:</span></span><br><span class=\"line\"><span class=\"attr\">  depth:</span> <span class=\"number\">10</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">trigger:</span></span><br><span class=\"line\"><span class=\"attr\">  branch:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">master</span> <span class=\"comment\"># 只有在master分支的变动，才会触发 CI</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">steps:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"attr\">  image:</span> <span class=\"string\">golang</span></span><br><span class=\"line\"><span class=\"attr\">  environment:</span></span><br><span class=\"line\"><span class=\"attr\">    GOOS:</span> <span class=\"string\">linux</span></span><br><span class=\"line\"><span class=\"attr\">    GOARCH:</span> <span class=\"string\">amd64</span></span><br><span class=\"line\"><span class=\"attr\">    CGO_ENABLED:</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">  volumes:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">cache-go-deps</span></span><br><span class=\"line\"><span class=\"attr\">    path:</span> <span class=\"string\">/go</span> <span class=\"comment\"># 容器内的路径</span></span><br><span class=\"line\"><span class=\"attr\">  commands:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">go</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">go</span> <span class=\"string\">test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">deploy</span></span><br><span class=\"line\"><span class=\"attr\">  image:</span> <span class=\"string\">drillster/drone-rsync</span></span><br><span class=\"line\"><span class=\"attr\">  environment:</span></span><br><span class=\"line\"><span class=\"attr\">    RSYNC_KEY:</span></span><br><span class=\"line\"><span class=\"attr\">      from_secret:</span> <span class=\"string\">rsync_key</span></span><br><span class=\"line\"><span class=\"attr\">  settings:</span></span><br><span class=\"line\"><span class=\"attr\">    user:</span> <span class=\"string\">admin</span></span><br><span class=\"line\"><span class=\"attr\">    hosts:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"prod01.host.com\"</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"prod02.host.com\"</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"attr\">    source:</span> <span class=\"string\">./</span></span><br><span class=\"line\"><span class=\"attr\">    target:</span> <span class=\"string\">/var/local/prod/</span></span><br><span class=\"line\"><span class=\"attr\">    recursive:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">    delete:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">    include:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">drone-test</span></span><br><span class=\"line\"><span class=\"attr\">    exclude:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"**.*\"</span></span><br><span class=\"line\"><span class=\"attr\">    script:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/var/local/prod/drone-test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">cache-go-deps</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span></span><br><span class=\"line\"><span class=\"attr\">    path:</span> <span class=\"string\">/var/local/drone-cache/repo/go-cache</span> <span class=\"comment\"># 宿主机的路径</span></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"<p>本文仅针对 Drone 1.0 版本</p><p>由于版本更新无法向下兼容，所有有必要自己从头实践一下。实现目标为：</p><ul><li>搭建 drone ci 服务器，配置nginx反代，实现https访问</li><li>编写 <code>.drone.yml</code> 配置文件，实现 golang 项目的自动化部署，包括 build，依赖缓存，二进制发布(rsync)</li></ul>","more":"<h2 id=\"Drone-CI-服务器搭建与访问\"><a href=\"#Drone-CI-服务器搭建与访问\" class=\"headerlink\" title=\"Drone CI 服务器搭建与访问\"></a>Drone CI 服务器搭建与访问</h2><p>我选用的是针对 GitHub 仓库的单机部署。 根据<a href=\"https://docs.drone.io/installation/github/single-machine/\" target=\"_blank\" rel=\"noopener\">官方文档</a>的说明，先进行 <code>docker pull drone/drone:1</code> 将镜像拉下来，然后配置 <code>docker-compose.yml</code> (官方只给出了 <code>docker run</code> 的启动方式，可能是因为 1.0 版本只需要启动一个容器吧)：</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">'3'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  ci:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">drone/drone:1</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/var/run/docker.sock:/var/run/docker.sock</span> <span class=\"comment\"># 宿主机的路径不能变</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/var/lib/drone:/data</span> <span class=\"comment\"># 宿主机路径可以是别的地方</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_GITHUB_SERVER=https://github.com</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_GITHUB_CLIENT_ID=github的clientID</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_GITHUB_CLIENT_SECRET=github的clientSecret</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_RUNNER_CAPACITY=2</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_USER_CREATE=username:DarthPestilane,admin:true</span> <span class=\"comment\"># 指定管理员用户</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_SERVER_HOST=ci.yourhost.com</span> <span class=\"comment\"># ci 服务器域名</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_SERVER_PROTO=https</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_TLS_AUTOCERT=true</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">DRONE_LOGS_DEBUG=true</span> <span class=\"comment\"># debug 日志级别</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">8004</span><span class=\"string\">:80</span> <span class=\"comment\"># 将端口暴露出来</span></span><br></pre></td></tr></table></figure><p>Drone CI 容器启动后，我们继续配置 nginx 反代：</p><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 443 ssl http2;</span><br><span class=\"line\">    server_name ci.yourhost.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    ssl_certificate /path/to/ci.yourhost.com/fullchain.pem;</span><br><span class=\"line\">    ssl_certificate_key /path/to/ci.yourhost.com/privkey.pem;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://172.17.0.1:8004; # 反代到 drone 服务，ip为 docker network bridge</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    # 强制 https</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">    server_name ci.yourhost.com;</span><br><span class=\"line\">    return 301 https://ci.yourhost.com$request_uri;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>配置完成后，记得先要将域名和证书准备好，然后 restart nginx 容器。此时我们可以通过域名访问Drone CI了。</p><h2 id=\"配置-CI-drone-yml\"><a href=\"#配置-CI-drone-yml\" class=\"headerlink\" title=\"配置 CI (.drone.yml)\"></a>配置 CI (.drone.yml)</h2><p>Drone 1.0版本的配置文件依然是 <code>.drone.yml</code>。我将 CI 步骤分为两步：build 和 deploy。</p><h3 id=\"Build\"><a href=\"#Build\" class=\"headerlink\" title=\"Build\"></a>Build</h3><p>最简单的配置：</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">pipeline</span></span><br><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">drone-test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">steps:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"attr\">  image:</span> <span class=\"string\">golang</span></span><br><span class=\"line\"><span class=\"attr\">  environment:</span></span><br><span class=\"line\"><span class=\"attr\">    GOOS:</span> <span class=\"string\">linux</span></span><br><span class=\"line\"><span class=\"attr\">    GOARCH:</span> <span class=\"string\">amd64</span></span><br><span class=\"line\"><span class=\"attr\">    CGO_ENABLED:</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">  commands:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">go</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">go</span> <span class=\"string\">test</span></span><br></pre></td></tr></table></figure><p>CI 服务器会拉取 GitHub 仓库代码，并读取上述配置，然后根据配置执行对应的操作。这里 CI 会执行<strong>类似</strong>下面的命令：</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --rm \\</span><br><span class=\"line\">    --env=GOOS=linux \\</span><br><span class=\"line\">    <span class=\"comment\"># --env=... 其他环境变量 \\</span></span><br><span class=\"line\">    --volumes=`<span class=\"built_in\">pwd</span>`:/drone/src \\</span><br><span class=\"line\">    --workdir=/drone/src \\ <span class=\"comment\"># workdir 也为 /drone/src</span></span><br><span class=\"line\">    --entrypoint=build.sh \\</span><br><span class=\"line\">    golang \\</span><br><span class=\"line\">    <span class=\"comment\"># your commands</span></span><br></pre></td></tr></table></figure><p>在容器内部会执行：</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\"><span class=\"built_in\">set</span> -e</span><br><span class=\"line\"></span><br><span class=\"line\">go build</span><br><span class=\"line\">go <span class=\"built_in\">test</span></span><br></pre></td></tr></table></figure><p>执行完成后，如果命令不出错，就可以在宿主机上得到编译好的二进制文件。然而如果我的 golang 项目中包含了第三方依赖，按照这样的配置，每次 push 后执行 <code>go build</code> 是会重新通过网络下载依赖包的，因为宿主机本地没有保存依赖，以至于 build 时间太长(想想 <code>npm install</code> 😱)。 但了解了 CI 对容器的操作后，这个问题就迎刃而解了。</p><p>更新配置：</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ...</span></span><br><span class=\"line\"><span class=\"attr\">steps:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"attr\">  image:</span> <span class=\"string\">golang</span></span><br><span class=\"line\"><span class=\"attr\">  volumes:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">cache-go-deps</span></span><br><span class=\"line\"><span class=\"attr\">    path:</span> <span class=\"string\">/go</span> <span class=\"comment\"># 容器内的路径</span></span><br><span class=\"line\">  <span class=\"comment\"># ...</span></span><br><span class=\"line\"><span class=\"comment\">#...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">cache-go-deps</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span></span><br><span class=\"line\"><span class=\"attr\">    path:</span> <span class=\"string\">/var/local/drone-cache/repo/go-cache</span> <span class=\"comment\"># 宿主机的路径</span></span><br></pre></td></tr></table></figure><p>上面的配置中，我将宿主机的路径挂载到了容器内，实现了依赖缓存持久化，后面的 build 过程可以就可以使用依赖缓存了。</p><h3 id=\"Deploy\"><a href=\"#Deploy\" class=\"headerlink\" title=\"Deploy\"></a>Deploy</h3><p>实现了自动化 build 后，还需要实现自动化部署，即分发二进制。 在实际生产中，CI 服务器需要将 build 完成后的项目，发布到生产服务器上，这里我使用 rsync 来发布：</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ...</span></span><br><span class=\"line\"><span class=\"attr\">steps:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">build</span></span><br><span class=\"line\">  <span class=\"comment\"># ...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">deploy</span></span><br><span class=\"line\"><span class=\"attr\">  image:</span> <span class=\"string\">drillster/drone-rsync</span></span><br><span class=\"line\"><span class=\"attr\">  environment:</span></span><br><span class=\"line\"><span class=\"attr\">    RSYNC_KEY:</span></span><br><span class=\"line\"><span class=\"attr\">      from_secret:</span> <span class=\"string\">rsync_key</span></span><br><span class=\"line\"><span class=\"attr\">  settings:</span></span><br><span class=\"line\"><span class=\"attr\">    user:</span> <span class=\"string\">admin</span></span><br><span class=\"line\"><span class=\"attr\">    hosts:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"prod01.host.com\"</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"prod02.host.com\"</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"attr\">    source:</span> <span class=\"string\">./</span></span><br><span class=\"line\"><span class=\"attr\">    target:</span> <span class=\"string\">/var/local/prod/</span></span><br><span class=\"line\"><span class=\"attr\">    recursive:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">    delete:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">    include:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">drone-test</span></span><br><span class=\"line\"><span class=\"attr\">    exclude:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"**.*\"</span></span><br><span class=\"line\"><span class=\"attr\">    script:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/var/local/prod/drone-test</span></span><br><span class=\"line\"><span class=\"comment\">#...</span></span><br></pre></td></tr></table></figure><p>通过上面的配置文件，drone 会将容器中的 <code>./</code> 目录（其中的内容和宿主机相同）下的指定文件分别同步到两个生产服务器中的 <code>/var/local/prod/</code> 目录中，并登录生产服务器，执行指定的 <code>scripts</code>。这些操作的前提是要允许 CI 服务器够通过 <code>ssh</code> 的文件秘钥方式登录到生产服务器，那么首先我需要确保 CI 宿主机本身可以登录到生产服务器。 在CI 宿主机上执行 <code>ssh-keygen</code> 命令，生成公钥和私钥(id_rsa, id_rsa.pub)，然后将公钥内容拷贝到生产服务器的 <code>~/.ssh/authorized_keys</code> 文件中，这样一来在 CI 宿主机上就可以登录到生产服务器了。然而我最终的目标是要在 Drone CI 的容器中实现 ssh 登录，有个很直接的方法就是直接将宿主机私钥填写在 .drone.yml 配置里，但是这样做太危险了，好在 Drone 1.0 版本可以通过 Web UI 来添加私密信息键值对(key-secret)，于是我在 Web 界面中配置了 <code>rsync_key</code>，并将这个名称引用在 <code>.drone.yml</code> 中，这样就安全了！ 关于 <code>drillster/drone-rsync</code> 镜像的更多配置参数，可以参考它的 <a href=\"https://github.com/Drillster/drone-rsync/blob/master/1-DOCS.md\" target=\"_blank\" rel=\"noopener\">Docs</a></p><p>===</p><p>至此，整个 CI 配置已经大部分完成了，再加上一些 git pull 和触发条件的配置(triggers)，整个 <code>.drone.yml</code> 看起来是这样的：</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">pipeline</span></span><br><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">drone-test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">clone:</span></span><br><span class=\"line\"><span class=\"attr\">  depth:</span> <span class=\"number\">10</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">trigger:</span></span><br><span class=\"line\"><span class=\"attr\">  branch:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">master</span> <span class=\"comment\"># 只有在master分支的变动，才会触发 CI</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">steps:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"attr\">  image:</span> <span class=\"string\">golang</span></span><br><span class=\"line\"><span class=\"attr\">  environment:</span></span><br><span class=\"line\"><span class=\"attr\">    GOOS:</span> <span class=\"string\">linux</span></span><br><span class=\"line\"><span class=\"attr\">    GOARCH:</span> <span class=\"string\">amd64</span></span><br><span class=\"line\"><span class=\"attr\">    CGO_ENABLED:</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">  volumes:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">cache-go-deps</span></span><br><span class=\"line\"><span class=\"attr\">    path:</span> <span class=\"string\">/go</span> <span class=\"comment\"># 容器内的路径</span></span><br><span class=\"line\"><span class=\"attr\">  commands:</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">go</span> <span class=\"string\">build</span></span><br><span class=\"line\"><span class=\"bullet\">  -</span> <span class=\"string\">go</span> <span class=\"string\">test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">deploy</span></span><br><span class=\"line\"><span class=\"attr\">  image:</span> <span class=\"string\">drillster/drone-rsync</span></span><br><span class=\"line\"><span class=\"attr\">  environment:</span></span><br><span class=\"line\"><span class=\"attr\">    RSYNC_KEY:</span></span><br><span class=\"line\"><span class=\"attr\">      from_secret:</span> <span class=\"string\">rsync_key</span></span><br><span class=\"line\"><span class=\"attr\">  settings:</span></span><br><span class=\"line\"><span class=\"attr\">    user:</span> <span class=\"string\">admin</span></span><br><span class=\"line\"><span class=\"attr\">    hosts:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"prod01.host.com\"</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"prod02.host.com\"</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"attr\">    source:</span> <span class=\"string\">./</span></span><br><span class=\"line\"><span class=\"attr\">    target:</span> <span class=\"string\">/var/local/prod/</span></span><br><span class=\"line\"><span class=\"attr\">    recursive:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">    delete:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">    include:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">drone-test</span></span><br><span class=\"line\"><span class=\"attr\">    exclude:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"**.*\"</span></span><br><span class=\"line\"><span class=\"attr\">    script:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/var/local/prod/drone-test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\"><span class=\"attr\">- name:</span> <span class=\"string\">cache-go-deps</span></span><br><span class=\"line\"><span class=\"attr\">  host:</span></span><br><span class=\"line\"><span class=\"attr\">    path:</span> <span class=\"string\">/var/local/drone-cache/repo/go-cache</span> <span class=\"comment\"># 宿主机的路径</span></span><br></pre></td></tr></table></figure>"},{"title":"Jenkins 多分支 pipeline 配置","date":"2021-10-09T06:12:08.000Z","_content":"\n最近恰巧有机会在一台 Centos 物理机上搭建 Jenkins，\n也借此机会实践了从 git 提交自动触发 Jenkins build 的工作流，故在此记录，以作备忘。\n\n## Jenkins 安装\n\ndocker 镜像在 https://hub.docker.com/r/jenkins/jenkins 。\n\ndocker-compose.yml 配置如下:\n\n```yml\nversion: \"3\"\n\nservices:\n  jenkins:\n    image: jenkins/jenkins:lts-alpine-jdk11\n    ports:\n      - '8180:8080' # web 端口\n      - '50000:50000'\n    volumes:\n      - ./jenkins/:/var/jenkins_home # 持久化\n    environment:\n      TZ: \"Asia/Shanghai\"\n```\n\n需要注意宿主机的 `./jenkins/` 目录需要将用户和组更改为 `1000:1000`:\n\n```sh\n> sudo chown -R 1000:1000 ./jenkins\n```\n\n启动之后，进入 web 界面，需要输入 admin 的密码，这个密码可以在容器的日志中获得:\n\n```sh\n> docker-compose logs jenkins # 查看容器日志\n```\n\n```log\njenkins_1  | *************************************************************\njenkins_1  | *************************************************************\njenkins_1  | *************************************************************\njenkins_1  |\njenkins_1  | Jenkins initial setup is required. An admin user has been created and a password generated.\njenkins_1  | Please use the following password to proceed to installation:\njenkins_1  |\njenkins_1  | aee0014b14124efe03c361e1eed93589\njenkins_1  |\njenkins_1  | This may also be found at: /var/jenkins_home/secrets/initialAdminPassword\njenkins_1  |\njenkins_1  | *************************************************************\njenkins_1  | *************************************************************\njenkins_1  | *************************************************************\n```\n\n接下来建议直接选择安装社区 `推荐` 的插件，然后进行简单配置后，就可以正常登陆到 Jenkins 控制台了，\n然后进行slave节点配置，顺便配置下域名反代。\n\n<!-- more -->\n\n## Gitea 安装\n\n使用 `Gitea` 作为私有 git 代码仓库，docker 镜像在: https://hub.docker.com/r/gitea/gitea 。\n\ndocker-compose.yml 配置如下:\n\n```yml\nversion: \"3\"\n\nservices:\n  server:\n    image: gitea/gitea:1.15.3\n    environment:\n      - USER_UID=1000\n      - USER_GID=1000\n    volumes:\n      - ./gitea:/data # 持久化\n      - /etc/timezone:/etc/timezone:ro\n      - /etc/localtime:/etc/localtime:ro\n    ports:\n      - \"3000:3000\" # http 端口\n```\n\n启动后，进入 web 界面进行安装，要注意 URL 里要填写容器内对应的地址。\n如果配置了域名并进行反代，需要更改容器内的 `app.ini` 配置文件:\n\n```ini\n# 由于已经将文件挂载到了宿主机，所以直接修改宿主机文件即可。\n# ./gitea/gitea/conf/app.ini\n[server]\nDOMAIN           = gitea.wrzsj.top # 修改成域名\nSSH_DOMAIN       = gitea.wrzsj.top # 修改成域名\nROOT_URL         = https://gitea.wrzsj.top/ # 修改成域名，可以理解为外部 URL\nLOCAL_ROOT_URL   = http://127.0.0.1:3000/ # 添加 LOCAL_ROOT_URL\n```\n\n修改之后，重启容器 `docker-compose restart server` 。\n\n## CI/CD\n\nJenkins 和 Gitea 都准备好后，接下来就要开始配置 CI/CD 了。\n\n### 工作流:\n\n![git workflow](https://qiniu.wrzsj.top/git-flow)\n\ngit 分支操作:\n\n- 从 `master` 分支切出 `dev` 分支作为长期迭代分支\n- 从 `dev` 分支切出 `feat` 分支作为功能分支\n- 在 `feat` 分支上提交代码，并及时 rebase `dev` 来保证提交不落后，完成开发后通过 `pull request` 的方式合并回 `dev` 分支\n- 将 `dev` 分支合并回 `master` 分支\n- 在 `master` 分支上打 tag，用于发布\n\n对于线上的 bug 修复，应从 `master` 分支切出 `hotfix` 分支，\n开发完成后合并到 `dev` 进行测试，测试通过后合并到 `master` ，然后打 tag 发布。\n\nCI/CD 触发:\n\n- 当 `master` 和 `dev` 分支发生 push 时，触发\n- 当 `pull request` 创建或有后续 push 时，触发\n- 每次触发都会执行 build, lint 和 test 任务\n- 如果由 `dev` 分支 push 触发，则部署到 QA 环境\n- 如果由 `master` 分支 push 触发，会进入打标签阶段，需要人工确认\n- 打上标签后，会进入部署到生产环境阶段，也需要人工确认\n\n### 配置\n\n#### Jenkins 配置\n\n安装 [gitea 插件](https://plugins.jenkins.io/gitea/)。\n\n新建 `多分支流水线` 任务。\n\n配置分支源:\n\n- 需要设置 `Credentials` ，使用类型为 `Gitea Personal Access Token` 的凭证\n- 添加 `Discover branches`，策略为 `Only branches that are not also filed as PRs`\n- 添加 `Discover pull requests from origin`，策略为 `Merging the pull request with the current target branch revision`\n- 添加 `Discover tags`\n- 添加 `根据名称过滤（支持通配符)`, 包含 `master dev release-* PR-*`\n  - `release-*` 用来过滤 tag。在打 tag 的时候，需要有 `release-` 前缀\n  - `PR-*` 用来过滤 pull request\n- 添加高级克隆行为，勾选 `Fetch tags` 和 `浅克隆`，并设置 `浅克隆深度` 为 1\n\n保存配置。\n\n#### Gitea 配置\n\n在代码仓库里配置 `webhook`:\n\n- 添加 `Gitea` 钩子\n- 目标 URL 输入: `https://jenkins.wrzsj.top/gitea-webhook/post/`，注意要加上最后的斜杠 `/` ！！\n- 触发条件勾选 `所有事件`\n\n保存配置。\n\n#### Jenkinsfile 配置\n\n语法参考: https://www.jenkins.io/zh/doc/book/pipeline/syntax/ 。\n\n由于是 pipeline 类型的任务，需要通过 Jenkinsfile 来触发。在代码中提交 Jenkinsfile 文件:\n\n```groovy\npipeline {\n    agent any\n    options {\n        disableConcurrentBuilds() // 禁用并发构建\n        timestamps()              // Console log 中打印时间戳\n    }\n    stages {\n        stage('Build') {\n            when { not { tag '*' } }\n            steps {\n                echo 'build'\n                sh 'sleep 1'\n            }\n        }\n        stage('Lint') {\n            when { not { tag '*' } }\n            steps {\n                echo 'lint'\n                sh 'sleep 1'\n            }\n        }\n        stage('Test') {\n            when { not { tag '*' } }\n            steps {\n                echo 'test'\n                sh 'sleep 1'\n            }\n        }\n        stage('Deploy QA') {\n            when { branch 'dev' }\n            steps {\n                echo 'deploy QA'\n            }\n        }\n        stage('Tag on master') {\n            when {\n                branch 'master'\n                beforeInput true\n            }\n            input { // 人工确认\n                message \"Release a tag?\"\n                ok \"Yes, do it.\"\n                parameters {\n                    string(name: 'milestone', defaultValue: 'regular', description: 'milestone as tag prefix')\n                }\n            }\n            steps {\n                sh '''\n                export TAG=release-${milestone}-$(date +\"%Y%m%d\").${BUILD_ID}\n                git tag ${TAG}\n                git push origin ${TAG}\n                '''\n            }\n        }\n        stage('Deploy Prod') {\n            when {\n                tag '*'\n                beforeInput true\n            }\n            input { // 人工确认\n                message \"Should we continue?\"\n                ok \"Yes, do it.\"\n            }\n            steps {\n                echo 'deploy production'\n            }\n        }\n    }\n}\n```\n\n现在，按照 Git 工作流来提交合并代码，就能够触发 Jenkins 流水线了。\n\n## 总结\n\n这次实践中，在 Jenkins 的使用上采取 master-slave 方式来运行流水线，相比只有 master 节点的工作方式，更加合理，且方便扩展。\n配合 Jenkinsfile 的使用，实现了持续集成，搭建了敏捷开发的基础。\n\n不过对比 `GitHub Actions` 和 `Gitlab CI` 还是略显笨重和*复古*，配置文件的语法相比 `yaml` 也更加晦涩难懂，文档也略显粗糙。\n尽管如此，大多数公司的 CI/CD 还是使用的是 Jenkins，所以是有必要学会的。\n","source":"_posts/2021-10-09-Jenkins-多分支-pipeline-配置.md","raw":"---\ntitle: Jenkins 多分支 pipeline 配置\ndate: 2021-10-09 14:12:08\ncategories:\n- 笔记\ntags:\n- CI\n- Jenkins\n---\n\n最近恰巧有机会在一台 Centos 物理机上搭建 Jenkins，\n也借此机会实践了从 git 提交自动触发 Jenkins build 的工作流，故在此记录，以作备忘。\n\n## Jenkins 安装\n\ndocker 镜像在 https://hub.docker.com/r/jenkins/jenkins 。\n\ndocker-compose.yml 配置如下:\n\n```yml\nversion: \"3\"\n\nservices:\n  jenkins:\n    image: jenkins/jenkins:lts-alpine-jdk11\n    ports:\n      - '8180:8080' # web 端口\n      - '50000:50000'\n    volumes:\n      - ./jenkins/:/var/jenkins_home # 持久化\n    environment:\n      TZ: \"Asia/Shanghai\"\n```\n\n需要注意宿主机的 `./jenkins/` 目录需要将用户和组更改为 `1000:1000`:\n\n```sh\n> sudo chown -R 1000:1000 ./jenkins\n```\n\n启动之后，进入 web 界面，需要输入 admin 的密码，这个密码可以在容器的日志中获得:\n\n```sh\n> docker-compose logs jenkins # 查看容器日志\n```\n\n```log\njenkins_1  | *************************************************************\njenkins_1  | *************************************************************\njenkins_1  | *************************************************************\njenkins_1  |\njenkins_1  | Jenkins initial setup is required. An admin user has been created and a password generated.\njenkins_1  | Please use the following password to proceed to installation:\njenkins_1  |\njenkins_1  | aee0014b14124efe03c361e1eed93589\njenkins_1  |\njenkins_1  | This may also be found at: /var/jenkins_home/secrets/initialAdminPassword\njenkins_1  |\njenkins_1  | *************************************************************\njenkins_1  | *************************************************************\njenkins_1  | *************************************************************\n```\n\n接下来建议直接选择安装社区 `推荐` 的插件，然后进行简单配置后，就可以正常登陆到 Jenkins 控制台了，\n然后进行slave节点配置，顺便配置下域名反代。\n\n<!-- more -->\n\n## Gitea 安装\n\n使用 `Gitea` 作为私有 git 代码仓库，docker 镜像在: https://hub.docker.com/r/gitea/gitea 。\n\ndocker-compose.yml 配置如下:\n\n```yml\nversion: \"3\"\n\nservices:\n  server:\n    image: gitea/gitea:1.15.3\n    environment:\n      - USER_UID=1000\n      - USER_GID=1000\n    volumes:\n      - ./gitea:/data # 持久化\n      - /etc/timezone:/etc/timezone:ro\n      - /etc/localtime:/etc/localtime:ro\n    ports:\n      - \"3000:3000\" # http 端口\n```\n\n启动后，进入 web 界面进行安装，要注意 URL 里要填写容器内对应的地址。\n如果配置了域名并进行反代，需要更改容器内的 `app.ini` 配置文件:\n\n```ini\n# 由于已经将文件挂载到了宿主机，所以直接修改宿主机文件即可。\n# ./gitea/gitea/conf/app.ini\n[server]\nDOMAIN           = gitea.wrzsj.top # 修改成域名\nSSH_DOMAIN       = gitea.wrzsj.top # 修改成域名\nROOT_URL         = https://gitea.wrzsj.top/ # 修改成域名，可以理解为外部 URL\nLOCAL_ROOT_URL   = http://127.0.0.1:3000/ # 添加 LOCAL_ROOT_URL\n```\n\n修改之后，重启容器 `docker-compose restart server` 。\n\n## CI/CD\n\nJenkins 和 Gitea 都准备好后，接下来就要开始配置 CI/CD 了。\n\n### 工作流:\n\n![git workflow](https://qiniu.wrzsj.top/git-flow)\n\ngit 分支操作:\n\n- 从 `master` 分支切出 `dev` 分支作为长期迭代分支\n- 从 `dev` 分支切出 `feat` 分支作为功能分支\n- 在 `feat` 分支上提交代码，并及时 rebase `dev` 来保证提交不落后，完成开发后通过 `pull request` 的方式合并回 `dev` 分支\n- 将 `dev` 分支合并回 `master` 分支\n- 在 `master` 分支上打 tag，用于发布\n\n对于线上的 bug 修复，应从 `master` 分支切出 `hotfix` 分支，\n开发完成后合并到 `dev` 进行测试，测试通过后合并到 `master` ，然后打 tag 发布。\n\nCI/CD 触发:\n\n- 当 `master` 和 `dev` 分支发生 push 时，触发\n- 当 `pull request` 创建或有后续 push 时，触发\n- 每次触发都会执行 build, lint 和 test 任务\n- 如果由 `dev` 分支 push 触发，则部署到 QA 环境\n- 如果由 `master` 分支 push 触发，会进入打标签阶段，需要人工确认\n- 打上标签后，会进入部署到生产环境阶段，也需要人工确认\n\n### 配置\n\n#### Jenkins 配置\n\n安装 [gitea 插件](https://plugins.jenkins.io/gitea/)。\n\n新建 `多分支流水线` 任务。\n\n配置分支源:\n\n- 需要设置 `Credentials` ，使用类型为 `Gitea Personal Access Token` 的凭证\n- 添加 `Discover branches`，策略为 `Only branches that are not also filed as PRs`\n- 添加 `Discover pull requests from origin`，策略为 `Merging the pull request with the current target branch revision`\n- 添加 `Discover tags`\n- 添加 `根据名称过滤（支持通配符)`, 包含 `master dev release-* PR-*`\n  - `release-*` 用来过滤 tag。在打 tag 的时候，需要有 `release-` 前缀\n  - `PR-*` 用来过滤 pull request\n- 添加高级克隆行为，勾选 `Fetch tags` 和 `浅克隆`，并设置 `浅克隆深度` 为 1\n\n保存配置。\n\n#### Gitea 配置\n\n在代码仓库里配置 `webhook`:\n\n- 添加 `Gitea` 钩子\n- 目标 URL 输入: `https://jenkins.wrzsj.top/gitea-webhook/post/`，注意要加上最后的斜杠 `/` ！！\n- 触发条件勾选 `所有事件`\n\n保存配置。\n\n#### Jenkinsfile 配置\n\n语法参考: https://www.jenkins.io/zh/doc/book/pipeline/syntax/ 。\n\n由于是 pipeline 类型的任务，需要通过 Jenkinsfile 来触发。在代码中提交 Jenkinsfile 文件:\n\n```groovy\npipeline {\n    agent any\n    options {\n        disableConcurrentBuilds() // 禁用并发构建\n        timestamps()              // Console log 中打印时间戳\n    }\n    stages {\n        stage('Build') {\n            when { not { tag '*' } }\n            steps {\n                echo 'build'\n                sh 'sleep 1'\n            }\n        }\n        stage('Lint') {\n            when { not { tag '*' } }\n            steps {\n                echo 'lint'\n                sh 'sleep 1'\n            }\n        }\n        stage('Test') {\n            when { not { tag '*' } }\n            steps {\n                echo 'test'\n                sh 'sleep 1'\n            }\n        }\n        stage('Deploy QA') {\n            when { branch 'dev' }\n            steps {\n                echo 'deploy QA'\n            }\n        }\n        stage('Tag on master') {\n            when {\n                branch 'master'\n                beforeInput true\n            }\n            input { // 人工确认\n                message \"Release a tag?\"\n                ok \"Yes, do it.\"\n                parameters {\n                    string(name: 'milestone', defaultValue: 'regular', description: 'milestone as tag prefix')\n                }\n            }\n            steps {\n                sh '''\n                export TAG=release-${milestone}-$(date +\"%Y%m%d\").${BUILD_ID}\n                git tag ${TAG}\n                git push origin ${TAG}\n                '''\n            }\n        }\n        stage('Deploy Prod') {\n            when {\n                tag '*'\n                beforeInput true\n            }\n            input { // 人工确认\n                message \"Should we continue?\"\n                ok \"Yes, do it.\"\n            }\n            steps {\n                echo 'deploy production'\n            }\n        }\n    }\n}\n```\n\n现在，按照 Git 工作流来提交合并代码，就能够触发 Jenkins 流水线了。\n\n## 总结\n\n这次实践中，在 Jenkins 的使用上采取 master-slave 方式来运行流水线，相比只有 master 节点的工作方式，更加合理，且方便扩展。\n配合 Jenkinsfile 的使用，实现了持续集成，搭建了敏捷开发的基础。\n\n不过对比 `GitHub Actions` 和 `Gitlab CI` 还是略显笨重和*复古*，配置文件的语法相比 `yaml` 也更加晦涩难懂，文档也略显粗糙。\n尽管如此，大多数公司的 CI/CD 还是使用的是 Jenkins，所以是有必要学会的。\n","slug":"Jenkins-多分支-pipeline-配置","published":1,"updated":"2024-04-08T11:35:26.860Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1je000xiubfkl4e4evg","content":"<p>最近恰巧有机会在一台 Centos 物理机上搭建 Jenkins， 也借此机会实践了从 git 提交自动触发 Jenkins build 的工作流，故在此记录，以作备忘。</p><h2 id=\"Jenkins-安装\"><a href=\"#Jenkins-安装\" class=\"headerlink\" title=\"Jenkins 安装\"></a>Jenkins 安装</h2><p>docker 镜像在 <a href=\"https://hub.docker.com/r/jenkins/jenkins\" target=\"_blank\" rel=\"noopener\">https://hub.docker.com/r/jenkins/jenkins</a> 。</p><p>docker-compose.yml 配置如下:</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">\"3\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  jenkins:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">jenkins/jenkins:lts-alpine-jdk11</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">'8180:8080'</span> <span class=\"comment\"># web 端口</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">'50000:50000'</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">./jenkins/:/var/jenkins_home</span> <span class=\"comment\"># 持久化</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"attr\">      TZ:</span> <span class=\"string\">\"Asia/Shanghai\"</span></span><br></pre></td></tr></table></figure><p>需要注意宿主机的 <code>./jenkins/</code> 目录需要将用户和组更改为 <code>1000:1000</code>:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; sudo chown -R 1000:1000 ./jenkins</span><br></pre></td></tr></table></figure><p>启动之后，进入 web 界面，需要输入 admin 的密码，这个密码可以在容器的日志中获得:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; docker-compose logs jenkins <span class=\"comment\"># 查看容器日志</span></span><br></pre></td></tr></table></figure><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jenkins_1  | *************************************************************</span><br><span class=\"line\">jenkins_1  | *************************************************************</span><br><span class=\"line\">jenkins_1  | *************************************************************</span><br><span class=\"line\">jenkins_1  |</span><br><span class=\"line\">jenkins_1  | Jenkins initial setup is required. An admin user has been created and a password generated.</span><br><span class=\"line\">jenkins_1  | Please use the following password to proceed to installation:</span><br><span class=\"line\">jenkins_1  |</span><br><span class=\"line\">jenkins_1  | aee0014b14124efe03c361e1eed93589</span><br><span class=\"line\">jenkins_1  |</span><br><span class=\"line\">jenkins_1  | This may also be found at: /var/jenkins_home/secrets/initialAdminPassword</span><br><span class=\"line\">jenkins_1  |</span><br><span class=\"line\">jenkins_1  | *************************************************************</span><br><span class=\"line\">jenkins_1  | *************************************************************</span><br><span class=\"line\">jenkins_1  | *************************************************************</span><br></pre></td></tr></table></figure><p>接下来建议直接选择安装社区 <code>推荐</code> 的插件，然后进行简单配置后，就可以正常登陆到 Jenkins 控制台了， 然后进行slave节点配置，顺便配置下域名反代。</p><a id=\"more\"></a><h2 id=\"Gitea-安装\"><a href=\"#Gitea-安装\" class=\"headerlink\" title=\"Gitea 安装\"></a>Gitea 安装</h2><p>使用 <code>Gitea</code> 作为私有 git 代码仓库，docker 镜像在: <a href=\"https://hub.docker.com/r/gitea/gitea\" target=\"_blank\" rel=\"noopener\">https://hub.docker.com/r/gitea/gitea</a> 。</p><p>docker-compose.yml 配置如下:</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">\"3\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  server:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">gitea/gitea:1.15.3</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">USER_UID=1000</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">USER_GID=1000</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">./gitea:/data</span> <span class=\"comment\"># 持久化</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/etc/timezone:/etc/timezone:ro</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/etc/localtime:/etc/localtime:ro</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"3000:3000\"</span> <span class=\"comment\"># http 端口</span></span><br></pre></td></tr></table></figure><p>启动后，进入 web 界面进行安装，要注意 URL 里要填写容器内对应的地址。 如果配置了域名并进行反代，需要更改容器内的 <code>app.ini</code> 配置文件:</p><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 由于已经将文件挂载到了宿主机，所以直接修改宿主机文件即可。</span></span><br><span class=\"line\"><span class=\"comment\"># ./gitea/gitea/conf/app.ini</span></span><br><span class=\"line\"><span class=\"section\">[server]</span></span><br><span class=\"line\"><span class=\"attr\">DOMAIN</span>           = gitea.wrzsj.top # 修改成域名</span><br><span class=\"line\"><span class=\"attr\">SSH_DOMAIN</span>       = gitea.wrzsj.top # 修改成域名</span><br><span class=\"line\"><span class=\"attr\">ROOT_URL</span>         = https://gitea.wrzsj.top/ # 修改成域名，可以理解为外部 URL</span><br><span class=\"line\"><span class=\"attr\">LOCAL_ROOT_URL</span>   = http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">3000</span>/ # 添加 LOCAL_ROOT_URL</span><br></pre></td></tr></table></figure><p>修改之后，重启容器 <code>docker-compose restart server</code> 。</p><h2 id=\"CI-CD\"><a href=\"#CI-CD\" class=\"headerlink\" title=\"CI/CD\"></a>CI/CD</h2><p>Jenkins 和 Gitea 都准备好后，接下来就要开始配置 CI/CD 了。</p><h3 id=\"工作流\"><a href=\"#工作流\" class=\"headerlink\" title=\"工作流:\"></a>工作流:</h3><p><img src=\"https://qiniu.wrzsj.top/git-flow\" alt=\"git workflow\"></p><p>git 分支操作:</p><ul><li>从 <code>master</code> 分支切出 <code>dev</code> 分支作为长期迭代分支</li><li>从 <code>dev</code> 分支切出 <code>feat</code> 分支作为功能分支</li><li>在 <code>feat</code> 分支上提交代码，并及时 rebase <code>dev</code> 来保证提交不落后，完成开发后通过 <code>pull request</code> 的方式合并回 <code>dev</code> 分支</li><li>将 <code>dev</code> 分支合并回 <code>master</code> 分支</li><li>在 <code>master</code> 分支上打 tag，用于发布</li></ul><p>对于线上的 bug 修复，应从 <code>master</code> 分支切出 <code>hotfix</code> 分支， 开发完成后合并到 <code>dev</code> 进行测试，测试通过后合并到 <code>master</code> ，然后打 tag 发布。</p><p>CI/CD 触发:</p><ul><li>当 <code>master</code> 和 <code>dev</code> 分支发生 push 时，触发</li><li>当 <code>pull request</code> 创建或有后续 push 时，触发</li><li>每次触发都会执行 build, lint 和 test 任务</li><li>如果由 <code>dev</code> 分支 push 触发，则部署到 QA 环境</li><li>如果由 <code>master</code> 分支 push 触发，会进入打标签阶段，需要人工确认</li><li>打上标签后，会进入部署到生产环境阶段，也需要人工确认</li></ul><h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><h4 id=\"Jenkins-配置\"><a href=\"#Jenkins-配置\" class=\"headerlink\" title=\"Jenkins 配置\"></a>Jenkins 配置</h4><p>安装 <a href=\"https://plugins.jenkins.io/gitea/\" target=\"_blank\" rel=\"noopener\">gitea 插件</a>。</p><p>新建 <code>多分支流水线</code> 任务。</p><p>配置分支源:</p><ul><li>需要设置 <code>Credentials</code> ，使用类型为 <code>Gitea Personal Access Token</code> 的凭证</li><li>添加 <code>Discover branches</code>，策略为 <code>Only branches that are not also filed as PRs</code></li><li>添加 <code>Discover pull requests from origin</code>，策略为 <code>Merging the pull request with the current target branch revision</code></li><li>添加 <code>Discover tags</code></li><li>添加 <code>根据名称过滤（支持通配符)</code>, 包含 <code>master dev release-* PR-*</code><ul><li><code>release-*</code> 用来过滤 tag。在打 tag 的时候，需要有 <code>release-</code> 前缀</li><li><code>PR-*</code> 用来过滤 pull request</li></ul></li><li>添加高级克隆行为，勾选 <code>Fetch tags</code> 和 <code>浅克隆</code>，并设置 <code>浅克隆深度</code> 为 1</li></ul><p>保存配置。</p><h4 id=\"Gitea-配置\"><a href=\"#Gitea-配置\" class=\"headerlink\" title=\"Gitea 配置\"></a>Gitea 配置</h4><p>在代码仓库里配置 <code>webhook</code>:</p><ul><li>添加 <code>Gitea</code> 钩子</li><li>目标 URL 输入: <code>https://jenkins.wrzsj.top/gitea-webhook/post/</code>，注意要加上最后的斜杠 <code>/</code> ！！</li><li>触发条件勾选 <code>所有事件</code></li></ul><p>保存配置。</p><h4 id=\"Jenkinsfile-配置\"><a href=\"#Jenkinsfile-配置\" class=\"headerlink\" title=\"Jenkinsfile 配置\"></a>Jenkinsfile 配置</h4><p>语法参考: <a href=\"https://www.jenkins.io/zh/doc/book/pipeline/syntax/\" target=\"_blank\" rel=\"noopener\">https://www.jenkins.io/zh/doc/book/pipeline/syntax/</a> 。</p><p>由于是 pipeline 类型的任务，需要通过 Jenkinsfile 来触发。在代码中提交 Jenkinsfile 文件:</p><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    options &#123;</span><br><span class=\"line\">        disableConcurrentBuilds() <span class=\"comment\">// 禁用并发构建</span></span><br><span class=\"line\">        timestamps()              <span class=\"comment\">// Console log 中打印时间戳</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">'Build'</span>) &#123;</span><br><span class=\"line\">            when &#123; not &#123; tag <span class=\"string\">'*'</span> &#125; &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                echo <span class=\"string\">'build'</span></span><br><span class=\"line\">                sh <span class=\"string\">'sleep 1'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Lint'</span>) &#123;</span><br><span class=\"line\">            when &#123; not &#123; tag <span class=\"string\">'*'</span> &#125; &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                echo <span class=\"string\">'lint'</span></span><br><span class=\"line\">                sh <span class=\"string\">'sleep 1'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Test'</span>) &#123;</span><br><span class=\"line\">            when &#123; not &#123; tag <span class=\"string\">'*'</span> &#125; &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                echo <span class=\"string\">'test'</span></span><br><span class=\"line\">                sh <span class=\"string\">'sleep 1'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Deploy QA'</span>) &#123;</span><br><span class=\"line\">            when &#123; branch <span class=\"string\">'dev'</span> &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                echo <span class=\"string\">'deploy QA'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Tag on master'</span>) &#123;</span><br><span class=\"line\">            when &#123;</span><br><span class=\"line\">                branch <span class=\"string\">'master'</span></span><br><span class=\"line\">                beforeInput <span class=\"literal\">true</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            input &#123; <span class=\"comment\">// 人工确认</span></span><br><span class=\"line\">                message <span class=\"string\">\"Release a tag?\"</span></span><br><span class=\"line\">                ok <span class=\"string\">\"Yes, do it.\"</span></span><br><span class=\"line\">                parameters &#123;</span><br><span class=\"line\">                    string(<span class=\"string\">name:</span> <span class=\"string\">'milestone'</span>, <span class=\"string\">defaultValue:</span> <span class=\"string\">'regular'</span>, <span class=\"string\">description:</span> <span class=\"string\">'milestone as tag prefix'</span>)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                sh <span class=\"string\">'''</span></span><br><span class=\"line\"><span class=\"string\">                export TAG=release-$&#123;milestone&#125;-$(date +\"%Y%m%d\").$&#123;BUILD_ID&#125;</span></span><br><span class=\"line\"><span class=\"string\">                git tag $&#123;TAG&#125;</span></span><br><span class=\"line\"><span class=\"string\">                git push origin $&#123;TAG&#125;</span></span><br><span class=\"line\"><span class=\"string\">                '''</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Deploy Prod'</span>) &#123;</span><br><span class=\"line\">            when &#123;</span><br><span class=\"line\">                tag <span class=\"string\">'*'</span></span><br><span class=\"line\">                beforeInput <span class=\"literal\">true</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            input &#123; <span class=\"comment\">// 人工确认</span></span><br><span class=\"line\">                message <span class=\"string\">\"Should we continue?\"</span></span><br><span class=\"line\">                ok <span class=\"string\">\"Yes, do it.\"</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                echo <span class=\"string\">'deploy production'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>现在，按照 Git 工作流来提交合并代码，就能够触发 Jenkins 流水线了。</p><h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>这次实践中，在 Jenkins 的使用上采取 master-slave 方式来运行流水线，相比只有 master 节点的工作方式，更加合理，且方便扩展。 配合 Jenkinsfile 的使用，实现了持续集成，搭建了敏捷开发的基础。</p><p>不过对比 <code>GitHub Actions</code> 和 <code>Gitlab CI</code> 还是略显笨重和<em>复古</em>，配置文件的语法相比 <code>yaml</code> 也更加晦涩难懂，文档也略显粗糙。 尽管如此，大多数公司的 CI/CD 还是使用的是 Jenkins，所以是有必要学会的。</p>","site":{"data":{}},"excerpt":"<p>最近恰巧有机会在一台 Centos 物理机上搭建 Jenkins， 也借此机会实践了从 git 提交自动触发 Jenkins build 的工作流，故在此记录，以作备忘。</p><h2 id=\"Jenkins-安装\"><a href=\"#Jenkins-安装\" class=\"headerlink\" title=\"Jenkins 安装\"></a>Jenkins 安装</h2><p>docker 镜像在 <a href=\"https://hub.docker.com/r/jenkins/jenkins\" target=\"_blank\" rel=\"noopener\">https://hub.docker.com/r/jenkins/jenkins</a> 。</p><p>docker-compose.yml 配置如下:</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">\"3\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  jenkins:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">jenkins/jenkins:lts-alpine-jdk11</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">'8180:8080'</span> <span class=\"comment\"># web 端口</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">'50000:50000'</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">./jenkins/:/var/jenkins_home</span> <span class=\"comment\"># 持久化</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"attr\">      TZ:</span> <span class=\"string\">\"Asia/Shanghai\"</span></span><br></pre></td></tr></table></figure><p>需要注意宿主机的 <code>./jenkins/</code> 目录需要将用户和组更改为 <code>1000:1000</code>:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; sudo chown -R 1000:1000 ./jenkins</span><br></pre></td></tr></table></figure><p>启动之后，进入 web 界面，需要输入 admin 的密码，这个密码可以在容器的日志中获得:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; docker-compose logs jenkins <span class=\"comment\"># 查看容器日志</span></span><br></pre></td></tr></table></figure><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jenkins_1  | *************************************************************</span><br><span class=\"line\">jenkins_1  | *************************************************************</span><br><span class=\"line\">jenkins_1  | *************************************************************</span><br><span class=\"line\">jenkins_1  |</span><br><span class=\"line\">jenkins_1  | Jenkins initial setup is required. An admin user has been created and a password generated.</span><br><span class=\"line\">jenkins_1  | Please use the following password to proceed to installation:</span><br><span class=\"line\">jenkins_1  |</span><br><span class=\"line\">jenkins_1  | aee0014b14124efe03c361e1eed93589</span><br><span class=\"line\">jenkins_1  |</span><br><span class=\"line\">jenkins_1  | This may also be found at: /var/jenkins_home/secrets/initialAdminPassword</span><br><span class=\"line\">jenkins_1  |</span><br><span class=\"line\">jenkins_1  | *************************************************************</span><br><span class=\"line\">jenkins_1  | *************************************************************</span><br><span class=\"line\">jenkins_1  | *************************************************************</span><br></pre></td></tr></table></figure><p>接下来建议直接选择安装社区 <code>推荐</code> 的插件，然后进行简单配置后，就可以正常登陆到 Jenkins 控制台了， 然后进行slave节点配置，顺便配置下域名反代。</p>","more":"<h2 id=\"Gitea-安装\"><a href=\"#Gitea-安装\" class=\"headerlink\" title=\"Gitea 安装\"></a>Gitea 安装</h2><p>使用 <code>Gitea</code> 作为私有 git 代码仓库，docker 镜像在: <a href=\"https://hub.docker.com/r/gitea/gitea\" target=\"_blank\" rel=\"noopener\">https://hub.docker.com/r/gitea/gitea</a> 。</p><p>docker-compose.yml 配置如下:</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">\"3\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  server:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">gitea/gitea:1.15.3</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">USER_UID=1000</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">USER_GID=1000</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">./gitea:/data</span> <span class=\"comment\"># 持久化</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/etc/timezone:/etc/timezone:ro</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/etc/localtime:/etc/localtime:ro</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"3000:3000\"</span> <span class=\"comment\"># http 端口</span></span><br></pre></td></tr></table></figure><p>启动后，进入 web 界面进行安装，要注意 URL 里要填写容器内对应的地址。 如果配置了域名并进行反代，需要更改容器内的 <code>app.ini</code> 配置文件:</p><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 由于已经将文件挂载到了宿主机，所以直接修改宿主机文件即可。</span></span><br><span class=\"line\"><span class=\"comment\"># ./gitea/gitea/conf/app.ini</span></span><br><span class=\"line\"><span class=\"section\">[server]</span></span><br><span class=\"line\"><span class=\"attr\">DOMAIN</span>           = gitea.wrzsj.top # 修改成域名</span><br><span class=\"line\"><span class=\"attr\">SSH_DOMAIN</span>       = gitea.wrzsj.top # 修改成域名</span><br><span class=\"line\"><span class=\"attr\">ROOT_URL</span>         = https://gitea.wrzsj.top/ # 修改成域名，可以理解为外部 URL</span><br><span class=\"line\"><span class=\"attr\">LOCAL_ROOT_URL</span>   = http://<span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">3000</span>/ # 添加 LOCAL_ROOT_URL</span><br></pre></td></tr></table></figure><p>修改之后，重启容器 <code>docker-compose restart server</code> 。</p><h2 id=\"CI-CD\"><a href=\"#CI-CD\" class=\"headerlink\" title=\"CI/CD\"></a>CI/CD</h2><p>Jenkins 和 Gitea 都准备好后，接下来就要开始配置 CI/CD 了。</p><h3 id=\"工作流\"><a href=\"#工作流\" class=\"headerlink\" title=\"工作流:\"></a>工作流:</h3><p><img src=\"https://qiniu.wrzsj.top/git-flow\" alt=\"git workflow\"></p><p>git 分支操作:</p><ul><li>从 <code>master</code> 分支切出 <code>dev</code> 分支作为长期迭代分支</li><li>从 <code>dev</code> 分支切出 <code>feat</code> 分支作为功能分支</li><li>在 <code>feat</code> 分支上提交代码，并及时 rebase <code>dev</code> 来保证提交不落后，完成开发后通过 <code>pull request</code> 的方式合并回 <code>dev</code> 分支</li><li>将 <code>dev</code> 分支合并回 <code>master</code> 分支</li><li>在 <code>master</code> 分支上打 tag，用于发布</li></ul><p>对于线上的 bug 修复，应从 <code>master</code> 分支切出 <code>hotfix</code> 分支， 开发完成后合并到 <code>dev</code> 进行测试，测试通过后合并到 <code>master</code> ，然后打 tag 发布。</p><p>CI/CD 触发:</p><ul><li>当 <code>master</code> 和 <code>dev</code> 分支发生 push 时，触发</li><li>当 <code>pull request</code> 创建或有后续 push 时，触发</li><li>每次触发都会执行 build, lint 和 test 任务</li><li>如果由 <code>dev</code> 分支 push 触发，则部署到 QA 环境</li><li>如果由 <code>master</code> 分支 push 触发，会进入打标签阶段，需要人工确认</li><li>打上标签后，会进入部署到生产环境阶段，也需要人工确认</li></ul><h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><h4 id=\"Jenkins-配置\"><a href=\"#Jenkins-配置\" class=\"headerlink\" title=\"Jenkins 配置\"></a>Jenkins 配置</h4><p>安装 <a href=\"https://plugins.jenkins.io/gitea/\" target=\"_blank\" rel=\"noopener\">gitea 插件</a>。</p><p>新建 <code>多分支流水线</code> 任务。</p><p>配置分支源:</p><ul><li>需要设置 <code>Credentials</code> ，使用类型为 <code>Gitea Personal Access Token</code> 的凭证</li><li>添加 <code>Discover branches</code>，策略为 <code>Only branches that are not also filed as PRs</code></li><li>添加 <code>Discover pull requests from origin</code>，策略为 <code>Merging the pull request with the current target branch revision</code></li><li>添加 <code>Discover tags</code></li><li>添加 <code>根据名称过滤（支持通配符)</code>, 包含 <code>master dev release-* PR-*</code><ul><li><code>release-*</code> 用来过滤 tag。在打 tag 的时候，需要有 <code>release-</code> 前缀</li><li><code>PR-*</code> 用来过滤 pull request</li></ul></li><li>添加高级克隆行为，勾选 <code>Fetch tags</code> 和 <code>浅克隆</code>，并设置 <code>浅克隆深度</code> 为 1</li></ul><p>保存配置。</p><h4 id=\"Gitea-配置\"><a href=\"#Gitea-配置\" class=\"headerlink\" title=\"Gitea 配置\"></a>Gitea 配置</h4><p>在代码仓库里配置 <code>webhook</code>:</p><ul><li>添加 <code>Gitea</code> 钩子</li><li>目标 URL 输入: <code>https://jenkins.wrzsj.top/gitea-webhook/post/</code>，注意要加上最后的斜杠 <code>/</code> ！！</li><li>触发条件勾选 <code>所有事件</code></li></ul><p>保存配置。</p><h4 id=\"Jenkinsfile-配置\"><a href=\"#Jenkinsfile-配置\" class=\"headerlink\" title=\"Jenkinsfile 配置\"></a>Jenkinsfile 配置</h4><p>语法参考: <a href=\"https://www.jenkins.io/zh/doc/book/pipeline/syntax/\" target=\"_blank\" rel=\"noopener\">https://www.jenkins.io/zh/doc/book/pipeline/syntax/</a> 。</p><p>由于是 pipeline 类型的任务，需要通过 Jenkinsfile 来触发。在代码中提交 Jenkinsfile 文件:</p><figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    options &#123;</span><br><span class=\"line\">        disableConcurrentBuilds() <span class=\"comment\">// 禁用并发构建</span></span><br><span class=\"line\">        timestamps()              <span class=\"comment\">// Console log 中打印时间戳</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">'Build'</span>) &#123;</span><br><span class=\"line\">            when &#123; not &#123; tag <span class=\"string\">'*'</span> &#125; &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                echo <span class=\"string\">'build'</span></span><br><span class=\"line\">                sh <span class=\"string\">'sleep 1'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Lint'</span>) &#123;</span><br><span class=\"line\">            when &#123; not &#123; tag <span class=\"string\">'*'</span> &#125; &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                echo <span class=\"string\">'lint'</span></span><br><span class=\"line\">                sh <span class=\"string\">'sleep 1'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Test'</span>) &#123;</span><br><span class=\"line\">            when &#123; not &#123; tag <span class=\"string\">'*'</span> &#125; &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                echo <span class=\"string\">'test'</span></span><br><span class=\"line\">                sh <span class=\"string\">'sleep 1'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Deploy QA'</span>) &#123;</span><br><span class=\"line\">            when &#123; branch <span class=\"string\">'dev'</span> &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                echo <span class=\"string\">'deploy QA'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Tag on master'</span>) &#123;</span><br><span class=\"line\">            when &#123;</span><br><span class=\"line\">                branch <span class=\"string\">'master'</span></span><br><span class=\"line\">                beforeInput <span class=\"literal\">true</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            input &#123; <span class=\"comment\">// 人工确认</span></span><br><span class=\"line\">                message <span class=\"string\">\"Release a tag?\"</span></span><br><span class=\"line\">                ok <span class=\"string\">\"Yes, do it.\"</span></span><br><span class=\"line\">                parameters &#123;</span><br><span class=\"line\">                    string(<span class=\"string\">name:</span> <span class=\"string\">'milestone'</span>, <span class=\"string\">defaultValue:</span> <span class=\"string\">'regular'</span>, <span class=\"string\">description:</span> <span class=\"string\">'milestone as tag prefix'</span>)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                sh <span class=\"string\">'''</span></span><br><span class=\"line\"><span class=\"string\">                export TAG=release-$&#123;milestone&#125;-$(date +\"%Y%m%d\").$&#123;BUILD_ID&#125;</span></span><br><span class=\"line\"><span class=\"string\">                git tag $&#123;TAG&#125;</span></span><br><span class=\"line\"><span class=\"string\">                git push origin $&#123;TAG&#125;</span></span><br><span class=\"line\"><span class=\"string\">                '''</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Deploy Prod'</span>) &#123;</span><br><span class=\"line\">            when &#123;</span><br><span class=\"line\">                tag <span class=\"string\">'*'</span></span><br><span class=\"line\">                beforeInput <span class=\"literal\">true</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            input &#123; <span class=\"comment\">// 人工确认</span></span><br><span class=\"line\">                message <span class=\"string\">\"Should we continue?\"</span></span><br><span class=\"line\">                ok <span class=\"string\">\"Yes, do it.\"</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                echo <span class=\"string\">'deploy production'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>现在，按照 Git 工作流来提交合并代码，就能够触发 Jenkins 流水线了。</p><h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>这次实践中，在 Jenkins 的使用上采取 master-slave 方式来运行流水线，相比只有 master 节点的工作方式，更加合理，且方便扩展。 配合 Jenkinsfile 的使用，实现了持续集成，搭建了敏捷开发的基础。</p><p>不过对比 <code>GitHub Actions</code> 和 <code>Gitlab CI</code> 还是略显笨重和<em>复古</em>，配置文件的语法相比 <code>yaml</code> 也更加晦涩难懂，文档也略显粗糙。 尽管如此，大多数公司的 CI/CD 还是使用的是 Jenkins，所以是有必要学会的。</p>"},{"title":"Go Blog 翻译: Fuzzing is Beta Ready","date":"2021-09-15T06:07:06.000Z","_content":"\n# Fuzzing is Beta Ready\n\n> 原文地址 : https://blog.golang.org/fuzz-beta\n>\n> 作者     : Katie Hockman and Jay Conrod\n>\n> 时间     : 3 June 2021\n\n我们兴奋地宣布: 原生 `fuzzing` 已经可供beta测试了，就在 [dev.fuzz](https://github.com/golang/go/tree/dev.fuzz) 中的 development 分支里！\n\n`Fuzzing` 是自动化测试的一种，通过持续操控程序的输入来找出问题，比如说 panic 或 bug。\n这些半随机的变换数据能够覆盖到已有单元测试所遗漏的地方，并且揭露出一些不易察觉的边界 bug。\n正因为 `fuzzing` 可以抵达这些边界情况，fuzz 测试对于查找安全漏洞和弱点是尤为重要的。\n\n详见 [golang.org/s/draft-fuzzing-design](https://golang.org/s/draft-fuzzing-design) 。\n\n## Getting started\n\n你可通过运行下面命令来上手\n\n```sh\n$ go get golang.org/dl/gotip\n$ gotip download dev.fuzz\n```\n\n该操作从 dev.fuzz 的 development 分支构建 Go toolchain，将来一旦代码合并到了 master 分支就不用这样了。\n运行之后，`gotip` 可以看做 go 命令的绿色替代 (drop-in replacement)。\n你现在可以这样运行命令\n\n```sh\n$ gotip test -fuzz=FuzzFoo\n```\n\n因为在 dev.fuzz 分支中会不断地开发和bug修复，所以你应当有规律地执行 `gotip download dev.fuzz`  来应用最新的代码。\n\n为兼容已发行的 Go 版本，在提交含有 `fuzz target` 的源文件到仓库时，要使用 `gofuzzbeta` build tag。\ndev.fuzz 分支中，这个 tag 在 build-time 是默认开启的。\n如果你对 tags 使用有疑问，参考 [the go command documentation about build tags](https://golang.org/cmd/go/#hdr-Build_constraints)。\n\n```go\n// +build gofuzzbeta\n```\n\n<!-- more -->\n\n## Writing a fuzz target\n\n`fuzz target` 必须是 `*_test.go` 文件中以 `FuzzXxx` 形式命名的 function。\n该 function 必须传递一个 `*testing.F` 参数，很类似于传递一个 `*testing.T` 参数到 `TestXxx` function。\n\n下面是个 fuzz target 的例子，用来测试 [net/url 包](https://pkg.go.dev/net/url#ParseQuery) 的行为。\n\n```go\n// +build gofuzzbeta\n\npackage fuzz\n\nimport (\n    \"net/url\"\n    \"reflect\"\n    \"testing\"\n)\n\nfunc FuzzParseQuery(f *testing.F) {\n    f.Add(\"x=1&y=2\")\n    f.Fuzz(func(t *testing.T, queryStr string) {\n        query, err := url.ParseQuery(queryStr)\n        if err != nil {\n            t.Skip()\n        }\n        queryStr2 := query.Encode()\n        query2, err := url.ParseQuery(queryStr2)\n        if err != nil {\n            t.Fatalf(\"ParseQuery failed to decode a valid encoded query %s: %v\", queryStr2, err)\n        }\n        if !reflect.DeepEqual(query, query2) {\n            t.Errorf(\"ParseQuery gave different query after being encoded\\nbefore: %v\\nafter: %v\", query, query2)\n        }\n    })\n}\n```\n\n你可以用 go doc 阅读更多 fuzzing 的 API\n\n```sh\ngotip doc testing\ngotip doc testing.F\ngotip doc testing.F.Add\ngotip doc testing.F.Fuzz\n```\n\n## Expectations\n\n由于这是 development 分支的 beta 发布，所以很可能遭遇 bug 和不完善的 feature。查看 [\"fuzz\" 相关的 issue tracker](https://github.com/golang/go/issues?q=is%3Aopen+is%3Aissue+label%3Afuzz) 来跟进已有的 bug 和 遗漏的 feature。\n\n请注意，fuzzing 很可能会消耗大量内存，在运行过程中也许会影响你机器的性能。`go test -fuzz` 默认是根据 `$GOMAXPROCS` 来并行运行。\n你可以设置 `go test` 的 `-parallel` flag 来降低并行数量。如果想获得更多信息，可执行 `gotip help testflag` go 命令来阅读 go test 命令文档。\n\n也要注意，在运行中，fuzzing 引擎会写入那些扩大测试覆盖的值到 fuzz 缓存目录，位于 `$GOCACHE/fuzz`。\n由于目前还没有文件数量或写入数据大小的限制，所以这可能会占据大量的存储空间 (好几个GB)。你可以通过运行 `gotip clean -fuzzcache` 来清理 fuzz 缓存。\n\n## What’s next?\n\n这个 feature 是不会出现在即将到来的 Go 版本中 (go1.17)，但计划会出现在未来的 Go 版本中。\n我们希望这个还在开发中的原型 feature 会让 Go 开发者开始编写 `fuzz` target 并提供关于设计上有帮助的反馈，为合并到 master 做准备。\n\n如遇任何问题或对 feature 有想法，请 [提 issue](https://github.com/golang/go/issues/new/?&labels=fuzz&title=%5Bdev%2Efuzz%5D&milestone=backlog)。\n\n你可参与 Gophers Slack 的 [#fuzzing channel](https://gophers.slack.com/archives/CH5KV1AKE)，来对 feature 进行讨论或反馈。\n\nHappy fuzzing!\n","source":"_posts/2021-09-15-Go-Blog-翻译-Fuzzing-is-Beta-Ready.md","raw":"---\ntitle: 'Go Blog 翻译: Fuzzing is Beta Ready'\ndate: 2021-09-15 14:07:06\ncategories:\n- [翻译]\n- [笔记]\ntags:\n- golang\n---\n\n# Fuzzing is Beta Ready\n\n> 原文地址 : https://blog.golang.org/fuzz-beta\n>\n> 作者     : Katie Hockman and Jay Conrod\n>\n> 时间     : 3 June 2021\n\n我们兴奋地宣布: 原生 `fuzzing` 已经可供beta测试了，就在 [dev.fuzz](https://github.com/golang/go/tree/dev.fuzz) 中的 development 分支里！\n\n`Fuzzing` 是自动化测试的一种，通过持续操控程序的输入来找出问题，比如说 panic 或 bug。\n这些半随机的变换数据能够覆盖到已有单元测试所遗漏的地方，并且揭露出一些不易察觉的边界 bug。\n正因为 `fuzzing` 可以抵达这些边界情况，fuzz 测试对于查找安全漏洞和弱点是尤为重要的。\n\n详见 [golang.org/s/draft-fuzzing-design](https://golang.org/s/draft-fuzzing-design) 。\n\n## Getting started\n\n你可通过运行下面命令来上手\n\n```sh\n$ go get golang.org/dl/gotip\n$ gotip download dev.fuzz\n```\n\n该操作从 dev.fuzz 的 development 分支构建 Go toolchain，将来一旦代码合并到了 master 分支就不用这样了。\n运行之后，`gotip` 可以看做 go 命令的绿色替代 (drop-in replacement)。\n你现在可以这样运行命令\n\n```sh\n$ gotip test -fuzz=FuzzFoo\n```\n\n因为在 dev.fuzz 分支中会不断地开发和bug修复，所以你应当有规律地执行 `gotip download dev.fuzz`  来应用最新的代码。\n\n为兼容已发行的 Go 版本，在提交含有 `fuzz target` 的源文件到仓库时，要使用 `gofuzzbeta` build tag。\ndev.fuzz 分支中，这个 tag 在 build-time 是默认开启的。\n如果你对 tags 使用有疑问，参考 [the go command documentation about build tags](https://golang.org/cmd/go/#hdr-Build_constraints)。\n\n```go\n// +build gofuzzbeta\n```\n\n<!-- more -->\n\n## Writing a fuzz target\n\n`fuzz target` 必须是 `*_test.go` 文件中以 `FuzzXxx` 形式命名的 function。\n该 function 必须传递一个 `*testing.F` 参数，很类似于传递一个 `*testing.T` 参数到 `TestXxx` function。\n\n下面是个 fuzz target 的例子，用来测试 [net/url 包](https://pkg.go.dev/net/url#ParseQuery) 的行为。\n\n```go\n// +build gofuzzbeta\n\npackage fuzz\n\nimport (\n    \"net/url\"\n    \"reflect\"\n    \"testing\"\n)\n\nfunc FuzzParseQuery(f *testing.F) {\n    f.Add(\"x=1&y=2\")\n    f.Fuzz(func(t *testing.T, queryStr string) {\n        query, err := url.ParseQuery(queryStr)\n        if err != nil {\n            t.Skip()\n        }\n        queryStr2 := query.Encode()\n        query2, err := url.ParseQuery(queryStr2)\n        if err != nil {\n            t.Fatalf(\"ParseQuery failed to decode a valid encoded query %s: %v\", queryStr2, err)\n        }\n        if !reflect.DeepEqual(query, query2) {\n            t.Errorf(\"ParseQuery gave different query after being encoded\\nbefore: %v\\nafter: %v\", query, query2)\n        }\n    })\n}\n```\n\n你可以用 go doc 阅读更多 fuzzing 的 API\n\n```sh\ngotip doc testing\ngotip doc testing.F\ngotip doc testing.F.Add\ngotip doc testing.F.Fuzz\n```\n\n## Expectations\n\n由于这是 development 分支的 beta 发布，所以很可能遭遇 bug 和不完善的 feature。查看 [\"fuzz\" 相关的 issue tracker](https://github.com/golang/go/issues?q=is%3Aopen+is%3Aissue+label%3Afuzz) 来跟进已有的 bug 和 遗漏的 feature。\n\n请注意，fuzzing 很可能会消耗大量内存，在运行过程中也许会影响你机器的性能。`go test -fuzz` 默认是根据 `$GOMAXPROCS` 来并行运行。\n你可以设置 `go test` 的 `-parallel` flag 来降低并行数量。如果想获得更多信息，可执行 `gotip help testflag` go 命令来阅读 go test 命令文档。\n\n也要注意，在运行中，fuzzing 引擎会写入那些扩大测试覆盖的值到 fuzz 缓存目录，位于 `$GOCACHE/fuzz`。\n由于目前还没有文件数量或写入数据大小的限制，所以这可能会占据大量的存储空间 (好几个GB)。你可以通过运行 `gotip clean -fuzzcache` 来清理 fuzz 缓存。\n\n## What’s next?\n\n这个 feature 是不会出现在即将到来的 Go 版本中 (go1.17)，但计划会出现在未来的 Go 版本中。\n我们希望这个还在开发中的原型 feature 会让 Go 开发者开始编写 `fuzz` target 并提供关于设计上有帮助的反馈，为合并到 master 做准备。\n\n如遇任何问题或对 feature 有想法，请 [提 issue](https://github.com/golang/go/issues/new/?&labels=fuzz&title=%5Bdev%2Efuzz%5D&milestone=backlog)。\n\n你可参与 Gophers Slack 的 [#fuzzing channel](https://gophers.slack.com/archives/CH5KV1AKE)，来对 feature 进行讨论或反馈。\n\nHappy fuzzing!\n","slug":"Go-Blog-翻译-Fuzzing-is-Beta-Ready","published":1,"updated":"2023-05-28T05:36:04.286Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1jf000yiubfcj1xq1je","content":"<h1 id=\"Fuzzing-is-Beta-Ready\"><a href=\"#Fuzzing-is-Beta-Ready\" class=\"headerlink\" title=\"Fuzzing is Beta Ready\"></a>Fuzzing is Beta Ready</h1><blockquote><p>原文地址 : <a href=\"https://blog.golang.org/fuzz-beta\" target=\"_blank\" rel=\"noopener\">https://blog.golang.org/fuzz-beta</a></p><p>作者 : Katie Hockman and Jay Conrod</p><p>时间 : 3 June 2021</p></blockquote><p>我们兴奋地宣布: 原生 <code>fuzzing</code> 已经可供beta测试了，就在 <a href=\"https://github.com/golang/go/tree/dev.fuzz\" target=\"_blank\" rel=\"noopener\">dev.fuzz</a> 中的 development 分支里！</p><p><code>Fuzzing</code> 是自动化测试的一种，通过持续操控程序的输入来找出问题，比如说 panic 或 bug。 这些半随机的变换数据能够覆盖到已有单元测试所遗漏的地方，并且揭露出一些不易察觉的边界 bug。 正因为 <code>fuzzing</code> 可以抵达这些边界情况，fuzz 测试对于查找安全漏洞和弱点是尤为重要的。</p><p>详见 <a href=\"https://golang.org/s/draft-fuzzing-design\" target=\"_blank\" rel=\"noopener\">golang.org/s/draft-fuzzing-design</a> 。</p><h2 id=\"Getting-started\"><a href=\"#Getting-started\" class=\"headerlink\" title=\"Getting started\"></a>Getting started</h2><p>你可通过运行下面命令来上手</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ go get golang.org/dl/gotip</span><br><span class=\"line\">$ gotip download dev.fuzz</span><br></pre></td></tr></table></figure><p>该操作从 dev.fuzz 的 development 分支构建 Go toolchain，将来一旦代码合并到了 master 分支就不用这样了。 运行之后，<code>gotip</code> 可以看做 go 命令的绿色替代 (drop-in replacement)。 你现在可以这样运行命令</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ gotip <span class=\"built_in\">test</span> -fuzz=FuzzFoo</span><br></pre></td></tr></table></figure><p>因为在 dev.fuzz 分支中会不断地开发和bug修复，所以你应当有规律地执行 <code>gotip download dev.fuzz</code> 来应用最新的代码。</p><p>为兼容已发行的 Go 版本，在提交含有 <code>fuzz target</code> 的源文件到仓库时，要使用 <code>gofuzzbeta</code> build tag。 dev.fuzz 分支中，这个 tag 在 build-time 是默认开启的。 如果你对 tags 使用有疑问，参考 <a href=\"https://golang.org/cmd/go/#hdr-Build_constraints\" target=\"_blank\" rel=\"noopener\">the go command documentation about build tags</a>。</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// +build gofuzzbeta</span></span><br></pre></td></tr></table></figure><a id=\"more\"></a><h2 id=\"Writing-a-fuzz-target\"><a href=\"#Writing-a-fuzz-target\" class=\"headerlink\" title=\"Writing a fuzz target\"></a>Writing a fuzz target</h2><p><code>fuzz target</code> 必须是 <code>*_test.go</code> 文件中以 <code>FuzzXxx</code> 形式命名的 function。 该 function 必须传递一个 <code>*testing.F</code> 参数，很类似于传递一个 <code>*testing.T</code> 参数到 <code>TestXxx</code> function。</p><p>下面是个 fuzz target 的例子，用来测试 <a href=\"https://pkg.go.dev/net/url#ParseQuery\" target=\"_blank\" rel=\"noopener\">net/url 包</a> 的行为。</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// +build gofuzzbeta</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> fuzz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"net/url\"</span></span><br><span class=\"line\">    <span class=\"string\">\"reflect\"</span></span><br><span class=\"line\">    <span class=\"string\">\"testing\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">FuzzParseQuery</span><span class=\"params\">(f *testing.F)</span></span> &#123;</span><br><span class=\"line\">    f.Add(<span class=\"string\">\"x=1&amp;y=2\"</span>)</span><br><span class=\"line\">    f.Fuzz(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(t *testing.T, queryStr <span class=\"keyword\">string</span>)</span></span> &#123;</span><br><span class=\"line\">        query, err := url.ParseQuery(queryStr)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">            t.Skip()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        queryStr2 := query.Encode()</span><br><span class=\"line\">        query2, err := url.ParseQuery(queryStr2)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">            t.Fatalf(<span class=\"string\">\"ParseQuery failed to decode a valid encoded query %s: %v\"</span>, queryStr2, err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> !reflect.DeepEqual(query, query2) &#123;</span><br><span class=\"line\">            t.Errorf(<span class=\"string\">\"ParseQuery gave different query after being encoded\\nbefore: %v\\nafter: %v\"</span>, query, query2)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>你可以用 go doc 阅读更多 fuzzing 的 API</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gotip doc testing</span><br><span class=\"line\">gotip doc testing.F</span><br><span class=\"line\">gotip doc testing.F.Add</span><br><span class=\"line\">gotip doc testing.F.Fuzz</span><br></pre></td></tr></table></figure><h2 id=\"Expectations\"><a href=\"#Expectations\" class=\"headerlink\" title=\"Expectations\"></a>Expectations</h2><p>由于这是 development 分支的 beta 发布，所以很可能遭遇 bug 和不完善的 feature。查看 <a href=\"https://github.com/golang/go/issues?q=is%3Aopen+is%3Aissue+label%3Afuzz\" target=\"_blank\" rel=\"noopener\">&quot;fuzz&quot; 相关的 issue tracker</a> 来跟进已有的 bug 和 遗漏的 feature。</p><p>请注意，fuzzing 很可能会消耗大量内存，在运行过程中也许会影响你机器的性能。<code>go test -fuzz</code> 默认是根据 <code>$GOMAXPROCS</code> 来并行运行。 你可以设置 <code>go test</code> 的 <code>-parallel</code> flag 来降低并行数量。如果想获得更多信息，可执行 <code>gotip help testflag</code> go 命令来阅读 go test 命令文档。</p><p>也要注意，在运行中，fuzzing 引擎会写入那些扩大测试覆盖的值到 fuzz 缓存目录，位于 <code>$GOCACHE/fuzz</code>。 由于目前还没有文件数量或写入数据大小的限制，所以这可能会占据大量的存储空间 (好几个GB)。你可以通过运行 <code>gotip clean -fuzzcache</code> 来清理 fuzz 缓存。</p><h2 id=\"What’s-next\"><a href=\"#What’s-next\" class=\"headerlink\" title=\"What’s next?\"></a>What’s next?</h2><p>这个 feature 是不会出现在即将到来的 Go 版本中 (go1.17)，但计划会出现在未来的 Go 版本中。 我们希望这个还在开发中的原型 feature 会让 Go 开发者开始编写 <code>fuzz</code> target 并提供关于设计上有帮助的反馈，为合并到 master 做准备。</p><p>如遇任何问题或对 feature 有想法，请 <a href=\"https://github.com/golang/go/issues/new/?&amp;labels=fuzz&amp;title=%5Bdev%2Efuzz%5D&amp;milestone=backlog\" target=\"_blank\" rel=\"noopener\">提 issue</a>。</p><p>你可参与 Gophers Slack 的 <a href=\"https://gophers.slack.com/archives/CH5KV1AKE\" target=\"_blank\" rel=\"noopener\">#fuzzing channel</a>，来对 feature 进行讨论或反馈。</p><p>Happy fuzzing!</p>","site":{"data":{}},"excerpt":"<h1 id=\"Fuzzing-is-Beta-Ready\"><a href=\"#Fuzzing-is-Beta-Ready\" class=\"headerlink\" title=\"Fuzzing is Beta Ready\"></a>Fuzzing is Beta Ready</h1><blockquote><p>原文地址 : <a href=\"https://blog.golang.org/fuzz-beta\" target=\"_blank\" rel=\"noopener\">https://blog.golang.org/fuzz-beta</a></p><p>作者 : Katie Hockman and Jay Conrod</p><p>时间 : 3 June 2021</p></blockquote><p>我们兴奋地宣布: 原生 <code>fuzzing</code> 已经可供beta测试了，就在 <a href=\"https://github.com/golang/go/tree/dev.fuzz\" target=\"_blank\" rel=\"noopener\">dev.fuzz</a> 中的 development 分支里！</p><p><code>Fuzzing</code> 是自动化测试的一种，通过持续操控程序的输入来找出问题，比如说 panic 或 bug。 这些半随机的变换数据能够覆盖到已有单元测试所遗漏的地方，并且揭露出一些不易察觉的边界 bug。 正因为 <code>fuzzing</code> 可以抵达这些边界情况，fuzz 测试对于查找安全漏洞和弱点是尤为重要的。</p><p>详见 <a href=\"https://golang.org/s/draft-fuzzing-design\" target=\"_blank\" rel=\"noopener\">golang.org/s/draft-fuzzing-design</a> 。</p><h2 id=\"Getting-started\"><a href=\"#Getting-started\" class=\"headerlink\" title=\"Getting started\"></a>Getting started</h2><p>你可通过运行下面命令来上手</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ go get golang.org/dl/gotip</span><br><span class=\"line\">$ gotip download dev.fuzz</span><br></pre></td></tr></table></figure><p>该操作从 dev.fuzz 的 development 分支构建 Go toolchain，将来一旦代码合并到了 master 分支就不用这样了。 运行之后，<code>gotip</code> 可以看做 go 命令的绿色替代 (drop-in replacement)。 你现在可以这样运行命令</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ gotip <span class=\"built_in\">test</span> -fuzz=FuzzFoo</span><br></pre></td></tr></table></figure><p>因为在 dev.fuzz 分支中会不断地开发和bug修复，所以你应当有规律地执行 <code>gotip download dev.fuzz</code> 来应用最新的代码。</p><p>为兼容已发行的 Go 版本，在提交含有 <code>fuzz target</code> 的源文件到仓库时，要使用 <code>gofuzzbeta</code> build tag。 dev.fuzz 分支中，这个 tag 在 build-time 是默认开启的。 如果你对 tags 使用有疑问，参考 <a href=\"https://golang.org/cmd/go/#hdr-Build_constraints\" target=\"_blank\" rel=\"noopener\">the go command documentation about build tags</a>。</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// +build gofuzzbeta</span></span><br></pre></td></tr></table></figure>","more":"<h2 id=\"Writing-a-fuzz-target\"><a href=\"#Writing-a-fuzz-target\" class=\"headerlink\" title=\"Writing a fuzz target\"></a>Writing a fuzz target</h2><p><code>fuzz target</code> 必须是 <code>*_test.go</code> 文件中以 <code>FuzzXxx</code> 形式命名的 function。 该 function 必须传递一个 <code>*testing.F</code> 参数，很类似于传递一个 <code>*testing.T</code> 参数到 <code>TestXxx</code> function。</p><p>下面是个 fuzz target 的例子，用来测试 <a href=\"https://pkg.go.dev/net/url#ParseQuery\" target=\"_blank\" rel=\"noopener\">net/url 包</a> 的行为。</p><figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// +build gofuzzbeta</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> fuzz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">    <span class=\"string\">\"net/url\"</span></span><br><span class=\"line\">    <span class=\"string\">\"reflect\"</span></span><br><span class=\"line\">    <span class=\"string\">\"testing\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">FuzzParseQuery</span><span class=\"params\">(f *testing.F)</span></span> &#123;</span><br><span class=\"line\">    f.Add(<span class=\"string\">\"x=1&amp;y=2\"</span>)</span><br><span class=\"line\">    f.Fuzz(<span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(t *testing.T, queryStr <span class=\"keyword\">string</span>)</span></span> &#123;</span><br><span class=\"line\">        query, err := url.ParseQuery(queryStr)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">            t.Skip()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        queryStr2 := query.Encode()</span><br><span class=\"line\">        query2, err := url.ParseQuery(queryStr2)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">            t.Fatalf(<span class=\"string\">\"ParseQuery failed to decode a valid encoded query %s: %v\"</span>, queryStr2, err)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> !reflect.DeepEqual(query, query2) &#123;</span><br><span class=\"line\">            t.Errorf(<span class=\"string\">\"ParseQuery gave different query after being encoded\\nbefore: %v\\nafter: %v\"</span>, query, query2)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>你可以用 go doc 阅读更多 fuzzing 的 API</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gotip doc testing</span><br><span class=\"line\">gotip doc testing.F</span><br><span class=\"line\">gotip doc testing.F.Add</span><br><span class=\"line\">gotip doc testing.F.Fuzz</span><br></pre></td></tr></table></figure><h2 id=\"Expectations\"><a href=\"#Expectations\" class=\"headerlink\" title=\"Expectations\"></a>Expectations</h2><p>由于这是 development 分支的 beta 发布，所以很可能遭遇 bug 和不完善的 feature。查看 <a href=\"https://github.com/golang/go/issues?q=is%3Aopen+is%3Aissue+label%3Afuzz\" target=\"_blank\" rel=\"noopener\">&quot;fuzz&quot; 相关的 issue tracker</a> 来跟进已有的 bug 和 遗漏的 feature。</p><p>请注意，fuzzing 很可能会消耗大量内存，在运行过程中也许会影响你机器的性能。<code>go test -fuzz</code> 默认是根据 <code>$GOMAXPROCS</code> 来并行运行。 你可以设置 <code>go test</code> 的 <code>-parallel</code> flag 来降低并行数量。如果想获得更多信息，可执行 <code>gotip help testflag</code> go 命令来阅读 go test 命令文档。</p><p>也要注意，在运行中，fuzzing 引擎会写入那些扩大测试覆盖的值到 fuzz 缓存目录，位于 <code>$GOCACHE/fuzz</code>。 由于目前还没有文件数量或写入数据大小的限制，所以这可能会占据大量的存储空间 (好几个GB)。你可以通过运行 <code>gotip clean -fuzzcache</code> 来清理 fuzz 缓存。</p><h2 id=\"What’s-next\"><a href=\"#What’s-next\" class=\"headerlink\" title=\"What’s next?\"></a>What’s next?</h2><p>这个 feature 是不会出现在即将到来的 Go 版本中 (go1.17)，但计划会出现在未来的 Go 版本中。 我们希望这个还在开发中的原型 feature 会让 Go 开发者开始编写 <code>fuzz</code> target 并提供关于设计上有帮助的反馈，为合并到 master 做准备。</p><p>如遇任何问题或对 feature 有想法，请 <a href=\"https://github.com/golang/go/issues/new/?&amp;labels=fuzz&amp;title=%5Bdev%2Efuzz%5D&amp;milestone=backlog\" target=\"_blank\" rel=\"noopener\">提 issue</a>。</p><p>你可参与 Gophers Slack 的 <a href=\"https://gophers.slack.com/archives/CH5KV1AKE\" target=\"_blank\" rel=\"noopener\">#fuzzing channel</a>，来对 feature 进行讨论或反馈。</p><p>Happy fuzzing!</p>"},{"title":"Docker 部署 JIRA","date":"2021-09-24T07:27:04.000Z","_content":"\n近日有机会在 Linux 环境中从零开始使用 docker 部署 [JIRA](https://www.atlassian.com/zh/software/jira), 在此记录下部署过程中遇到的问题及解决.\n\n## 镜像选择\n\n在 docker 的镜像仓库中搜索 'jira', 会看到好几个相关的镜像: atlassian/jira-software, atlassian/jira-core 等.\n这里应当选择 [`atlassian/jira-software`](https://hub.docker.com/r/atlassian/jira-software).\n\n## 初次启动\n\n根据 dockerhub 中的描述, 编排出下面的 `docker-compose.yml` 配置:\n\n```yml\nversion: '3'\n\nservices:\n  jira:\n    image: atlassian/jira-software\n    environment:\n      TZ: Asia/Shanghai\n    ports:\n      - \"18081:8080\"\n    volumes:\n      - ./jira-data:/var/atlassian/application-data/jira # 应用数据持久化\n```\n\n启动之后, 进入web界面, 选择手动配置, 然后开始配置 JIRA.\n\n在配置数据库时, 此时还只能选在内置数据库, 不能选择 MySQL 或者 PostgreSQL,\n因为 atlassian/jira-software 镜像中并没有包含连接 MySQL 或 PostgreSQL 的驱动 jar 包.\n接下来就需要去下载对应的 jar 包, 并将其放入容器中特定的目录下, 来完成 MySQL 或 PostgreSQL 的配置.\n\n<!-- more -->\n\n## 载入驱动, 配置 PostgreSQL 数据库\n\n更新 docker-compose.yml 来添加 PostgreSQL 容器, 并与 jira-software 关联上:\n\n```yml\nversion: '3'\n\nservices:\n  jira:\n    image: atlassian/jira-software\n    environment:\n      TZ: Asia/Shanghai\n    depends_on:\n      - postgres # 关联上 postgres\n    ports:\n      - \"18081:8080\"\n    volumes:\n      - ./jira-data:/var/atlassian/application-data/jira # 应用数据持久化\n\n  # 添加 postgres 容器\n  postgres:\n    image: postgres:11-alpine\n    ports:\n      - \"15432:5432\"\n    environment:\n      TZ: Asia/Shanghai\n      POSTGRES_DB: jira\n      POSTGRES_USER: postgres\n      POSTGRES_PASSWORD: postgres\n      POSTGRES_HOST_AUTH_METHOD: trust\n    volumes:\n      - ./pgdata:/var/lib/postgresql/data # 数据库持久化\n\n# 如果是 Mac 环境, 最好是使用单独的 volume 来做数据持久化\n#\n# volumes:\n#  jiradata:\n#    external: false\n#  pgdata:\n#    external: false\n```\n\n至此, 还需要载入 PostgreSQL 驱动, 才能完成数据库的配置.\n\n访问 [startup-check-jira-database-driver-missing](https://confluence.atlassian.com/jirakb/startup-check-jira-database-driver-missing-873872169.html) 可得知对应数据库驱动的下载地址.\n下载得到的 jar 包为 `postgresql-42.2.23.jar`,\n现在需要将其放入 jira-software 容器中的 `/opt/atlassian/jira/lib` 目录下, 使用 `docker cp` 命令即可完成.\n\n重启容器后, PostgreSQL 驱动已完成载入, 可以在 web 界面完成数据库配置了.\n\n## 激(po)活(jie) JIRA\n\n当进行到激活步骤时, 需要提供 license-key 才可激活 JIRA, 然而我并没有购买 license-key, 所以需要一些特殊手段来激活.\n\n由于 jira-software 的版本是 8.x, 需要 [atlassian-agent](https://gitee.com/pengzhile/atlassian-agent) 来提供 license-key 用来激活.\n下载并解压后得到 `atlassian-agent.jar`, 还是需要将其放入 jira-software 容器中的 `/var/local/agent` 目录下(目录可以自己定), 记住这个目录，后面会用到.\n然后进入容器内的 `opt/atlassian/jira/bin` 目录, 修改 `setenv.sh` 文件:\n\n```sh\n# 找到 export JAVA_OPTS\n\nexport JAVA_OPTS\n\n# 仅添加下面这一行. /var/local/agent 为 atlassian-agent.jar 所在目录\nexport JAVA_OPTS=\"-javaagent:/var/local/agent/atlassian-agent.jar ${JAVA_OPTS}\"\n```\n\n重启容器, 可能需要重新配置刚才已经配置过的条目, 直到来到激活步骤. 进入 jira-software 容器的 `/var/local/agent` 目录, 也就是 `atlassian-agent.jar` 所在目录, 执行:\n\n```sh\n$ java -jar atlassian-agent.jar -p jira -m aaa@local.com -n my_name -o https://local.com -s '这里填写 web 页面上的 server id, 或者留空'\n\n# java -jar atlassian-agent.jar -h 可以打印出帮助信息\n```\n\n将 license-key 填入, 方可完成激活.\n\n===\n\n接下来完成剩下的一些配置, JIRA 就按照完毕了.\n\n","source":"_posts/2021-09-24-Docker-部署-JIRA.md","raw":"---\ntitle: Docker 部署 JIRA\ndate: 2021-09-24 15:27:04\ncategories:\n- 笔记\ntags:\n- docker\n---\n\n近日有机会在 Linux 环境中从零开始使用 docker 部署 [JIRA](https://www.atlassian.com/zh/software/jira), 在此记录下部署过程中遇到的问题及解决.\n\n## 镜像选择\n\n在 docker 的镜像仓库中搜索 'jira', 会看到好几个相关的镜像: atlassian/jira-software, atlassian/jira-core 等.\n这里应当选择 [`atlassian/jira-software`](https://hub.docker.com/r/atlassian/jira-software).\n\n## 初次启动\n\n根据 dockerhub 中的描述, 编排出下面的 `docker-compose.yml` 配置:\n\n```yml\nversion: '3'\n\nservices:\n  jira:\n    image: atlassian/jira-software\n    environment:\n      TZ: Asia/Shanghai\n    ports:\n      - \"18081:8080\"\n    volumes:\n      - ./jira-data:/var/atlassian/application-data/jira # 应用数据持久化\n```\n\n启动之后, 进入web界面, 选择手动配置, 然后开始配置 JIRA.\n\n在配置数据库时, 此时还只能选在内置数据库, 不能选择 MySQL 或者 PostgreSQL,\n因为 atlassian/jira-software 镜像中并没有包含连接 MySQL 或 PostgreSQL 的驱动 jar 包.\n接下来就需要去下载对应的 jar 包, 并将其放入容器中特定的目录下, 来完成 MySQL 或 PostgreSQL 的配置.\n\n<!-- more -->\n\n## 载入驱动, 配置 PostgreSQL 数据库\n\n更新 docker-compose.yml 来添加 PostgreSQL 容器, 并与 jira-software 关联上:\n\n```yml\nversion: '3'\n\nservices:\n  jira:\n    image: atlassian/jira-software\n    environment:\n      TZ: Asia/Shanghai\n    depends_on:\n      - postgres # 关联上 postgres\n    ports:\n      - \"18081:8080\"\n    volumes:\n      - ./jira-data:/var/atlassian/application-data/jira # 应用数据持久化\n\n  # 添加 postgres 容器\n  postgres:\n    image: postgres:11-alpine\n    ports:\n      - \"15432:5432\"\n    environment:\n      TZ: Asia/Shanghai\n      POSTGRES_DB: jira\n      POSTGRES_USER: postgres\n      POSTGRES_PASSWORD: postgres\n      POSTGRES_HOST_AUTH_METHOD: trust\n    volumes:\n      - ./pgdata:/var/lib/postgresql/data # 数据库持久化\n\n# 如果是 Mac 环境, 最好是使用单独的 volume 来做数据持久化\n#\n# volumes:\n#  jiradata:\n#    external: false\n#  pgdata:\n#    external: false\n```\n\n至此, 还需要载入 PostgreSQL 驱动, 才能完成数据库的配置.\n\n访问 [startup-check-jira-database-driver-missing](https://confluence.atlassian.com/jirakb/startup-check-jira-database-driver-missing-873872169.html) 可得知对应数据库驱动的下载地址.\n下载得到的 jar 包为 `postgresql-42.2.23.jar`,\n现在需要将其放入 jira-software 容器中的 `/opt/atlassian/jira/lib` 目录下, 使用 `docker cp` 命令即可完成.\n\n重启容器后, PostgreSQL 驱动已完成载入, 可以在 web 界面完成数据库配置了.\n\n## 激(po)活(jie) JIRA\n\n当进行到激活步骤时, 需要提供 license-key 才可激活 JIRA, 然而我并没有购买 license-key, 所以需要一些特殊手段来激活.\n\n由于 jira-software 的版本是 8.x, 需要 [atlassian-agent](https://gitee.com/pengzhile/atlassian-agent) 来提供 license-key 用来激活.\n下载并解压后得到 `atlassian-agent.jar`, 还是需要将其放入 jira-software 容器中的 `/var/local/agent` 目录下(目录可以自己定), 记住这个目录，后面会用到.\n然后进入容器内的 `opt/atlassian/jira/bin` 目录, 修改 `setenv.sh` 文件:\n\n```sh\n# 找到 export JAVA_OPTS\n\nexport JAVA_OPTS\n\n# 仅添加下面这一行. /var/local/agent 为 atlassian-agent.jar 所在目录\nexport JAVA_OPTS=\"-javaagent:/var/local/agent/atlassian-agent.jar ${JAVA_OPTS}\"\n```\n\n重启容器, 可能需要重新配置刚才已经配置过的条目, 直到来到激活步骤. 进入 jira-software 容器的 `/var/local/agent` 目录, 也就是 `atlassian-agent.jar` 所在目录, 执行:\n\n```sh\n$ java -jar atlassian-agent.jar -p jira -m aaa@local.com -n my_name -o https://local.com -s '这里填写 web 页面上的 server id, 或者留空'\n\n# java -jar atlassian-agent.jar -h 可以打印出帮助信息\n```\n\n将 license-key 填入, 方可完成激活.\n\n===\n\n接下来完成剩下的一些配置, JIRA 就按照完毕了.\n\n","slug":"Docker-部署-JIRA","published":1,"updated":"2023-05-28T05:36:04.286Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1jf000ziubfqk0yp27g","content":"<p>近日有机会在 Linux 环境中从零开始使用 docker 部署 <a href=\"https://www.atlassian.com/zh/software/jira\" target=\"_blank\" rel=\"noopener\">JIRA</a>, 在此记录下部署过程中遇到的问题及解决.</p><h2 id=\"镜像选择\"><a href=\"#镜像选择\" class=\"headerlink\" title=\"镜像选择\"></a>镜像选择</h2><p>在 docker 的镜像仓库中搜索 &#39;jira&#39;, 会看到好几个相关的镜像: atlassian/jira-software, atlassian/jira-core 等. 这里应当选择 <a href=\"https://hub.docker.com/r/atlassian/jira-software\" target=\"_blank\" rel=\"noopener\"><code>atlassian/jira-software</code></a>.</p><h2 id=\"初次启动\"><a href=\"#初次启动\" class=\"headerlink\" title=\"初次启动\"></a>初次启动</h2><p>根据 dockerhub 中的描述, 编排出下面的 <code>docker-compose.yml</code> 配置:</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">'3'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  jira:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">atlassian/jira-software</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"attr\">      TZ:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"18081:8080\"</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">./jira-data:/var/atlassian/application-data/jira</span> <span class=\"comment\"># 应用数据持久化</span></span><br></pre></td></tr></table></figure><p>启动之后, 进入web界面, 选择手动配置, 然后开始配置 JIRA.</p><p>在配置数据库时, 此时还只能选在内置数据库, 不能选择 MySQL 或者 PostgreSQL, 因为 atlassian/jira-software 镜像中并没有包含连接 MySQL 或 PostgreSQL 的驱动 jar 包. 接下来就需要去下载对应的 jar 包, 并将其放入容器中特定的目录下, 来完成 MySQL 或 PostgreSQL 的配置.</p><a id=\"more\"></a><h2 id=\"载入驱动-配置-PostgreSQL-数据库\"><a href=\"#载入驱动-配置-PostgreSQL-数据库\" class=\"headerlink\" title=\"载入驱动, 配置 PostgreSQL 数据库\"></a>载入驱动, 配置 PostgreSQL 数据库</h2><p>更新 docker-compose.yml 来添加 PostgreSQL 容器, 并与 jira-software 关联上:</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">'3'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  jira:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">atlassian/jira-software</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"attr\">      TZ:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"attr\">    depends_on:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">postgres</span> <span class=\"comment\"># 关联上 postgres</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"18081:8080\"</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">./jira-data:/var/atlassian/application-data/jira</span> <span class=\"comment\"># 应用数据持久化</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 添加 postgres 容器</span></span><br><span class=\"line\"><span class=\"attr\">  postgres:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"attr\">postgres:11-alpine</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"15432:5432\"</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"attr\">      TZ:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"attr\">      POSTGRES_DB:</span> <span class=\"string\">jira</span></span><br><span class=\"line\"><span class=\"attr\">      POSTGRES_USER:</span> <span class=\"string\">postgres</span></span><br><span class=\"line\"><span class=\"attr\">      POSTGRES_PASSWORD:</span> <span class=\"string\">postgres</span></span><br><span class=\"line\"><span class=\"attr\">      POSTGRES_HOST_AUTH_METHOD:</span> <span class=\"string\">trust</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">./pgdata:/var/lib/postgresql/data</span> <span class=\"comment\"># 数据库持久化</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果是 Mac 环境, 最好是使用单独的 volume 来做数据持久化</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># volumes:</span></span><br><span class=\"line\"><span class=\"comment\">#  jiradata:</span></span><br><span class=\"line\"><span class=\"comment\">#    external: false</span></span><br><span class=\"line\"><span class=\"comment\">#  pgdata:</span></span><br><span class=\"line\"><span class=\"comment\">#    external: false</span></span><br></pre></td></tr></table></figure><p>至此, 还需要载入 PostgreSQL 驱动, 才能完成数据库的配置.</p><p>访问 <a href=\"https://confluence.atlassian.com/jirakb/startup-check-jira-database-driver-missing-873872169.html\" target=\"_blank\" rel=\"noopener\">startup-check-jira-database-driver-missing</a> 可得知对应数据库驱动的下载地址. 下载得到的 jar 包为 <code>postgresql-42.2.23.jar</code>, 现在需要将其放入 jira-software 容器中的 <code>/opt/atlassian/jira/lib</code> 目录下, 使用 <code>docker cp</code> 命令即可完成.</p><p>重启容器后, PostgreSQL 驱动已完成载入, 可以在 web 界面完成数据库配置了.</p><h2 id=\"激-po-活-jie-JIRA\"><a href=\"#激-po-活-jie-JIRA\" class=\"headerlink\" title=\"激(po)活(jie) JIRA\"></a>激(po)活(jie) JIRA</h2><p>当进行到激活步骤时, 需要提供 license-key 才可激活 JIRA, 然而我并没有购买 license-key, 所以需要一些特殊手段来激活.</p><p>由于 jira-software 的版本是 8.x, 需要 <a href=\"https://gitee.com/pengzhile/atlassian-agent\" target=\"_blank\" rel=\"noopener\">atlassian-agent</a> 来提供 license-key 用来激活. 下载并解压后得到 <code>atlassian-agent.jar</code>, 还是需要将其放入 jira-software 容器中的 <code>/var/local/agent</code> 目录下(目录可以自己定), 记住这个目录，后面会用到. 然后进入容器内的 <code>opt/atlassian/jira/bin</code> 目录, 修改 <code>setenv.sh</code> 文件:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 找到 export JAVA_OPTS</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_OPTS</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 仅添加下面这一行. /var/local/agent 为 atlassian-agent.jar 所在目录</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_OPTS=<span class=\"string\">\"-javaagent:/var/local/agent/atlassian-agent.jar <span class=\"variable\">$&#123;JAVA_OPTS&#125;</span>\"</span></span><br></pre></td></tr></table></figure><p>重启容器, 可能需要重新配置刚才已经配置过的条目, 直到来到激活步骤. 进入 jira-software 容器的 <code>/var/local/agent</code> 目录, 也就是 <code>atlassian-agent.jar</code> 所在目录, 执行:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ java -jar atlassian-agent.jar -p jira -m aaa@local.com -n my_name -o https://local.com -s <span class=\"string\">'这里填写 web 页面上的 server id, 或者留空'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># java -jar atlassian-agent.jar -h 可以打印出帮助信息</span></span><br></pre></td></tr></table></figure><p>将 license-key 填入, 方可完成激活.</p><p>===</p><p>接下来完成剩下的一些配置, JIRA 就按照完毕了.</p>","site":{"data":{}},"excerpt":"<p>近日有机会在 Linux 环境中从零开始使用 docker 部署 <a href=\"https://www.atlassian.com/zh/software/jira\" target=\"_blank\" rel=\"noopener\">JIRA</a>, 在此记录下部署过程中遇到的问题及解决.</p><h2 id=\"镜像选择\"><a href=\"#镜像选择\" class=\"headerlink\" title=\"镜像选择\"></a>镜像选择</h2><p>在 docker 的镜像仓库中搜索 &#39;jira&#39;, 会看到好几个相关的镜像: atlassian/jira-software, atlassian/jira-core 等. 这里应当选择 <a href=\"https://hub.docker.com/r/atlassian/jira-software\" target=\"_blank\" rel=\"noopener\"><code>atlassian/jira-software</code></a>.</p><h2 id=\"初次启动\"><a href=\"#初次启动\" class=\"headerlink\" title=\"初次启动\"></a>初次启动</h2><p>根据 dockerhub 中的描述, 编排出下面的 <code>docker-compose.yml</code> 配置:</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">'3'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  jira:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">atlassian/jira-software</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"attr\">      TZ:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"18081:8080\"</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">./jira-data:/var/atlassian/application-data/jira</span> <span class=\"comment\"># 应用数据持久化</span></span><br></pre></td></tr></table></figure><p>启动之后, 进入web界面, 选择手动配置, 然后开始配置 JIRA.</p><p>在配置数据库时, 此时还只能选在内置数据库, 不能选择 MySQL 或者 PostgreSQL, 因为 atlassian/jira-software 镜像中并没有包含连接 MySQL 或 PostgreSQL 的驱动 jar 包. 接下来就需要去下载对应的 jar 包, 并将其放入容器中特定的目录下, 来完成 MySQL 或 PostgreSQL 的配置.</p>","more":"<h2 id=\"载入驱动-配置-PostgreSQL-数据库\"><a href=\"#载入驱动-配置-PostgreSQL-数据库\" class=\"headerlink\" title=\"载入驱动, 配置 PostgreSQL 数据库\"></a>载入驱动, 配置 PostgreSQL 数据库</h2><p>更新 docker-compose.yml 来添加 PostgreSQL 容器, 并与 jira-software 关联上:</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">'3'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"><span class=\"attr\">  jira:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">atlassian/jira-software</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"attr\">      TZ:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"attr\">    depends_on:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">postgres</span> <span class=\"comment\"># 关联上 postgres</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"18081:8080\"</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">./jira-data:/var/atlassian/application-data/jira</span> <span class=\"comment\"># 应用数据持久化</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 添加 postgres 容器</span></span><br><span class=\"line\"><span class=\"attr\">  postgres:</span></span><br><span class=\"line\"><span class=\"attr\">    image:</span> <span class=\"attr\">postgres:11-alpine</span></span><br><span class=\"line\"><span class=\"attr\">    ports:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">\"15432:5432\"</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span></span><br><span class=\"line\"><span class=\"attr\">      TZ:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"attr\">      POSTGRES_DB:</span> <span class=\"string\">jira</span></span><br><span class=\"line\"><span class=\"attr\">      POSTGRES_USER:</span> <span class=\"string\">postgres</span></span><br><span class=\"line\"><span class=\"attr\">      POSTGRES_PASSWORD:</span> <span class=\"string\">postgres</span></span><br><span class=\"line\"><span class=\"attr\">      POSTGRES_HOST_AUTH_METHOD:</span> <span class=\"string\">trust</span></span><br><span class=\"line\"><span class=\"attr\">    volumes:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">./pgdata:/var/lib/postgresql/data</span> <span class=\"comment\"># 数据库持久化</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果是 Mac 环境, 最好是使用单独的 volume 来做数据持久化</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># volumes:</span></span><br><span class=\"line\"><span class=\"comment\">#  jiradata:</span></span><br><span class=\"line\"><span class=\"comment\">#    external: false</span></span><br><span class=\"line\"><span class=\"comment\">#  pgdata:</span></span><br><span class=\"line\"><span class=\"comment\">#    external: false</span></span><br></pre></td></tr></table></figure><p>至此, 还需要载入 PostgreSQL 驱动, 才能完成数据库的配置.</p><p>访问 <a href=\"https://confluence.atlassian.com/jirakb/startup-check-jira-database-driver-missing-873872169.html\" target=\"_blank\" rel=\"noopener\">startup-check-jira-database-driver-missing</a> 可得知对应数据库驱动的下载地址. 下载得到的 jar 包为 <code>postgresql-42.2.23.jar</code>, 现在需要将其放入 jira-software 容器中的 <code>/opt/atlassian/jira/lib</code> 目录下, 使用 <code>docker cp</code> 命令即可完成.</p><p>重启容器后, PostgreSQL 驱动已完成载入, 可以在 web 界面完成数据库配置了.</p><h2 id=\"激-po-活-jie-JIRA\"><a href=\"#激-po-活-jie-JIRA\" class=\"headerlink\" title=\"激(po)活(jie) JIRA\"></a>激(po)活(jie) JIRA</h2><p>当进行到激活步骤时, 需要提供 license-key 才可激活 JIRA, 然而我并没有购买 license-key, 所以需要一些特殊手段来激活.</p><p>由于 jira-software 的版本是 8.x, 需要 <a href=\"https://gitee.com/pengzhile/atlassian-agent\" target=\"_blank\" rel=\"noopener\">atlassian-agent</a> 来提供 license-key 用来激活. 下载并解压后得到 <code>atlassian-agent.jar</code>, 还是需要将其放入 jira-software 容器中的 <code>/var/local/agent</code> 目录下(目录可以自己定), 记住这个目录，后面会用到. 然后进入容器内的 <code>opt/atlassian/jira/bin</code> 目录, 修改 <code>setenv.sh</code> 文件:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 找到 export JAVA_OPTS</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_OPTS</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 仅添加下面这一行. /var/local/agent 为 atlassian-agent.jar 所在目录</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_OPTS=<span class=\"string\">\"-javaagent:/var/local/agent/atlassian-agent.jar <span class=\"variable\">$&#123;JAVA_OPTS&#125;</span>\"</span></span><br></pre></td></tr></table></figure><p>重启容器, 可能需要重新配置刚才已经配置过的条目, 直到来到激活步骤. 进入 jira-software 容器的 <code>/var/local/agent</code> 目录, 也就是 <code>atlassian-agent.jar</code> 所在目录, 执行:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ java -jar atlassian-agent.jar -p jira -m aaa@local.com -n my_name -o https://local.com -s <span class=\"string\">'这里填写 web 页面上的 server id, 或者留空'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># java -jar atlassian-agent.jar -h 可以打印出帮助信息</span></span><br></pre></td></tr></table></figure><p>将 license-key 填入, 方可完成激活.</p><p>===</p><p>接下来完成剩下的一些配置, JIRA 就按照完毕了.</p>"},{"title":"利用 Github Action 部署博客","date":"2021-10-09T06:05:20.000Z","_content":"\n\n之前的博客是需要在我本地电脑上手动执行命令来部署的:\n\n```sh\n> make deploy\n```\n\n如今已经成功将这个部署的过程迁移到了 Github Actions。\n整个 workflow 包括 npm 依赖的安装和缓存，将 Markdown 生成静态 html 文件，和部署到服务器。\n\n配置如下:\n\n```yml\nname: deploy\n\non:\n  push:\n    branches:\n      - 'master' # 只会在 master 分支发生 push 事件时，才触发\n\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    environment: # 环境变量在 github 项目的设置页面里进行配置\n      name: deploy # 这里需要手动进行授权，才会进行job\n    steps:\n      - name: Checkout Code\n        uses: actions/checkout@v2\n\n      # 指定 nodejs 版本\n      - name: Setup Nodejs\n        uses: actions/setup-node@v2\n        with:\n          node-version: '12'\n\n      # 依赖缓存设置\n      - name: Cache node dependency\n        uses: actions/cache@v2\n        with:\n          path: ~/.npm # 缓存目录\n          key: cache-node-${{ hashFiles('**/package-lock.json') }} # 缓存的key\n          restore-keys: | # 恢复缓存时要去匹配的key\n            cache-node-\n            cache-\n\n      # 安装 npm 依赖包\n      - name: Install dependency\n        run: npm install\n\n      # 生成静态文件\n      - name: Build to static\n        run: make build\n\n      # 部署到服务器，使用 rsync 来传递文件\n      - name: Deploy to server\n        uses: burnett01/rsync-deployments@5.1\n        with:\n          switches: -azvhP --delete\n          path: ./public/\n          remote_path: ${{ secrets.SSH_REMOTE_PATH }} # secrets 在 github 项目的设置页面里进行配置\n          remote_user: ${{ secrets.SSH_USER }}\n          remote_host: ${{ secrets.SSH_HOST }}\n          remote_port: ${{ secrets.SSH_PORT }}\n          remote_key: ${{ secrets.SSH_SECRET }}\n```\n","source":"_posts/2021-10-09-利用-Github-Action-部署博客.md","raw":"---\ntitle: 利用 Github Action 部署博客\ndate: 2021-10-09 14:05:20\ncategories:\n- 笔记\ntags:\n- CI\n- Github Actions\n---\n\n\n之前的博客是需要在我本地电脑上手动执行命令来部署的:\n\n```sh\n> make deploy\n```\n\n如今已经成功将这个部署的过程迁移到了 Github Actions。\n整个 workflow 包括 npm 依赖的安装和缓存，将 Markdown 生成静态 html 文件，和部署到服务器。\n\n配置如下:\n\n```yml\nname: deploy\n\non:\n  push:\n    branches:\n      - 'master' # 只会在 master 分支发生 push 事件时，才触发\n\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    environment: # 环境变量在 github 项目的设置页面里进行配置\n      name: deploy # 这里需要手动进行授权，才会进行job\n    steps:\n      - name: Checkout Code\n        uses: actions/checkout@v2\n\n      # 指定 nodejs 版本\n      - name: Setup Nodejs\n        uses: actions/setup-node@v2\n        with:\n          node-version: '12'\n\n      # 依赖缓存设置\n      - name: Cache node dependency\n        uses: actions/cache@v2\n        with:\n          path: ~/.npm # 缓存目录\n          key: cache-node-${{ hashFiles('**/package-lock.json') }} # 缓存的key\n          restore-keys: | # 恢复缓存时要去匹配的key\n            cache-node-\n            cache-\n\n      # 安装 npm 依赖包\n      - name: Install dependency\n        run: npm install\n\n      # 生成静态文件\n      - name: Build to static\n        run: make build\n\n      # 部署到服务器，使用 rsync 来传递文件\n      - name: Deploy to server\n        uses: burnett01/rsync-deployments@5.1\n        with:\n          switches: -azvhP --delete\n          path: ./public/\n          remote_path: ${{ secrets.SSH_REMOTE_PATH }} # secrets 在 github 项目的设置页面里进行配置\n          remote_user: ${{ secrets.SSH_USER }}\n          remote_host: ${{ secrets.SSH_HOST }}\n          remote_port: ${{ secrets.SSH_PORT }}\n          remote_key: ${{ secrets.SSH_SECRET }}\n```\n","slug":"利用-Github-Action-部署博客","published":1,"updated":"2023-05-28T05:36:04.287Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1jf0010iubflhwbslgh","content":"<p>之前的博客是需要在我本地电脑上手动执行命令来部署的:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; make deploy</span><br></pre></td></tr></table></figure><p>如今已经成功将这个部署的过程迁移到了 Github Actions。 整个 workflow 包括 npm 依赖的安装和缓存，将 Markdown 生成静态 html 文件，和部署到服务器。</p><p>配置如下:</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">deploy</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">on:</span></span><br><span class=\"line\"><span class=\"attr\">  push:</span></span><br><span class=\"line\"><span class=\"attr\">    branches:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">'master'</span> <span class=\"comment\"># 只会在 master 分支发生 push 事件时，才触发</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">jobs:</span></span><br><span class=\"line\"><span class=\"attr\">  deploy:</span></span><br><span class=\"line\"><span class=\"attr\">    runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span> <span class=\"comment\"># 环境变量在 github 项目的设置页面里进行配置</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">deploy</span> <span class=\"comment\"># 这里需要手动进行授权，才会进行job</span></span><br><span class=\"line\"><span class=\"attr\">    steps:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">Checkout</span> <span class=\"string\">Code</span></span><br><span class=\"line\"><span class=\"attr\">        uses:</span> <span class=\"string\">actions/checkout@v2</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 指定 nodejs 版本</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">Setup</span> <span class=\"string\">Nodejs</span></span><br><span class=\"line\"><span class=\"attr\">        uses:</span> <span class=\"string\">actions/setup-node@v2</span></span><br><span class=\"line\"><span class=\"attr\">        with:</span></span><br><span class=\"line\"><span class=\"attr\">          node-version:</span> <span class=\"string\">'12'</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 依赖缓存设置</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">Cache</span> <span class=\"string\">node</span> <span class=\"string\">dependency</span></span><br><span class=\"line\"><span class=\"attr\">        uses:</span> <span class=\"string\">actions/cache@v2</span></span><br><span class=\"line\"><span class=\"attr\">        with:</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">~/.npm</span> <span class=\"comment\"># 缓存目录</span></span><br><span class=\"line\"><span class=\"attr\">          key:</span> <span class=\"string\">cache-node-$&#123;&#123;</span> <span class=\"string\">hashFiles('**/package-lock.json')</span> <span class=\"string\">&#125;&#125;</span> <span class=\"comment\"># 缓存的key</span></span><br><span class=\"line\"><span class=\"attr\">          restore-keys:</span> <span class=\"string\">| # 恢复缓存时要去匹配的key</span></span><br><span class=\"line\"><span class=\"string\">            cache-node-</span></span><br><span class=\"line\"><span class=\"string\">            cache-</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">      # 安装 npm 依赖包</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">      - name:</span> <span class=\"string\">Install</span> <span class=\"string\">dependency</span></span><br><span class=\"line\"><span class=\"attr\">        run:</span> <span class=\"string\">npm</span> <span class=\"string\">install</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 生成静态文件</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">Build</span> <span class=\"string\">to</span> <span class=\"string\">static</span></span><br><span class=\"line\"><span class=\"attr\">        run:</span> <span class=\"string\">make</span> <span class=\"string\">build</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 部署到服务器，使用 rsync 来传递文件</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">Deploy</span> <span class=\"string\">to</span> <span class=\"string\">server</span></span><br><span class=\"line\"><span class=\"attr\">        uses:</span> <span class=\"string\">burnett01/rsync-deployments@5.1</span></span><br><span class=\"line\"><span class=\"attr\">        with:</span></span><br><span class=\"line\"><span class=\"attr\">          switches:</span> <span class=\"bullet\">-azvhP</span> <span class=\"bullet\">--delete</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">./public/</span></span><br><span class=\"line\"><span class=\"attr\">          remote_path:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.SSH_REMOTE_PATH</span> <span class=\"string\">&#125;&#125;</span> <span class=\"comment\"># secrets 在 github 项目的设置页面里进行配置</span></span><br><span class=\"line\"><span class=\"attr\">          remote_user:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.SSH_USER</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">          remote_host:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.SSH_HOST</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">          remote_port:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.SSH_PORT</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">          remote_key:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.SSH_SECRET</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>之前的博客是需要在我本地电脑上手动执行命令来部署的:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; make deploy</span><br></pre></td></tr></table></figure><p>如今已经成功将这个部署的过程迁移到了 Github Actions。 整个 workflow 包括 npm 依赖的安装和缓存，将 Markdown 生成静态 html 文件，和部署到服务器。</p><p>配置如下:</p><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">deploy</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">on:</span></span><br><span class=\"line\"><span class=\"attr\">  push:</span></span><br><span class=\"line\"><span class=\"attr\">    branches:</span></span><br><span class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">'master'</span> <span class=\"comment\"># 只会在 master 分支发生 push 事件时，才触发</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">jobs:</span></span><br><span class=\"line\"><span class=\"attr\">  deploy:</span></span><br><span class=\"line\"><span class=\"attr\">    runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\"><span class=\"attr\">    environment:</span> <span class=\"comment\"># 环境变量在 github 项目的设置页面里进行配置</span></span><br><span class=\"line\"><span class=\"attr\">      name:</span> <span class=\"string\">deploy</span> <span class=\"comment\"># 这里需要手动进行授权，才会进行job</span></span><br><span class=\"line\"><span class=\"attr\">    steps:</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">Checkout</span> <span class=\"string\">Code</span></span><br><span class=\"line\"><span class=\"attr\">        uses:</span> <span class=\"string\">actions/checkout@v2</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 指定 nodejs 版本</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">Setup</span> <span class=\"string\">Nodejs</span></span><br><span class=\"line\"><span class=\"attr\">        uses:</span> <span class=\"string\">actions/setup-node@v2</span></span><br><span class=\"line\"><span class=\"attr\">        with:</span></span><br><span class=\"line\"><span class=\"attr\">          node-version:</span> <span class=\"string\">'12'</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 依赖缓存设置</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">Cache</span> <span class=\"string\">node</span> <span class=\"string\">dependency</span></span><br><span class=\"line\"><span class=\"attr\">        uses:</span> <span class=\"string\">actions/cache@v2</span></span><br><span class=\"line\"><span class=\"attr\">        with:</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">~/.npm</span> <span class=\"comment\"># 缓存目录</span></span><br><span class=\"line\"><span class=\"attr\">          key:</span> <span class=\"string\">cache-node-$&#123;&#123;</span> <span class=\"string\">hashFiles('**/package-lock.json')</span> <span class=\"string\">&#125;&#125;</span> <span class=\"comment\"># 缓存的key</span></span><br><span class=\"line\"><span class=\"attr\">          restore-keys:</span> <span class=\"string\">| # 恢复缓存时要去匹配的key</span></span><br><span class=\"line\"><span class=\"string\">            cache-node-</span></span><br><span class=\"line\"><span class=\"string\">            cache-</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">      # 安装 npm 依赖包</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">      - name:</span> <span class=\"string\">Install</span> <span class=\"string\">dependency</span></span><br><span class=\"line\"><span class=\"attr\">        run:</span> <span class=\"string\">npm</span> <span class=\"string\">install</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 生成静态文件</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">Build</span> <span class=\"string\">to</span> <span class=\"string\">static</span></span><br><span class=\"line\"><span class=\"attr\">        run:</span> <span class=\"string\">make</span> <span class=\"string\">build</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 部署到服务器，使用 rsync 来传递文件</span></span><br><span class=\"line\"><span class=\"attr\">      - name:</span> <span class=\"string\">Deploy</span> <span class=\"string\">to</span> <span class=\"string\">server</span></span><br><span class=\"line\"><span class=\"attr\">        uses:</span> <span class=\"string\">burnett01/rsync-deployments@5.1</span></span><br><span class=\"line\"><span class=\"attr\">        with:</span></span><br><span class=\"line\"><span class=\"attr\">          switches:</span> <span class=\"bullet\">-azvhP</span> <span class=\"bullet\">--delete</span></span><br><span class=\"line\"><span class=\"attr\">          path:</span> <span class=\"string\">./public/</span></span><br><span class=\"line\"><span class=\"attr\">          remote_path:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.SSH_REMOTE_PATH</span> <span class=\"string\">&#125;&#125;</span> <span class=\"comment\"># secrets 在 github 项目的设置页面里进行配置</span></span><br><span class=\"line\"><span class=\"attr\">          remote_user:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.SSH_USER</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">          remote_host:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.SSH_HOST</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">          remote_port:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.SSH_PORT</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\"><span class=\"attr\">          remote_key:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.SSH_SECRET</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure>"},{"title":"Homebrew 安装 disabled formula","date":"2021-12-07T08:25:50.000Z","_content":"\n## 安装还在仓库里的 formula\n\n如果需要用 Homebrew 安装已经被 disable 掉的 formula，例如需要安装 v1.12 版本的 golang, 使用 `brew install go@1.12` 是无法安装的，需要修改对应的 formula 脚本:\n\n```sh\n> brew edit go@1.12\n```\n\n该操作会在默认的编辑器中打开位于 `/usr/local/Homebrew/Library/Taps/homebrew/homebrew-core/Formula` 目录下的\n<code>go&#64;1.12.rb</code> 脚本文件。\n\n编辑脚本文件，找到 `disable` 方法的调用，并注释掉，例如:\n\n```ruby\nclass GoAT112 < Formula\n  desc \"Go programming environment (1.12)\"\n  homepage \"https://golang.org\"\n  url \"https://dl.google.com/go/go1.12.17.src.tar.gz\"\n  mirror \"https://fossies.org/linux/misc/go1.12.17.src.tar.gz\"\n  sha256 \"de878218c43aa3c3bad54c1c52d95e3b0e5d336e1285c647383e775541a28b25\"\n  license \"BSD-3-Clause\"\n\n  # ......\n\n  keg_only :versioned_formula\n\n  disable! date: \"2021-02-16\", because: :unsupported # **就是这一行** TODO: 注释掉\n\n  depends_on arch: :x86_64\n\n  # ......\n```\n\n之后，再次使用 `brew install go@1.12` ，虽然会有 warning 但最终还是可以顺利安装 v1.12 版本的 golang 。\n\n## 安装已给移除仓库的 formula\n\n通过 github 仓库搜索 <code>go&#64;1.12.rb</code>, 在 commits 中找到对应的提交。将 rb 文件保存到本地, 例如: <code>go&#64;1.12.rb</code> 。\n然后执行:\n\n```sh\n> HOMEBREW_NO_INSTALL_FROM_API=1 brew install ./go@1.12.rb\n```\n","source":"_posts/2021-12-07-Homebrew-安装-disabled-formula.md","raw":"---\ntitle: Homebrew 安装 disabled formula\ndate: 2021-12-07 16:25:50\ncategories:\n- 笔记\ntags:\n- mac\n---\n\n## 安装还在仓库里的 formula\n\n如果需要用 Homebrew 安装已经被 disable 掉的 formula，例如需要安装 v1.12 版本的 golang, 使用 `brew install go@1.12` 是无法安装的，需要修改对应的 formula 脚本:\n\n```sh\n> brew edit go@1.12\n```\n\n该操作会在默认的编辑器中打开位于 `/usr/local/Homebrew/Library/Taps/homebrew/homebrew-core/Formula` 目录下的\n<code>go&#64;1.12.rb</code> 脚本文件。\n\n编辑脚本文件，找到 `disable` 方法的调用，并注释掉，例如:\n\n```ruby\nclass GoAT112 < Formula\n  desc \"Go programming environment (1.12)\"\n  homepage \"https://golang.org\"\n  url \"https://dl.google.com/go/go1.12.17.src.tar.gz\"\n  mirror \"https://fossies.org/linux/misc/go1.12.17.src.tar.gz\"\n  sha256 \"de878218c43aa3c3bad54c1c52d95e3b0e5d336e1285c647383e775541a28b25\"\n  license \"BSD-3-Clause\"\n\n  # ......\n\n  keg_only :versioned_formula\n\n  disable! date: \"2021-02-16\", because: :unsupported # **就是这一行** TODO: 注释掉\n\n  depends_on arch: :x86_64\n\n  # ......\n```\n\n之后，再次使用 `brew install go@1.12` ，虽然会有 warning 但最终还是可以顺利安装 v1.12 版本的 golang 。\n\n## 安装已给移除仓库的 formula\n\n通过 github 仓库搜索 <code>go&#64;1.12.rb</code>, 在 commits 中找到对应的提交。将 rb 文件保存到本地, 例如: <code>go&#64;1.12.rb</code> 。\n然后执行:\n\n```sh\n> HOMEBREW_NO_INSTALL_FROM_API=1 brew install ./go@1.12.rb\n```\n","slug":"Homebrew-安装-disabled-formula","published":1,"updated":"2023-06-16T01:47:35.189Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1jg0011iubf8hzijse5","content":"<h2 id=\"安装还在仓库里的-formula\"><a href=\"#安装还在仓库里的-formula\" class=\"headerlink\" title=\"安装还在仓库里的 formula\"></a>安装还在仓库里的 formula</h2><p>如果需要用 Homebrew 安装已经被 disable 掉的 formula，例如需要安装 v1.12 版本的 golang, 使用 <code>brew install go@1.12</code> 是无法安装的，需要修改对应的 formula 脚本:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; brew edit go@1.12</span><br></pre></td></tr></table></figure><p>该操作会在默认的编辑器中打开位于 <code>/usr/local/Homebrew/Library/Taps/homebrew/homebrew-core/Formula</code> 目录下的 <code>go&#64;1.12.rb</code> 脚本文件。</p><p>编辑脚本文件，找到 <code>disable</code> 方法的调用，并注释掉，例如:</p><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GoAT112</span> &lt; Formula</span></span><br><span class=\"line\">  desc <span class=\"string\">\"Go programming environment (1.12)\"</span></span><br><span class=\"line\">  homepage <span class=\"string\">\"https://golang.org\"</span></span><br><span class=\"line\">  url <span class=\"string\">\"https://dl.google.com/go/go1.12.17.src.tar.gz\"</span></span><br><span class=\"line\">  mirror <span class=\"string\">\"https://fossies.org/linux/misc/go1.12.17.src.tar.gz\"</span></span><br><span class=\"line\">  sha256 <span class=\"string\">\"de878218c43aa3c3bad54c1c52d95e3b0e5d336e1285c647383e775541a28b25\"</span></span><br><span class=\"line\">  license <span class=\"string\">\"BSD-3-Clause\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ......</span></span><br><span class=\"line\"></span><br><span class=\"line\">  keg_only <span class=\"symbol\">:versioned_formula</span></span><br><span class=\"line\"></span><br><span class=\"line\">  disable! <span class=\"symbol\">date:</span> <span class=\"string\">\"2021-02-16\"</span>, <span class=\"symbol\">because:</span> <span class=\"symbol\">:unsupported</span> <span class=\"comment\"># **就是这一行** <span class=\"doctag\">TODO:</span> 注释掉</span></span><br><span class=\"line\"></span><br><span class=\"line\">  depends_on <span class=\"symbol\">arch:</span> <span class=\"symbol\">:x86_64</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ......</span></span><br></pre></td></tr></table></figure><p>之后，再次使用 <code>brew install go@1.12</code> ，虽然会有 warning 但最终还是可以顺利安装 v1.12 版本的 golang 。</p><h2 id=\"安装已给移除仓库的-formula\"><a href=\"#安装已给移除仓库的-formula\" class=\"headerlink\" title=\"安装已给移除仓库的 formula\"></a>安装已给移除仓库的 formula</h2><p>通过 github 仓库搜索 <code>go&#64;1.12.rb</code>, 在 commits 中找到对应的提交。将 rb 文件保存到本地, 例如: <code>go&#64;1.12.rb</code> 。 然后执行:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; HOMEBREW_NO_INSTALL_FROM_API=1 brew install ./go@1.12.rb</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"安装还在仓库里的-formula\"><a href=\"#安装还在仓库里的-formula\" class=\"headerlink\" title=\"安装还在仓库里的 formula\"></a>安装还在仓库里的 formula</h2><p>如果需要用 Homebrew 安装已经被 disable 掉的 formula，例如需要安装 v1.12 版本的 golang, 使用 <code>brew install go@1.12</code> 是无法安装的，需要修改对应的 formula 脚本:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; brew edit go@1.12</span><br></pre></td></tr></table></figure><p>该操作会在默认的编辑器中打开位于 <code>/usr/local/Homebrew/Library/Taps/homebrew/homebrew-core/Formula</code> 目录下的 <code>go&#64;1.12.rb</code> 脚本文件。</p><p>编辑脚本文件，找到 <code>disable</code> 方法的调用，并注释掉，例如:</p><figure class=\"highlight ruby\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GoAT112</span> &lt; Formula</span></span><br><span class=\"line\">  desc <span class=\"string\">\"Go programming environment (1.12)\"</span></span><br><span class=\"line\">  homepage <span class=\"string\">\"https://golang.org\"</span></span><br><span class=\"line\">  url <span class=\"string\">\"https://dl.google.com/go/go1.12.17.src.tar.gz\"</span></span><br><span class=\"line\">  mirror <span class=\"string\">\"https://fossies.org/linux/misc/go1.12.17.src.tar.gz\"</span></span><br><span class=\"line\">  sha256 <span class=\"string\">\"de878218c43aa3c3bad54c1c52d95e3b0e5d336e1285c647383e775541a28b25\"</span></span><br><span class=\"line\">  license <span class=\"string\">\"BSD-3-Clause\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ......</span></span><br><span class=\"line\"></span><br><span class=\"line\">  keg_only <span class=\"symbol\">:versioned_formula</span></span><br><span class=\"line\"></span><br><span class=\"line\">  disable! <span class=\"symbol\">date:</span> <span class=\"string\">\"2021-02-16\"</span>, <span class=\"symbol\">because:</span> <span class=\"symbol\">:unsupported</span> <span class=\"comment\"># **就是这一行** <span class=\"doctag\">TODO:</span> 注释掉</span></span><br><span class=\"line\"></span><br><span class=\"line\">  depends_on <span class=\"symbol\">arch:</span> <span class=\"symbol\">:x86_64</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># ......</span></span><br></pre></td></tr></table></figure><p>之后，再次使用 <code>brew install go@1.12</code> ，虽然会有 warning 但最终还是可以顺利安装 v1.12 版本的 golang 。</p><h2 id=\"安装已给移除仓库的-formula\"><a href=\"#安装已给移除仓库的-formula\" class=\"headerlink\" title=\"安装已给移除仓库的 formula\"></a>安装已给移除仓库的 formula</h2><p>通过 github 仓库搜索 <code>go&#64;1.12.rb</code>, 在 commits 中找到对应的提交。将 rb 文件保存到本地, 例如: <code>go&#64;1.12.rb</code> 。 然后执行:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; HOMEBREW_NO_INSTALL_FROM_API=1 brew install ./go@1.12.rb</span><br></pre></td></tr></table></figure>"},{"title":"disable mds_stores","date":"2022-11-10T07:04:04.000Z","_content":"\n记几个命令行，用来暂停/恢复 spotlight 搜索的索引进程:\n\n---\n\nAs you know, the mds and mds_stores are Spotlight activities.\n\nThe reason why your Spotlight is so active could be a number of things; it could be you have an app or multiple apps constantly changing some folder contents.\n\nFirst let's check whether Spotlight is the cause of the fans running so much. To test this, run the following in your terminal:\n\n```sh\nsudo mdutil -a -i off # 暂停索引建立\n```\n\nthis turns off indexing of files, and should result in a clear slow down of the fans if `mds` and/or `mds_stores` are to blame.\n\nTo turn indexing back on, run:\n\n```sh\nsudo mdutil -a -i on # 恢复索引建立\n```\n\nAfter this you could run the complete re-indexing of your hard drive (be aware this could be an over night job),\nit will delete your Spotlight data base forcing it to start over.\n\n```sh\nsudo rm -rf /System/Volumes/Data/.Spotlight-V100/*\n```\n\nThe next and final step would be to add others to your (do not scan), privacy settings.\n\n> 参考自: https://apple.stackexchange.com/questions/144474/mds-and-mds-stores-constantly-consuming-cpu\n\n---\n\n`mdutil` 用法:\n\n```sh\n$ mdutil --help\nmdutil: unrecognized option `--help'\nUsage: mdutil -pEsa -i (on|off) -d volume ...\n       mdutil -t {volume-path | deviceid} fileid\n\tUtility to manage Spotlight indexes.\n\t-i (on|off)    Turn indexing on or off.\n\t-d             Disable Spotlight activity for volume (re-enable using -i on).\n\t-E             Erase and rebuild index.\n\t-s             Print indexing status.\n\t-a             Apply command to all stores on all volumes.\n\t-t             Resolve files from file id with an optional volume path or device id.\n\t-p             Publish metadata.\n\t-V vol         Apply command to all stores on the specified volume.\n\t-v             Display verbose information.\n\t-r plugins     Ask the server to reimport files for UTIs claimed by the listed plugin.\n\t-L volume-path List the directory contents of the Spotlight index on the specified volume.\n\t-P volume-path Dump the VolumeConfig.plist for the specified volume.\n\t-X volume-path Remove the Spotlight index directory on the specified volume.  Does not disable indexing.\n\t               Spotlight will reevaluate volume when it is unmounted and remounted, the\n\t               machine is rebooted, or an explicit index command such as 'mdutil -i' or 'mdutil -E' is\n\t               run for the volume.\nNOTE: Run as owner for network homes, otherwise run as root.\n```\n","source":"_posts/2022-11-10-disable-mds-stores.md","raw":"---\ntitle: disable mds_stores\ndate: 2022-11-10 15:04:04\ncategories:\n- 笔记\ntags:\n- mac\n---\n\n记几个命令行，用来暂停/恢复 spotlight 搜索的索引进程:\n\n---\n\nAs you know, the mds and mds_stores are Spotlight activities.\n\nThe reason why your Spotlight is so active could be a number of things; it could be you have an app or multiple apps constantly changing some folder contents.\n\nFirst let's check whether Spotlight is the cause of the fans running so much. To test this, run the following in your terminal:\n\n```sh\nsudo mdutil -a -i off # 暂停索引建立\n```\n\nthis turns off indexing of files, and should result in a clear slow down of the fans if `mds` and/or `mds_stores` are to blame.\n\nTo turn indexing back on, run:\n\n```sh\nsudo mdutil -a -i on # 恢复索引建立\n```\n\nAfter this you could run the complete re-indexing of your hard drive (be aware this could be an over night job),\nit will delete your Spotlight data base forcing it to start over.\n\n```sh\nsudo rm -rf /System/Volumes/Data/.Spotlight-V100/*\n```\n\nThe next and final step would be to add others to your (do not scan), privacy settings.\n\n> 参考自: https://apple.stackexchange.com/questions/144474/mds-and-mds-stores-constantly-consuming-cpu\n\n---\n\n`mdutil` 用法:\n\n```sh\n$ mdutil --help\nmdutil: unrecognized option `--help'\nUsage: mdutil -pEsa -i (on|off) -d volume ...\n       mdutil -t {volume-path | deviceid} fileid\n\tUtility to manage Spotlight indexes.\n\t-i (on|off)    Turn indexing on or off.\n\t-d             Disable Spotlight activity for volume (re-enable using -i on).\n\t-E             Erase and rebuild index.\n\t-s             Print indexing status.\n\t-a             Apply command to all stores on all volumes.\n\t-t             Resolve files from file id with an optional volume path or device id.\n\t-p             Publish metadata.\n\t-V vol         Apply command to all stores on the specified volume.\n\t-v             Display verbose information.\n\t-r plugins     Ask the server to reimport files for UTIs claimed by the listed plugin.\n\t-L volume-path List the directory contents of the Spotlight index on the specified volume.\n\t-P volume-path Dump the VolumeConfig.plist for the specified volume.\n\t-X volume-path Remove the Spotlight index directory on the specified volume.  Does not disable indexing.\n\t               Spotlight will reevaluate volume when it is unmounted and remounted, the\n\t               machine is rebooted, or an explicit index command such as 'mdutil -i' or 'mdutil -E' is\n\t               run for the volume.\nNOTE: Run as owner for network homes, otherwise run as root.\n```\n","slug":"disable-mds-stores","published":1,"updated":"2023-05-28T05:36:04.287Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1jh0012iubf3wg3gliv","content":"<p>记几个命令行，用来暂停/恢复 spotlight 搜索的索引进程:</p><hr><p>As you know, the mds and mds_stores are Spotlight activities.</p><p>The reason why your Spotlight is so active could be a number of things; it could be you have an app or multiple apps constantly changing some folder contents.</p><p>First let&#39;s check whether Spotlight is the cause of the fans running so much. To test this, run the following in your terminal:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo mdutil -a -i off <span class=\"comment\"># 暂停索引建立</span></span><br></pre></td></tr></table></figure><p>this turns off indexing of files, and should result in a clear slow down of the fans if <code>mds</code> and/or <code>mds_stores</code> are to blame.</p><p>To turn indexing back on, run:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo mdutil -a -i on <span class=\"comment\"># 恢复索引建立</span></span><br></pre></td></tr></table></figure><p>After this you could run the complete re-indexing of your hard drive (be aware this could be an over night job), it will delete your Spotlight data base forcing it to start over.</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo rm -rf /System/Volumes/Data/.Spotlight-V100/*</span><br></pre></td></tr></table></figure><p>The next and final step would be to add others to your (do not scan), privacy settings.</p><blockquote><p>参考自: <a href=\"https://apple.stackexchange.com/questions/144474/mds-and-mds-stores-constantly-consuming-cpu\" target=\"_blank\" rel=\"noopener\">https://apple.stackexchange.com/questions/144474/mds-and-mds-stores-constantly-consuming-cpu</a></p></blockquote><hr><p><code>mdutil</code> 用法:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mdutil --<span class=\"built_in\">help</span></span><br><span class=\"line\">mdutil: unrecognized option `--<span class=\"built_in\">help</span><span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">Usage: mdutil -pEsa -i (on|off) -d volume ...</span></span><br><span class=\"line\"><span class=\"string\">       mdutil -t &#123;volume-path | deviceid&#125; fileid</span></span><br><span class=\"line\"><span class=\"string\">\tUtility to manage Spotlight indexes.</span></span><br><span class=\"line\"><span class=\"string\">\t-i (on|off)    Turn indexing on or off.</span></span><br><span class=\"line\"><span class=\"string\">\t-d             Disable Spotlight activity for volume (re-enable using -i on).</span></span><br><span class=\"line\"><span class=\"string\">\t-E             Erase and rebuild index.</span></span><br><span class=\"line\"><span class=\"string\">\t-s             Print indexing status.</span></span><br><span class=\"line\"><span class=\"string\">\t-a             Apply command to all stores on all volumes.</span></span><br><span class=\"line\"><span class=\"string\">\t-t             Resolve files from file id with an optional volume path or device id.</span></span><br><span class=\"line\"><span class=\"string\">\t-p             Publish metadata.</span></span><br><span class=\"line\"><span class=\"string\">\t-V vol         Apply command to all stores on the specified volume.</span></span><br><span class=\"line\"><span class=\"string\">\t-v             Display verbose information.</span></span><br><span class=\"line\"><span class=\"string\">\t-r plugins     Ask the server to reimport files for UTIs claimed by the listed plugin.</span></span><br><span class=\"line\"><span class=\"string\">\t-L volume-path List the directory contents of the Spotlight index on the specified volume.</span></span><br><span class=\"line\"><span class=\"string\">\t-P volume-path Dump the VolumeConfig.plist for the specified volume.</span></span><br><span class=\"line\"><span class=\"string\">\t-X volume-path Remove the Spotlight index directory on the specified volume.  Does not disable indexing.</span></span><br><span class=\"line\"><span class=\"string\">\t               Spotlight will reevaluate volume when it is unmounted and remounted, the</span></span><br><span class=\"line\"><span class=\"string\">\t               machine is rebooted, or an explicit index command such as '</span>mdutil -i<span class=\"string\">' or '</span>mdutil -E<span class=\"string\">' is</span></span><br><span class=\"line\"><span class=\"string\">\t               run for the volume.</span></span><br><span class=\"line\"><span class=\"string\">NOTE: Run as owner for network homes, otherwise run as root.</span></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>记几个命令行，用来暂停/恢复 spotlight 搜索的索引进程:</p><hr><p>As you know, the mds and mds_stores are Spotlight activities.</p><p>The reason why your Spotlight is so active could be a number of things; it could be you have an app or multiple apps constantly changing some folder contents.</p><p>First let&#39;s check whether Spotlight is the cause of the fans running so much. To test this, run the following in your terminal:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo mdutil -a -i off <span class=\"comment\"># 暂停索引建立</span></span><br></pre></td></tr></table></figure><p>this turns off indexing of files, and should result in a clear slow down of the fans if <code>mds</code> and/or <code>mds_stores</code> are to blame.</p><p>To turn indexing back on, run:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo mdutil -a -i on <span class=\"comment\"># 恢复索引建立</span></span><br></pre></td></tr></table></figure><p>After this you could run the complete re-indexing of your hard drive (be aware this could be an over night job), it will delete your Spotlight data base forcing it to start over.</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo rm -rf /System/Volumes/Data/.Spotlight-V100/*</span><br></pre></td></tr></table></figure><p>The next and final step would be to add others to your (do not scan), privacy settings.</p><blockquote><p>参考自: <a href=\"https://apple.stackexchange.com/questions/144474/mds-and-mds-stores-constantly-consuming-cpu\" target=\"_blank\" rel=\"noopener\">https://apple.stackexchange.com/questions/144474/mds-and-mds-stores-constantly-consuming-cpu</a></p></blockquote><hr><p><code>mdutil</code> 用法:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mdutil --<span class=\"built_in\">help</span></span><br><span class=\"line\">mdutil: unrecognized option `--<span class=\"built_in\">help</span><span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">Usage: mdutil -pEsa -i (on|off) -d volume ...</span></span><br><span class=\"line\"><span class=\"string\">       mdutil -t &#123;volume-path | deviceid&#125; fileid</span></span><br><span class=\"line\"><span class=\"string\">\tUtility to manage Spotlight indexes.</span></span><br><span class=\"line\"><span class=\"string\">\t-i (on|off)    Turn indexing on or off.</span></span><br><span class=\"line\"><span class=\"string\">\t-d             Disable Spotlight activity for volume (re-enable using -i on).</span></span><br><span class=\"line\"><span class=\"string\">\t-E             Erase and rebuild index.</span></span><br><span class=\"line\"><span class=\"string\">\t-s             Print indexing status.</span></span><br><span class=\"line\"><span class=\"string\">\t-a             Apply command to all stores on all volumes.</span></span><br><span class=\"line\"><span class=\"string\">\t-t             Resolve files from file id with an optional volume path or device id.</span></span><br><span class=\"line\"><span class=\"string\">\t-p             Publish metadata.</span></span><br><span class=\"line\"><span class=\"string\">\t-V vol         Apply command to all stores on the specified volume.</span></span><br><span class=\"line\"><span class=\"string\">\t-v             Display verbose information.</span></span><br><span class=\"line\"><span class=\"string\">\t-r plugins     Ask the server to reimport files for UTIs claimed by the listed plugin.</span></span><br><span class=\"line\"><span class=\"string\">\t-L volume-path List the directory contents of the Spotlight index on the specified volume.</span></span><br><span class=\"line\"><span class=\"string\">\t-P volume-path Dump the VolumeConfig.plist for the specified volume.</span></span><br><span class=\"line\"><span class=\"string\">\t-X volume-path Remove the Spotlight index directory on the specified volume.  Does not disable indexing.</span></span><br><span class=\"line\"><span class=\"string\">\t               Spotlight will reevaluate volume when it is unmounted and remounted, the</span></span><br><span class=\"line\"><span class=\"string\">\t               machine is rebooted, or an explicit index command such as '</span>mdutil -i<span class=\"string\">' or '</span>mdutil -E<span class=\"string\">' is</span></span><br><span class=\"line\"><span class=\"string\">\t               run for the volume.</span></span><br><span class=\"line\"><span class=\"string\">NOTE: Run as owner for network homes, otherwise run as root.</span></span><br></pre></td></tr></table></figure>"},{"title":"Nginx 反代 go module","date":"2023-03-15T10:38:44.000Z","_content":"\n在特定情况下，用 nginx 反代 git 仓库，且避免出现 `go get meta tag did not match import path` 的报错。\n\n配置如下:\n\n```sh\nlocation / {\n    if ($query_string ~ \"go-get=1\") {\n        set $condition goget;\n    }\n    if ($uri ~ ^/([a-zA-Z0-9_\\-\\.]+)/([a-zA-Z0-9_\\-\\.]+).*$) {\n        set $condition \"${condition}path\";\n    }\n    if ($condition = gogetpath) {\n        return 200 '\n        <!DOCTYPE html>\n        <html>\n        <head>\n            <meta name=\"go-import\" content=\"$host/$1/$2 git http://$host/$1/$2.git\">\n            <meta name=\"go-source\" content=\"$host/$1/$2 _ http://$host/$1/$2/src/mster{/dir} http://$host/$1/$2/src/master{/dir}/file#L{line}\">\n        </head>\n        <body>\n        $uri\n        </body>\n        </html>\n        ';\n    }\n\n    proxy_pass http://原本的git仓库;\n}\n```\n\n后续 go get 时，可能出现 `terminal prompts disabled` 的报错，使用 `GIT_TERMINAL_PROMPT=1 go get` 方可化解。\n","source":"_posts/2023-03-15-Nginx-反代-go-module.md","raw":"---\ntitle: Nginx 反代 go module\ndate: 2023-03-15 18:38:44\ncategories:\n- 笔记\ntags:\n- nginx\n- golang\n---\n\n在特定情况下，用 nginx 反代 git 仓库，且避免出现 `go get meta tag did not match import path` 的报错。\n\n配置如下:\n\n```sh\nlocation / {\n    if ($query_string ~ \"go-get=1\") {\n        set $condition goget;\n    }\n    if ($uri ~ ^/([a-zA-Z0-9_\\-\\.]+)/([a-zA-Z0-9_\\-\\.]+).*$) {\n        set $condition \"${condition}path\";\n    }\n    if ($condition = gogetpath) {\n        return 200 '\n        <!DOCTYPE html>\n        <html>\n        <head>\n            <meta name=\"go-import\" content=\"$host/$1/$2 git http://$host/$1/$2.git\">\n            <meta name=\"go-source\" content=\"$host/$1/$2 _ http://$host/$1/$2/src/mster{/dir} http://$host/$1/$2/src/master{/dir}/file#L{line}\">\n        </head>\n        <body>\n        $uri\n        </body>\n        </html>\n        ';\n    }\n\n    proxy_pass http://原本的git仓库;\n}\n```\n\n后续 go get 时，可能出现 `terminal prompts disabled` 的报错，使用 `GIT_TERMINAL_PROMPT=1 go get` 方可化解。\n","slug":"Nginx-反代-go-module","published":1,"updated":"2023-05-28T05:36:04.287Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1ji0013iubfidj5doci","content":"<p>在特定情况下，用 nginx 反代 git 仓库，且避免出现 <code>go get meta tag did not match import path</code> 的报错。</p><p>配置如下:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location / &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$query_string</span> ~ <span class=\"string\">\"go-get=1\"</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">set</span> <span class=\"variable\">$condition</span> goget;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$uri</span> ~ ^/([a-zA-Z0-9_\\-\\.]+)/([a-zA-Z0-9_\\-\\.]+).*$) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">set</span> <span class=\"variable\">$condition</span> <span class=\"string\">\"<span class=\"variable\">$&#123;condition&#125;</span>path\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$condition</span> = gogetpath) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">return</span> 200 <span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">        &lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;html&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;head&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;meta name=\"go-import\" content=\"$host/$1/$2 git http://$host/$1/$2.git\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;meta name=\"go-source\" content=\"$host/$1/$2 _ http://$host/$1/$2/src/mster&#123;/dir&#125; http://$host/$1/$2/src/master&#123;/dir&#125;/file#L&#123;line&#125;\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;/head&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;body&gt;</span></span><br><span class=\"line\"><span class=\"string\">        $uri</span></span><br><span class=\"line\"><span class=\"string\">        &lt;/body&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;/html&gt;</span></span><br><span class=\"line\"><span class=\"string\">        '</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    proxy_pass http://原本的git仓库;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>后续 go get 时，可能出现 <code>terminal prompts disabled</code> 的报错，使用 <code>GIT_TERMINAL_PROMPT=1 go get</code> 方可化解。</p>","site":{"data":{}},"excerpt":"","more":"<p>在特定情况下，用 nginx 反代 git 仓库，且避免出现 <code>go get meta tag did not match import path</code> 的报错。</p><p>配置如下:</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location / &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$query_string</span> ~ <span class=\"string\">\"go-get=1\"</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">set</span> <span class=\"variable\">$condition</span> goget;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$uri</span> ~ ^/([a-zA-Z0-9_\\-\\.]+)/([a-zA-Z0-9_\\-\\.]+).*$) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">set</span> <span class=\"variable\">$condition</span> <span class=\"string\">\"<span class=\"variable\">$&#123;condition&#125;</span>path\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$condition</span> = gogetpath) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">return</span> 200 <span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">        &lt;!DOCTYPE html&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;html&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;head&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;meta name=\"go-import\" content=\"$host/$1/$2 git http://$host/$1/$2.git\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;meta name=\"go-source\" content=\"$host/$1/$2 _ http://$host/$1/$2/src/mster&#123;/dir&#125; http://$host/$1/$2/src/master&#123;/dir&#125;/file#L&#123;line&#125;\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;/head&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;body&gt;</span></span><br><span class=\"line\"><span class=\"string\">        $uri</span></span><br><span class=\"line\"><span class=\"string\">        &lt;/body&gt;</span></span><br><span class=\"line\"><span class=\"string\">        &lt;/html&gt;</span></span><br><span class=\"line\"><span class=\"string\">        '</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    proxy_pass http://原本的git仓库;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><p>后续 go get 时，可能出现 <code>terminal prompts disabled</code> 的报错，使用 <code>GIT_TERMINAL_PROMPT=1 go get</code> 方可化解。</p>"},{"title":"温故 base64 编码","date":"2021-10-18T08:06:59.000Z","_content":"\n温故 `base64` 编码过程。\n\n虽然现在绝大多数编程语言都已经在标准库中实现了 base64 编码和解码，但还是要时不时回顾其原理。\n\n## 编码原理\n\n**TLDR: 将 `8 位` 二进制串 **分割为** 多个 `4 个 6 位` 二进制串，参考 https://zh.wikipedia.org/wiki/Base64 。**\n\n- 将每个字符都转换成对应的 `ASCII` 码\n- 将每个 `ASCII` 码由十进制转为 8 位二进制\n- 将这些二进制按照每 6 位分进行分隔，4 个 6 位二进制位 `一组` ，若在分隔的时候，位数不够则用 0 填补在末尾\n- 将这些 6 位的二进制重新转为十进制，并根据十进制数在 `base64 索引表` 中找到对应的编码。\n- 若构不成 `一组`，则用 `=` 号填补在末尾\n\n编码 (encode) 过程如下:\n\n<table id=\"tb\">\n    <tbody>\n        <tr id=\"tr-text\">\n            <td>Text</td>\n            <!-- inserted in js script -->\n        </tr>\n        <tr id=\"tr-ascii\">\n            <td>ASCII</td>\n            <!-- inserted in js script -->\n        </tr>\n        <tr id=\"tr-bits\">\n            <td>8 Bit</td>\n            <!-- inserted in js script -->\n        </tr>\n        <tr id=\"tr-index\">\n            <td>Index</td>\n            <!-- inserted in js script -->\n        </tr>\n        <tr id=\"tr-base64\">\n            <td>Base64</td>\n            <!-- inserted in js script -->\n        </tr>\n    </tbody>\n</table>\n\n<style>\n#tb td {\n    padding: 0;\n    margin: 0;\n    text-align: center;\n    min-width: 1em;\n}\n</style>\n\n<script>\n    function buildTd(items, colspan = 0) {\n        let tdString = '';\n        for (const item of items) {\n            tdString += `<td colspan=\"${colspan}\">${item}</td>`;\n        }\n        return tdString;\n    }\n\n    // text\n    const texts = ['m', 'i', 'x', 'x', ' ', ' '];\n    document.getElementById('tr-text').innerHTML += buildTd(texts, 8);\n\n    // ascii\n    const asciis = [109, 105, 120, 120, ' ', ' '];\n    document.getElementById('tr-ascii').innerHTML += buildTd(asciis, 8);\n\n    // bits\n    const bits = [\n        '0', '1', '1', '0', '1', '1', '0', '1',\n        '0', '1', '1', '0', '1', '0', '0', '1',\n        '0', '1', '1', '1', '1', '0', '0', '0',\n        '0', '1', '1', '1', '1', '0', '0', '0',\n        ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',\n        ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',\n    ]\n    document.getElementById('tr-bits').innerHTML += buildTd(bits);\n\n    // index\n    const indices = [27, 22, 37, 56, 30, 0, ' ', ' '];\n    document.getElementById('tr-index').innerHTML += buildTd(indices, 6);\n\n    // Base64\n    const base64s = ['b', 'W', 'l', '4', 'e', 'A', '=', '='];\n    document.getElementById('tr-base64').innerHTML += buildTd(base64s, 6);\n</script>\n\n```sh\necho -n 'mixx' | base64 # 输出: bWl4eA==\n```\n\n## 程序简单实现\n\n<!-- more -->\n\n```php\n/**\n * @var base64 索引表 索引从 0 到 63\n * @see https://zh.wikipedia.org/wiki/Base64\n */\n$base64Map = [\n    'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',\n    'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z',\n    '0', '1', '2', '3', '4', '5', '6', '7', '8', '9',\n    '+', '/',\n];\n\nfunction base64Encode(string $data): string\n{\n    $binConcat = '';\n    $length = strlen($data);\n\n    // 遍历字节\n    for ($i = 0; $i < $length; $i++) {\n        $char = $data[$i];\n        $asciCode = ord($char); // 得到 ASCII 码\n        $bin = str_pad(decbin($asciCode), 8, '0', STR_PAD_LEFT); // 转为二进制并高位补0\n        $binConcat .= $bin;\n    }\n\n    $sixBits = str_split($binConcat, 6); // 分割为6位数组\n    $sixBitsGroup = array_chunk($sixBits, 4); // 每4个为一组\n\n    $groupLen = count($sixBitsGroup);\n    $lastGroup = $sixBitsGroup[$groupLen - 1];\n    $lastGroupLen = count($lastGroup);\n    $lastGroup[$lastGroupLen - 1] = str_pad($lastGroup[$lastGroupLen - 1], 6, '0', STR_PAD_RIGHT); // 不足6位则用0填补末尾\n    $sixBitsGroup[$groupLen - 1] = $lastGroup;\n\n    global $base64Map; // 引用 base64 索引表\n\n    // encode\n    $base64Concat = '';\n    foreach ($sixBitsGroup as $sixBits) {\n        foreach ($sixBits as $sixBit) {\n            $dec = bindec($sixBit); // 二进制转十进制\n            $base64Concat .= $base64Map[$dec]; // 查询 base64 索引表，得到字符\n        }\n    }\n\n    // 用 '=' 补位\n    for ($i = 0; $i < 4 - $lastGroupLen; $i++) {\n        $base64Concat .= '=';\n    }\n\n    return $base64Concat;\n}\n```\n","source":"_posts/2021-10-18-温故-base64-编码.md","raw":"---\ntitle: 温故 base64 编码\ndate: 2021-10-18 16:06:59\ncategories:\n- 笔记\ntags:\n-\n---\n\n温故 `base64` 编码过程。\n\n虽然现在绝大多数编程语言都已经在标准库中实现了 base64 编码和解码，但还是要时不时回顾其原理。\n\n## 编码原理\n\n**TLDR: 将 `8 位` 二进制串 **分割为** 多个 `4 个 6 位` 二进制串，参考 https://zh.wikipedia.org/wiki/Base64 。**\n\n- 将每个字符都转换成对应的 `ASCII` 码\n- 将每个 `ASCII` 码由十进制转为 8 位二进制\n- 将这些二进制按照每 6 位分进行分隔，4 个 6 位二进制位 `一组` ，若在分隔的时候，位数不够则用 0 填补在末尾\n- 将这些 6 位的二进制重新转为十进制，并根据十进制数在 `base64 索引表` 中找到对应的编码。\n- 若构不成 `一组`，则用 `=` 号填补在末尾\n\n编码 (encode) 过程如下:\n\n<table id=\"tb\">\n    <tbody>\n        <tr id=\"tr-text\">\n            <td>Text</td>\n            <!-- inserted in js script -->\n        </tr>\n        <tr id=\"tr-ascii\">\n            <td>ASCII</td>\n            <!-- inserted in js script -->\n        </tr>\n        <tr id=\"tr-bits\">\n            <td>8 Bit</td>\n            <!-- inserted in js script -->\n        </tr>\n        <tr id=\"tr-index\">\n            <td>Index</td>\n            <!-- inserted in js script -->\n        </tr>\n        <tr id=\"tr-base64\">\n            <td>Base64</td>\n            <!-- inserted in js script -->\n        </tr>\n    </tbody>\n</table>\n\n<style>\n#tb td {\n    padding: 0;\n    margin: 0;\n    text-align: center;\n    min-width: 1em;\n}\n</style>\n\n<script>\n    function buildTd(items, colspan = 0) {\n        let tdString = '';\n        for (const item of items) {\n            tdString += `<td colspan=\"${colspan}\">${item}</td>`;\n        }\n        return tdString;\n    }\n\n    // text\n    const texts = ['m', 'i', 'x', 'x', ' ', ' '];\n    document.getElementById('tr-text').innerHTML += buildTd(texts, 8);\n\n    // ascii\n    const asciis = [109, 105, 120, 120, ' ', ' '];\n    document.getElementById('tr-ascii').innerHTML += buildTd(asciis, 8);\n\n    // bits\n    const bits = [\n        '0', '1', '1', '0', '1', '1', '0', '1',\n        '0', '1', '1', '0', '1', '0', '0', '1',\n        '0', '1', '1', '1', '1', '0', '0', '0',\n        '0', '1', '1', '1', '1', '0', '0', '0',\n        ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',\n        ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',\n    ]\n    document.getElementById('tr-bits').innerHTML += buildTd(bits);\n\n    // index\n    const indices = [27, 22, 37, 56, 30, 0, ' ', ' '];\n    document.getElementById('tr-index').innerHTML += buildTd(indices, 6);\n\n    // Base64\n    const base64s = ['b', 'W', 'l', '4', 'e', 'A', '=', '='];\n    document.getElementById('tr-base64').innerHTML += buildTd(base64s, 6);\n</script>\n\n```sh\necho -n 'mixx' | base64 # 输出: bWl4eA==\n```\n\n## 程序简单实现\n\n<!-- more -->\n\n```php\n/**\n * @var base64 索引表 索引从 0 到 63\n * @see https://zh.wikipedia.org/wiki/Base64\n */\n$base64Map = [\n    'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',\n    'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z',\n    '0', '1', '2', '3', '4', '5', '6', '7', '8', '9',\n    '+', '/',\n];\n\nfunction base64Encode(string $data): string\n{\n    $binConcat = '';\n    $length = strlen($data);\n\n    // 遍历字节\n    for ($i = 0; $i < $length; $i++) {\n        $char = $data[$i];\n        $asciCode = ord($char); // 得到 ASCII 码\n        $bin = str_pad(decbin($asciCode), 8, '0', STR_PAD_LEFT); // 转为二进制并高位补0\n        $binConcat .= $bin;\n    }\n\n    $sixBits = str_split($binConcat, 6); // 分割为6位数组\n    $sixBitsGroup = array_chunk($sixBits, 4); // 每4个为一组\n\n    $groupLen = count($sixBitsGroup);\n    $lastGroup = $sixBitsGroup[$groupLen - 1];\n    $lastGroupLen = count($lastGroup);\n    $lastGroup[$lastGroupLen - 1] = str_pad($lastGroup[$lastGroupLen - 1], 6, '0', STR_PAD_RIGHT); // 不足6位则用0填补末尾\n    $sixBitsGroup[$groupLen - 1] = $lastGroup;\n\n    global $base64Map; // 引用 base64 索引表\n\n    // encode\n    $base64Concat = '';\n    foreach ($sixBitsGroup as $sixBits) {\n        foreach ($sixBits as $sixBit) {\n            $dec = bindec($sixBit); // 二进制转十进制\n            $base64Concat .= $base64Map[$dec]; // 查询 base64 索引表，得到字符\n        }\n    }\n\n    // 用 '=' 补位\n    for ($i = 0; $i < 4 - $lastGroupLen; $i++) {\n        $base64Concat .= '=';\n    }\n\n    return $base64Concat;\n}\n```\n","slug":"温故-base64-编码","published":1,"updated":"2023-05-28T05:36:04.287Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1ji0014iubfi8y3yj0x","content":"<p>温故 <code>base64</code> 编码过程。</p><p>虽然现在绝大多数编程语言都已经在标准库中实现了 base64 编码和解码，但还是要时不时回顾其原理。</p><h2 id=\"编码原理\"><a href=\"#编码原理\" class=\"headerlink\" title=\"编码原理\"></a>编码原理</h2><p><strong>TLDR: 将 <code>8 位</code> 二进制串 </strong>分割为<strong> 多个 <code>4 个 6 位</code> 二进制串，参考 <a href=\"https://zh.wikipedia.org/wiki/Base64\" target=\"_blank\" rel=\"noopener\">https://zh.wikipedia.org/wiki/Base64</a> 。</strong></p><ul><li>将每个字符都转换成对应的 <code>ASCII</code> 码</li><li>将每个 <code>ASCII</code> 码由十进制转为 8 位二进制</li><li>将这些二进制按照每 6 位分进行分隔，4 个 6 位二进制位 <code>一组</code> ，若在分隔的时候，位数不够则用 0 填补在末尾</li><li>将这些 6 位的二进制重新转为十进制，并根据十进制数在 <code>base64 索引表</code> 中找到对应的编码。</li><li>若构不成 <code>一组</code>，则用 <code>=</code> 号填补在末尾</li></ul><p>编码 (encode) 过程如下:</p><table id=\"tb\"><tbody><tr id=\"tr-text\"><td>Text</td></tr><tr id=\"tr-ascii\"><td>ASCII</td></tr><tr id=\"tr-bits\"><td>8 Bit</td></tr><tr id=\"tr-index\"><td>Index</td></tr><tr id=\"tr-base64\"><td>Base64</td></tr></tbody></table><style>#tb td{padding:0;margin:0;text-align:center;min-width:1em}</style><script>function buildTd(items, colspan = 0) {\n        let tdString = '';\n        for (const item of items) {\n            tdString += `<td colspan=\"${colspan}\">${item}</td>`;\n        }\n        return tdString;\n    }\n\n    // text\n    const texts = ['m', 'i', 'x', 'x', ' ', ' '];\n    document.getElementById('tr-text').innerHTML += buildTd(texts, 8);\n\n    // ascii\n    const asciis = [109, 105, 120, 120, ' ', ' '];\n    document.getElementById('tr-ascii').innerHTML += buildTd(asciis, 8);\n\n    // bits\n    const bits = [\n        '0', '1', '1', '0', '1', '1', '0', '1',\n        '0', '1', '1', '0', '1', '0', '0', '1',\n        '0', '1', '1', '1', '1', '0', '0', '0',\n        '0', '1', '1', '1', '1', '0', '0', '0',\n        ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',\n        ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',\n    ]\n    document.getElementById('tr-bits').innerHTML += buildTd(bits);\n\n    // index\n    const indices = [27, 22, 37, 56, 30, 0, ' ', ' '];\n    document.getElementById('tr-index').innerHTML += buildTd(indices, 6);\n\n    // Base64\n    const base64s = ['b', 'W', 'l', '4', 'e', 'A', '=', '='];\n    document.getElementById('tr-base64').innerHTML += buildTd(base64s, 6);</script><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> -n <span class=\"string\">'mixx'</span> | base64 <span class=\"comment\"># 输出: bWl4eA==</span></span><br></pre></td></tr></table></figure><h2 id=\"程序简单实现\"><a href=\"#程序简单实现\" class=\"headerlink\" title=\"程序简单实现\"></a>程序简单实现</h2><a id=\"more\"></a><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@var</span> base64 索引表 索引从 0 到 63</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@see</span> https://zh.wikipedia.org/wiki/Base64</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">$base64Map = [</span><br><span class=\"line\">    <span class=\"string\">'A'</span>, <span class=\"string\">'B'</span>, <span class=\"string\">'C'</span>, <span class=\"string\">'D'</span>, <span class=\"string\">'E'</span>, <span class=\"string\">'F'</span>, <span class=\"string\">'G'</span>, <span class=\"string\">'H'</span>, <span class=\"string\">'I'</span>, <span class=\"string\">'J'</span>, <span class=\"string\">'K'</span>, <span class=\"string\">'L'</span>, <span class=\"string\">'M'</span>, <span class=\"string\">'N'</span>, <span class=\"string\">'O'</span>, <span class=\"string\">'P'</span>, <span class=\"string\">'Q'</span>, <span class=\"string\">'R'</span>, <span class=\"string\">'S'</span>, <span class=\"string\">'T'</span>, <span class=\"string\">'U'</span>, <span class=\"string\">'V'</span>, <span class=\"string\">'W'</span>, <span class=\"string\">'X'</span>, <span class=\"string\">'Y'</span>, <span class=\"string\">'Z'</span>,</span><br><span class=\"line\">    <span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>, <span class=\"string\">'c'</span>, <span class=\"string\">'d'</span>, <span class=\"string\">'e'</span>, <span class=\"string\">'f'</span>, <span class=\"string\">'g'</span>, <span class=\"string\">'h'</span>, <span class=\"string\">'i'</span>, <span class=\"string\">'j'</span>, <span class=\"string\">'k'</span>, <span class=\"string\">'l'</span>, <span class=\"string\">'m'</span>, <span class=\"string\">'n'</span>, <span class=\"string\">'o'</span>, <span class=\"string\">'p'</span>, <span class=\"string\">'q'</span>, <span class=\"string\">'r'</span>, <span class=\"string\">'s'</span>, <span class=\"string\">'t'</span>, <span class=\"string\">'u'</span>, <span class=\"string\">'v'</span>, <span class=\"string\">'w'</span>, <span class=\"string\">'x'</span>, <span class=\"string\">'y'</span>, <span class=\"string\">'z'</span>,</span><br><span class=\"line\">    <span class=\"string\">'0'</span>, <span class=\"string\">'1'</span>, <span class=\"string\">'2'</span>, <span class=\"string\">'3'</span>, <span class=\"string\">'4'</span>, <span class=\"string\">'5'</span>, <span class=\"string\">'6'</span>, <span class=\"string\">'7'</span>, <span class=\"string\">'8'</span>, <span class=\"string\">'9'</span>,</span><br><span class=\"line\">    <span class=\"string\">'+'</span>, <span class=\"string\">'/'</span>,</span><br><span class=\"line\">];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">base64Encode</span><span class=\"params\">(string $data)</span>: <span class=\"title\">string</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $binConcat = <span class=\"string\">''</span>;</span><br><span class=\"line\">    $length = strlen($data);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 遍历字节</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> ($i = <span class=\"number\">0</span>; $i &lt; $length; $i++) &#123;</span><br><span class=\"line\">        $char = $data[$i];</span><br><span class=\"line\">        $asciCode = ord($char); <span class=\"comment\">// 得到 ASCII 码</span></span><br><span class=\"line\">        $bin = str_pad(decbin($asciCode), <span class=\"number\">8</span>, <span class=\"string\">'0'</span>, STR_PAD_LEFT); <span class=\"comment\">// 转为二进制并高位补0</span></span><br><span class=\"line\">        $binConcat .= $bin;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $sixBits = str_split($binConcat, <span class=\"number\">6</span>); <span class=\"comment\">// 分割为6位数组</span></span><br><span class=\"line\">    $sixBitsGroup = array_chunk($sixBits, <span class=\"number\">4</span>); <span class=\"comment\">// 每4个为一组</span></span><br><span class=\"line\"></span><br><span class=\"line\">    $groupLen = count($sixBitsGroup);</span><br><span class=\"line\">    $lastGroup = $sixBitsGroup[$groupLen - <span class=\"number\">1</span>];</span><br><span class=\"line\">    $lastGroupLen = count($lastGroup);</span><br><span class=\"line\">    $lastGroup[$lastGroupLen - <span class=\"number\">1</span>] = str_pad($lastGroup[$lastGroupLen - <span class=\"number\">1</span>], <span class=\"number\">6</span>, <span class=\"string\">'0'</span>, STR_PAD_RIGHT); <span class=\"comment\">// 不足6位则用0填补末尾</span></span><br><span class=\"line\">    $sixBitsGroup[$groupLen - <span class=\"number\">1</span>] = $lastGroup;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">global</span> $base64Map; <span class=\"comment\">// 引用 base64 索引表</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// encode</span></span><br><span class=\"line\">    $base64Concat = <span class=\"string\">''</span>;</span><br><span class=\"line\">    <span class=\"keyword\">foreach</span> ($sixBitsGroup <span class=\"keyword\">as</span> $sixBits) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> ($sixBits <span class=\"keyword\">as</span> $sixBit) &#123;</span><br><span class=\"line\">            $dec = bindec($sixBit); <span class=\"comment\">// 二进制转十进制</span></span><br><span class=\"line\">            $base64Concat .= $base64Map[$dec]; <span class=\"comment\">// 查询 base64 索引表，得到字符</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 用 '=' 补位</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> ($i = <span class=\"number\">0</span>; $i &lt; <span class=\"number\">4</span> - $lastGroupLen; $i++) &#123;</span><br><span class=\"line\">        $base64Concat .= <span class=\"string\">'='</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> $base64Concat;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"<p>温故 <code>base64</code> 编码过程。</p><p>虽然现在绝大多数编程语言都已经在标准库中实现了 base64 编码和解码，但还是要时不时回顾其原理。</p><h2 id=\"编码原理\"><a href=\"#编码原理\" class=\"headerlink\" title=\"编码原理\"></a>编码原理</h2><p><strong>TLDR: 将 <code>8 位</code> 二进制串 </strong>分割为<strong> 多个 <code>4 个 6 位</code> 二进制串，参考 <a href=\"https://zh.wikipedia.org/wiki/Base64\" target=\"_blank\" rel=\"noopener\">https://zh.wikipedia.org/wiki/Base64</a> 。</strong></p><ul><li>将每个字符都转换成对应的 <code>ASCII</code> 码</li><li>将每个 <code>ASCII</code> 码由十进制转为 8 位二进制</li><li>将这些二进制按照每 6 位分进行分隔，4 个 6 位二进制位 <code>一组</code> ，若在分隔的时候，位数不够则用 0 填补在末尾</li><li>将这些 6 位的二进制重新转为十进制，并根据十进制数在 <code>base64 索引表</code> 中找到对应的编码。</li><li>若构不成 <code>一组</code>，则用 <code>=</code> 号填补在末尾</li></ul><p>编码 (encode) 过程如下:</p><table id=\"tb\"><tbody><tr id=\"tr-text\"><td>Text</td></tr><tr id=\"tr-ascii\"><td>ASCII</td></tr><tr id=\"tr-bits\"><td>8 Bit</td></tr><tr id=\"tr-index\"><td>Index</td></tr><tr id=\"tr-base64\"><td>Base64</td></tr></tbody></table><style>#tb td{padding:0;margin:0;text-align:center;min-width:1em}</style><script>function buildTd(items, colspan = 0) {\n        let tdString = '';\n        for (const item of items) {\n            tdString += `<td colspan=\"${colspan}\">${item}</td>`;\n        }\n        return tdString;\n    }\n\n    // text\n    const texts = ['m', 'i', 'x', 'x', ' ', ' '];\n    document.getElementById('tr-text').innerHTML += buildTd(texts, 8);\n\n    // ascii\n    const asciis = [109, 105, 120, 120, ' ', ' '];\n    document.getElementById('tr-ascii').innerHTML += buildTd(asciis, 8);\n\n    // bits\n    const bits = [\n        '0', '1', '1', '0', '1', '1', '0', '1',\n        '0', '1', '1', '0', '1', '0', '0', '1',\n        '0', '1', '1', '1', '1', '0', '0', '0',\n        '0', '1', '1', '1', '1', '0', '0', '0',\n        ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',\n        ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ',\n    ]\n    document.getElementById('tr-bits').innerHTML += buildTd(bits);\n\n    // index\n    const indices = [27, 22, 37, 56, 30, 0, ' ', ' '];\n    document.getElementById('tr-index').innerHTML += buildTd(indices, 6);\n\n    // Base64\n    const base64s = ['b', 'W', 'l', '4', 'e', 'A', '=', '='];\n    document.getElementById('tr-base64').innerHTML += buildTd(base64s, 6);</script><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> -n <span class=\"string\">'mixx'</span> | base64 <span class=\"comment\"># 输出: bWl4eA==</span></span><br></pre></td></tr></table></figure><h2 id=\"程序简单实现\"><a href=\"#程序简单实现\" class=\"headerlink\" title=\"程序简单实现\"></a>程序简单实现</h2>","more":"<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@var</span> base64 索引表 索引从 0 到 63</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@see</span> https://zh.wikipedia.org/wiki/Base64</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">$base64Map = [</span><br><span class=\"line\">    <span class=\"string\">'A'</span>, <span class=\"string\">'B'</span>, <span class=\"string\">'C'</span>, <span class=\"string\">'D'</span>, <span class=\"string\">'E'</span>, <span class=\"string\">'F'</span>, <span class=\"string\">'G'</span>, <span class=\"string\">'H'</span>, <span class=\"string\">'I'</span>, <span class=\"string\">'J'</span>, <span class=\"string\">'K'</span>, <span class=\"string\">'L'</span>, <span class=\"string\">'M'</span>, <span class=\"string\">'N'</span>, <span class=\"string\">'O'</span>, <span class=\"string\">'P'</span>, <span class=\"string\">'Q'</span>, <span class=\"string\">'R'</span>, <span class=\"string\">'S'</span>, <span class=\"string\">'T'</span>, <span class=\"string\">'U'</span>, <span class=\"string\">'V'</span>, <span class=\"string\">'W'</span>, <span class=\"string\">'X'</span>, <span class=\"string\">'Y'</span>, <span class=\"string\">'Z'</span>,</span><br><span class=\"line\">    <span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>, <span class=\"string\">'c'</span>, <span class=\"string\">'d'</span>, <span class=\"string\">'e'</span>, <span class=\"string\">'f'</span>, <span class=\"string\">'g'</span>, <span class=\"string\">'h'</span>, <span class=\"string\">'i'</span>, <span class=\"string\">'j'</span>, <span class=\"string\">'k'</span>, <span class=\"string\">'l'</span>, <span class=\"string\">'m'</span>, <span class=\"string\">'n'</span>, <span class=\"string\">'o'</span>, <span class=\"string\">'p'</span>, <span class=\"string\">'q'</span>, <span class=\"string\">'r'</span>, <span class=\"string\">'s'</span>, <span class=\"string\">'t'</span>, <span class=\"string\">'u'</span>, <span class=\"string\">'v'</span>, <span class=\"string\">'w'</span>, <span class=\"string\">'x'</span>, <span class=\"string\">'y'</span>, <span class=\"string\">'z'</span>,</span><br><span class=\"line\">    <span class=\"string\">'0'</span>, <span class=\"string\">'1'</span>, <span class=\"string\">'2'</span>, <span class=\"string\">'3'</span>, <span class=\"string\">'4'</span>, <span class=\"string\">'5'</span>, <span class=\"string\">'6'</span>, <span class=\"string\">'7'</span>, <span class=\"string\">'8'</span>, <span class=\"string\">'9'</span>,</span><br><span class=\"line\">    <span class=\"string\">'+'</span>, <span class=\"string\">'/'</span>,</span><br><span class=\"line\">];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">base64Encode</span><span class=\"params\">(string $data)</span>: <span class=\"title\">string</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $binConcat = <span class=\"string\">''</span>;</span><br><span class=\"line\">    $length = strlen($data);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 遍历字节</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> ($i = <span class=\"number\">0</span>; $i &lt; $length; $i++) &#123;</span><br><span class=\"line\">        $char = $data[$i];</span><br><span class=\"line\">        $asciCode = ord($char); <span class=\"comment\">// 得到 ASCII 码</span></span><br><span class=\"line\">        $bin = str_pad(decbin($asciCode), <span class=\"number\">8</span>, <span class=\"string\">'0'</span>, STR_PAD_LEFT); <span class=\"comment\">// 转为二进制并高位补0</span></span><br><span class=\"line\">        $binConcat .= $bin;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $sixBits = str_split($binConcat, <span class=\"number\">6</span>); <span class=\"comment\">// 分割为6位数组</span></span><br><span class=\"line\">    $sixBitsGroup = array_chunk($sixBits, <span class=\"number\">4</span>); <span class=\"comment\">// 每4个为一组</span></span><br><span class=\"line\"></span><br><span class=\"line\">    $groupLen = count($sixBitsGroup);</span><br><span class=\"line\">    $lastGroup = $sixBitsGroup[$groupLen - <span class=\"number\">1</span>];</span><br><span class=\"line\">    $lastGroupLen = count($lastGroup);</span><br><span class=\"line\">    $lastGroup[$lastGroupLen - <span class=\"number\">1</span>] = str_pad($lastGroup[$lastGroupLen - <span class=\"number\">1</span>], <span class=\"number\">6</span>, <span class=\"string\">'0'</span>, STR_PAD_RIGHT); <span class=\"comment\">// 不足6位则用0填补末尾</span></span><br><span class=\"line\">    $sixBitsGroup[$groupLen - <span class=\"number\">1</span>] = $lastGroup;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">global</span> $base64Map; <span class=\"comment\">// 引用 base64 索引表</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// encode</span></span><br><span class=\"line\">    $base64Concat = <span class=\"string\">''</span>;</span><br><span class=\"line\">    <span class=\"keyword\">foreach</span> ($sixBitsGroup <span class=\"keyword\">as</span> $sixBits) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> ($sixBits <span class=\"keyword\">as</span> $sixBit) &#123;</span><br><span class=\"line\">            $dec = bindec($sixBit); <span class=\"comment\">// 二进制转十进制</span></span><br><span class=\"line\">            $base64Concat .= $base64Map[$dec]; <span class=\"comment\">// 查询 base64 索引表，得到字符</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 用 '=' 补位</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> ($i = <span class=\"number\">0</span>; $i &lt; <span class=\"number\">4</span> - $lastGroupLen; $i++) &#123;</span><br><span class=\"line\">        $base64Concat .= <span class=\"string\">'='</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> $base64Concat;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"REGRETS OF THE DYING","date":"2021-01-11T02:35:34.000Z","_content":"\nFor many years I worked in palliative care. My patients were those who had gone home to die.\nSome incredibly special times were shared. I was with them for the last three to twelve weeks of their lives.\n\n我从事保守治疗许多年，我的病人都是回到家中逝世的。\n我们共度了一些非常特殊的时光，我陪在他们身边，在他们生命最后的3到12周。\n\nPeople grow a lot when they are faced with their own mortality.\nI learnt never to underestimate someone’s capacity for growth.\nSome changes were phenomenal. Each experienced a variety of emotions, as expected, denial, fear, anger, remorse, more denial and eventually acceptance.\nEvery single patient found their peace before they departed though, every one of them.\n\n人们在面临固有一死的命运时会有许多觉悟，永远不要低估某人的觉悟能力，这是我领略到的。\n有些人的改变是非凡的，他们每个人都体会到了各种各样的情感: 期许，否认，恐惧，愤怒，后悔，跟多的否认，以及最终的接受和释怀。\n每位病人在离开之前都找到了自己内心的安详。\n\nWhen questioned about any regrets they had or anything they would do differently,\ncommon themes surfaced again and again. Here are the most common five:\n\n当问到他们有没有什么后悔的事情时，总会谈及些普遍的话题。下面是5个最常见的：\n\n<!-- more -->\n\n### I wish I’d had the courage to live a life true to myself, not the life others expected of me.\n\n我希望我曾拥有勇气去忠于自己地生活，而不是按照别人期望的方式。\n\nThis was the most common regret of all.\nWhen people realise that their life is almost over and look back clearly on it,\nit is easy to see how many dreams have gone unfulfilled.\nMost people had not honoured even a half of their dreams and had to die knowing that it was due to choices they had made, or not made.\n\n这是最常提及的一种后悔。当人们意识到自己的生命即将结束时，回顾此生，很容易就看到许多梦想已变得无法实现。\n大多数人都没有对梦想的荣誉进行捍卫，然后就得死去，他们心知肚明这是由于自己的选择造成的。\n\nIt is very important to try and honour at least some of your dreams along the way.\nFrom the moment that you lose your health, it is too late.\nHealth brings a freedom very few realise, until they no longer have it.\n\n在人生路上，尝试去捍卫哪怕一丁点自己梦想的荣誉是很重要的。\n从你失去健康的那一刻起，就已经太迟了。健康带来的是自由，很少人能意识到这点，直到失去健康。\n\n### I wish I hadn’t worked so hard.\n\n我希望我不曾那么拼命地工作\n\nThis came from every male patient that I nursed. They missed their children’s youth and their partner’s companionship.\nWomen also spoke of this regret. But as most were from an older generation, many of the female patients had not been breadwinners.\nAll of the men I nursed deeply regretted spending so much of their lives on the treadmill of a work existence.\n\n每一位我照顾过的男性患者都会这么说。他们错过了子女的年少时期，错过了另一半的陪伴时光。\n女性患者也谈到过这样的后悔，但大多数是老一辈的人，多数女性患者都不用养家糊口。\n我所照顾过的所有男性患者都深深地感到后悔，后悔花费了大部分的人生在工作上。\n\nBy simplifying your lifestyle and making conscious choices along the way,\nit is possible to not need the income that you think you do.\nAnd by creating more space in your life,\nyou become happier and more open to new opportunities, ones more suited to your new lifestyle.\n\n通过简化生活方式和做出明白的抉择，可能就会发现你并不需要你当时认为需要的收入。\n同时，给生活腾出更多的空间，你会感到更加幸福，也更能拥抱新的、更适合你新的生活方式的机遇。\n\n### I wish I’d had the courage to express my feelings.\n\n我希望我曾拥有勇气来表达我的感受\n\nMany people suppressed their feelings in order to keep peace with others.\nAs a result, they settled for a mediocre existence and never became who they were truly capable of becoming.\nMany developed illnesses relating to the bitterness and resentment they carried as a result.\n\n许多人都压抑着自己的感受来和他人和睦相处，结果就是他们过着平庸的生活，无法发挥出自己的全部去才能，许多人还会在痛苦和埋怨中生病。\n\nWe cannot control the reactions of others.\nHowever, although people may initially react when you change the way you are by speaking honestly,\nin the end it raises the relationship to a whole new and healthier level.\nEither that or it releases the unhealthy relationship from your life. Either way, you win.\n\n我们不能控制别人做出的反应，然而当你开始实话实说后，人们虽然会有对此做出不适的反应，但到最后会建立起一个全新的更健康的人际关系，\n如果不是这样，则这个不健康的人际关系就会被剔除。\n怎么样你都是赢。\n\n### I wish I had stayed in touch with my friends.\n\n我希望我能和朋友们保持联系\n\nOften they would not truly realise the full benefits of old friends until their dying weeks and it was not always possible to track them down.\nMany had become so caught up in their own lives that they had let golden friendships slip by over the years. There were many deep regrets about not giving friendships the time and effort that they deserved.\nEveryone misses their friends when they are dying.\n\n他们通常不会真正意识到老朋友的益处，直到等到他们快要面临死的那几周；而且也不一定能联络上这些朋友。\n许多人都的生活节奏都太快了，以至于让金贵的友谊一年年渐渐溜走。有很多深深的遗憾都是关于友谊的，他们没有为友谊的维持贡献出足够的时间和努力。\n所有人都在临终前想念他们的朋友。\n\nIt is common for anyone in a busy lifestyle to let friendships slip.\nBut when you are faced with your approaching death, the physical details of life fall away.\nPeople do want to get their financial affairs in order if possible.\nBut it is not money or status that holds the true importance for them.\nThey want to get things in order more for the benefit of those they love.\nUsually though, they are too ill and weary to ever manage this task. It all comes down to love and relationships in the end.\nThat is all that remains in the final weeks, love and relationships.\n\n在忙碌的生活方式中，友谊的流逝是很普遍的。但当你不得不面对自己的死亡时，那些生活中物质的一面会渐渐消模糊。\n人们确实希望尽可能地去创造财富，但真正重要的并不是钱或者地位。\n他们为了自己的所爱而努力去带来更多的物质，但通常他们都太体弱多病而无法达成这个目标。\n所有这一切都归结到爱和关系，这就是在最终的几周时间内剩下的全部内容了。\n\n### I wish that I had let myself be happier.\n\n我希望我曾可以让自己过得更开心一些\n\nThis is a surprisingly common one. Many did not realise until the end that happiness is a choice.\nThey had stayed stuck in old patterns and habits.\nThe so-called ‘comfort’ of familiarity overflowed into their emotions, as well as their physical lives.\nFear of change had them pretending to others, and to their selves, that they were content. When deep within, they longed to laugh properly and have silliness in their life again.\n\n令人惊讶的是，许多患者到最后才意识到开心是一种选择。\n他们禁锢在陈旧的方式和习惯中，所谓的舒适感从他们的情感中和物质生活中溢出。\n因为害怕改变，他们变得自欺欺人，安于现状。在内心深处，他们渴望在生命中再次适当地欢笑和犯糊涂。\n\nWhen you are on your deathbed, what others think of you is a long way from your mind.\nHow wonderful to be able to let go and smile again, long before you are dying.\n\n当你时日已尽，别人怎么看你已经无关紧要了，在死之前能够释怀和再次微笑是多么的美妙啊。\n\n---\n\nLife is a choice. It is YOUR life. Choose consciously, choose wisely, choose honestly. Choose happiness.\n\n生活是一种选择。这是 **你的** 生活，请清醒地、明智地、诚实地选择。请选择幸福。\n\n\n","source":"_posts/2021-01-11-REGRETS-OF-THE-DYING.md","raw":"---\ntitle: REGRETS OF THE DYING\ndate: 2021-01-11 10:35:34\ncategories:\n- 翻译\ntags:\n---\n\nFor many years I worked in palliative care. My patients were those who had gone home to die.\nSome incredibly special times were shared. I was with them for the last three to twelve weeks of their lives.\n\n我从事保守治疗许多年，我的病人都是回到家中逝世的。\n我们共度了一些非常特殊的时光，我陪在他们身边，在他们生命最后的3到12周。\n\nPeople grow a lot when they are faced with their own mortality.\nI learnt never to underestimate someone’s capacity for growth.\nSome changes were phenomenal. Each experienced a variety of emotions, as expected, denial, fear, anger, remorse, more denial and eventually acceptance.\nEvery single patient found their peace before they departed though, every one of them.\n\n人们在面临固有一死的命运时会有许多觉悟，永远不要低估某人的觉悟能力，这是我领略到的。\n有些人的改变是非凡的，他们每个人都体会到了各种各样的情感: 期许，否认，恐惧，愤怒，后悔，跟多的否认，以及最终的接受和释怀。\n每位病人在离开之前都找到了自己内心的安详。\n\nWhen questioned about any regrets they had or anything they would do differently,\ncommon themes surfaced again and again. Here are the most common five:\n\n当问到他们有没有什么后悔的事情时，总会谈及些普遍的话题。下面是5个最常见的：\n\n<!-- more -->\n\n### I wish I’d had the courage to live a life true to myself, not the life others expected of me.\n\n我希望我曾拥有勇气去忠于自己地生活，而不是按照别人期望的方式。\n\nThis was the most common regret of all.\nWhen people realise that their life is almost over and look back clearly on it,\nit is easy to see how many dreams have gone unfulfilled.\nMost people had not honoured even a half of their dreams and had to die knowing that it was due to choices they had made, or not made.\n\n这是最常提及的一种后悔。当人们意识到自己的生命即将结束时，回顾此生，很容易就看到许多梦想已变得无法实现。\n大多数人都没有对梦想的荣誉进行捍卫，然后就得死去，他们心知肚明这是由于自己的选择造成的。\n\nIt is very important to try and honour at least some of your dreams along the way.\nFrom the moment that you lose your health, it is too late.\nHealth brings a freedom very few realise, until they no longer have it.\n\n在人生路上，尝试去捍卫哪怕一丁点自己梦想的荣誉是很重要的。\n从你失去健康的那一刻起，就已经太迟了。健康带来的是自由，很少人能意识到这点，直到失去健康。\n\n### I wish I hadn’t worked so hard.\n\n我希望我不曾那么拼命地工作\n\nThis came from every male patient that I nursed. They missed their children’s youth and their partner’s companionship.\nWomen also spoke of this regret. But as most were from an older generation, many of the female patients had not been breadwinners.\nAll of the men I nursed deeply regretted spending so much of their lives on the treadmill of a work existence.\n\n每一位我照顾过的男性患者都会这么说。他们错过了子女的年少时期，错过了另一半的陪伴时光。\n女性患者也谈到过这样的后悔，但大多数是老一辈的人，多数女性患者都不用养家糊口。\n我所照顾过的所有男性患者都深深地感到后悔，后悔花费了大部分的人生在工作上。\n\nBy simplifying your lifestyle and making conscious choices along the way,\nit is possible to not need the income that you think you do.\nAnd by creating more space in your life,\nyou become happier and more open to new opportunities, ones more suited to your new lifestyle.\n\n通过简化生活方式和做出明白的抉择，可能就会发现你并不需要你当时认为需要的收入。\n同时，给生活腾出更多的空间，你会感到更加幸福，也更能拥抱新的、更适合你新的生活方式的机遇。\n\n### I wish I’d had the courage to express my feelings.\n\n我希望我曾拥有勇气来表达我的感受\n\nMany people suppressed their feelings in order to keep peace with others.\nAs a result, they settled for a mediocre existence and never became who they were truly capable of becoming.\nMany developed illnesses relating to the bitterness and resentment they carried as a result.\n\n许多人都压抑着自己的感受来和他人和睦相处，结果就是他们过着平庸的生活，无法发挥出自己的全部去才能，许多人还会在痛苦和埋怨中生病。\n\nWe cannot control the reactions of others.\nHowever, although people may initially react when you change the way you are by speaking honestly,\nin the end it raises the relationship to a whole new and healthier level.\nEither that or it releases the unhealthy relationship from your life. Either way, you win.\n\n我们不能控制别人做出的反应，然而当你开始实话实说后，人们虽然会有对此做出不适的反应，但到最后会建立起一个全新的更健康的人际关系，\n如果不是这样，则这个不健康的人际关系就会被剔除。\n怎么样你都是赢。\n\n### I wish I had stayed in touch with my friends.\n\n我希望我能和朋友们保持联系\n\nOften they would not truly realise the full benefits of old friends until their dying weeks and it was not always possible to track them down.\nMany had become so caught up in their own lives that they had let golden friendships slip by over the years. There were many deep regrets about not giving friendships the time and effort that they deserved.\nEveryone misses their friends when they are dying.\n\n他们通常不会真正意识到老朋友的益处，直到等到他们快要面临死的那几周；而且也不一定能联络上这些朋友。\n许多人都的生活节奏都太快了，以至于让金贵的友谊一年年渐渐溜走。有很多深深的遗憾都是关于友谊的，他们没有为友谊的维持贡献出足够的时间和努力。\n所有人都在临终前想念他们的朋友。\n\nIt is common for anyone in a busy lifestyle to let friendships slip.\nBut when you are faced with your approaching death, the physical details of life fall away.\nPeople do want to get their financial affairs in order if possible.\nBut it is not money or status that holds the true importance for them.\nThey want to get things in order more for the benefit of those they love.\nUsually though, they are too ill and weary to ever manage this task. It all comes down to love and relationships in the end.\nThat is all that remains in the final weeks, love and relationships.\n\n在忙碌的生活方式中，友谊的流逝是很普遍的。但当你不得不面对自己的死亡时，那些生活中物质的一面会渐渐消模糊。\n人们确实希望尽可能地去创造财富，但真正重要的并不是钱或者地位。\n他们为了自己的所爱而努力去带来更多的物质，但通常他们都太体弱多病而无法达成这个目标。\n所有这一切都归结到爱和关系，这就是在最终的几周时间内剩下的全部内容了。\n\n### I wish that I had let myself be happier.\n\n我希望我曾可以让自己过得更开心一些\n\nThis is a surprisingly common one. Many did not realise until the end that happiness is a choice.\nThey had stayed stuck in old patterns and habits.\nThe so-called ‘comfort’ of familiarity overflowed into their emotions, as well as their physical lives.\nFear of change had them pretending to others, and to their selves, that they were content. When deep within, they longed to laugh properly and have silliness in their life again.\n\n令人惊讶的是，许多患者到最后才意识到开心是一种选择。\n他们禁锢在陈旧的方式和习惯中，所谓的舒适感从他们的情感中和物质生活中溢出。\n因为害怕改变，他们变得自欺欺人，安于现状。在内心深处，他们渴望在生命中再次适当地欢笑和犯糊涂。\n\nWhen you are on your deathbed, what others think of you is a long way from your mind.\nHow wonderful to be able to let go and smile again, long before you are dying.\n\n当你时日已尽，别人怎么看你已经无关紧要了，在死之前能够释怀和再次微笑是多么的美妙啊。\n\n---\n\nLife is a choice. It is YOUR life. Choose consciously, choose wisely, choose honestly. Choose happiness.\n\n生活是一种选择。这是 **你的** 生活，请清醒地、明智地、诚实地选择。请选择幸福。\n\n\n","slug":"REGRETS-OF-THE-DYING","published":1,"updated":"2023-05-28T05:36:04.286Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clxwky1ji0015iubf0b8fy7ar","content":"<p>For many years I worked in palliative care. My patients were those who had gone home to die. Some incredibly special times were shared. I was with them for the last three to twelve weeks of their lives.</p><p>我从事保守治疗许多年，我的病人都是回到家中逝世的。 我们共度了一些非常特殊的时光，我陪在他们身边，在他们生命最后的3到12周。</p><p>People grow a lot when they are faced with their own mortality. I learnt never to underestimate someone’s capacity for growth. Some changes were phenomenal. Each experienced a variety of emotions, as expected, denial, fear, anger, remorse, more denial and eventually acceptance. Every single patient found their peace before they departed though, every one of them.</p><p>人们在面临固有一死的命运时会有许多觉悟，永远不要低估某人的觉悟能力，这是我领略到的。 有些人的改变是非凡的，他们每个人都体会到了各种各样的情感: 期许，否认，恐惧，愤怒，后悔，跟多的否认，以及最终的接受和释怀。 每位病人在离开之前都找到了自己内心的安详。</p><p>When questioned about any regrets they had or anything they would do differently, common themes surfaced again and again. Here are the most common five:</p><p>当问到他们有没有什么后悔的事情时，总会谈及些普遍的话题。下面是5个最常见的：</p><a id=\"more\"></a><h3 id=\"I-wish-I’d-had-the-courage-to-live-a-life-true-to-myself-not-the-life-others-expected-of-me\"><a href=\"#I-wish-I’d-had-the-courage-to-live-a-life-true-to-myself-not-the-life-others-expected-of-me\" class=\"headerlink\" title=\"I wish I’d had the courage to live a life true to myself, not the life others expected of me.\"></a>I wish I’d had the courage to live a life true to myself, not the life others expected of me.</h3><p>我希望我曾拥有勇气去忠于自己地生活，而不是按照别人期望的方式。</p><p>This was the most common regret of all. When people realise that their life is almost over and look back clearly on it, it is easy to see how many dreams have gone unfulfilled. Most people had not honoured even a half of their dreams and had to die knowing that it was due to choices they had made, or not made.</p><p>这是最常提及的一种后悔。当人们意识到自己的生命即将结束时，回顾此生，很容易就看到许多梦想已变得无法实现。 大多数人都没有对梦想的荣誉进行捍卫，然后就得死去，他们心知肚明这是由于自己的选择造成的。</p><p>It is very important to try and honour at least some of your dreams along the way. From the moment that you lose your health, it is too late. Health brings a freedom very few realise, until they no longer have it.</p><p>在人生路上，尝试去捍卫哪怕一丁点自己梦想的荣誉是很重要的。 从你失去健康的那一刻起，就已经太迟了。健康带来的是自由，很少人能意识到这点，直到失去健康。</p><h3 id=\"I-wish-I-hadn’t-worked-so-hard\"><a href=\"#I-wish-I-hadn’t-worked-so-hard\" class=\"headerlink\" title=\"I wish I hadn’t worked so hard.\"></a>I wish I hadn’t worked so hard.</h3><p>我希望我不曾那么拼命地工作</p><p>This came from every male patient that I nursed. They missed their children’s youth and their partner’s companionship. Women also spoke of this regret. But as most were from an older generation, many of the female patients had not been breadwinners. All of the men I nursed deeply regretted spending so much of their lives on the treadmill of a work existence.</p><p>每一位我照顾过的男性患者都会这么说。他们错过了子女的年少时期，错过了另一半的陪伴时光。 女性患者也谈到过这样的后悔，但大多数是老一辈的人，多数女性患者都不用养家糊口。 我所照顾过的所有男性患者都深深地感到后悔，后悔花费了大部分的人生在工作上。</p><p>By simplifying your lifestyle and making conscious choices along the way, it is possible to not need the income that you think you do. And by creating more space in your life, you become happier and more open to new opportunities, ones more suited to your new lifestyle.</p><p>通过简化生活方式和做出明白的抉择，可能就会发现你并不需要你当时认为需要的收入。 同时，给生活腾出更多的空间，你会感到更加幸福，也更能拥抱新的、更适合你新的生活方式的机遇。</p><h3 id=\"I-wish-I’d-had-the-courage-to-express-my-feelings\"><a href=\"#I-wish-I’d-had-the-courage-to-express-my-feelings\" class=\"headerlink\" title=\"I wish I’d had the courage to express my feelings.\"></a>I wish I’d had the courage to express my feelings.</h3><p>我希望我曾拥有勇气来表达我的感受</p><p>Many people suppressed their feelings in order to keep peace with others. As a result, they settled for a mediocre existence and never became who they were truly capable of becoming. Many developed illnesses relating to the bitterness and resentment they carried as a result.</p><p>许多人都压抑着自己的感受来和他人和睦相处，结果就是他们过着平庸的生活，无法发挥出自己的全部去才能，许多人还会在痛苦和埋怨中生病。</p><p>We cannot control the reactions of others. However, although people may initially react when you change the way you are by speaking honestly, in the end it raises the relationship to a whole new and healthier level. Either that or it releases the unhealthy relationship from your life. Either way, you win.</p><p>我们不能控制别人做出的反应，然而当你开始实话实说后，人们虽然会有对此做出不适的反应，但到最后会建立起一个全新的更健康的人际关系， 如果不是这样，则这个不健康的人际关系就会被剔除。 怎么样你都是赢。</p><h3 id=\"I-wish-I-had-stayed-in-touch-with-my-friends\"><a href=\"#I-wish-I-had-stayed-in-touch-with-my-friends\" class=\"headerlink\" title=\"I wish I had stayed in touch with my friends.\"></a>I wish I had stayed in touch with my friends.</h3><p>我希望我能和朋友们保持联系</p><p>Often they would not truly realise the full benefits of old friends until their dying weeks and it was not always possible to track them down. Many had become so caught up in their own lives that they had let golden friendships slip by over the years. There were many deep regrets about not giving friendships the time and effort that they deserved. Everyone misses their friends when they are dying.</p><p>他们通常不会真正意识到老朋友的益处，直到等到他们快要面临死的那几周；而且也不一定能联络上这些朋友。 许多人都的生活节奏都太快了，以至于让金贵的友谊一年年渐渐溜走。有很多深深的遗憾都是关于友谊的，他们没有为友谊的维持贡献出足够的时间和努力。 所有人都在临终前想念他们的朋友。</p><p>It is common for anyone in a busy lifestyle to let friendships slip. But when you are faced with your approaching death, the physical details of life fall away. People do want to get their financial affairs in order if possible. But it is not money or status that holds the true importance for them. They want to get things in order more for the benefit of those they love. Usually though, they are too ill and weary to ever manage this task. It all comes down to love and relationships in the end. That is all that remains in the final weeks, love and relationships.</p><p>在忙碌的生活方式中，友谊的流逝是很普遍的。但当你不得不面对自己的死亡时，那些生活中物质的一面会渐渐消模糊。 人们确实希望尽可能地去创造财富，但真正重要的并不是钱或者地位。 他们为了自己的所爱而努力去带来更多的物质，但通常他们都太体弱多病而无法达成这个目标。 所有这一切都归结到爱和关系，这就是在最终的几周时间内剩下的全部内容了。</p><h3 id=\"I-wish-that-I-had-let-myself-be-happier\"><a href=\"#I-wish-that-I-had-let-myself-be-happier\" class=\"headerlink\" title=\"I wish that I had let myself be happier.\"></a>I wish that I had let myself be happier.</h3><p>我希望我曾可以让自己过得更开心一些</p><p>This is a surprisingly common one. Many did not realise until the end that happiness is a choice. They had stayed stuck in old patterns and habits. The so-called ‘comfort’ of familiarity overflowed into their emotions, as well as their physical lives. Fear of change had them pretending to others, and to their selves, that they were content. When deep within, they longed to laugh properly and have silliness in their life again.</p><p>令人惊讶的是，许多患者到最后才意识到开心是一种选择。 他们禁锢在陈旧的方式和习惯中，所谓的舒适感从他们的情感中和物质生活中溢出。 因为害怕改变，他们变得自欺欺人，安于现状。在内心深处，他们渴望在生命中再次适当地欢笑和犯糊涂。</p><p>When you are on your deathbed, what others think of you is a long way from your mind. How wonderful to be able to let go and smile again, long before you are dying.</p><p>当你时日已尽，别人怎么看你已经无关紧要了，在死之前能够释怀和再次微笑是多么的美妙啊。</p><hr><p>Life is a choice. It is YOUR life. Choose consciously, choose wisely, choose honestly. Choose happiness.</p><p>生活是一种选择。这是 <strong>你的</strong> 生活，请清醒地、明智地、诚实地选择。请选择幸福。</p>","site":{"data":{}},"excerpt":"<p>For many years I worked in palliative care. My patients were those who had gone home to die. Some incredibly special times were shared. I was with them for the last three to twelve weeks of their lives.</p><p>我从事保守治疗许多年，我的病人都是回到家中逝世的。 我们共度了一些非常特殊的时光，我陪在他们身边，在他们生命最后的3到12周。</p><p>People grow a lot when they are faced with their own mortality. I learnt never to underestimate someone’s capacity for growth. Some changes were phenomenal. Each experienced a variety of emotions, as expected, denial, fear, anger, remorse, more denial and eventually acceptance. Every single patient found their peace before they departed though, every one of them.</p><p>人们在面临固有一死的命运时会有许多觉悟，永远不要低估某人的觉悟能力，这是我领略到的。 有些人的改变是非凡的，他们每个人都体会到了各种各样的情感: 期许，否认，恐惧，愤怒，后悔，跟多的否认，以及最终的接受和释怀。 每位病人在离开之前都找到了自己内心的安详。</p><p>When questioned about any regrets they had or anything they would do differently, common themes surfaced again and again. Here are the most common five:</p><p>当问到他们有没有什么后悔的事情时，总会谈及些普遍的话题。下面是5个最常见的：</p>","more":"<h3 id=\"I-wish-I’d-had-the-courage-to-live-a-life-true-to-myself-not-the-life-others-expected-of-me\"><a href=\"#I-wish-I’d-had-the-courage-to-live-a-life-true-to-myself-not-the-life-others-expected-of-me\" class=\"headerlink\" title=\"I wish I’d had the courage to live a life true to myself, not the life others expected of me.\"></a>I wish I’d had the courage to live a life true to myself, not the life others expected of me.</h3><p>我希望我曾拥有勇气去忠于自己地生活，而不是按照别人期望的方式。</p><p>This was the most common regret of all. When people realise that their life is almost over and look back clearly on it, it is easy to see how many dreams have gone unfulfilled. Most people had not honoured even a half of their dreams and had to die knowing that it was due to choices they had made, or not made.</p><p>这是最常提及的一种后悔。当人们意识到自己的生命即将结束时，回顾此生，很容易就看到许多梦想已变得无法实现。 大多数人都没有对梦想的荣誉进行捍卫，然后就得死去，他们心知肚明这是由于自己的选择造成的。</p><p>It is very important to try and honour at least some of your dreams along the way. From the moment that you lose your health, it is too late. Health brings a freedom very few realise, until they no longer have it.</p><p>在人生路上，尝试去捍卫哪怕一丁点自己梦想的荣誉是很重要的。 从你失去健康的那一刻起，就已经太迟了。健康带来的是自由，很少人能意识到这点，直到失去健康。</p><h3 id=\"I-wish-I-hadn’t-worked-so-hard\"><a href=\"#I-wish-I-hadn’t-worked-so-hard\" class=\"headerlink\" title=\"I wish I hadn’t worked so hard.\"></a>I wish I hadn’t worked so hard.</h3><p>我希望我不曾那么拼命地工作</p><p>This came from every male patient that I nursed. They missed their children’s youth and their partner’s companionship. Women also spoke of this regret. But as most were from an older generation, many of the female patients had not been breadwinners. All of the men I nursed deeply regretted spending so much of their lives on the treadmill of a work existence.</p><p>每一位我照顾过的男性患者都会这么说。他们错过了子女的年少时期，错过了另一半的陪伴时光。 女性患者也谈到过这样的后悔，但大多数是老一辈的人，多数女性患者都不用养家糊口。 我所照顾过的所有男性患者都深深地感到后悔，后悔花费了大部分的人生在工作上。</p><p>By simplifying your lifestyle and making conscious choices along the way, it is possible to not need the income that you think you do. And by creating more space in your life, you become happier and more open to new opportunities, ones more suited to your new lifestyle.</p><p>通过简化生活方式和做出明白的抉择，可能就会发现你并不需要你当时认为需要的收入。 同时，给生活腾出更多的空间，你会感到更加幸福，也更能拥抱新的、更适合你新的生活方式的机遇。</p><h3 id=\"I-wish-I’d-had-the-courage-to-express-my-feelings\"><a href=\"#I-wish-I’d-had-the-courage-to-express-my-feelings\" class=\"headerlink\" title=\"I wish I’d had the courage to express my feelings.\"></a>I wish I’d had the courage to express my feelings.</h3><p>我希望我曾拥有勇气来表达我的感受</p><p>Many people suppressed their feelings in order to keep peace with others. As a result, they settled for a mediocre existence and never became who they were truly capable of becoming. Many developed illnesses relating to the bitterness and resentment they carried as a result.</p><p>许多人都压抑着自己的感受来和他人和睦相处，结果就是他们过着平庸的生活，无法发挥出自己的全部去才能，许多人还会在痛苦和埋怨中生病。</p><p>We cannot control the reactions of others. However, although people may initially react when you change the way you are by speaking honestly, in the end it raises the relationship to a whole new and healthier level. Either that or it releases the unhealthy relationship from your life. Either way, you win.</p><p>我们不能控制别人做出的反应，然而当你开始实话实说后，人们虽然会有对此做出不适的反应，但到最后会建立起一个全新的更健康的人际关系， 如果不是这样，则这个不健康的人际关系就会被剔除。 怎么样你都是赢。</p><h3 id=\"I-wish-I-had-stayed-in-touch-with-my-friends\"><a href=\"#I-wish-I-had-stayed-in-touch-with-my-friends\" class=\"headerlink\" title=\"I wish I had stayed in touch with my friends.\"></a>I wish I had stayed in touch with my friends.</h3><p>我希望我能和朋友们保持联系</p><p>Often they would not truly realise the full benefits of old friends until their dying weeks and it was not always possible to track them down. Many had become so caught up in their own lives that they had let golden friendships slip by over the years. There were many deep regrets about not giving friendships the time and effort that they deserved. Everyone misses their friends when they are dying.</p><p>他们通常不会真正意识到老朋友的益处，直到等到他们快要面临死的那几周；而且也不一定能联络上这些朋友。 许多人都的生活节奏都太快了，以至于让金贵的友谊一年年渐渐溜走。有很多深深的遗憾都是关于友谊的，他们没有为友谊的维持贡献出足够的时间和努力。 所有人都在临终前想念他们的朋友。</p><p>It is common for anyone in a busy lifestyle to let friendships slip. But when you are faced with your approaching death, the physical details of life fall away. People do want to get their financial affairs in order if possible. But it is not money or status that holds the true importance for them. They want to get things in order more for the benefit of those they love. Usually though, they are too ill and weary to ever manage this task. It all comes down to love and relationships in the end. That is all that remains in the final weeks, love and relationships.</p><p>在忙碌的生活方式中，友谊的流逝是很普遍的。但当你不得不面对自己的死亡时，那些生活中物质的一面会渐渐消模糊。 人们确实希望尽可能地去创造财富，但真正重要的并不是钱或者地位。 他们为了自己的所爱而努力去带来更多的物质，但通常他们都太体弱多病而无法达成这个目标。 所有这一切都归结到爱和关系，这就是在最终的几周时间内剩下的全部内容了。</p><h3 id=\"I-wish-that-I-had-let-myself-be-happier\"><a href=\"#I-wish-that-I-had-let-myself-be-happier\" class=\"headerlink\" title=\"I wish that I had let myself be happier.\"></a>I wish that I had let myself be happier.</h3><p>我希望我曾可以让自己过得更开心一些</p><p>This is a surprisingly common one. Many did not realise until the end that happiness is a choice. They had stayed stuck in old patterns and habits. The so-called ‘comfort’ of familiarity overflowed into their emotions, as well as their physical lives. Fear of change had them pretending to others, and to their selves, that they were content. When deep within, they longed to laugh properly and have silliness in their life again.</p><p>令人惊讶的是，许多患者到最后才意识到开心是一种选择。 他们禁锢在陈旧的方式和习惯中，所谓的舒适感从他们的情感中和物质生活中溢出。 因为害怕改变，他们变得自欺欺人，安于现状。在内心深处，他们渴望在生命中再次适当地欢笑和犯糊涂。</p><p>When you are on your deathbed, what others think of you is a long way from your mind. How wonderful to be able to let go and smile again, long before you are dying.</p><p>当你时日已尽，别人怎么看你已经无关紧要了，在死之前能够释怀和再次微笑是多么的美妙啊。</p><hr><p>Life is a choice. It is YOUR life. Choose consciously, choose wisely, choose honestly. Choose happiness.</p><p>生活是一种选择。这是 <strong>你的</strong> 生活，请清醒地、明智地、诚实地选择。请选择幸福。</p>"}],"PostAsset":[],"PostCategory":[{"post_id":"clxwky1iq0001iubf74k18g94","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m4003xiubfhy6mr922"},{"post_id":"clxwky1iv0003iubf1pu7ppy3","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m4003ziubfbqd3qb5q"},{"post_id":"clxwky1iw0004iubfz0el5f1b","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m40041iubf2uq7q4sz"},{"post_id":"clxwky1ix0005iubf9giwjzv1","category_id":"clxwky1l6001eiubfhu5a052e","_id":"clxwky1m50043iubfarthey0b"},{"post_id":"clxwky1iy0006iubfidqhof8w","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m50045iubfezv0exsp"},{"post_id":"clxwky1j00007iubf0hz6pt16","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m50047iubfow2p5fdw"},{"post_id":"clxwky1j00008iubf1pumxhh2","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m50049iubf84tik65p"},{"post_id":"clxwky1j00009iubf4dpogemv","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m5004biubf81osxich"},{"post_id":"clxwky1j1000aiubfa52nolna","category_id":"clxwky1l8001oiubfgiyug2f3","_id":"clxwky1m5004diubfx3o0p2sg"},{"post_id":"clxwky1j2000biubf66vtnul6","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m5004fiubfqda15rr8"},{"post_id":"clxwky1j2000ciubf5l8wnqgb","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m5004hiubfdhii0wi0"},{"post_id":"clxwky1j3000diubfbfsp42ia","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m5004jiubfu2eyfgyw"},{"post_id":"clxwky1j3000eiubfrvxcw0pl","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m5004liubfdm1be2m2"},{"post_id":"clxwky1j4000fiubf1bo0zv86","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m5004niubfkzg269t9"},{"post_id":"clxwky1j4000giubfdylphnnl","category_id":"clxwky1lb0020iubf7w90i4i6","_id":"clxwky1m5004piubf1fwd4du8"},{"post_id":"clxwky1j6000hiubf5tccg8sl","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m5004riubfe0wz88aa"},{"post_id":"clxwky1j7000iiubf3qc01na0","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m5004tiubf5duqdwfw"},{"post_id":"clxwky1j8000jiubf1trks4cq","category_id":"clxwky1l6001eiubfhu5a052e","_id":"clxwky1m6004viubfjflxwjg6"},{"post_id":"clxwky1j8000kiubf8j3rwo42","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m8004xiubf6aw4ru9x"},{"post_id":"clxwky1j9000liubf3e0sh7tl","category_id":"clxwky1lb0020iubf7w90i4i6","_id":"clxwky1m8004ziubf5k36t4ww"},{"post_id":"clxwky1j9000miubfqqb4rm7e","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m80051iubfw5xr7lft"},{"post_id":"clxwky1j9000niubf8a6twjli","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m80053iubf8m5o5fog"},{"post_id":"clxwky1ja000oiubf4sdbmfeq","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m80055iubf4x0zpdmg"},{"post_id":"clxwky1jb000piubf7kz4xt19","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m80057iubf9u23v5nu"},{"post_id":"clxwky1jc000qiubf9tyxwuof","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m80059iubf7wousnt9"},{"post_id":"clxwky1jc000riubfo9go6qsb","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m8005biubfgqawzbyl"},{"post_id":"clxwky1jd000tiubfg1plb8yi","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m8005diubf655omzfa"},{"post_id":"clxwky1je000viubfjqrn7h9g","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m8005fiubfuf1rx1cw"},{"post_id":"clxwky1je000wiubfmaqjte92","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m8005hiubfxz4ujmry"},{"post_id":"clxwky1je000xiubfkl4e4evg","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m8005jiubflyfs06ua"},{"post_id":"clxwky1jf000ziubfqk0yp27g","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m9005liubfds7mva8v"},{"post_id":"clxwky1jf0010iubflhwbslgh","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m9005niubfiiokew0j"},{"post_id":"clxwky1jg0011iubf8hzijse5","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m9005piubfjhfbhm58"},{"post_id":"clxwky1jh0012iubf3wg3gliv","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m9005riubfri1pzqpr"},{"post_id":"clxwky1ji0013iubfidj5doci","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m9005tiubf7wez4sjj"},{"post_id":"clxwky1ji0014iubfi8y3yj0x","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m9005viubfpchqhjxx"},{"post_id":"clxwky1ji0015iubf0b8fy7ar","category_id":"clxwky1lb0020iubf7w90i4i6","_id":"clxwky1m9005xiubfcbep98xf"},{"post_id":"clxwky1jd000siubfufllpjyo","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m9005ziubf490oyaua"},{"post_id":"clxwky1jd000siubfufllpjyo","category_id":"clxwky1lb0020iubf7w90i4i6","_id":"clxwky1m90061iubftuod0yuv"},{"post_id":"clxwky1jd000uiubfyqe13gdx","category_id":"clxwky1lb0020iubf7w90i4i6","_id":"clxwky1m90063iubfjcpwoan7"},{"post_id":"clxwky1jd000uiubfyqe13gdx","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m90065iubfaisvsiz5"},{"post_id":"clxwky1jf000yiubfcj1xq1je","category_id":"clxwky1lb0020iubf7w90i4i6","_id":"clxwky1m90067iubf0ixlh0k6"},{"post_id":"clxwky1jf000yiubfcj1xq1je","category_id":"clxwky1kq0016iubfclvinora","_id":"clxwky1m90069iubfdxfi96xe"}],"PostTag":[{"post_id":"clxwky1iq0001iubf74k18g94","tag_id":"clxwky1kz0017iubfy0u40x2c","_id":"clxwky1m4003wiubfa95y2n65"},{"post_id":"clxwky1iv0003iubf1pu7ppy3","tag_id":"clxwky1l3001biubfuytij83c","_id":"clxwky1m4003yiubf0zhdx4by"},{"post_id":"clxwky1iv0003iubf1pu7ppy3","tag_id":"clxwky1l6001diubfuqbrygdv","_id":"clxwky1m40040iubfaq73bo0l"},{"post_id":"clxwky1iv0003iubf1pu7ppy3","tag_id":"clxwky1l6001fiubf4dd4hqk1","_id":"clxwky1m50042iubffaq6ppua"},{"post_id":"clxwky1iw0004iubfz0el5f1b","tag_id":"clxwky1l7001hiubfhcmsynqt","_id":"clxwky1m50044iubf6m16m8z9"},{"post_id":"clxwky1iy0006iubfidqhof8w","tag_id":"clxwky1kz0017iubfy0u40x2c","_id":"clxwky1m50046iubfff39j1js"},{"post_id":"clxwky1iy0006iubfidqhof8w","tag_id":"clxwky1l8001liubf0xacbtds","_id":"clxwky1m50048iubfhwifobm7"},{"post_id":"clxwky1j00007iubf0hz6pt16","tag_id":"clxwky1l8001niubfj0tyeeq7","_id":"clxwky1m5004aiubflte1qvhh"},{"post_id":"clxwky1j00007iubf0hz6pt16","tag_id":"clxwky1l7001hiubfhcmsynqt","_id":"clxwky1m5004ciubfqbi03wnv"},{"post_id":"clxwky1j00008iubf1pumxhh2","tag_id":"clxwky1l9001riubf5rq72c3n","_id":"clxwky1m5004eiubf623s3xsk"},{"post_id":"clxwky1j00008iubf1pumxhh2","tag_id":"clxwky1l9001tiubfptq531el","_id":"clxwky1m5004giubf1rdh8osp"},{"post_id":"clxwky1j00009iubf4dpogemv","tag_id":"clxwky1l7001hiubfhcmsynqt","_id":"clxwky1m5004iiubfz5f20oa7"},{"post_id":"clxwky1j2000biubf66vtnul6","tag_id":"clxwky1la001xiubf37se11v3","_id":"clxwky1m5004kiubfd78258oa"},{"post_id":"clxwky1j2000biubf66vtnul6","tag_id":"clxwky1la001ziubfvl5wjuzu","_id":"clxwky1m5004miubfzpjoypyl"},{"post_id":"clxwky1j2000biubf66vtnul6","tag_id":"clxwky1lb0021iubf5k5wyj04","_id":"clxwky1m5004oiubfip34svct"},{"post_id":"clxwky1j2000ciubf5l8wnqgb","tag_id":"clxwky1l7001hiubfhcmsynqt","_id":"clxwky1m5004qiubfjrq3tb6h"},{"post_id":"clxwky1j3000diubfbfsp42ia","tag_id":"clxwky1lc0026iubfqhq3nkvx","_id":"clxwky1m5004siubfa759jhsm"},{"post_id":"clxwky1j3000eiubfrvxcw0pl","tag_id":"clxwky1ld0028iubf2mz6v52j","_id":"clxwky1m6004uiubfsyrmdgqr"},{"post_id":"clxwky1j4000fiubf1bo0zv86","tag_id":"clxwky1l7001hiubfhcmsynqt","_id":"clxwky1m8004wiubf507r33pk"},{"post_id":"clxwky1j4000giubfdylphnnl","tag_id":"clxwky1ld002ciubfgbiy577q","_id":"clxwky1m8004yiubfokpvh5jr"},{"post_id":"clxwky1j6000hiubf5tccg8sl","tag_id":"clxwky1le002eiubf60tmvkav","_id":"clxwky1m80050iubfktsuxxsn"},{"post_id":"clxwky1j7000iiubf3qc01na0","tag_id":"clxwky1le002eiubf60tmvkav","_id":"clxwky1m80052iubfaih2qusi"},{"post_id":"clxwky1j7000iiubf3qc01na0","tag_id":"clxwky1la001xiubf37se11v3","_id":"clxwky1m80054iubft3ltv4qj"},{"post_id":"clxwky1j7000iiubf3qc01na0","tag_id":"clxwky1lf002kiubf3klva2jp","_id":"clxwky1m80056iubfalagx8ei"},{"post_id":"clxwky1j8000kiubf8j3rwo42","tag_id":"clxwky1le002eiubf60tmvkav","_id":"clxwky1m80058iubfbeysuzqb"},{"post_id":"clxwky1j8000kiubf8j3rwo42","tag_id":"clxwky1lg002oiubf1d2dtfyy","_id":"clxwky1m8005aiubf6m8ijhdu"},{"post_id":"clxwky1j9000liubf3e0sh7tl","tag_id":"clxwky1ld002ciubfgbiy577q","_id":"clxwky1m8005ciubfcdineigy"},{"post_id":"clxwky1j9000miubfqqb4rm7e","tag_id":"clxwky1lg002siubf24lwah4c","_id":"clxwky1m8005eiubfb9m04miz"},{"post_id":"clxwky1j9000niubf8a6twjli","tag_id":"clxwky1lh002uiubfm0xlxs4z","_id":"clxwky1m8005giubf11iju7lr"},{"post_id":"clxwky1ja000oiubf4sdbmfeq","tag_id":"clxwky1lh002xiubfwxygxc3t","_id":"clxwky1m8005iiubf9v4gbsbt"},{"post_id":"clxwky1ja000oiubf4sdbmfeq","tag_id":"clxwky1lj002ziubfe78pzpxa","_id":"clxwky1m9005kiubf2tkzytv7"},{"post_id":"clxwky1jb000piubf7kz4xt19","tag_id":"clxwky1lk0031iubfb5c42obn","_id":"clxwky1m9005miubflnbmu5c3"},{"post_id":"clxwky1jc000qiubf9tyxwuof","tag_id":"clxwky1lg002siubf24lwah4c","_id":"clxwky1m9005oiubf2jxm3dul"},{"post_id":"clxwky1jc000qiubf9tyxwuof","tag_id":"clxwky1lk0035iubf7n0sbrlq","_id":"clxwky1m9005qiubft331yr6e"},{"post_id":"clxwky1jc000qiubf9tyxwuof","tag_id":"clxwky1ll0037iubf90a30hh1","_id":"clxwky1m9005siubfx7a3lkxu"},{"post_id":"clxwky1jc000qiubf9tyxwuof","tag_id":"clxwky1ll0039iubfj9vhnx3t","_id":"clxwky1m9005uiubfrb5mjuew"},{"post_id":"clxwky1jc000qiubf9tyxwuof","tag_id":"clxwky1lm003biubfb0rrqh77","_id":"clxwky1m9005wiubfncvfu7a0"},{"post_id":"clxwky1jc000qiubf9tyxwuof","tag_id":"clxwky1ln003diubf9xdb3ile","_id":"clxwky1m9005yiubfmx31e2ue"},{"post_id":"clxwky1jc000riubfo9go6qsb","tag_id":"clxwky1kz0017iubfy0u40x2c","_id":"clxwky1m90060iubfbh86xz98"},{"post_id":"clxwky1jd000siubfufllpjyo","tag_id":"clxwky1la001xiubf37se11v3","_id":"clxwky1m90062iubf4z43tpzv"},{"post_id":"clxwky1jd000siubfufllpjyo","tag_id":"clxwky1lo003giubfqwmnbewq","_id":"clxwky1m90064iubfddvpulpz"},{"post_id":"clxwky1jd000tiubfg1plb8yi","tag_id":"clxwky1l7001hiubfhcmsynqt","_id":"clxwky1m90066iubfy9onzsr7"},{"post_id":"clxwky1jd000uiubfyqe13gdx","tag_id":"clxwky1l7001hiubfhcmsynqt","_id":"clxwky1m90068iubf20tkczqs"},{"post_id":"clxwky1je000viubfjqrn7h9g","tag_id":"clxwky1ld0028iubf2mz6v52j","_id":"clxwky1m9006aiubf6fdx7wuy"},{"post_id":"clxwky1je000wiubfmaqjte92","tag_id":"clxwky1lr003kiubftnnxbljm","_id":"clxwky1m9006biubft1c6x790"},{"post_id":"clxwky1je000wiubfmaqjte92","tag_id":"clxwky1lr003liubfwj6nidya","_id":"clxwky1m9006ciubf66apghxo"},{"post_id":"clxwky1je000xiubfkl4e4evg","tag_id":"clxwky1lr003kiubftnnxbljm","_id":"clxwky1m9006diubfpckpm2k8"},{"post_id":"clxwky1je000xiubfkl4e4evg","tag_id":"clxwky1ls003niubfmbmgd1f1","_id":"clxwky1m9006eiubfemp8f589"},{"post_id":"clxwky1jf000yiubfcj1xq1je","tag_id":"clxwky1l7001hiubfhcmsynqt","_id":"clxwky1m9006fiubfs1fawdsg"},{"post_id":"clxwky1jf000ziubfqk0yp27g","tag_id":"clxwky1l3001biubfuytij83c","_id":"clxwky1m9006giubfs8fpc0xw"},{"post_id":"clxwky1jf0010iubflhwbslgh","tag_id":"clxwky1lr003kiubftnnxbljm","_id":"clxwky1m9006hiubf5j5o9rtx"},{"post_id":"clxwky1jf0010iubflhwbslgh","tag_id":"clxwky1lt003riubfpigrqodd","_id":"clxwky1m9006iiubfhjuntec0"},{"post_id":"clxwky1jg0011iubf8hzijse5","tag_id":"clxwky1kz0017iubfy0u40x2c","_id":"clxwky1ma006jiubfjbcsv7wd"},{"post_id":"clxwky1jh0012iubf3wg3gliv","tag_id":"clxwky1kz0017iubfy0u40x2c","_id":"clxwky1ma006kiubfivudkhlv"},{"post_id":"clxwky1ji0013iubfidj5doci","tag_id":"clxwky1le002eiubf60tmvkav","_id":"clxwky1ma006liubfzxaa5cf3"},{"post_id":"clxwky1ji0013iubfidj5doci","tag_id":"clxwky1l7001hiubfhcmsynqt","_id":"clxwky1ma006miubf8r4lmbco"}],"Tag":[{"name":"mac","_id":"clxwky1kz0017iubfy0u40x2c"},{"name":"docker","_id":"clxwky1l3001biubfuytij83c"},{"name":"shadowsocks","_id":"clxwky1l6001diubfuqbrygdv"},{"name":"ubuntu","_id":"clxwky1l6001fiubf4dd4hqk1"},{"name":"golang","_id":"clxwky1l7001hiubfhcmsynqt"},{"name":"android","_id":"clxwky1l8001liubf0xacbtds"},{"name":"gRPC","_id":"clxwky1l8001niubfj0tyeeq7"},{"name":"router","_id":"clxwky1l9001riubf5rq72c3n"},{"name":"merlin","_id":"clxwky1l9001tiubfptq531el"},{"name":"php","_id":"clxwky1la001xiubf37se11v3"},{"name":"shell","_id":"clxwky1la001ziubfvl5wjuzu"},{"name":"laravel/lumen","_id":"clxwky1lb0021iubf5k5wyj04"},{"name":"linux","_id":"clxwky1lc0026iubfqhq3nkvx"},{"name":"git","_id":"clxwky1ld0028iubf2mz6v52j"},{"name":"Metallica","_id":"clxwky1ld002ciubfgbiy577q"},{"name":"nginx","_id":"clxwky1le002eiubf60tmvkav"},{"name":"fpm","_id":"clxwky1lf002kiubf3klva2jp"},{"name":"https","_id":"clxwky1lg002oiubf1d2dtfyy"},{"name":"mysql","_id":"clxwky1lg002siubf24lwah4c"},{"name":"ssh","_id":"clxwky1lh002uiubfm0xlxs4z"},{"name":"NAS","_id":"clxwky1lh002xiubfwxygxc3t"},{"name":"群晖","_id":"clxwky1lj002ziubfe78pzpxa"},{"name":"jailbreak","_id":"clxwky1lk0031iubfb5c42obn"},{"name":"innodb","_id":"clxwky1lk0035iubf7n0sbrlq"},{"name":"lock","_id":"clxwky1ll0037iubf90a30hh1"},{"name":"transaction","_id":"clxwky1ll0039iubfj9vhnx3t"},{"name":"index","_id":"clxwky1lm003biubfb0rrqh77"},{"name":"database","_id":"clxwky1ln003diubf9xdb3ile"},{"name":"gc","_id":"clxwky1lo003giubfqwmnbewq"},{"name":"CI","_id":"clxwky1lr003kiubftnnxbljm"},{"name":"Drone","_id":"clxwky1lr003liubfwj6nidya"},{"name":"Jenkins","_id":"clxwky1ls003niubfmbmgd1f1"},{"name":"Github Actions","_id":"clxwky1lt003riubfpigrqodd"}]}}