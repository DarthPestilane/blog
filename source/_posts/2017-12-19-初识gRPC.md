---
title: åˆè¯†gRPC
date: 2017-12-19 11:04:29
categories:
- ç¬”è®°
tags:
- gRPC
- golang
---
å†™è¿™ç¯‡æ–‡ç« ç”¨äºè®°å½•é¦–æ¬¡æ¥è§¦gRPCçš„æ„Ÿå—ã€‚

å®˜ç½‘ï¼š[grpc.io](https://grpc.io/)

å…ˆä¸Šä¸€å¼ æ ¸å¿ƒæ¦‚å¿µçš„æµç¨‹å›¾ï¼š

![Overview](https://grpc.io/img/landing-2.svg)

çœ‹äº†çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œä¹Ÿæœ‰äº†åˆæ­¥çš„ä¸€ä¸ªè®¤è¯†ã€‚ä¸ªäººè§‰å¾—è¿™ä¸ªæ¡†æ¶ä¸­æœ€å‰å®³çš„æ˜¯ `protobuf` çš„ç›®æ ‡è¯­è¨€ `generator` ï¼Œæ•´ä¸ªæ¡†æ¶çš„æ ¸å¿ƒä¹Ÿæ˜¯å›´ç»•ç€è¿™ä¸ªç”Ÿæˆå™¨å±•å¼€çš„ã€‚

<!-- more -->

# æ ¸å¿ƒæ€è·¯

ä½¿ç”¨ `.proto` æ–‡ä»¶ç¼–å†™æ–¹æ³•ã€å‚æ•°ã€è¿”å›(ç±»ä¼¼è·¯ç”±è§„åˆ™)ï¼Œå†é€šè¿‡ `generator` ç”Ÿæˆå„ç§è¯­è¨€çš„æ–‡ä»¶ æ¯”å¦‚ `Golang` `PHP` `Javascript` ç­‰ã€‚
åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¼•å…¥ç”Ÿæˆçš„è¯­è¨€æ–‡ä»¶å³å¯è¿›è¡Œä¸šåŠ¡ä»£ç å¼€å‘ï¼Œç”±æ­¤è¾¾åˆ°äº†è·¨è¯­è¨€çš„è°ƒç”¨ã€‚

# ä¸¾ä¸ªä¾‹å­

è™½ç„¶å®˜æ–¹ç­‰æ–‡æ¡£å·²ç»å†™çš„æ¯”è¾ƒæ¸…æ™°äº†ï¼Œä½†æ˜¯è¿˜æ˜¯æƒ³åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹è‡ªå·±è·Ÿç€å®˜ç½‘æ‰“æ•™ç¨‹ä½“éªŒã€‚

è¿™é‡Œæš‚ä¸”åªè®°å½• `Golang` çš„æ•™ç¨‹

## åœ¨ `.proto` æ–‡ä»¶ä¸­å®šä¹‰æ–¹æ³•ã€å‚æ•°ã€è¿”å›

å…ˆæ¥ä¸€ä¸ªæœ€ç®€å•çš„ï¼š

```proto3
// file: $GOPATH/src/proto/user.proto

syntax = "proto3";

package proto; // åŒ…å

service User {
  rpc all (Request) returns (Response);
}

message Request {
  string json = 1;
}

message Response {
  string json = 1;
}
```

è¿™ä¸ªç®€å•çš„ `.proto` æ–‡ä»¶å®šä¹‰äº† ä¸€ä¸ªè·¯ç”±ç»„ `user` å’Œ è¿™ä¸ªè·¯ç”±ç»„é‡Œçš„ä¸€ä¸ª `all` æ–¹æ³•ï¼Œ
è¿™ä¸ª `all` æ–¹æ³•éœ€è¦æ¥æ”¶ä¸€ä¸ª `Request` å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œ`Request` å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª `json` å±æ€§ï¼Œç±»å‹æ˜¯ `string`ï¼Œ
åŒæ—¶ï¼Œè¿™ä¸ª `all` æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª `Response` å¯¹è±¡ï¼Œ`Response` å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª `json` å±æ€§ï¼Œç±»å‹æ˜¯ `string`ã€‚

ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ª `.proto` æ–‡ä»¶è½¬æ¢ä¸ºæˆ‘ä»¬çš„å¼€å‘è¯­è¨€ï¼Œä¹Ÿå°±æ˜¯ `Golang`ã€‚è½¬æ¢ç­‰æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œä¸€ä¸ªå‘½ä»¤å°±å¯ä»¥æå®šã€‚
ä½†æ˜¯åœ¨ä½¿ç”¨è¿™ä¸ªå‘½ä»¤å‰ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€äº›ä¾èµ–ï¼Œè¿™äº›ä¾èµ–ä¼šæ ¹æ®ç›®æ ‡è¯­è¨€çš„ä¸åŒè€Œä¸åŒï¼Œå…·ä½“å†…å®¹å¯ä»¥å‚è€ƒæ–‡æ¡£ã€‚

å®‰è£… Protocol Buffers v3

> Install the protoc compiler that is used to generate gRPC service code. The simplest way to do this is to download pre-compiled binaries for your platform(protoc-<version>-<platform>.zip) from here: https://github.com/google/protobuf/releases
> Unzip this file.
> Update the environment variable PATH to include the path to the protoc binary file.

ç„¶åå®‰è£… the protoc plugin for Go

```sh
go get -u -v github.com/golang/protobuf/protoc-gen-go
```

æ£€æŸ¥ä¸‹ç¯å¢ƒå˜é‡

```sh
echo $path # åº”è¯¥åŒ…å« /path/to/protoc å’Œ $GOPATH
```

æ‰§è¡Œå‘½ä»¤ï¼Œç”Ÿæˆ `golang` ä»£ç 

```sh
cd $GOPATH/src
protoc -I proto proto/*.proto --go_out=plugins=grpc:proto
```

å®Œæˆåä½ ä¼šå¾—åˆ°ä¸€ä¸ª `user.pb.go` æ–‡ä»¶ï¼Œå…¶ `package` æ˜¯ `proto` æ­£å¦‚åœ¨ `user.proto` æ–‡ä»¶ä¸­å®šä¹‰çš„ä¸€æ ·

å½“ç„¶é’ˆå¯¹ä¸åŒçš„ç›®æ ‡è¯­è¨€ï¼Œå‘½ä»¤çš„å‚æ•°æ˜¯ä¸ä¸€æ ·çš„ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚

æœ‰äº† `user.pb.go` æ–‡ä»¶ï¼Œå¼•ç”¨ä¹‹åï¼Œç¼–å†™ `server` å’Œ `client` å°±å¾ˆè½»æ¾äº†ã€‚thanks to code hint.
å½“ç„¶ï¼Œé¦–å…ˆéœ€è¦å®‰è£… `gRPC` æ¡†æ¶

```sh
go get -u -v google.golang.org/grpc
```

## ç¼–å†™server

ç›´æ¥çœ‹ä»£ç 

```golang
// file: $GOPATH/src/server/main.go
package main

import (
    "log"
    "net"
    "proto"
    "google.golang.org/grpc"
    "golang.org/x/net/context"
)

var address string = ":6666"

type server struct {}

// è¿™é‡Œç­‰æ–¹æ³•åç§°å¿…é¡»æ˜¯å¤§å†™å¼€å¤´ï¼Œåº”è¯¥æ˜¯ç”±äºgolangçš„è¯­è¨€ç‰¹æ€§
func (s *server) All(ctx context.Context, req *proto.Request) (*proto.Response, error) {
    // handle req...
    return &proto.Response{Json: "user list"}, nil
}

func main() {
    lis, err := net.Listen("tcp", address)
    if err != nil {
        log.Fatalf("failed to listen: %v", err)
    }

    // æ³¨å†ŒæœåŠ¡
    grpcServer := grpc.NewServer()
    proto.RegisterUserServer(grpcServer, &server{})

    // ç›‘å¬
    if err := grpcServer.Serve(lis); err != nil {
        log.Fatalf("failed to serve: %v", err)
    }
}
```

æ‰§è¡Œ `server`

```sh
cd $GOPATH/src
go run server/main.go
```

## ç¼–å†™client

ç›´æ¥çœ‹ä»£ç 

```golang
// file: $GOPATH/src/client/main.go
package main

import (
    "golang.org/x/net/context"
    "google.golang.org/grpc"
    "log"
    "proto"
)

var address string = "localhost:6666" // å’Œserverä¿æŒä¸€è‡´

func main() {
    var response *proto.Response
    var err error

    // æ‹¨å·å»ºç«‹è¿æ¥
    conn, err := grpc.Dial(address, grpc.WithInsecure())
    if err != nil {
        log.Fatalf("did not connect: %v", err)
    }
    defer conn.Close()

    // rpcè°ƒç”¨
    users := proto.NewUserClient(conn)
    response, err = users.All(context.Background(), &proto.Request{Json: "string param"})
    if err != nil {
        log.Fatalf("could not call user.All: %v", err)
    }
    log.Print(response.Json) // è¾“å‡ºå“åº”
}
```

æ‰§è¡Œ `client`

```sh
cd $GOPATH/src
go run client/main.go
```

è¾“å‡º

```sh
2017/12/19 11:52:44 user list
```

## æ€»ç»“

ç¬¬ä¸€ä¸ªæ•™ç¨‹æ‰“å®Œäº†ã€‚æ„Ÿè§‰æœ€ä¸»è¦çš„åŠŸåŠ³è¿˜æ˜¯ `generator` ğŸ˜†

---

# æ›´æ–°

ç”Ÿæˆç›®æ ‡è¯­è¨€çš„å‘½ä»¤ï¼š(ç›®å‰åªåœ¨Macä¸Šæµ‹è¯•è¿‡)

```sh
cd protos # å‡è®¾è¿™é‡Œæ”¾çš„æ˜¯ .proto æ–‡ä»¶

# golang
mkdir go
# éœ€è¦å®‰è£…æ’ä»¶ go get -u -v github.com/golang/protobuf/protoc-gen-go
protoc --go_out=./go *.proto # æœ‰æœ¨æœ‰å¾ˆç®€å•ã€‚ã€‚

# node
mkdir node
# éœ€è¦å®‰è£…æ’ä»¶ npm install -g grpc-tools
protoc --js_out=import_style=commonjs,binary:./node --grpc_out=./node --plugin=protoc-gen-grpc=`which grpc_tools_node_protoc_plugin` *.proto
# ä¼šç”Ÿæˆä¸¤ç§æ–‡ä»¶ *_pb.js å’Œ *_grpc_pb.js
# å‰è€…ç”¨äºè®¿é—® request å’Œ response
# åè€…ç”¨äºåˆ›å»º server å’Œ client ä»¥åŠæ–¹æ³•è°ƒç”¨
```
