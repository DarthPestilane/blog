---
title: 记一次群晖 SHR 降级折腾
date: 2019-04-01 10:14:01
categories:
- 笔记
tags:
- NAS
- 群晖
---
## 背景

硬件:
- NAS: 群晖DS218+(双盘位) 系统版本: DSM 6.2.1-23824 Update 1
- 硬盘: 2T希捷酷狼 x 2
- 移动硬盘: 1T希捷

由于在最初安装DSM时，系统自动选择了SHR冗余模式，使得其中一块硬盘变成了数据保护盘，实际可用的容量只有2T。
随着下载的电影，以及上传照片和其他文件的数量增加，NAS空间使用率已高达95%+。

若要给空间扩容，无非是两种策略:
- 将原有的两块硬盘整体换为更大容量的2块硬盘
- 将系统原先设定的SHR冗余模式降级为basic模式(无数据冗余保护)，归还硬盘空间

由于NAS空间中的大部分体积被电影所占用，相比之下真正重要的文件--比如照片，生活视频，工作文件等--数量相对较少。
经过思考，决定采取第二种解决方案，即SHR降级，并配合外接USB存储设备，对重要文件进行冷备份。

<!-- more -->

## 准备

- 将移动硬盘通过USB和NAS连接，可先将硬盘格式化为NTFS格式。
- `File Station`应用中会新增`usbshare1-1`和`usbshare1-2`两个共享文件夹。通过查看容量空间，找到可用的那一个(usbshare1-2)。
- 将重要数据备份到移动硬盘中，比如照片。

## SHR降级步骤

- 在NAS运行状态下取出一块硬盘，取出后，在`存储空间管理员`应用中的存储空间上会显示`堪用`字样，此时NAS机器会发出警报声，但可以关闭。
- 将取出的硬盘插回去，此时该硬盘处于`未初始化`状态。
- 新增存储空间，此时可以手动选择RAID类型。按照提示，选择basic模式，逐步完成创建。
- 打开`控制面板`，将所有的共享文件夹，迁移至新的存储空间中，过程中可能需要停用一些应用程序。
- 迁移完成后，`堪用`存储空间对应的硬盘拔出，并重新插入，然后按照上述方法新增存储空间。如果无法识别硬盘，则重启NAS。(也许可以不用拔硬盘，直接删除存储空间并新增...)
- 现在已经有2个存储空间了，可以根据需求，迁移共享文件夹。
- 修复或重新安装NAS套件。

## 数据冷备份

- 编写冷备份脚步，使用rsync:
```sh
#!/bin/sh
echo "started to sync photo.";
rsync -avzh --exclude='@eaDir' --exclude='.DS_Store' --delete /volume2/photo/ /volumeUSB1/usbshare1-2/photo/;

echo "started to sync video.";
rsync -avzh --exclude='@eaDir' --exclude='.DS_Store' --delete /volume2/video/ /volumeUSB1/usbshare1-2/video/;
```
- 将脚本添加到定时任务中。

## 结束

整个过程可能会耗费数小时，不过群晖NAS套件体验是非常好的，很多功能都能轻松实现。
