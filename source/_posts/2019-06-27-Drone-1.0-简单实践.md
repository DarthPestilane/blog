---
title: Drone 1.0 ç®€å•å®è·µ
date: 2019-06-27 15:05:04
categories:
- ç¬”è®°
tags:
- CI
- Drone
---
æœ¬æ–‡ä»…é’ˆå¯¹ Drone 1.0 ç‰ˆæœ¬

ç”±äºç‰ˆæœ¬æ›´æ–°æ— æ³•å‘ä¸‹å…¼å®¹ï¼Œæ‰€æœ‰æœ‰å¿…è¦è‡ªå·±ä»å¤´å®è·µä¸€ä¸‹ã€‚å®ç°ç›®æ ‡ä¸ºï¼š

- æ­å»º drone ci æœåŠ¡å™¨ï¼Œé…ç½®nginxåä»£ï¼Œå®ç°httpsè®¿é—®
- ç¼–å†™ `.drone.yml` é…ç½®æ–‡ä»¶ï¼Œå®ç° golang é¡¹ç›®çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼ŒåŒ…æ‹¬ buildï¼Œä¾èµ–ç¼“å­˜ï¼ŒäºŒè¿›åˆ¶å‘å¸ƒ(rsync)

<!-- more -->

## Drone CI æœåŠ¡å™¨æ­å»ºä¸è®¿é—®

æˆ‘é€‰ç”¨çš„æ˜¯é’ˆå¯¹ GitHub ä»“åº“çš„å•æœºéƒ¨ç½²ã€‚
æ ¹æ®[å®˜æ–¹æ–‡æ¡£](https://docs.drone.io/installation/github/single-machine/)çš„è¯´æ˜ï¼Œå…ˆè¿›è¡Œ `docker pull drone/drone:1` å°†é•œåƒæ‹‰ä¸‹æ¥ï¼Œç„¶åé…ç½® `docker-compose.yml` (å®˜æ–¹åªç»™å‡ºäº† `docker run` çš„å¯åŠ¨æ–¹å¼ï¼Œå¯èƒ½æ˜¯å› ä¸º 1.0 ç‰ˆæœ¬åªéœ€è¦å¯åŠ¨ä¸€ä¸ªå®¹å™¨å§)ï¼š

```yml
version: '3'

services:
  ci:
    image: drone/drone:1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # å®¿ä¸»æœºçš„è·¯å¾„ä¸èƒ½å˜
      - /var/lib/drone:/data # å®¿ä¸»æœºè·¯å¾„å¯ä»¥æ˜¯åˆ«çš„åœ°æ–¹
    environment:
      - DRONE_GITHUB_SERVER=https://github.com
      - DRONE_GITHUB_CLIENT_ID=githubçš„clientID
      - DRONE_GITHUB_CLIENT_SECRET=githubçš„clientSecret
      - DRONE_RUNNER_CAPACITY=2
      - DRONE_USER_CREATE=username:DarthPestilane,admin:true # æŒ‡å®šç®¡ç†å‘˜ç”¨æˆ·
      - DRONE_SERVER_HOST=ci.yourhost.com # ci æœåŠ¡å™¨åŸŸå
      - DRONE_SERVER_PROTO=https
      - DRONE_TLS_AUTOCERT=true
      - DRONE_LOGS_DEBUG=true # debug æ—¥å¿—çº§åˆ«
    ports:
      - 8004:80 # å°†ç«¯å£æš´éœ²å‡ºæ¥
```

Drone CI å®¹å™¨å¯åŠ¨åï¼Œæˆ‘ä»¬ç»§ç»­é…ç½® nginx åä»£ï¼š

```conf
server {
    listen 443 ssl http2;
    server_name ci.yourhost.com;

    ssl_certificate /path/to/ci.yourhost.com/fullchain.pem;
    ssl_certificate_key /path/to/ci.yourhost.com/privkey.pem;

    location / {
        proxy_pass http://172.17.0.1:8004; # åä»£åˆ° drone æœåŠ¡ï¼Œipä¸º docker network bridge
    }
}
server {
    # å¼ºåˆ¶ https
    listen 80;
    server_name ci.yourhost.com;
    return 301 https://ci.yourhost.com$request_uri;
}
```

é…ç½®å®Œæˆåï¼Œè®°å¾—å…ˆè¦å°†åŸŸåå’Œè¯ä¹¦å‡†å¤‡å¥½ï¼Œç„¶å restart nginx å®¹å™¨ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡åŸŸåè®¿é—®Drone CIäº†ã€‚

## é…ç½® CI (.drone.yml)

Drone 1.0ç‰ˆæœ¬çš„é…ç½®æ–‡ä»¶ä¾ç„¶æ˜¯ `.drone.yml`ã€‚æˆ‘å°† CI æ­¥éª¤åˆ†ä¸ºä¸¤æ­¥ï¼šbuild å’Œ deployã€‚

### Build

æœ€ç®€å•çš„é…ç½®ï¼š

```yml
kind: pipeline
name: drone-test

steps:
- name: build
  image: golang
  environment:
    GOOS: linux
    GOARCH: amd64
    CGO_ENABLED: 0
  commands:
  - go build
  - go test
```

CI æœåŠ¡å™¨ä¼šæ‹‰å– GitHub ä»“åº“ä»£ç ï¼Œå¹¶è¯»å–ä¸Šè¿°é…ç½®ï¼Œç„¶åæ ¹æ®é…ç½®æ‰§è¡Œå¯¹åº”çš„æ“ä½œã€‚è¿™é‡Œ CI ä¼šæ‰§è¡Œ**ç±»ä¼¼**ä¸‹é¢çš„å‘½ä»¤ï¼š

```sh
docker run --rm \
    --env=GOOS=linux \
    # --env=... å…¶ä»–ç¯å¢ƒå˜é‡ \
    --volumes=`pwd`:/drone/src \
    --workdir=/drone/src \ # workdir ä¹Ÿä¸º /drone/src
    --entrypoint=build.sh \
    golang \
    # your commands
```

åœ¨å®¹å™¨å†…éƒ¨ä¼šæ‰§è¡Œï¼š

```sh
#!/bin/sh
set -e

go build
go test
```

æ‰§è¡Œå®Œæˆåï¼Œå¦‚æœå‘½ä»¤ä¸å‡ºé”™ï¼Œå°±å¯ä»¥åœ¨å®¿ä¸»æœºä¸Šå¾—åˆ°ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ç„¶è€Œå¦‚æœæˆ‘çš„ golang é¡¹ç›®ä¸­åŒ…å«äº†ç¬¬ä¸‰æ–¹ä¾èµ–ï¼ŒæŒ‰ç…§è¿™æ ·çš„é…ç½®ï¼Œæ¯æ¬¡ push åæ‰§è¡Œ `go build` æ˜¯ä¼šé‡æ–°é€šè¿‡ç½‘ç»œä¸‹è½½ä¾èµ–åŒ…çš„ï¼Œå› ä¸ºå®¿ä¸»æœºæœ¬åœ°æ²¡æœ‰ä¿å­˜ä¾èµ–ï¼Œä»¥è‡³äº build æ—¶é—´å¤ªé•¿(æƒ³æƒ³ `npm install` ğŸ˜±)ã€‚
ä½†äº†è§£äº† CI å¯¹å®¹å™¨çš„æ“ä½œåï¼Œè¿™ä¸ªé—®é¢˜å°±è¿åˆƒè€Œè§£äº†ã€‚

æ›´æ–°é…ç½®ï¼š

```yml
# ...
steps:
- name: build
  image: golang
  volumes:
  - name: cache-go-deps
    path: /go # å®¹å™¨å†…çš„è·¯å¾„
  # ...
#...

volumes:
- name: cache-go-deps
  host:
    path: /var/local/drone-cache/repo/go-cache # å®¿ä¸»æœºçš„è·¯å¾„
```

ä¸Šé¢çš„é…ç½®ä¸­ï¼Œæˆ‘å°†å®¿ä¸»æœºçš„è·¯å¾„æŒ‚è½½åˆ°äº†å®¹å™¨å†…ï¼Œå®ç°äº†ä¾èµ–ç¼“å­˜æŒä¹…åŒ–ï¼Œåé¢çš„ build è¿‡ç¨‹å¯ä»¥å°±å¯ä»¥ä½¿ç”¨ä¾èµ–ç¼“å­˜äº†ã€‚

### Deploy

å®ç°äº†è‡ªåŠ¨åŒ– build åï¼Œè¿˜éœ€è¦å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œå³åˆ†å‘äºŒè¿›åˆ¶ã€‚
åœ¨å®é™…ç”Ÿäº§ä¸­ï¼ŒCI æœåŠ¡å™¨éœ€è¦å°† build å®Œæˆåçš„é¡¹ç›®ï¼Œå‘å¸ƒåˆ°ç”Ÿäº§æœåŠ¡å™¨ä¸Šï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨ rsync æ¥å‘å¸ƒï¼š

```yml
# ...
steps:
- name: build
  # ...

- name: deploy
  image: drillster/drone-rsync
  environment:
    RSYNC_KEY:
      from_secret: rsync_key
  settings:
    user: admin
    hosts:
      - "prod01.host.com"
      - "prod02.host.com"
    ports:
      - 22
      - 22
    source: ./
    target: /var/local/prod/
    recursive: true
    delete: true
    include:
      - drone-test
    exclude:
      - "**.*"
    script:
      - /var/local/prod/drone-test
#...
```

é€šè¿‡ä¸Šé¢çš„é…ç½®æ–‡ä»¶ï¼Œdrone ä¼šå°†å®¹å™¨ä¸­çš„ `./` ç›®å½•ï¼ˆå…¶ä¸­çš„å†…å®¹å’Œå®¿ä¸»æœºç›¸åŒï¼‰ä¸‹çš„æŒ‡å®šæ–‡ä»¶åˆ†åˆ«åŒæ­¥åˆ°ä¸¤ä¸ªç”Ÿäº§æœåŠ¡å™¨ä¸­çš„ `/var/local/prod/` ç›®å½•ä¸­ï¼Œå¹¶ç™»å½•ç”Ÿäº§æœåŠ¡å™¨ï¼Œæ‰§è¡ŒæŒ‡å®šçš„ `scripts`ã€‚è¿™äº›æ“ä½œçš„å‰ææ˜¯è¦å…è®¸ CI æœåŠ¡å™¨å¤Ÿé€šè¿‡ `ssh` çš„æ–‡ä»¶ç§˜é’¥æ–¹å¼ç™»å½•åˆ°ç”Ÿäº§æœåŠ¡å™¨ï¼Œé‚£ä¹ˆé¦–å…ˆæˆ‘éœ€è¦ç¡®ä¿ CI å®¿ä¸»æœºæœ¬èº«å¯ä»¥ç™»å½•åˆ°ç”Ÿäº§æœåŠ¡å™¨ã€‚
åœ¨CI å®¿ä¸»æœºä¸Šæ‰§è¡Œ `ssh-keygen` å‘½ä»¤ï¼Œç”Ÿæˆå…¬é’¥å’Œç§é’¥(id_rsa, id_rsa.pub)ï¼Œç„¶åå°†å…¬é’¥å†…å®¹æ‹·è´åˆ°ç”Ÿäº§æœåŠ¡å™¨çš„ `~/.ssh/authorized_keys` æ–‡ä»¶ä¸­ï¼Œè¿™æ ·ä¸€æ¥åœ¨ CI å®¿ä¸»æœºä¸Šå°±å¯ä»¥ç™»å½•åˆ°ç”Ÿäº§æœåŠ¡å™¨äº†ã€‚ç„¶è€Œæˆ‘æœ€ç»ˆçš„ç›®æ ‡æ˜¯è¦åœ¨ Drone CI çš„å®¹å™¨ä¸­å®ç° ssh ç™»å½•ï¼Œæœ‰ä¸ªå¾ˆç›´æ¥çš„æ–¹æ³•å°±æ˜¯ç›´æ¥å°†å®¿ä¸»æœºç§é’¥å¡«å†™åœ¨ .drone.yml é…ç½®é‡Œï¼Œä½†æ˜¯è¿™æ ·åšå¤ªå±é™©äº†ï¼Œå¥½åœ¨ Drone 1.0 ç‰ˆæœ¬å¯ä»¥é€šè¿‡ Web UI æ¥æ·»åŠ ç§å¯†ä¿¡æ¯é”®å€¼å¯¹(key-secret)ï¼Œäºæ˜¯æˆ‘åœ¨ Web ç•Œé¢ä¸­é…ç½®äº† `rsync_key`ï¼Œå¹¶å°†è¿™ä¸ªåç§°å¼•ç”¨åœ¨ `.drone.yml` ä¸­ï¼Œè¿™æ ·å°±å®‰å…¨äº†ï¼
å…³äº `drillster/drone-rsync` é•œåƒçš„æ›´å¤šé…ç½®å‚æ•°ï¼Œå¯ä»¥å‚è€ƒå®ƒçš„ [Docs](https://github.com/Drillster/drone-rsync/blob/master/1-DOCS.md)

===

è‡³æ­¤ï¼Œæ•´ä¸ª CI é…ç½®å·²ç»å¤§éƒ¨åˆ†å®Œæˆäº†ï¼Œå†åŠ ä¸Šä¸€äº› git pull å’Œè§¦å‘æ¡ä»¶çš„é…ç½®(triggers)ï¼Œæ•´ä¸ª `.drone.yml` çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

```yml
kind: pipeline
name: drone-test

clone:
  depth: 10

trigger:
  branch:
  - master # åªæœ‰åœ¨masteråˆ†æ”¯çš„å˜åŠ¨ï¼Œæ‰ä¼šè§¦å‘ CI

steps:
- name: build
  image: golang
  environment:
    GOOS: linux
    GOARCH: amd64
    CGO_ENABLED: 0
  volumes:
  - name: cache-go-deps
    path: /go # å®¹å™¨å†…çš„è·¯å¾„
  commands:
  - go build
  - go test

- name: deploy
  image: drillster/drone-rsync
  environment:
    RSYNC_KEY:
      from_secret: rsync_key
  settings:
    user: admin
    hosts:
      - "prod01.host.com"
      - "prod02.host.com"
    ports:
      - 22
      - 22
    source: ./
    target: /var/local/prod/
    recursive: true
    delete: true
    include:
      - drone-test
    exclude:
      - "**.*"
    script:
      - /var/local/prod/drone-test

volumes:
- name: cache-go-deps
  host:
    path: /var/local/drone-cache/repo/go-cache # å®¿ä¸»æœºçš„è·¯å¾„
```
